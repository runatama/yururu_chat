<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Lobby</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 20px;
    }

    h2{ margin:0; }

    /* ===== Top ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }

    .userBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      font-size:12px;
      flex-wrap: wrap;
      justify-content:flex-end;
      max-width: 62vw;
    }
    .userPill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .userText{
      color:var(--muted);
      max-width:30vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .avatarSm{
      width:26px;height:26px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .avatarSmFb{
      width:26px;height:26px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      color:rgba(234,242,255,.92);
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.18));
      flex:0 0 auto;
      user-select:none;
    }

    button{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:700;
    }
    button:hover{ filter:brightness(1.1); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    /* ===== Cards ===== */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    .sectionTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    input{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* ===== Room list ===== */
    #roomsBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }

    .roomRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .roomBtn{
      flex:1;
      text-align:left;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }

    .roomBtn:hover{
      background:linear-gradient(180deg, rgba(110,231,255,.15), rgba(255,255,255,.05));
    }

    .callLine{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badge{
      margin-left:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
    }

    .delBtn{
      width:44px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .delBtn:hover{ background:rgba(255,107,107,.25); }

    #status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }

    details{ margin-top:12px; }
    #log{
      margin-top:8px;
      font-size:12px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      max-height:200px;
      overflow:auto;
      white-space:pre-wrap;
    }

    .row > button{ white-space:nowrap; }
  </style>
</head>

<body>

<div class="topbar">
  <h2>ğŸ§ ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ â€“ ãƒ­ãƒ“ãƒ¼</h2>
  <div class="userBox">
    <!-- ã‚¢ã‚¤ã‚³ãƒ³ã¯ userPill ã®ä¸­ã«1å€‹ã ã‘å‡ºã™ï¼ˆã“ã“ã«imgã¯ç½®ã‹ãªã„ï¼‰ -->
    <button class="userPill" id="userNamePill" type="button" onclick="goProfile()">æœªãƒ­ã‚°ã‚¤ãƒ³</button>
    <span class="userText" id="userMailText"></span>
    <button class="btnPrimary" onclick="goLogin()" id="goLoginBtn" style="display:none;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="btnDanger" onclick="signOut()" id="signOutBtn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="card">
  <div class="sectionTitle">ğŸ  ãƒ«ãƒ¼ãƒ </div>
  <div class="row">
    <input id="room" placeholder="éƒ¨å±‹åï¼ˆä¾‹: testï¼‰" />
    <button class="btnPrimary" type="button" onclick="createRoom()">ä½œæˆ</button>
    <button type="button" onclick="enterRoom()">å…¥å®¤</button>
    <button type="button" onclick="loadRooms()">æ›´æ–°</button>
  </div>

  <div class="sectionTitle" style="margin-top:14px;">ğŸ“‹ éƒ¨å±‹ä¸€è¦§</div>
  <div id="roomsBox"></div>

  <details>
    <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
    <div id="log"></div>
  </details>

  <div id="status"></div>
</div>

<script>
/* =================== Supabase è¨­å®š =================== */
    const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";

/* â˜…ã“ã“ã¯ anon public key ã‚’å…¥ã‚Œã¦ã­ï¼ˆæ—¥æœ¬èª/å…¨è§’/æ”¹è¡ŒãŒæ··ã–ã‚‹ã¨ fetch ãŒæ­»ã¬ï¼‰ */
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

/* â˜…é‡è¦ï¼šlogin.html ã¨åŒã˜ auth è¨­å®šã§ createClientï¼ˆãƒ­ãƒ“ãƒ¼ã§ã€Œåˆ‡ã‚Œã‚‹ã€ã‚’é˜²ãï¼‰ */
const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);

/* =================== çŠ¶æ…‹ =================== */
let authUser = null;
let roomsChannel = null;
let callParticipantsChannel = null;

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[lobby]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok=true){
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok?'ok':'ng'}">${escapeHtml(text)}</span>`;
}

/* =================== ç§»å‹• =================== */
function goLogin(){ location.replace("./login.html?_r=" + Date.now()); }
function goRoom(roomName){
  location.replace("./room.html?room=" + encodeURIComponent(roomName) + "&_r=" + Date.now());
}
function goProfile(){
  location.replace("./profile.html?back=lobby&_r=" + Date.now());
}

/* =================== å³ä¸Šãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º =================== */
function setTopRightButtons(isLoggedIn){
  const goBtn = document.getElementById("goLoginBtn");
  const soBtn = document.getElementById("signOutBtn");
  if (goBtn) goBtn.style.display = isLoggedIn ? "none" : "";
  if (soBtn) soBtn.style.display = isLoggedIn ? "" : "none";
}

function updateTopRightUser(){
  const pill = document.getElementById("userNamePill");
  const mail = document.getElementById("userMailText");
  if (!pill) return;

if (!authUser){
  pill.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
  if (mail) mail.textContent = "";

  // â˜…ã“ã“é‡è¦ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ®‹ã£ã¦ã‚‹ãªã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã¯å‡ºã™
  sb.auth.getSession().then(({data})=>{
    const hasSession = !!data?.session;
    setTopRightButtons(hasSession); // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚‹â†’ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡ºã™ / ãªã„â†’ãƒ­ã‚°ã‚¤ãƒ³å‡ºã™
  }).catch(()=>{
    setTopRightButtons(false);
  });

  return;
}


  const dn = (authUser.user_metadata?.display_name || "").trim();
  const em = (authUser.email || "").trim();
  const shown = dn || em || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";


  const avm = getPreferredAvatar();

  pill.innerHTML = `
  ${avatarHtml(avm.url || "", shown, avm.ver || "")}
  <span>${escapeHtml(shown)}</span>
`;


  if (mail) mail.textContent = em ? `(${em})` : "";
  setTopRightButtons(true);
}

/* =================== ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ =================== */
async function refreshAuth(){
  const { data: ses, error: sesErr } = await sb.auth.getSession();
  if (sesErr) log("getSession error", sesErr);

  const sessionUser = ses?.session?.user || null;
  if (!sessionUser){
    authUser = null;
    updateTopRightUser();
    return false;
  }

  // â˜…ä»–ç«¯æœ«æ›´æ–°ã‚’æ‹¾ã†ï¼šrefresh â†’ getUser
  try { await sb.auth.refreshSession(); } catch (e) { log("refreshSession warn", e); }

  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);

  authUser = u?.user || sessionUser;
  updateTopRightUser();

  return true;
}

async function requireLoginOrRedirect(){
  const ok = await refreshAuth();
  if (!ok){
    goLogin();
    return false;
  }
  return true;
}

/* =================== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =================== */
function clearSupabaseLocalStorage(){
  try{
    // Supabase v2 ã®ä¿å­˜ã‚­ãƒ¼ã‚’å…¨éƒ¨æ¶ˆã™ï¼ˆã“ã‚Œã§â€œç¢ºå®Ÿã«â€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰
    for (const k of Object.keys(localStorage)){
      if (k.startsWith("sb-") || k.includes("supabase")) localStorage.removeItem(k);
    }
    for (const k of Object.keys(sessionStorage)){
      if (k.startsWith("sb-") || k.includes("supabase")) sessionStorage.removeItem(k);
    }
  }catch(e){
    console.warn("clear storage warn", e);
  }
}

    async function signOut() {
        const btn = document.getElementById("signOutBtn");
        if (btn) btn.disabled = true;

        try {
            // å…ˆã« realtime ã‚’æ­¢ã‚ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‹ã®ã‚’é˜²ãï¼‰
            try { await sb.removeAllChannels?.(); } catch (e) { log("removeAllChannels warn", e); }

            // 1) ãƒ­ãƒ¼ã‚«ãƒ«å‰Šé™¤ï¼ˆæœ€é‡è¦ï¼‰
            clearSupabaseLocalStorage();

            // 2) ã‚µãƒ¼ãƒ signOutï¼ˆå¤±æ•—ã—ã¦ã‚‚OKï¼‰
            try { await sb.auth.signOut({ scope: "local" }); } catch (e) { log("signOut warn", e); }
        } finally {
            // â˜…ä½•ãŒèµ·ãã¦ã‚‚ã“ã“ã§å¿…ãšãƒ­ã‚°ã‚¤ãƒ³ã¸
            location.replace("./login.html?_r=" + Date.now());
        }
    }

/* =================== Realtime =================== */
async function startRealtime(){
  if (roomsChannel) return;

  roomsChannel = sb
    .channel("rooms-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, async () => {
      await loadRooms();
    })
    .subscribe();
}

async function startCallParticipantsRealtime(){
  if (callParticipantsChannel) return;

  callParticipantsChannel = sb
    .channel("call-participants-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async () => {
      await loadRooms();
    })
    .subscribe();
}

/* =================== é€šè©±ä¸­ã‹ã©ã†ã‹åˆ¤å®š =================== */
const CALL_ALIVE_SEC = 30;

async function isRoomInCall(roomName){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await sb
    .from("call_participants")
    .select("user_id")
    .eq("room_id", roomName)
    .gte("updated_at", cutoff)
    .limit(1);

  if (error){
    log("isRoomInCall error", error);
    return true; // åˆ¤å®šã§ããªã„æ™‚ã¯å®‰å…¨å´ï¼ˆå‰Šé™¤ã•ã›ãªã„ï¼‰
  }
  return (data || []).length > 0;
}

/* =================== ãƒ­ãƒ“ãƒ¼ã§ã€Œå„éƒ¨å±‹ã®é€šè©±ä¸­ãƒ¡ãƒ³ãƒãƒ¼ã€ã‚’ã¾ã¨ã‚ã¦å–å¾— =================== */
async function fetchActiveCallUsersByRoom(){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await sb
    .from("call_participants")
    .select("room_id, name, user_id, updated_at")
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  if (error){
    log("fetchActiveCallUsersByRoom error", error);
    return new Map();
  }

  const map = new Map(); // room_id -> [{name,user_id}]
  for (const row of (data || [])){
    const rid = row.room_id;
    if (!rid) continue;
    if (!map.has(rid)) map.set(rid, []);
    map.get(rid).push({
      name: (row.name || row.user_id || "").toString(),
      user_id: row.user_id
    });
  }

  // é‡è¤‡é™¤å»
  for (const [rid, arr] of map.entries()){
    const seen = new Set();
    const out = [];
    for (const a of arr){
      const k = a.user_id || a.name;
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(a);
    }
    map.set(rid, out);
  }

  return map;
}

/* =================== éƒ¨å±‹ä¸€è¦§èª­ã¿è¾¼ã¿ =================== */
async function loadRooms(){
  if (!authUser) return;

  const { data, error } = await sb
    .from("rooms")
    .select("room_name, created_at, owner_id")
    .order("created_at", { ascending:true });

  if (error){
    log("loadRooms error", error);
    setStatus("éƒ¨å±‹ä¸€è¦§å–å¾—å¤±æ•—: " + error.message, false);
    return;
  }

  const activeMap = await fetchActiveCallUsersByRoom();

  const box = document.getElementById("roomsBox");
  box.innerHTML = "";

  if (!data || data.length === 0){
    box.innerHTML = "<div style='color:var(--muted);font-size:12px;'>ã¾ã éƒ¨å±‹ãŒãªã„ã‚ˆï¼ˆéƒ¨å±‹ä½œæˆã—ã¦ã­ï¼‰</div>";
    setStatus("éƒ¨å±‹ãªã—", true);
    return;
  }

  for (const r of data){
    const rn = r.room_name;

    const row = document.createElement("div");
    row.className = "roomRow";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "roomBtn";
    btn.textContent = rn;
    btn.onclick = () => document.getElementById("room").value = rn;
    btn.ondblclick = () => goRoom(rn);

    const users = activeMap.get(rn) || [];
    if (users.length > 0){
      const names = users.map(x=>x.name).filter(Boolean);
      const line = document.createElement("div");
      line.className = "callLine";
      const shown = names.slice(0, 4).join("ã€");
      const more = names.length > 4 ? ` â€¦(+${names.length-4})` : "";
      line.innerHTML = `ğŸ“ é€šè©±ä¸­: ${escapeHtml(shown + more)} <span class="badge">${names.length}</span>`;
      btn.appendChild(line);
      btn.title = "é€šè©±ä¸­: " + names.join("ã€");
    }

    const del = document.createElement("button");
    del.type = "button";
    del.className = "delBtn";
    del.textContent = "ğŸ—‘";
    del.title = "é€šè©±ä¸­ã¯å‰Šé™¤ã§ãã¾ã›ã‚“";

    const inCall = await isRoomInCall(rn);
    if (inCall){
      del.disabled = true;
      del.style.opacity = "0.4";
      del.style.cursor = "not-allowed";
    }

    del.onclick = async () => {
      const nowInCall = await isRoomInCall(rn);
      if (nowInCall){
        alert("ã“ã®éƒ¨å±‹ã¯é€šè©±ä¸­ãªã®ã§å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
        await loadRooms();
        return;
      }

      if (!confirm(`éƒ¨å±‹ã€Œ${rn}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      const r2 = await sb.from("rooms").delete().eq("room_name", rn);
      if (r2.error){ alert("å‰Šé™¤å¤±æ•—: " + r2.error.message); return; }
      await loadRooms();
    };

    row.appendChild(btn);
    row.appendChild(del);
    box.appendChild(row);
  }

  setStatus(`éƒ¨å±‹ä¸€è¦§OKï¼ˆ${data.length}ä»¶ï¼‰`, true);
}

/* =================== éƒ¨å±‹ä½œæˆ / å…¥å®¤ =================== */
async function createRoom(){
  const rn = document.getElementById("room").value.trim();
  if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

  const { data: exists, error: e1 } = await sb
    .from("rooms").select("room_name").eq("room_name", rn).maybeSingle();
  if (e1) return alert("ç¢ºèªå¤±æ•—: " + e1.message);
  if (exists) return alert("ãã®éƒ¨å±‹ã¯ã‚‚ã†ã‚ã‚‹ã‚ˆï¼");

  const { error } = await sb
    .from("rooms")
    .insert({ room_name: rn, owner_id: authUser.id });

  if (error) return alert("ä½œæˆå¤±æ•—: " + error.message);

  await loadRooms();
}

async function enterRoom(){
  const rn = document.getElementById("room").value.trim();
  if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

  const { data: exists, error } = await sb
    .from("rooms").select("room_name").eq("room_name", rn).maybeSingle();

  if (error) return alert("ç¢ºèªå¤±æ•—: " + error.message);
  if (!exists) return alert("ãã®éƒ¨å±‹ã¯ã¾ã ãªã„ã‚ˆã€‚å…ˆã«éƒ¨å±‹ä½œæˆã—ã¦ã­ï¼");

  goRoom(rn);
}

    /* =================== è¡¨ç¤ºåä¿å­˜ =================== */
async function saveDisplayName() {
  if (!authUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");

  const input = document.getElementById("displayName");
  if (!input) return;

  const dn = input.value.trim();
  if (!dn) return alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ã­ï¼");

  const { error } = await sb.auth.updateUser({
    data: { display_name: dn }
  });

  if (error) {
    alert("ä¿å­˜å¤±æ•—: " + error.message);
    return;
  }

        // 2) â˜…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨åŒã˜æ€æƒ³ï¼šå¿…ãšæœ€æ–°ã‚’å–ã‚Šç›´ã™ï¼ˆä»–ç«¯æœ«æ›´æ–°/åæ˜ é…å»¶ã«å¼·ã„ï¼‰
        try { await sb.auth.refreshSession(); } catch (e) { log("refreshSession warn", e); }

        const { data: u, error: uErr } = await sb.auth.getUser();
        if (uErr) log("getUser error", uErr);

        authUser = u?.user || authUser;

        // 3) UIåæ˜ ï¼ˆå³ä¸Šï¼‹å…¥åŠ›æ¬„ï¼‰
        input.value = (authUser.user_metadata?.display_name || "").trim();
        updateTopRightUser();
        setStatus("è¡¨ç¤ºåã‚’ä¿å­˜ã—ã¾ã—ãŸï¼", true);
    }



/* =================== HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— / Avatar =================== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('`','&#096;'); }
function getInitial(s){
  const t = String(s||'').trim();
  if(!t) return '?';
  return Array.from(t)[0] || '?';
}
function normalizeAvatarUrl(url, ver){
  const u = String(url||'').trim();
  if (!u) return '';
  const v = String(ver||'').trim();
  if (!v) return u;
  return u + (u.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(v);
}
function avatarHtml(url, label, ver){
  const u = normalizeAvatarUrl(url, ver);
  if (u) return `<img class="avatarSm" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  return `<span class="avatarSmFb">${escapeHtml(getInitial(label))}</span>`;
}

function getPreferredAvatar(){
  const um = authUser?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const url = hasCustom ? String(um.custom_avatar_url || "").trim() : String(um.avatar_url || "").trim();
  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();
  return { url, ver };
}

/* =================== èµ·å‹• =================== */
(async () => {
  // URL/Hash ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã‚’æ‹¾ã†ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
  try {
    const url = new URL(location.href);
    const hasAuthParams =
      url.searchParams.has("code") ||
      url.searchParams.has("type") ||
      url.searchParams.has("access_token") ||
      url.searchParams.has("refresh_token") ||
      (location.hash && (location.hash.includes("access_token=") || location.hash.includes("refresh_token=")));

    if (hasAuthParams) {
      const { data, error } = await sb.auth.getSessionFromUrl({ storeSession: true });
      if (error) log("getSessionFromUrl error", error);
      if (data?.session?.user) log("OAuth session OK", data.session.user.email);
      history.replaceState({}, document.title, "./lobby.html");
    }
  } catch (e) {
    log("init session url exception", e);
  }

  if (!(await requireLoginOrRedirect())) return;

  await loadRooms();
  await startRealtime();
  await startCallParticipantsRealtime();

  sb.auth.onAuthStateChange(async () => {
    const ok = await refreshAuth();
    if (!ok) { goLogin(); return; }
    await loadRooms();
  });

  log("ready");
})();
</script>

</body>
</html>




