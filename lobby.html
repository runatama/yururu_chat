<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Lobby</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ================= UI: lobby(11) ================= -->
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 20px;
    }

    h2{ margin:0; }

    /* ===== Top ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }

    .userBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      font-size:12px;
      flex-wrap: wrap;
      justify-content:flex-end;
      max-width: 62vw;
    }
    .userPill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .userText{
      color:var(--muted);
      max-width:30vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .avatarSm{
      width:26px;height:26px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .avatarSmFb{
      width:26px;height:26px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      color:rgba(234,242,255,.92);
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.18));
      flex:0 0 auto;
      user-select:none;
    }
    .userBtn{
      cursor:pointer;
    }

    button{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:700;
    }
    button:hover{ filter:brightness(1.1); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.40);
    }

    /* ===== Cards ===== */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    .sectionTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    input{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      width: min(520px, 92vw);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }

    #roomsBox{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      max-width: 720px;
      background: rgba(0,0,0,.20);
    }
    .roomRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .roomRow:last-child{ border-bottom:none; }

    .muted{ color:var(--muted); font-size:12px; }

    #status{
      margin-top:10px;
      font-size:12px;
    }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }

    #log{
      margin-top:12px;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      max-height: 200px;
      overflow:auto;
      color: rgba(234,242,255,.78);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <h2>ğŸ  ãƒ­ãƒ“ãƒ¼</h2>
    <div class="userBox">
      <div class="userPill userBtn" id="userNamePill" onclick="goProfile()">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
      <button class="btnDanger" onclick="signOut()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div class="card">
    <div class="sectionTitle">ğŸ‘¤ è¡¨ç¤ºå</div>
    <div class="row">
      <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" />
      <button class="btnPrimary" onclick="saveDisplayName()">ä¿å­˜</button>
    </div>
    <div id="status"></div>
  </div>

  <div class="card">
    <div class="sectionTitle">ğŸ§© éƒ¨å±‹ä¸€è¦§</div>
    <div class="row" style="margin-bottom:10px;">
      <input id="newRoomName" placeholder="éƒ¨å±‹åï¼ˆä¾‹: testï¼‰" />
      <button class="btnPrimary" onclick="createRoom()">â• ä½œæˆ</button>
      <button onclick="loadRooms()">ğŸ”„ æ›´æ–°</button>
    </div>
    <div id="roomsBox">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>

  <details class="card">
    <summary class="muted">ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
    <div id="log"></div>
  </details>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

/* â˜…é‡è¦ï¼šlogin.html ã¨åŒã˜ auth è¨­å®šã§ createClientï¼ˆãƒ­ãƒ“ãƒ¼ã§ã€Œåˆ‡ã‚Œã‚‹ã€ã‚’é˜²ãï¼‰ */
const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);

/* =================== çŠ¶æ…‹ =================== */
let authUser = null;
let roomsChannel = null;
let callParticipantsChannel = null;

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[lobby]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok=true){
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok?'ok':'ng'}">${escapeHtml(text)}</span>`;
}

/* =================== å…±é€šï¼šæœ€æ–°userã‚’å–ã‚Šç›´ã™ï¼ˆåˆ¥ç«¯æœ«åæ˜ ã®ã‚³ã‚¢ï¼‰ =================== */
async function refetchLatestUser(fallbackUser){
  try{
    await sb.auth.refreshSession();
  }catch{}
  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);
  if (u?.user) return u.user;
  return fallbackUser || null;
}

/* =================== ç§»å‹• =================== */
function goLogin(){ location.replace("./login.html?_r=" + Date.now()); }
function goRoom(roomName){
  location.replace("./room.html?room=" + encodeURIComponent(roomName) + "&_r=" + Date.now());
}
function goProfile(){
  location.replace("./profile.html?back=lobby&_r=" + Date.now());
}

/* =================== å³ä¸Šãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º =================== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('`','&#096;'); }
function getInitial(s){ const t=String(s||'').trim(); if(!t) return '?'; return Array.from(t)[0] || '?'; }
function avatarHtml(url, label){
  const u = String(url||'').trim();
  if (u) return `<img class="avatarSm" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  return `<span class="avatarSmFb">${escapeHtml(getInitial(label))}</span>`;
}

function updateTopRightUser(){
  const pill = document.getElementById("userNamePill");
  if (!pill) return;

  if (!authUser){
    pill.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return;
  }

  const dn = (authUser.user_metadata?.display_name || "").trim();
  const em = (authUser.email || "").trim();
  const shown = dn || em || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";

  // â˜… ã‚¢ã‚¤ã‚³ãƒ³ã¯ã€Œåå‰ã®æ¨ªã«1å€‹ã ã‘ã€
  pill.innerHTML = `
    ${avatarHtml(authUser.user_metadata?.avatar_url || "", shown)}
    <span>${escapeHtml(shown)}</span>
  `;
}

/* =================== ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒï¼ˆSYSTEM = lobby(10)ï¼‰ =================== */
async function refreshAuth(){
  const { data: ses, error: sesErr } = await sb.auth.getSession();
  if (sesErr) log("getSession error", sesErr);

  const sessionUser = ses?.session?.user || null;
  if (!sessionUser){
    authUser = null;
    updateTopRightUser();
    return false;
  }

  // â˜…è¿½åŠ ï¼šã‚µãƒ¼ãƒãƒ¼å´ã®æœ€æ–°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ‹¾ã„ã‚„ã™ãã™ã‚‹
  try { await sb.auth.refreshSession(); } catch {}

  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);

  authUser = u?.user || sessionUser;
  updateTopRightUser();

  const dn = (authUser.user_metadata?.display_name || "").trim();
  const dnEl = document.getElementById("displayName");
  if (dnEl && !dnEl.value) dnEl.value = dn;

  return true;
}


  // â˜…ã“ã“ãŒé‡è¦ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°userã‚’å–ã‚Šç›´ã™
  // â˜…ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰æœ€æ–°userã‚’å–ã‚‹ï¼ˆåˆ¥ç«¯æœ«å¤‰æ›´ã‚’æ‹¾ã†ï¼‰
  try{ await sb.auth.refreshSession(); }catch{}

  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);

  authUser = u?.user || sessionUser;  // å–ã‚ŒãŸã‚‰æœ€æ–°ã€ãƒ€ãƒ¡ãªã‚‰sessionã®user
  updateTopRightUser();

  // è¡¨ç¤ºåå…¥åŠ›æ¬„ã¸åæ˜ ï¼ˆç©ºã®ã¨ãã ã‘ï¼‰
  const dn = (authUser.user_metadata?.display_name || "").trim();
  const dnEl = document.getElementById("displayName");
  if (dnEl && !dnEl.value) dnEl.value = dn;

  return true;
}

/* ãƒ­ãƒ“ãƒ¼ã§ã¯ã€Œæœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰loginã¸ã€ */
async function requireLoginOrRedirect(){
  const ok = await refreshAuth();
  if (!ok){
    goLogin();
    return false;
  }
  return true;
}

/* =================== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =================== */
async function signOut(){
  try { await sb.auth.signOut({ scope:"local" }); } catch {}
  goLogin();
}

/* =================== è¡¨ç¤ºåä¿å­˜ =================== */
async function saveDisplayName() {
  if (!authUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");

  const input = document.getElementById("displayName");
  if (!input) return;

  const dn = input.value.trim();
  if (!dn) return alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ã­ï¼");

  const { data, error } = await sb.auth.updateUser({
    data: { display_name: dn }
  });

  if (error) {
    alert("ä¿å­˜å¤±æ•—: " + error.message);
    return;
  }

  // â˜…åˆ¥ç«¯æœ«åæ˜ ã®ãŸã‚ï¼šæœ€æ–°userã‚’å–ã‚Šç›´ã™
  authUser = await refetchLatestUser(data?.user || authUser);
  updateTopRightUser();

  setStatus("è¡¨ç¤ºåã‚’ä¿å­˜ã—ã¾ã—ãŸï¼", true);
}

/* =================== rooms =================== */
async function loadRooms(){
  const box = document.getElementById("roomsBox");
  box.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

  const { data, error } = await sb
    .from("rooms")
    .select("room_name, created_at")
    .order("created_at", { ascending:false })
    .limit(50);

  if (error){
    box.textContent = "å–å¾—å¤±æ•—: " + error.message;
    return;
  }

  const rows = data || [];
  if (rows.length === 0){
    box.innerHTML = "<div class='muted'>éƒ¨å±‹ãŒãªã„ã‚ˆã€‚ä½œã£ã¦ã¿ã¦ï¼</div>";
    return;
  }

  box.innerHTML = "";
  rows.forEach(r=>{
    const div = document.createElement("div");
    div.className = "roomRow";
    div.innerHTML = `
      <div>
        <div style="font-weight:900;">${escapeHtml(r.room_name || "")}</div>
        <div class="muted">${escapeHtml(String(r.created_at || ""))}</div>
      </div>
      <div class="row">
        <button onclick="goRoom('${escapeAttr(r.room_name || "")}')">å…¥å®¤</button>
      </div>
    `;
    box.appendChild(div);
  });
}

async function createRoom(){
  const input = document.getElementById("newRoomName");
  const rn = (input.value || "").trim();
  if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

  const { error } = await sb.from("rooms").insert({ room_name: rn });
  if (error){
    alert("ä½œæˆå¤±æ•—: " + error.message);
    return;
  }

  input.value = "";
  await loadRooms();
  goRoom(rn);
}

/* =================== Realtime =================== */
async function startRealtime(){
  if (roomsChannel) return;
  roomsChannel = sb
    .channel("rooms-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, async ()=>{
      await loadRooms();
    })
    .subscribe();
}

/* call_participants ãŒã‚ã‚‹å‰æï¼ˆãƒ­ãƒ“ãƒ¼ã§ç›£è¦–ã ã‘ã—ã¦ã‚‹ï¼‰ */
async function startCallParticipantsRealtime(){
  if (callParticipantsChannel) return;
  callParticipantsChannel = sb
    .channel("call_participants-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async ()=>{
      // å¿…è¦ãªã‚‰ãƒ­ãƒ“ãƒ¼å´ã§è¡¨ç¤ºæ›´æ–°ã‚’è¿½åŠ 
    })
    .subscribe();
}

/* =================== èµ·å‹•ï¼ˆSYSTEM = lobby(10)ï¼‰ =================== */
(async () => {
  // â˜…ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒURLã«å«ã¾ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã‚‚æ‹¾ã†ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
  try {
    const url = new URL(location.href);
    const hasAuthParams =
      url.searchParams.has("code") ||
      url.searchParams.has("type") ||
      url.searchParams.has("access_token") ||
      url.searchParams.has("refresh_token") ||
      (location.hash && (location.hash.includes("access_token=") || location.hash.includes("refresh_token=")));

    if (hasAuthParams) {
      const { data, error } = await sb.auth.getSessionFromUrl({ storeSession: true });
      if (error) log("getSessionFromUrl error", error);
      if (data?.session?.user) log("OAuth session OK", data.session.user.email);
      history.replaceState({}, document.title, "./lobby.html");
    }
  } catch (e) {
    log("init session url exception", e);
  }

  if (!(await requireLoginOrRedirect())) return;

  document.getElementById("displayName").value =
    (authUser.user_metadata?.display_name || "").trim();

  await loadRooms();
  await startRealtime();
  await startCallParticipantsRealtime();

  sb.auth.onAuthStateChange(async () => {
    // çŠ¶æ…‹å¤‰åŒ–æ™‚ã¯ã€å¿…ãšã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒã—ã¦ã‹ã‚‰ç”»é¢ã‚’æ›´æ–°
    const ok = await refreshAuth();
    if (!ok) { goLogin(); return; }
    await loadRooms();
  });

  log("ready");
})();
</script>

</body>
</html>

