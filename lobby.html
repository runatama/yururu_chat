
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Lobby</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===================== Notify (same as profile) ===================== */
let frChannel = null;
let roomNotifyChannel = null;
let inviteNotifyChannel = null;
let pendingCount = 0;
const shownToastIds = new Set();

let notifyInbox = []; // max 10, localStorage
function inboxKey(){
  return authUser?.id ? ("notify_inbox_" + authUser.id) : "notify_inbox_anon";
}
function loadNotifyInbox(){
  try{
    const raw = localStorage.getItem(inboxKey());
    if (!raw) { notifyInbox = []; return; }
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) notifyInbox = arr.slice(0,10);
    else notifyInbox = [];
  }catch{ notifyInbox = []; }
}
function saveNotifyInbox(){
  try{
    localStorage.setItem(inboxKey(), JSON.stringify(notifyInbox.slice(0,10)));
  }catch{}
}

function setNotifyBadge(n){
  const el = document.getElementById("notifyBadge");
  if (!el) return;
  const num = Math.max(0, Number(n||0)|0);
  if (num <= 0){
    el.style.display = "none";
    el.textContent = "";
  }else{
    el.style.display = "inline-flex";
    el.textContent = String(Math.min(99, num));
  }
}

function unreadOtherCount(){
  return notifyInbox.filter(n => !n.read && n.type !== "friend_request").length;
}
function updateNotifyBadgeTotal(){
  setNotifyBadge(pendingCount + unreadOtherCount());
}

function addNotify(item){
  if (!item) return;
  // åŒã˜IDã¯äºŒé‡è¿½åŠ ã—ãªã„
  if (item.id && notifyInbox.some(x => x.id === item.id)) return;
  notifyInbox.unshift({
    id: item.id || ("local_" + Date.now() + "_" + Math.random()),
    type: item.type || "other",
    title: item.title || "é€šçŸ¥",
    msg: item.msg || "",
    from_uid: item.from_uid || null,
    from_name: item.from_name || null,
    room_id: item.room_id || null,
    room_name: item.room_name || null,
    created_at: item.created_at || new Date().toISOString(),
    read: !!item.read
  });
  // 10å€‹ã¾ã§ä¿æŒã€‚ãã‚Œä»¥ä¸Šã¯å¤ã„ã®ã‚’å‰Šé™¤
  if (notifyInbox.length > 10) notifyInbox = notifyInbox.slice(0,10);
  saveNotifyInbox();
  updateNotifyBadgeTotal();
}

function markAllRead(){
  notifyInbox = notifyInbox.map(n => ({...n, read:true}));
  saveNotifyInbox();
  updateNotifyBadgeTotal();
  renderNotifyPanel();
}
function markOneRead(id){
  notifyInbox = notifyInbox.map(n => n.id === id ? ({...n, read:true}) : n);
  saveNotifyInbox();
  updateNotifyBadgeTotal();
  renderNotifyPanel();
}

function showToast({title, msg, onOpen, onAllowNotify}){
  const wrap = document.getElementById("toastWrap");
  if (!wrap) return;

  const el = document.createElement("div");
  el.className = "toast";
  el.innerHTML = `
    <div class="toastHead">
      <div class="toastTitle">${escapeHtml(title||"é€šçŸ¥")}</div>
      <button class="toastClose" aria-label="close">Ã—</button>
    </div>
    <div class="toastBody">${escapeHtml(msg||"")}</div>
    <div class="toastBtns">
      ${onOpen ? `<button class="btn btnPrimary" data-open>é–‹ã</button>` : ``}
      ${onAllowNotify ? `<button class="btn btnGhost" data-allow>é€šçŸ¥ON</button>` : ``}
      <button class="btn btnGhost" data-close>é–‰ã˜ã‚‹</button>
    </div>
  `;

  const close = ()=>{ try{ el.remove(); }catch{} };

  el.querySelector(".toastClose").onclick = close;
  el.querySelector("[data-close]").onclick = close;

  const openBtn = el.querySelector("[data-open]");
  if (openBtn && onOpen){
    openBtn.onclick = ()=>{ try{ onOpen(); }finally{ close(); } };
  }

  const allowBtn = el.querySelector("[data-allow]");
  if (allowBtn && onAllowNotify){
    allowBtn.onclick = async()=>{
      try{ await onAllowNotify(); }catch{}
      close();
    };
  }

  wrap.prepend(el);

  // 12ç§’ã§è‡ªå‹•æ¶ˆã—
  setTimeout(close, 12000);
}

async function requestBrowserNotifyPermission(){
  try{
    if (!("Notification" in window)) return false;
    if (Notification.permission === "granted") return true;
    if (Notification.permission === "denied") return false;
    const res = await Notification.requestPermission();
    return res === "granted";
  }catch{ return false; }
}

function pushBrowserNotify(title, body){
  try{
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;
    new Notification(title, { body });
  }catch{}
}

/* ====== é€šçŸ¥ãƒ‘ãƒãƒ«ï¼ˆè¶…ç°¡æ˜“ï¼‰ ====== */
function toggleNotifyPanel(){
  const panel = document.getElementById("notifyPanel");
  if (!panel) return;
  const open = panel.style.display !== "block";
  panel.style.display = open ? "block" : "none";
  if (open) renderNotifyPanel();
}
function renderNotifyPanel(){
  const panel = document.getElementById("notifyPanel");
  const list = document.getElementById("notifyList");
  if (!panel || !list) return;

  // æ–°ã—ã„é †
  const arr = notifyInbox.slice().sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));

  if (arr.length === 0){
    list.innerHTML = `<div class="hint">é€šçŸ¥ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  list.innerHTML = arr.map(n=>{
    const unread = !n.read;
    const dot = unread ? "â—" : "";
    return `
      <div class="nItem" style="padding:10px 10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.04);margin-bottom:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;font-size:13px;">
            ${dot} ${escapeHtml(n.title||"é€šçŸ¥")}
          </div>
          <button class="btn" style="padding:6px 10px;border-radius:12px;" onclick="markOneRead('${String(n.id).replace(/'/g,"\'")}')">æ—¢èª­</button>
        </div>
        <div style="margin-top:6px;color:rgba(234,242,255,.82);font-size:13px;line-height:1.4;">
          ${escapeHtml(n.msg||"")}
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${n.from_uid ? `<button class="btn" style="padding:7px 10px;border-radius:12px;" onclick="location.href='./profile.html?uid=${encodeURIComponent(n.from_uid)}'">ç›¸æ‰‹</button>` : ``}
          ${(n.room_id && n.room_name) ? `<button class="btn btnPrimary" style="padding:7px 10px;border-radius:12px;" onclick="location.href='./room.html?room=${encodeURIComponent(n.room_name)}&room_id=${encodeURIComponent(n.room_id)}'">éƒ¨å±‹ã¸</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
}

/* ====== friend_requests: pendingæ•° åˆæœŸå–å¾—ï¼‹Realtime ====== */
async function refreshPendingCount(){
  if (!authUser?.id) return;
  try{
    const { count, error } = await sb
      .from("friend_requests")
      .select("id", { count: "exact", head: true })
      .eq("to_user", authUser.id)
      .eq("status", "pending");
    if (error) throw error;
    pendingCount = count || 0;
    updateNotifyBadgeTotal();
  }catch(e){
    console.error("refreshPendingCount error", e);
  }
}

async function startFriendRequestNotifications(){
  if (!authUser?.id) return;

  await refreshPendingCount();

  try{
    if (frChannel){
      await sb.removeChannel(frChannel);
      frChannel = null;
    }
  }catch(e){
    console.error("removeChannel error", e);
  }

  frChannel = sb.channel("fr_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "friend_requests",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      try{
        const r = payload?.new;
        if (!r) return;
        if (r.status !== "pending") return;

        pendingCount = pendingCount + 1;
        updateNotifyBadgeTotal();

        if (shownToastIds.has("fr_"+r.id)) return;
        shownToastIds.add("fr_"+r.id);

        let fromName = "èª°ã‹";
        try{
          const { data } = await sb.from("profiles")
            .select("display_name")
            .eq("user_id", r.from_user)
            .maybeSingle();
          if (data?.display_name) fromName = String(data.display_name);
        }catch{}

        // inboxä¿å­˜ï¼ˆè¦‹ã¦ã‚‚æ¶ˆãˆãªã„ï¼‰
        addNotify({
          id: "fr_" + r.id,
          type: "friend_request",
          title: "ğŸ¤ ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹",
          msg: `${fromName} ã•ã‚“ã‹ã‚‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`,
          from_uid: r.from_user,
          from_name: fromName,
          created_at: new Date().toISOString(),
          read: false
        });

        showToast({
          title: "ğŸ¤ ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒæ¥ãŸï¼",
          msg: `${fromName} ã•ã‚“ã‹ã‚‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`,
          onOpen: ()=>{
            location.href = `./profile.html?uid=${encodeURIComponent(r.from_user)}`;
          },
          onAllowNotify: async()=>{
            const ok = await requestBrowserNotifyPermission();
            if (typeof setStatus === "function"){
              setStatus(ok ? "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’ONã«ã—ã¾ã—ãŸ" : "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", ok);
            }
          }
        });

        pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${fromName} ã•ã‚“ã‹ã‚‰ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`);
      }catch(e){
        console.error("INSERT notify error", e);
      }
    })
    .on("postgres_changes", {
      event: "UPDATE",
      schema: "public",
      table: "friend_requests",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      try{
        const oldRow = payload?.old;
        const newRow = payload?.new;
        if (!oldRow || !newRow) return;

        const wasPending = oldRow.status === "pending";
        const isPending = newRow.status === "pending";

        if (wasPending && !isPending) pendingCount = Math.max(0, pendingCount - 1);
        if (!wasPending && isPending) pendingCount = pendingCount + 1;
        updateNotifyBadgeTotal();
      }catch(e){
        console.error("UPDATE notify error", e);
      }
    })
    .subscribe(()=>{});
}

/* ====== friends UIDä¸€è¦§ï¼ˆéƒ¨å±‹ä½œæˆé€šçŸ¥ç”¨ï¼‰ ====== */
let friendUidsCache = [];
async function loadFriendUids(){
  if (!authUser?.id) return [];
  try{
    // friends ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆuser_a, user_bï¼‰å‰æ
    const { data, error } = await sb
      .from("friends")
      .select("user_a,user_b")
      .or(`user_a.eq.${authUser.id},user_b.eq.${authUser.id}`);
    if (error) throw error;

    const uids = [];
    for (const row of (data||[])){
      if (row.user_a === authUser.id) uids.push(row.user_b);
      else uids.push(row.user_a);
    }
    friendUidsCache = Array.from(new Set(uids.filter(Boolean)));
  }catch(e){
    console.error("loadFriendUids error", e);
    friendUidsCache = [];
  }
  return friendUidsCache;
}

/* ====== rooms INSERTï¼ˆãƒ•ãƒ¬ãƒ³ãƒ‰ãŒéƒ¨å±‹ä½œæˆï¼‰ ====== */
async function startRoomCreateNotifications(){
  if (!authUser?.id) return;
  const friendUids = await loadFriendUids();
  if (friendUids.length === 0) return;

  if (roomNotifyChannel){
    try{ await sb.removeChannel(roomNotifyChannel); }catch{}
    roomNotifyChannel = null;
  }

  roomNotifyChannel = sb
    .channel("room_create_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "rooms"
    }, async(payload)=>{
      const r = payload?.new;
      if (!r) return;
      if (!friendUids.includes(r.owner_id)) return;

      let ownerName = "ãƒ•ãƒ¬ãƒ³ãƒ‰";
      try{
        const { data } = await sb
          .from("profiles")
          .select("display_name")
          .eq("user_id", r.owner_id)
          .maybeSingle();
        if (data?.display_name) ownerName = data.display_name;
      }catch{}

      addNotify({
        id: "room_" + r.id,
        type: "room_create",
        title: "ğŸ  éƒ¨å±‹ãŒä½œæˆã•ã‚ŒãŸ",
        msg: `${ownerName} ã•ã‚“ãŒã€Œ${r.room_name}ã€ã‚’ä½œã£ãŸã‚ˆ`,
        from_uid: r.owner_id,
        from_name: ownerName,
        room_id: r.id,
        room_name: r.room_name,
        created_at: new Date().toISOString(),
        read: false
      });

      showToast({
        title: "ğŸ  ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒéƒ¨å±‹ã‚’ä½œæˆï¼",
        msg: `${ownerName} ã•ã‚“ãŒã€Œ${r.room_name}ã€ã‚’ä½œã£ãŸã‚ˆ`,
        onOpen: ()=>{
          location.href = `./room.html?room=${encodeURIComponent(r.room_name)}&room_id=${encodeURIComponent(r.id)}`;
        }
      });

      pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${ownerName} ã•ã‚“ãŒéƒ¨å±‹ã€Œ${r.room_name}ã€ã‚’ä½œæˆ`);
    })
    .subscribe();
}

/* ====== room_invitesï¼ˆæ‹›å¾…ï¼‰ ====== */
async function startRoomInviteNotifications(){
  if (!authUser?.id) return;

  if (inviteNotifyChannel){
    try{ await sb.removeChannel(inviteNotifyChannel); }catch{}
    inviteNotifyChannel = null;
  }

  inviteNotifyChannel = sb
    .channel("room_invite_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "room_invites",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      const inv = payload?.new;
      if (!inv) return;

      if (shownToastIds.has("inv_"+inv.id)) return;
      shownToastIds.add("inv_"+inv.id);

      let fromName = "ãƒ•ãƒ¬ãƒ³ãƒ‰";
      try{
        const { data } = await sb
          .from("profiles")
          .select("display_name")
          .eq("user_id", inv.from_user)
          .maybeSingle();
        if (data?.display_name) fromName = data.display_name;
      }catch{}

      addNotify({
        id: "inv_" + inv.id,
        type: "room_invite",
        title: "ğŸ“© éƒ¨å±‹æ‹›å¾…",
        msg: `${fromName} ã•ã‚“ã‹ã‚‰ã€Œ${inv.room_name}ã€ã«æ‹›å¾…ãŒæ¥ãŸã‚ˆ`,
        from_uid: inv.from_user,
        from_name: fromName,
        room_id: inv.room_id,
        room_name: inv.room_name,
        created_at: new Date().toISOString(),
        read: false
      });

      showToast({
        title: "ğŸ“© éƒ¨å±‹æ‹›å¾…ãŒæ¥ãŸï¼",
        msg: `${fromName} ã•ã‚“ã‹ã‚‰ã€Œ${inv.room_name}ã€ã«æ‹›å¾…ãŒæ¥ãŸã‚ˆ`,
        onOpen: ()=>{
          location.href = `./room.html?room=${encodeURIComponent(inv.room_name)}&room_id=${encodeURIComponent(inv.room_id)}`;
        }
      });

      pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${fromName} ã•ã‚“ã‹ã‚‰éƒ¨å±‹æ‹›å¾…ã€Œ${inv.room_name}ã€`);
    })
    .subscribe();
}

/* ====== åˆæœŸåŒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ ====== */
function initNotify(){
  loadNotifyInbox();
  updateNotifyBadgeTotal();
  startFriendRequestNotifications();
  startRoomCreateNotifications();
  startRoomInviteNotifications();
}

</script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 20px;
    }

    h2{ margin:0; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }

    .userBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      font-size:12px;
      flex-wrap: wrap;
      justify-content:flex-end;
      max-width: 62vw;
    }
    .userPill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .userText{
      color:var(--muted);
      max-width:30vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .avatarSm{
      width:26px;height:26px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .avatarSmFb{
      width:26px;height:26px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      color:rgba(234,242,255,.92);
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.18));
      flex:0 0 auto;
      user-select:none;
    }

    button{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:700;
    }
    button:hover{ filter:brightness(1.1); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    .sectionTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
    }

    input, textarea{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
      outline:none;
    }
    textarea{ min-height: 88px; resize: vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* ===== Rooms ===== */
    #roomsBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }

    .roomRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .roomBtn{
      flex:1;
      text-align:left;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }

    .roomBtn:hover{
      background:linear-gradient(180deg, rgba(110,231,255,.15), rgba(255,255,255,.05));
    }

    .callLine{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badge{
      margin-left:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
    }

    
    .badge.admin{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.20));
      color: var(--text);
      font-weight: 900;
    }
/* ===== Tabs ===== */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tabBtn{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .tabBtn.active{
      background:linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.20));
      border-color: rgba(255,255,255,.22);
    }

    /* ===== Feed ===== */
    #feedBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .postCard{
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .postHead{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .profileLink{cursor:pointer;}
.profileLink:hover{text-decoration:underline;opacity:.95;}

.postName{
      font-weight:900;
      font-size:13px;
      line-height:1.2;
    }
    .postTime{
      color:var(--muted);
      font-size:11px;
      margin-top:2px;
    }
    .postBody{
      white-space:pre-wrap;
      line-height:1.5;
      font-size:13px;
      margin: 8px 0 10px;
    }
    .postActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .miniBtn{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      background:rgba(255,255,255,.06);
    }
    .miniBtn.liked{
      background:rgba(110,231,255,.18);
      border-color:rgba(110,231,255,.35);
    }
    .commentArea{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.16);
      display:none;
    }
    .commentArea.open{ display:block; }

    .commentRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .commentRow:last-child{ border-bottom:none; }
    .commentBody{
      flex:1;
      min-width: 0;
    }
    .commentMeta{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .commentName{ font-weight:900; font-size:12px; }
    .commentTime{ color:var(--muted); font-size:11px; }
    .commentText{ white-space:pre-wrap; font-size:12px; margin-top:4px; line-height:1.45; }

    #status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }

    details{ margin-top:12px; }
    #log{
      margin-top:8px;
      font-size:12px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }

    .row > button{ white-space:nowrap; }
    .hide{ display:none !important; }

    .replyIndent{ margin-left: 34px; padding-left: 10px; border-left: 2px solid rgba(255,255,255,.10); }
.commentActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.commentActions .miniBtn{ padding:6px 10px; font-size:11px; }

/* ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸»è¦ãƒœã‚¿ãƒ³ã¯æš—ãã—ãªã„ï¼ˆminiBtnã«è² ã‘ãªã„ï¼‰ */
.commentActions .btnPrimary{
  background: linear-gradient(135deg, var(--accent), var(--accent2)) !important;
  color:#08131f !important;
  border:none !important;
}


  
.toastWrap{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      width:min(380px, calc(100vw - 28px));
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(15,26,44,.92);
      box-shadow:var(--shadow);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation:toastIn .18s ease-out;
    }
    @keyframes toastIn{
      from{ transform:translateY(8px); opacity:0; }
      to{ transform:translateY(0); opacity:1; }
    }
    .toastTitle{ font-weight:900; margin-bottom:4px; }
    .toastMsg{ font-size:12px; color:var(--muted); line-height:1.5; }
    .toastBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    

</style>

<script>
window.toggleNotifyPanel = window.toggleNotifyPanel || function(){
  const panel = document.getElementById("notifyPanel");
  if (!panel) return;
  const open = panel.style.display !== "block";
  panel.style.display = open ? "block" : "none";
};
</script>

</head>

<body>

<div class="topbar">
  <h2>ğŸ§ ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ â€“ ãƒ­ãƒ“ãƒ¼</h2>
  <div class="userBox">
    <button class="userPill" id="userNamePill" type="button" onclick="goProfile()">æœªãƒ­ã‚°ã‚¤ãƒ³</button>
    <span class="userText" id="userMailText"></span>
    <button class="notifyBtn" id="notifyBtn" onclick="toggleNotifyPanel()">ğŸ””<span class="badge" id="notifyBadge"></span></button>
      <button class="btnDanger" onclick="signOut()" id="signOutBtn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>
    <div id="notifyPanel" class="card" style="display:none; position:absolute; right:14px; top:64px; width:min(520px, calc(100vw - 28px)); z-index:9998;">
      <div class="cardHeader" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <b>ğŸ”” é€šçŸ¥</b>
        <div style="display:flex; gap:8px;">
          <button class="btn" onclick="markAllRead()">å…¨éƒ¨æ—¢èª­</button>
          <button class="btn" onclick="toggleNotifyPanel()">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div class="cardBody" style="padding:12px 12px;">
        <div id="notifyList"></div>
      </div>
    </div>


<div class="card">
  <div class="sectionTitle">
    <span id="modeTitle">ğŸ  ãƒ«ãƒ¼ãƒ </span>
    <div class="tabs">
      <button class="tabBtn" id="tabRooms" type="button" onclick="setViewMode('rooms')">ãƒ«ãƒ¼ãƒ </button>
      <button class="tabBtn" id="tabFeed" type="button" onclick="setViewMode('feed')">ã¤ã¶ã‚„ã</button>
    </div>
  </div>

  <!-- ===== Rooms Panel ===== -->
  <div id="roomsPanel">
    <div class="row">
      <input id="room" placeholder="éƒ¨å±‹åï¼ˆä¾‹: testï¼‰" />
      <button class="btnPrimary" id="createCardBtn" type="button" onclick="log('create clicked (card)'); createRoom();">ä½œæˆ</button>
      <button type="button" onclick="enterRoom()">å…¥å®¤</button>
      <button type="button" onclick="loadRooms()">æ›´æ–°</button>
    </div>

    <div class="sectionTitle" style="margin-top:14px; justify-content:flex-start;">ğŸ“‹ éƒ¨å±‹ä¸€è¦§</div>
    <div id="roomsBox"></div>
  </div>

  <!-- ===== Feed Panel ===== -->
  <div id="feedPanel" class="hide">

    <div class="row" style="justify-content:flex-start;">
      <button class="miniBtn" type="button" onclick="togglePostBox()">ï¼‹ ã¤ã¶ã‚„ã</button>
      <button type="button" onclick="loadFeed()">æ›´æ–°</button>
    </div>

    <div id="postBox" class="hide" style="margin-top:10px;">
      <div class="row">
        <textarea id="postText" placeholder="ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿï¼ˆã¤ã¶ã‚„ãï¼‰"></textarea>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btnPrimary" type="button" onclick="createPost()">æŠ•ç¨¿</button>
        <button class="miniBtn" type="button" onclick="togglePostBox(true)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <div class="sectionTitle" style="margin-top:14px; justify-content:flex-start;">ğŸ—¯ï¸ ã¿ã‚“ãªã®ã¤ã¶ã‚„ã</div>
    <div id="feedBox"></div>
  </div>

  <details open>
    <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
    <div id="log"></div>
  </details>

  <div id="status"></div>
</div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);

/* =================== çŠ¶æ…‹ =================== */
let authUser = null;
  try{ initNotify(); }catch(e){ console.warn("initNotify fail", e); }
let roomsChannel = null;
let callParticipantsChannel = null;
let postsChannel = null;
let likesChannel = null;
let commentsChannel = null;

let viewMode = "rooms"; // rooms | feed

// loadFeed ã®å¤šé‡å®Ÿè¡Œã‚¬ãƒ¼ãƒ‰ï¼ˆä¸¦åˆ—ã§èµ°ã‚‹ã¨åŒã˜æŠ•ç¨¿ãŒ2å›æç”»ã•ã‚Œã‚‹ï¼‰
let loadFeedInFlight = null;

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[lobby]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok=true){
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok?'ok':'ng'}">${escapeHtml(text)}</span>`;
}
// ===== é‹å–¶åˆ¤å®šï¼ˆIDãƒ™ãƒ¼ã‚¹ãƒ»å®‰å…¨ï¼‰=====
function isAdmin(user){
  return user?.app_metadata?.is_admin === true || isAdminUserId(user?.id);
}


// ===== é‹å–¶ï¼ˆAdminï¼‰åˆ¤å®šï¼šåå‰ã§ã¯ãªã user_id ã§åˆ¤å®šã™ã‚‹ï¼ˆãªã‚Šã™ã¾ã—é˜²æ­¢ï¼‰=====
// ã“ã“ã«ã€Œé‹å–¶ã«ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã€ã‚’å…¥ã‚Œã¦ã­ï¼ˆSupabase Auth ã® user.idï¼‰
// ä¾‹: const ADMIN_UIDS = ["aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"];
const ADMIN_UIDS = [
  "054b7993-499d-45a7-ae15-c9f0e37bd2b9",
  "5f96d1c0-088e-4125-8670-e0fef1b563a6",
];

function isAdminUserId(userId){
  const uid = String(userId || "").trim();
  if (!uid) return false;
  return ADMIN_UIDS.includes(uid);
}

function adminBadgeHtmlByUserId(userId){
  return isAdminUserId(userId) ? '<span class="badge admin">é‹å–¶</span>' : '';
}
/* =================== ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ã await =================== */
function withTimeout(promise, label, ms=20000){
  let t;
  const timeout = new Promise((_, rej)=>{
    t = setTimeout(()=>rej(new Error(`TIMEOUT: ${label} (${ms}ms)`)), ms);
  });
  return Promise.race([promise, timeout]).finally(()=>clearTimeout(t));
}

/* =================== ç§»å‹• =================== */
function goLogin(){ location.replace("./login.html?_r=" + Date.now()); }
function goRoom(roomObj){
  const rn = (roomObj?.room_name || "").trim();
  const rid = roomObj?.id || "";
  if (!rn) return;
  const q = new URLSearchParams();
  q.set("room", rn);
  if (rid) q.set("room_id", rid);
  q.set("_r", Date.now());
  location.replace("./room.html?" + q.toString());
}
function goProfile(){
  location.replace("./profile.html?back=lobby&_r=" + Date.now());
}

function goUserProfile(uid){
  const id = String(uid || "").trim();
  if (!id) return;
  const p = new URLSearchParams();
  p.set("uid", id);
  p.set("back", "lobby");
  p.set("_r", Date.now());
  location.href = "./profile.html?" + p.toString();
}


/* ===================
   ğŸŸ¢ Online Heartbeatï¼ˆLobbyç”¨ï¼‰
   profiles.last_seen ã‚’å®šæœŸæ›´æ–°ã—ã¦ã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³/æœ€è¿‘ã€ã‚’åˆ¤å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
   =================== */
let onlineHeartbeatTimer = null;

async function heartbeatLastSeenLobby(){
  try{
    if (!authUser?.id) return;
    await sb.from("profiles").upsert({
      user_id: authUser.id,
      last_seen: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }, { onConflict: "user_id" });
  }catch(e){
    console.warn("heartbeatLastSeenLobby error", e);
  }
}

function startOnlineHeartbeatLobby(){
  // äºŒé‡èµ·å‹•é˜²æ­¢
  if (onlineHeartbeatTimer) return;

  // åˆå›å³æ›´æ–°
  heartbeatLastSeenLobby();

  // 60ç§’ã”ã¨æ›´æ–°
  onlineHeartbeatTimer = setInterval(heartbeatLastSeenLobby, 60_000);

  // ã‚¿ãƒ–å¾©å¸°æ™‚ã«å³æ›´æ–°
  document.addEventListener("visibilitychange", ()=>{
    if (!document.hidden) heartbeatLastSeenLobby();
  });
}


/* =================== å³ä¸Šãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º =================== */
function setTopRightButtons(isLoggedIn){
  const soBtn = document.getElementById("signOutBtn");
  if (soBtn) soBtn.style.display = isLoggedIn ? "" : "none";
}

function updateTopRightUser(){
  const pill = document.getElementById("userNamePill");
  const mail = document.getElementById("userMailText");
  if (!pill) return;

  if (!authUser){
    pill.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    if (mail) mail.textContent = "";
    sb.auth.getSession().then(({data})=>{
      const hasSession = !!data?.session;
      setTopRightButtons(hasSession);
    }).catch(()=>{
      setTopRightButtons(false);
    });
    return;
  }

  const dn = (authUser.user_metadata?.display_name || "").trim();
  const em = (authUser.email || "").trim();
  const shown = dn || em || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";

  const avm = getPreferredAvatar();
  pill.innerHTML = `
    ${avatarHtml(avm.url || "", shown, avm.ver || "")}
    <span>${escapeHtml(shown)}</span>${adminBadgeHtmlByUserId(authUser.id)}
  `;
  if (mail) mail.textContent = em ? `(${em})` : "";
  setTopRightButtons(true);
}

/* =================== ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒï¼ˆsingle-flight + timeoutï¼‰ =================== */
let refreshAuthInFlight = null;

async function refreshAuth(){
  if (refreshAuthInFlight) return refreshAuthInFlight;

  refreshAuthInFlight = (async ()=>{
    log("refreshAuth: start");

    log("refreshAuth: before getSession");
    const { data: ses, error: sesErr } = await withTimeout(sb.auth.getSession(), "sb.auth.getSession", 20000);
    log("refreshAuth: after getSession");
    if (sesErr) log("getSession error", sesErr);

    const session = ses?.session || null;
    const sessionUser = session?.user || null;

    if (!sessionUser){
      authUser = null;
      updateTopRightUser();
      log("refreshAuth: no sessionUser -> false");
      return false;
    }

    try{
      log("refreshAuth: before getUser");
      const { data: u, error: uErr } = await withTimeout(sb.auth.getUser(), "sb.auth.getUser", 20000);
      log("refreshAuth: after getUser");

      if (uErr){
        log("getUser error", uErr);
        authUser = null;
        updateTopRightUser();
        return false;
      }

      authUser = u?.user || sessionUser;
      updateTopRightUser();
      log("refreshAuth: ok user=", authUser?.id || "???");
      return true;

    }catch(e){
      log("getUser exception", String(e?.message || e));
      authUser = sessionUser;
      updateTopRightUser();
      log("refreshAuth: ok (sessionUser fallback) user=", authUser?.id || "???");
      return true;
    }
  })().finally(()=>{
    refreshAuthInFlight = null;
  });

  return refreshAuthInFlight;
}

async function requireLoginOrRedirect(){
  for (let i = 0; i < 3; i++){
    try{
      const ok = await refreshAuth();
      if (ok) return true;
    }catch(e){
      log("requireLoginOrRedirect refreshAuth err", String(e?.message || e));
    }
    await new Promise(r => setTimeout(r, 300));
  }
  clearSupabaseLocalStorage();
  goLogin();
  return false;
}

/* =================== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =================== */
function clearSupabaseLocalStorage(){
  try{
    for (const k of Object.keys(localStorage)){
      if (k.startsWith("sb-") || k.includes("supabase")) localStorage.removeItem(k);
    }
    for (const k of Object.keys(sessionStorage)){
      if (k.startsWith("sb-") || k.includes("supabase")) sessionStorage.removeItem(k);
    }
  }catch(e){
    console.warn("clear storage warn", e);
  }
}

async function signOut() {
  const btn = document.getElementById("signOutBtn");
  if (btn) btn.disabled = true;

  try {
    try { await sb.removeAllChannels?.(); } catch (e) { log("removeAllChannels warn", e); }
    clearSupabaseLocalStorage();
    try { await sb.auth.signOut({ scope: "local" }); } catch (e) { log("signOut warn", e); }
  } finally {
    location.replace("./login.html?_r=" + Date.now());
  }
}

/* =================== è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ«ãƒ¼ãƒ /ã¤ã¶ã‚„ãï¼‰ =================== */
function setViewMode(mode){
  const m = (mode === "feed") ? "feed" : "rooms";
  viewMode = m;
  try{ localStorage.setItem("lobby_view_mode", viewMode); }catch(e){}

  const roomsPanel = document.getElementById("roomsPanel");
  const feedPanel = document.getElementById("feedPanel");
  const tabRooms = document.getElementById("tabRooms");
  const tabFeed  = document.getElementById("tabFeed");
  const title = document.getElementById("modeTitle");

  if (m === "rooms"){
    roomsPanel.classList.remove("hide");
    feedPanel.classList.add("hide");
    tabRooms.classList.add("active");
    tabFeed.classList.remove("active");
    title.textContent = "ğŸ  ãƒ«ãƒ¼ãƒ ";
    loadRooms().catch(()=>{});
  }else{
    feedPanel.classList.remove("hide");
    roomsPanel.classList.add("hide");
    tabFeed.classList.add("active");
    tabRooms.classList.remove("active");
    title.textContent = "ğŸ—¯ï¸ ã¤ã¶ã‚„ã";
    loadFeed().catch(()=>{});
  }
}



/* =================== ã¤ã¶ã‚„ãå…¥åŠ›æ¬„ã®é–‹é–‰ =================== */
function togglePostBox(forceClose=false){
  const box = document.getElementById("postBox");
  if (!box) return;
  if (forceClose) { box.classList.add("hide"); return; }
  box.classList.toggle("hide");
}

/* =================== Realtime =================== */
async function startRealtime(){
  if (roomsChannel) return;

  roomsChannel = sb
    .channel("rooms-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, async () => {
      if (viewMode === "rooms") await loadRooms();
    })
    .subscribe();
}

async function startCallParticipantsRealtime(){
  if (callParticipantsChannel) return;

  callParticipantsChannel = sb
    .channel("call-participants-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async () => {
      if (viewMode === "rooms") await loadRooms();
    })
    .subscribe();
}

let feedReloadTimer = null;
function scheduleFeedReload(ms=600){
  if (feedReloadTimer) clearTimeout(feedReloadTimer);
  feedReloadTimer = setTimeout(()=>loadFeed().catch(()=>{}), ms);
}

async function startFeedRealtime(){
  if (postsChannel) return;

  postsChannel = sb
    .channel("posts-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"posts" }, () => {
      if (viewMode === "feed") scheduleFeedReload(400);
    })
    .subscribe();

  likesChannel = sb
    .channel("likes-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"post_likes" }, () => {
      if (viewMode === "feed") scheduleFeedReload(400);
    })
    .subscribe();

  commentsChannel = sb
    .channel("comments-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"post_comments" }, () => {
      if (viewMode === "feed") scheduleFeedReload(600);
    })
    .subscribe();
}

/* =================== é€šè©±ä¸­ã‹ã©ã†ã‹åˆ¤å®š =================== */
const CALL_ALIVE_SEC = 30;

async function fetchActiveCallUsersByRoom(){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await withTimeout(
    sb.from("call_participants")
      .select("room_id, name, user_id, updated_at")
      .gte("updated_at", cutoff)
      .order("updated_at", { ascending:false }),
    "call_participants list",
    8000
  );

  if (error){
    log("fetchActiveCallUsersByRoom error", error);
    return new Map();
  }

  const map = new Map();
  for (const row of (data || [])){
    const rid = row.room_id;
    if (!rid) continue;
    if (!map.has(rid)) map.set(rid, []);
    map.get(rid).push({
      name: (row.name || row.user_id || "").toString(),
      user_id: row.user_id
    });
  }

  for (const [rid, arr] of map.entries()){
    const seen = new Set();
    const out = [];
    for (const a of arr){
      const k = a.user_id || a.name;
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(a);
    }
    map.set(rid, out);
  }

  return map;
}

/* =================== éƒ¨å±‹ä¸€è¦§èª­ã¿è¾¼ã¿ =================== */
async function loadRooms(){
  const ok = await refreshAuth();
  if (!ok || !authUser){
    setStatus("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼", false);
    return;
  }

  const { data, error } = await withTimeout(
    sb.from("rooms")
      .select("id, room_name, created_at, owner_id")
      .order("created_at", { ascending:true }),
    "rooms select",
    8000
  );

  if (error){
    log("loadRooms error", error);
    setStatus("éƒ¨å±‹ä¸€è¦§å–å¾—å¤±æ•—: " + error.message, false);
    return;
  }

  const activeMap = await fetchActiveCallUsersByRoom();

  const box = document.getElementById("roomsBox");
  box.innerHTML = "";

  if (!data || data.length === 0){
    box.innerHTML = "<div style='color:var(--muted);font-size:12px;'>ã¾ã éƒ¨å±‹ãŒãªã„ã‚ˆï¼ˆéƒ¨å±‹ä½œæˆã—ã¦ã­ï¼‰</div>";
    setStatus("éƒ¨å±‹ãªã—", true);
    return;
  }

  for (const r of data){
    const rn = r.room_name;

    const row = document.createElement("div");
    row.className = "roomRow";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "roomBtn";
    btn.textContent = rn;
    btn.onclick = () => document.getElementById("room").value = rn;
    btn.ondblclick = () => goRoom(r);

    const users = activeMap.get(rn) || [];
    if (users.length > 0){
      const names = users.map(x=>x.name).filter(Boolean);
      const line = document.createElement("div");
      line.className = "callLine";
      const shown = names.slice(0, 4).join("ã€");
      const more = names.length > 4 ? ` â€¦(+${names.length-4})` : "";
      line.innerHTML = `ğŸ“ é€šè©±ä¸­: ${escapeHtml(shown + more)} <span class="badge">${names.length}</span>`;
      btn.appendChild(line);
      btn.title = "é€šè©±ä¸­: " + names.join("ã€");
    }
    row.appendChild(btn);
    box.appendChild(row);
  }

  setStatus(`éƒ¨å±‹ä¸€è¦§OKï¼ˆ${data.length}ä»¶ï¼‰`, true);
}

/* =================== éƒ¨å±‹ä½œæˆ / å…¥å®¤ =================== */
async function createRoom(){
  log("=== createRoom start ===");

  try{
    log("createRoom: refreshAuth...");
    const ok = await refreshAuth();
    log("createRoom: refreshAuth done ->", ok, "uid=", authUser?.id || null);

    if (!ok || !authUser){
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
      goLogin();
      return;
    }

    const rn = document.getElementById("room").value.trim();
    log("createRoom: rn=", rn);

    if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

    const q1 = await withTimeout(
      sb.from("rooms").select("id").eq("room_name", rn).maybeSingle(),
      "rooms exists",
      8000
    );
    log("createRoom: exists raw=", q1);

    if (q1.error){
      alert("å­˜åœ¨ãƒã‚§ãƒƒã‚¯å¤±æ•—(è©³ç´°):\n" + JSON.stringify(q1.error, null, 2));
      return;
    }

    if (q1.data){
      alert("ãã®éƒ¨å±‹ã¯ã‚‚ã†ã‚ã‚‹ã‚ˆï¼");
      const { data: r2, error: e2 } = await withTimeout(
        sb.from("rooms").select("id, room_name, created_at").eq("room_name", rn).order("created_at", { ascending:false }).limit(1).maybeSingle(),
        "rooms select latest",
        8000
      );
      if (!e2 && r2) goRoom(r2);
      return;
    }

    const q2 = await withTimeout(
      sb.from("rooms").insert({ room_name: rn, owner_id: authUser.id }).select("id, room_name, created_at, owner_id").maybeSingle(),
      "rooms insert",
      8000
    );
    log("createRoom: insert raw=", q2);

    if (q2.error){
      alert("ä½œæˆå¤±æ•—(è©³ç´°):\n" + JSON.stringify(q2.error, null, 2));
      return;
    }

    alert("éƒ¨å±‹ä½œæˆOKï¼");
    await loadRooms();
    log("=== createRoom ok ===");
    goRoom(q2.data);

  }catch(e){
    log("createRoom exception:", String(e?.message || e));
    alert("ä½œæˆã§ä¾‹å¤–:\n" + (e?.stack || e?.message || e));
  }finally{
    log("=== createRoom end ===");
  }
}

async function enterRoom(){
  const rn = document.getElementById("room").value.trim();
  if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

  const ok = await refreshAuth();
  if (!ok || !authUser){
    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
    goLogin();
    return;
  }

  const { data: r, error } = await withTimeout(
    sb.from("rooms")
      .select("id, room_name, created_at, owner_id")
      .eq("room_name", rn)
      .order("created_at", { ascending:false })
      .limit(1)
      .maybeSingle(),
    "rooms enter select",
    8000
  );

  if (error){
    alert("å…¥å®¤ãƒã‚§ãƒƒã‚¯å¤±æ•—: " + error.message);
    log("enterRoom error", error);
    return;
  }

  if (!r){
    alert("ãã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆï¼å…ˆã«ä½œæˆã—ã¦ã­ï¼");
    return;
  }

  goRoom(r);
}

/* =================== ã¤ã¶ã‚„ã =================== */
function formatTime(iso){
  try{
    const d = new Date(iso);
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch(e){
    return "";
  }
}

async function createPost(){
  const ok = await refreshAuth();
  if (!ok || !authUser){
    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
    goLogin();
    return;
  }

  const ta = document.getElementById("postText");
  const text = (ta?.value || "").trim();
  if (!text) return alert("ã¤ã¶ã‚„ãã‚’å…¥åŠ›ã—ã¦ã­ï¼");
  if (text.length > 400) return alert("ã¤ã¶ã‚„ããŒé•·ã™ãã‚‹ã‚ˆï¼ˆ400æ–‡å­—ã¾ã§ï¼‰");

  const dn = (authUser.user_metadata?.display_name || authUser.email || "åç„¡ã—").toString();
  const avm = getPreferredAvatar();

  const { error } = await withTimeout(
    sb.from("posts").insert({
      user_id: authUser.id,
      display_name: dn,
      avatar_url: avm.url || "",
      avatar_ver: avm.ver || "",
      content: text
    }),
    "posts insert",
    8000
  );

  if (error){
    log("createPost error", error);
    alert("æŠ•ç¨¿å¤±æ•—: " + error.message);
    return;
  }

  ta.value = "";
  togglePostBox(true);
  await loadFeed();
  setStatus("ã¤ã¶ã‚„ã„ãŸï¼", true);
}

async function loadFeed(){
  // 2å›åŒæ™‚ã«èµ°ã‚‹ã¨ã€ä¸¡æ–¹ãŒæç”»ã—ã¦ã€ŒåŒã˜æŠ•ç¨¿ãŒ2å›è¡¨ç¤ºã€ã«ãªã‚‹ã®ã§ã‚¬ãƒ¼ãƒ‰ã™ã‚‹
  if (loadFeedInFlight) return loadFeedInFlight;

  loadFeedInFlight = (async ()=>{

    const ok = await refreshAuth();
    if (!ok || !authUser) return;

    // è¡¨ç¤ºé ˜åŸŸ
    const box = document.getElementById("feedBox");
    if (!box) return;
    box.innerHTML = "";

    // æŠ•ç¨¿ã‚’å–å¾—ï¼ˆæœ€æ–°50ä»¶ï¼‰
    const { data: posts, error: perr } = await withTimeout(
      sb.from("posts")
        .select("id, user_id, display_name, avatar_url, avatar_ver, content, created_at")
        .order("created_at", { ascending:false })
        .limit(50),
      "posts select",
      8000
    );

    if (perr){
      log("posts select error", perr);
      setStatus("ã¤ã¶ã‚„ãå–å¾—å¤±æ•—: " + perr.message, false);
      return;
    }

    if (!posts || posts.length === 0){
      setStatus("ã¤ã¶ã‚„ããªã—", true);
      box.innerHTML = `<div class="muted">ã¾ã ã¤ã¶ã‚„ããŒãªã„ã‚ˆ</div>`;
      return;
    }

    // ã„ã„ã­æ•°
    const postIds = posts.map(p => p.id);
    const { data: likes, error: lerr } = await withTimeout(
      sb.from("post_likes")
        .select("post_id, user_id")
        .in("post_id", postIds)
        .limit(5000),
      "likes select",
      8000
    );

    if (lerr){
      log("likes select error", lerr);
    }

    const likeCountByPost = new Map();
    const likedByMe = new Set();
    for (const r of (likes || [])){
      likeCountByPost.set(r.post_id, (likeCountByPost.get(r.post_id) || 0) + 1);
      if (r.user_id === authUser.id) likedByMe.add(r.post_id);
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°
    const { data: commentCounts, error: cerr } = await withTimeout(
      sb.from("post_comments")
        .select("post_id, id")
        .in("post_id", postIds)
        .limit(5000),
      "comments count select",
      8000
    );

    if (cerr){
      log("comments count error", cerr);
    }

    const commentCountByPost = new Map();
    for (const r of (commentCounts || [])){
      commentCountByPost.set(r.post_id, (commentCountByPost.get(r.post_id) || 0) + 1);
    }

    for (const p of posts){
      // å‰Šé™¤æ¸ˆã¿ã®æŠ•ç¨¿ã¯UIã«è¡¨ç¤ºã—ãªã„
      if (String(p.content||"").trim() === "ã¤ã¶ã‚„ãã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ") continue;
      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "postHead";

      const name = (p.display_name || "åç„¡ã—").toString();
      head.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row" style="gap:8px;align-items:center;">
            <span class="profileLink" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹" onclick="goUserProfile('${escapeAttr(p.user_id)}');event.stopPropagation();">${avatarHtml(p.avatar_url || "", name, p.avatar_ver || "")}</span>
            <div>
              <div style="font-weight:700;"><span class="profileLink" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹" onclick="goUserProfile('${escapeAttr(p.user_id)}');event.stopPropagation();">${escapeHtml(name)}</span> ${adminBadgeHtmlByUserId(p.user_id)}</div>
              <div style="font-size:12px;color:var(--muted);">${escapeHtml(formatTime(p.created_at))}${(p.updated_at && String(p.updated_at) !== String(p.created_at)) ? "ï¼ˆç·¨é›†æ¸ˆï¼‰" : ""}</div>
            </div>
          </div>
        </div>
      `;

      const body = document.createElement("div");
      body.className = "postBody";
      body.innerHTML = `<div class="postText">${escapeHtml((p.content||"").toString())}</div>`;

      const actions = document.createElement("div");
      actions.className = "row";
      actions.style.marginTop = "10px";

      const likeBtn = document.createElement("button");
      likeBtn.type = "button";
      likeBtn.className = "miniBtn";
      const likeCount = likeCountByPost.get(p.id) || 0;
      likeBtn.textContent = `ğŸ‘ ã„ã„ã­ ${likeCount}${likedByMe.has(p.id) ? "ï¼ˆæ¸ˆï¼‰" : ""}`;
      likeBtn.onclick = () => toggleLike(p.id);

      const cBtn = document.createElement("button");
      cBtn.type = "button";
      cBtn.className = "miniBtn";
      const cc = commentCountByPost.get(p.id) || 0;
      cBtn.textContent = `ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ ${cc}`;
      cBtn.onclick = () => toggleComments(p.id);

      actions.appendChild(likeBtn);
      actions.appendChild(cBtn);

    // è‡ªåˆ†ã®æŠ•ç¨¿ãªã‚‰ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if (p.user_id === authUser.id){
      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "miniBtn btnDanger";
      delBtn.textContent = "ğŸ—‘ å‰Šé™¤";
      delBtn.onclick = () => deletePost(p.id);
      actions.appendChild(delBtn);
    }

      // ã‚³ãƒ¡ãƒ³ãƒˆé ˜åŸŸ
      const commentArea = document.createElement("div");
      commentArea.className = "commentArea";
      commentArea.id = "commentArea-" + p.id;
      commentArea.style.display = "none";

      commentArea.innerHTML = `
        <div id="commentList-${p.id}" style="margin-bottom:10px;"></div>

        <!-- ãƒ«ãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ› -->
        <div class="row">
          <textarea id="commentText-${p.id}" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãï¼ˆ200æ–‡å­—ã¾ã§ï¼‰" style="min-height:70px;"></textarea>
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="commentSubmit-${p.id}" class="btnPrimary" type="button">ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</button>
          <button id="commentRefresh-${p.id}" class="miniBtn" type="button">æ›´æ–°</button>
        </div>
      `;

      // onclick ã‚’ä½¿ã‚ãšã«ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆã‚¯ãƒªãƒƒã‚¯2é‡é€ä¿¡/CSPäº‹æ•…å¯¾ç­–ï¼‰
      const btnSubmit = commentArea.querySelector(`#commentSubmit-${p.id}`);
      const btnRefresh = commentArea.querySelector(`#commentRefresh-${p.id}`);
      if (btnSubmit) btnSubmit.addEventListener("click", ()=>createComment(p.id, null, btnSubmit));
      if (btnRefresh) btnRefresh.addEventListener("click", ()=>loadComments(p.id));
  card.appendChild(head);
      card.appendChild(body);
      card.appendChild(actions);
      card.appendChild(commentArea);

      box.appendChild(card);
    }

    setStatus(`ã¤ã¶ã‚„ãOKï¼ˆ${posts.length}ä»¶ï¼‰`, true);
  })().finally(()=>{
    loadFeedInFlight = null;
  });

  return loadFeedInFlight;
}

/* =================== ã„ã„ã­ / ã‚³ãƒ¡ãƒ³ãƒˆé–‹é–‰ =================== */
async function toggleLike(postId){
  const ok = await refreshAuth();
  if (!ok || !authUser){
    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
    goLogin();
    return;
  }

  // æ—¢ã«ã„ã„ã­ã—ã¦ã‚‹ã‹ç¢ºèª
  const { data: exists, error: qerr } = await withTimeout(
    sb.from("post_likes")
      .select("post_id")
      .eq("post_id", postId)
      .eq("user_id", authUser.id)
      .maybeSingle(),
    "likes exists",
    8000
  );

  if (qerr){
    log("toggleLike exists error", qerr);
    alert("ã„ã„ã­ç¢ºèªå¤±æ•—: " + qerr.message);
    return;
  }

  if (exists){
    const { error: derr } = await withTimeout(
      sb.from("post_likes")
        .delete()
        .eq("post_id", postId)
        .eq("user_id", authUser.id),
      "likes delete",
      8000
    );
    if (derr){
      log("toggleLike delete error", derr);
      alert("ã„ã„ã­è§£é™¤å¤±æ•—: " + derr.message);
      return;
    }
  }else{
    const { error: ierr } = await withTimeout(
      sb.from("post_likes").insert({ post_id: postId, user_id: authUser.id }),
      "likes insert",
      8000
    );
    if (ierr){
      log("toggleLike insert error", ierr);
      alert("ã„ã„ã­å¤±æ•—: " + ierr.message);
      return;
    }
  }

  await loadFeed();
}


/* =================== ã¤ã¶ã‚„ãå‰Šé™¤ï¼ˆæœ¬äººã®ã¿ï¼‰ =================== */
async function deletePost(postId){
  const ok = await refreshAuth();
  if (!ok || !authUser){
    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
    goLogin();
    return;
  }

  if (!confirm("ã“ã®ã¤ã¶ã‚„ãã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆUIã‹ã‚‰æ¶ˆãˆã‚‹ã‚ˆï¼‰")) return;

  // ç‰©ç†å‰Šé™¤ã ã¨å¤–éƒ¨ã‚­ãƒ¼ç­‰ã§è©°ã¿ã‚„ã™ã„ã®ã§ã€content ã‚’ç½®æ›ã™ã‚‹ã‚½ãƒ•ãƒˆå‰Šé™¤ã«ã™ã‚‹
  const { error } = await withTimeout(
    sb.from("posts")
      .update({ content: "ã¤ã¶ã‚„ãã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ" })
      .eq("id", postId)
      .eq("user_id", authUser.id),
    "post soft delete",
    8000
  );

  if (error){
    log("deletePost error", error);
    alert("å‰Šé™¤å¤±æ•—: " + error.message);
    return;
  }

  await loadFeed();
  setStatus("ã¤ã¶ã‚„ãã‚’å‰Šé™¤ã—ãŸï¼", true);
}

function toggleComments(postId){
  const area = document.getElementById("commentArea-" + postId);
  if (!area) return;

  const open = area.classList.toggle("open");
  area.style.display = open ? "block" : "none";
  if (open) loadComments(postId).catch(()=>{});
}

/* =================== ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè¿”ä¿¡/ç·¨é›†/å‰Šé™¤ï¼‰ =================== */

// ç·¨é›†ãƒ»è¿”ä¿¡ã®UIçŠ¶æ…‹ï¼ˆpostIdå˜ä½ã§ä¿æŒï¼‰
const commentUiState = new Map();
// äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆpostIdã”ã¨ï¼‰
const commentSendLock = new Map();
// stateä¾‹: { editingId: "uuid" | null, replyingToId: "uuid" | null }

function getPostState(postId){
  if (!commentUiState.has(postId)){
    commentUiState.set(postId, { editingId: null, replyingToId: null });
  }
  return commentUiState.get(postId);
}

function startReply(postId, commentId){
  const st = getPostState(postId);
  st.replyingToId = commentId;
  st.editingId = null;
  loadComments(postId).catch(()=>{});
}

function cancelReply(postId){
  const st = getPostState(postId);
  st.replyingToId = null;
  loadComments(postId).catch(()=>{});
}

function startEdit(postId, commentId){
  const st = getPostState(postId);
  st.editingId = commentId;
  st.replyingToId = null;
  loadComments(postId).catch(()=>{});
}

function cancelEdit(postId){
  const st = getPostState(postId);
  st.editingId = null;
  loadComments(postId).catch(()=>{});
}

async function updateComment(postId, commentId, btnEl){
  try{
    const ok = await refreshAuth();
    if (!ok || !authUser){
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
      goLogin();
      return;
    }

    const ta = document.getElementById(`editText-${postId}-${commentId}`);
    const text = (ta?.value || "").trim();
    if (!text) return alert("å†…å®¹ãŒç©ºã ã‚ˆï¼");
    if (text.length > 200) return alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ã™ãã‚‹ã‚ˆï¼ˆ200æ–‡å­—ã¾ã§ï¼‰");

    const { error } = await withTimeout(
      sb.from("post_comments")
        .update({ content: text })
        .eq("id", commentId)
        .eq("user_id", authUser.id),
      "comment update",
      8000
    );

    if (error){
      log("updateComment error", error);
      alert("ç·¨é›†å¤±æ•—: " + error.message);
      return;
    }

    getPostState(postId).editingId = null;
    await loadComments(postId);
    await loadFeed(); // ã‚³ãƒ¡ãƒ³ãƒˆæ•°æ›´æ–°
    setStatus("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†ã—ãŸï¼", true);

  }catch(e){
    log("updateComment exception", e?.stack || String(e?.message || e));
    alert("ç·¨é›†ã§ä¾‹å¤–:\n" + (e?.stack || e?.message || e));
  }
}

async function loadComments(postId){
  const ok = await refreshAuth();
  if (!ok || !authUser) return;

  const { data, error } = await withTimeout(
    sb.from("post_comments")
      .select("id, post_id, parent_comment_id, user_id, display_name, avatar_url, avatar_ver, content, created_at")
      .eq("post_id", postId)
      .order("created_at", { ascending:true })
      .limit(200),
    "comments select",
    8000
  );

  if (error){
    log("loadComments error", error);
    return;
  }

  const list = document.getElementById("commentList-" + postId);
  if (!list) return;

  list.innerHTML = "";
  if (!data || data.length === 0){
    list.innerHTML = "<div style='color:var(--muted);font-size:12px;'>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ã‚ˆ</div>";
    return;
  }

  // ãƒ„ãƒªãƒ¼åŒ–
  const byParent = new Map(); // parentId(string|null) -> array
  for (const c of data){
    const p = c.parent_comment_id || null;
    if (!byParent.has(p)) byParent.set(p, []);
    byParent.get(p).push(c);
  }

  const st = getPostState(postId);

  const render = (parentId, depth) => {
    const arr = byParent.get(parentId) || [];
    for (const c of arr){
      const row = document.createElement("div");
      row.className = "commentRow" + (depth > 0 ? " replyIndent" : "");

      const name = (c.display_name || "åç„¡ã—").toString();
      const av = avatarHtml(c.avatar_url || "", name, c.avatar_ver || "");
      const canOwner = (c.user_id === authUser.id);
      const isDeleted = String(c.content||"").trim() === "ã‚³ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";

      const timeLabel = escapeHtml(formatTime(c.created_at));

      // æœ¬æ–‡ or ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
      const isEditing = (st.editingId === c.id);
      const bodyHtml = isEditing
        ? `
          <div class="row" style="margin-top:6px;">
            <textarea id="editText-${postId}-${c.id}" style="min-height:70px;">${escapeHtml((c.content||"").toString())}</textarea>
          </div>
          <div class="commentActions">
            <button class="btnPrimary" type="button" onclick="updateComment('${postId}','${c.id}', this)">ä¿å­˜</button>
            <button class="miniBtn" type="button" onclick="cancelEdit('${postId}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        `
        : `<div class="commentText" style="color:var(--muted);">${escapeHtml((c.content||"").toString())}</div>`;

      // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ 
      const isReplying = (!isDeleted && st.replyingToId === c.id);
      const replyBox = isReplying
        ? `
          <div class="row" style="margin-top:8px;">
            <textarea id="replyText-${postId}-${c.id}" placeholder="è¿”ä¿¡ã‚’æ›¸ãï¼ˆ200æ–‡å­—ã¾ã§ï¼‰" style="min-height:70px;"></textarea>
          </div>
          <div class="commentActions">
            <button class="btnPrimary" type="button" onclick="createReply('${postId}','${c.id}', this)">è¿”ä¿¡ã™ã‚‹</button>
            <button class="miniBtn" type="button" onclick="cancelReply('${postId}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        `
        : "";

      row.innerHTML = `
        <span class="profileLink" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹" onclick="goUserProfile('${escapeAttr(c.user_id)}');event.stopPropagation();">${av}</span>
        <div class="commentBody">
          <div class="commentMeta">
  <span class="commentName">
    <span class="profileLink" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹" onclick="goUserProfile('${escapeAttr(c.user_id)}');event.stopPropagation();">${escapeHtml(name)}</span> ${adminBadgeHtmlByUserId(c.user_id)}
  </span>
  <span class="commentTime">${timeLabel}</span>
</div>


          ${bodyHtml}

          <div class="commentActions">
            <button class="miniBtn" type="button" onclick="startReply('${postId}','${c.id}')">è¿”ä¿¡</button>
            ${(canOwner && !isDeleted) ? `<button class="miniBtn" type="button" onclick="startEdit('${postId}','${c.id}')">ç·¨é›†</button>` : ""}
            ${canOwner ? `<button class="miniBtn" type="button" onclick="deleteComment('${c.id}','${postId}')">å‰Šé™¤</button>` : ""}
          </div>

          ${replyBox}
        </div>
      `;

      list.appendChild(row);
      render(c.id, depth + 1);
    }
  };

  render(null, 0);
}

// parentCommentId ã‚’å—ã‘å–ã‚Œã‚‹
async function createComment(postId, parentCommentId, btnEl){
  const isReply = !!parentCommentId;
  const lockKey = `${postId}:${parentCommentId || "root"}`;

  try{
    const ok = await refreshAuth();
    if (!ok || !authUser){
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
      goLogin();
      return;
    }

    // äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆUI + ãƒ­ãƒƒã‚¯ï¼‰
    if (commentSendLock.get(lockKey)) return;
    commentSendLock.set(lockKey, true);
    if (btnEl) btnEl.disabled = true;

    const ta = isReply
      ? document.getElementById(`replyText-${postId}-${parentCommentId}`)
      : document.getElementById(`commentText-${postId}`);

    const text = (ta?.value || "").trim();
    if (!text) return alert(isReply ? "è¿”ä¿¡ã‚’å…¥åŠ›ã—ã¦ã­ï¼" : "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ã­ï¼");
    if (text.length > 200) return alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ã™ãã‚‹ã‚ˆï¼ˆ200æ–‡å­—ã¾ã§ï¼‰");

    // è¿½åŠ ã®äºŒé‡æŠ•ç¨¿ã‚¬ãƒ¼ãƒ‰ï¼š
    // ç›´è¿‘æ•°ç§’ä»¥å†…ã«ã€ŒåŒã˜å†…å®¹ãƒ»åŒã˜è¦ªãƒ»åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°ã€å†insertã—ãªã„
    try{
      const cutoffIso = new Date(Date.now() - 10 * 1000).toISOString(); // 10ç§’
      const { data: dup, error: dupErr } = await withTimeout(
        sb.from("post_comments")
          .select("id, created_at, content, parent_comment_id")
          .eq("post_id", postId)
          .eq("user_id", authUser.id)
          .gte("created_at", cutoffIso)
          .order("created_at", { ascending:false })
          .limit(5),
        "comment dup check",
        8000
      );

      if (!dupErr && dup && dup.length){
        const same = dup.find(r => String(r.content||"").trim() === text && String(r.parent_comment_id||"") === String(parentCommentId||""));
        if (same){
          log("createComment: blocked duplicate", same);
          if (ta) ta.value = "";
          getPostState(postId).replyingToId = null;
          await loadComments(postId);
          await loadFeed();
          setStatus(isReply ? "è¿”ä¿¡ã—ãŸï¼ï¼ˆé‡è¤‡é€ä¿¡ã‚’é˜²æ­¢ã—ãŸã‚ˆï¼‰" : "ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸï¼ï¼ˆé‡è¤‡é€ä¿¡ã‚’é˜²æ­¢ã—ãŸã‚ˆï¼‰", true);
          return;
        }
      }
    }catch(e){
      // dup check ãŒè½ã¡ã¦ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è‡ªä½“ã¯ç¶šè¡Œ
      log("dup check warn", String(e?.message || e));
    }

    const dn = (authUser.user_metadata?.display_name || authUser.email || "åç„¡ã—").toString();
    const avm = getPreferredAvatar();

    const payload = {
      post_id: postId,
      parent_comment_id: parentCommentId || null,
      user_id: authUser.id,
      display_name: dn,
      avatar_url: avm.url || "",
      avatar_ver: avm.ver || "",
      content: text
    };

    const { error } = await withTimeout(
      sb.from("post_comments").insert(payload),
      "comment insert",
      8000
    );

    if (error){
      log("createComment insert error", error);
      alert("ã‚³ãƒ¡ãƒ³ãƒˆå¤±æ•—: " + error.message);
      return;
    }

    if (ta) ta.value = "";
    getPostState(postId).replyingToId = null;

    await loadComments(postId);
    await loadFeed();
    setStatus(isReply ? "è¿”ä¿¡ã—ãŸï¼" : "ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸï¼", true);

  }catch(e){
    log("createComment exception", e?.stack || String(e?.message || e));
    alert("ã‚³ãƒ¡ãƒ³ãƒˆå‡¦ç†ã§ä¾‹å¤–:\n" + (e?.stack || e?.message || e));
  }finally{
    commentSendLock.delete(lockKey);
    if (btnEl) btnEl.disabled = false;
  }
}



// è¿”ä¿¡ãƒœã‚¿ãƒ³ç”¨
function createReply(postId, parentCommentId, btnEl){
  return createComment(postId, parentCommentId, btnEl);
}

// å‰Šé™¤ï¼ˆæœ¬äººã®ã¿å®Ÿè¡Œå¯èƒ½ / ç‰©ç†å‰Šé™¤ã—ãªã„ã§ã€Œå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€ã«ã™ã‚‹ï¼‰
async function deleteComment(commentId, postId){
  const ok = await refreshAuth();
  if (!ok || !authUser) return;

  if (!confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆè¡¨ç¤ºã¯ã€Œå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€ã«ãªã‚‹ã‚ˆï¼‰")) return;

  // ç‰©ç†å‰Šé™¤ã ã¨ã€Œè¿”ä¿¡ãŒã‚ã‚‹ã€å ´åˆã«å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€
  // content ã‚’ç½®ãæ›ãˆã¦â€œã‚½ãƒ•ãƒˆå‰Šé™¤â€ã«ã™ã‚‹ï¼ˆRLSã§æœ¬äººã®ã¿ update ã§ãã‚‹æƒ³å®šï¼‰
  const { error } = await withTimeout(
    sb.from("post_comments")
      .update({ content: "ã‚³ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ" })
      .eq("id", commentId)
      .eq("user_id", authUser.id),
    "comment soft delete",
    8000
  );

  if (error){
    log("deleteComment error", error);
    alert("å‰Šé™¤å¤±æ•—: " + error.message);
    return;
  }

  // ç·¨é›†/è¿”ä¿¡UIã‚’é–‰ã˜ã‚‹
  const st = getPostState(postId);
  if (st.editingId === commentId) st.editingId = null;
  if (st.replyingToId === commentId) st.replyingToId = null;

  await loadComments(postId);
  await loadFeed();
  setStatus("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸï¼", true);
}




/* =================== HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— / Avatar =================== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('`','&#096;'); }
function getInitial(s){
  const t = String(s||'').trim();
  if(!t) return '?';
  return Array.from(t)[0] || '?';
}
function normalizeAvatarUrl(url, ver){
  const u = String(url||'').trim();
  if (!u) return '';
  const v = String(ver||'').trim();
  if (!v) return u;
  return u + (u.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(v);
}
function avatarHtml(url, label, ver){
  const u = normalizeAvatarUrl(url, ver);
  if (u) return `<img class="avatarSm" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  return `<span class="avatarSmFb">${escapeHtml(getInitial(label))}</span>`;
}
function getPreferredAvatar(){
  const um = authUser?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const url = hasCustom ? String(um.custom_avatar_url || "").trim() : String(um.avatar_url || "").trim();
  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();
  return { url, ver };
}

/* =================== èµ·å‹• =================== */
(async () => {
  try {
    const url = new URL(location.href);
    const hasAuthParams =
      url.searchParams.has("code") ||
      url.searchParams.has("type") ||
      url.searchParams.has("access_token") ||
      url.searchParams.has("refresh_token") ||
      (location.hash && (location.hash.includes("access_token=") || location.hash.includes("refresh_token=")));

    if (hasAuthParams) {
      const { data, error } = await sb.auth.getSessionFromUrl({ storeSession: true });
      if (error) log("getSessionFromUrl error", error);
      if (data?.session?.user) log("OAuth session OK", data.session.user.email);
      history.replaceState({}, document.title, "./lobby.html?_r=" + Date.now());
    }
  } catch (e) {
    log("init session url exception", e);
  }

  if (!(await requireLoginOrRedirect())) return;

  // â˜… ãƒ­ãƒ“ãƒ¼ã«ã„ã‚‹é–“ã‚‚æœ€çµ‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³(last_seen)ã‚’æ›´æ–°
  startOnlineHeartbeatLobby();

  // å‰å›ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¾©å…ƒ
  try{
    const saved = localStorage.getItem("lobby_view_mode");
    if (saved === "feed" || saved === "rooms") viewMode = saved;
  }catch(e){}

  // Realtimeèµ·å‹•
  await startRealtime();
  await startCallParticipantsRealtime();
  await startFeedRealtime();

  // åˆæœŸè¡¨ç¤º
  setViewMode(viewMode);

  sb.auth.onAuthStateChange(async () => {
    try{
      const ok = await refreshAuth();
      if (!ok) { goLogin(); return; }

      // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦æ›´æ–°
      if (viewMode === "rooms") await loadRooms();
      else await loadFeed();

    }catch(e){
      log("onAuthStateChange err", String(e?.message || e));
    }
  });

  log("ready");
})();
</script>


<!-- ãƒˆãƒ¼ã‚¹ãƒˆç½®ãå ´ï¼ˆé€šçŸ¥ï¼‰ -->
<div class="toastWrap" id="toastWrap"></div>

</body>
</html>




