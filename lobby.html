<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Lobby</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 20px;
    }

    h2{ margin:0; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }

    .userBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      font-size:12px;
      flex-wrap: wrap;
      justify-content:flex-end;
      max-width: 62vw;
    }
    .userPill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .userText{
      color:var(--muted);
      max-width:30vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .avatarSm{
      width:26px;height:26px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .avatarSmFb{
      width:26px;height:26px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      color:rgba(234,242,255,.92);
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.18));
      flex:0 0 auto;
      user-select:none;
    }

    button{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:700;
    }
    button:hover{ filter:brightness(1.1); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    .sectionTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    input{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    #roomsBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }

    .roomRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .roomBtn{
      flex:1;
      text-align:left;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }

    .roomBtn:hover{
      background:linear-gradient(180deg, rgba(110,231,255,.15), rgba(255,255,255,.05));
    }

    .callLine{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badge{
      margin-left:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
    }

    .delBtn{
      width:44px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .delBtn:hover{ background:rgba(255,107,107,.25); }

    #status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }

    details{ margin-top:12px; }
    #log{
      margin-top:8px;
      font-size:12px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }

    .row > button{ white-space:nowrap; }
  </style>
</head>

<body>

<div class="topbar">
  <h2>ğŸ§ ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ â€“ ãƒ­ãƒ“ãƒ¼</h2>
  <div class="userBox">
    <button class="userPill" id="userNamePill" type="button" onclick="goProfile()">æœªãƒ­ã‚°ã‚¤ãƒ³</button>
    <span class="userText" id="userMailText"></span>
    <button class="btnDanger" onclick="signOut()" id="signOutBtn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="card">
  <div class="sectionTitle">ğŸ  ãƒ«ãƒ¼ãƒ </div>
  <div class="row">
    <input id="room" placeholder="éƒ¨å±‹åï¼ˆä¾‹: testï¼‰" />
    <button class="btnPrimary" id="createCardBtn" type="button" onclick="log('create clicked (card)'); createRoom();">ä½œæˆ</button>
    <button type="button" onclick="enterRoom()">å…¥å®¤</button>
    <button type="button" onclick="loadRooms()">æ›´æ–°</button>
  </div>

  <div class="sectionTitle" style="margin-top:14px;">ğŸ“‹ éƒ¨å±‹ä¸€è¦§</div>
  <div id="roomsBox"></div>

  <details open>
    <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
    <div id="log"></div>
  </details>

  <div id="status"></div>
</div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);

/* =================== çŠ¶æ…‹ =================== */
let authUser = null;
let roomsChannel = null;
let callParticipantsChannel = null;

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[lobby]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok=true){
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok?'ok':'ng'}">${escapeHtml(text)}</span>`;
}

/* =================== ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ã await =================== */
function withTimeout(promise, label, ms=8000){
  let t;
  const timeout = new Promise((_, rej)=>{
    t = setTimeout(()=>rej(new Error(`TIMEOUT: ${label} (${ms}ms)`)), ms);
  });
  return Promise.race([promise, timeout]).finally(()=>clearTimeout(t));
}

/* =================== ç§»å‹• =================== */
function goLogin(){ location.replace("./login.html?_r=" + Date.now()); }
function goRoom(roomObj){
  // roomObj: { id, room_name }
  const rn = (roomObj?.room_name || "").trim();
  const rid = roomObj?.id || "";
  if (!rn) return;
  const q = new URLSearchParams();
  q.set("room", rn);
  if (rid) q.set("room_id", rid);
  q.set("_r", Date.now());
  location.replace("./room.html?" + q.toString());
}
function goProfile(){
  location.replace("./profile.html?back=lobby&_r=" + Date.now());
}

/* =================== å³ä¸Šãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º =================== */
function setTopRightButtons(isLoggedIn){
  const soBtn = document.getElementById("signOutBtn");
  if (soBtn) soBtn.style.display = isLoggedIn ? "" : "none";
}

function updateTopRightUser(){
  const pill = document.getElementById("userNamePill");
  const mail = document.getElementById("userMailText");
  if (!pill) return;

  if (!authUser){
    pill.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    if (mail) mail.textContent = "";
    sb.auth.getSession().then(({data})=>{
      const hasSession = !!data?.session;
      setTopRightButtons(hasSession);
    }).catch(()=>{
      setTopRightButtons(false);
    });
    return;
  }

  const dn = (authUser.user_metadata?.display_name || "").trim();
  const em = (authUser.email || "").trim();
  const shown = dn || em || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";

  const avm = getPreferredAvatar();
  pill.innerHTML = `
    ${avatarHtml(avm.url || "", shown, avm.ver || "")}
    <span>${escapeHtml(shown)}</span>
  `;
  if (mail) mail.textContent = em ? `(${em})` : "";
  setTopRightButtons(true);
}

/* =================== ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒï¼ˆsingle-flight + timeoutï¼‰ =================== */
let refreshAuthInFlight = null;

async function refreshAuth(){
  if (refreshAuthInFlight) return refreshAuthInFlight;

  refreshAuthInFlight = (async ()=>{
    log("refreshAuth: start");

    // 1) getSessionï¼ˆã“ã‚ŒãŒå–ã‚Œã‚Œã°ã¾ãšOKï¼‰
    log("refreshAuth: before getSession");
    const { data: ses, error: sesErr } = await withTimeout(sb.auth.getSession(), "sb.auth.getSession", 8000);
    log("refreshAuth: after getSession");
    if (sesErr) log("getSession error", sesErr);

    const session = ses?.session || null;
    const sessionUser = session?.user || null;

    if (!sessionUser){
      authUser = null;
      updateTopRightUser();
      log("refreshAuth: no sessionUser -> false");
      return false;
    }

    // â˜…é‡è¦ï¼šrefreshSession ã¯å‘¼ã°ãªã„ï¼ˆã“ã“ãŒè©°ã¾ã£ã¦ãŸï¼‰
    // 2) getUserï¼ˆã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿãã¦ã‚Œã°é€šã‚‹ï¼‰
    try{
      log("refreshAuth: before getUser");
      const { data: u, error: uErr } = await withTimeout(sb.auth.getUser(), "sb.auth.getUser", 8000);
      log("refreshAuth: after getUser");

      if (uErr){
        log("getUser error", uErr);

        // tokenåˆ‡ã‚Œ/ç„¡åŠ¹ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã™
        authUser = null;
        updateTopRightUser();
        return false;
      }

      authUser = u?.user || sessionUser;
      updateTopRightUser();
      log("refreshAuth: ok user=", authUser?.id || "???");
      return true;

    }catch(e){
      log("getUser exception", String(e?.message || e));
      // ä¾‹å¤–æ™‚ã‚‚ sessionUser ã§ç¶šè¡Œï¼ˆæœ€ä½é™å‹•ã‹ã™ï¼‰
      authUser = sessionUser;
      updateTopRightUser();
      log("refreshAuth: ok (sessionUser fallback) user=", authUser?.id || "???");
      return true;
    }
  })().finally(()=>{
    refreshAuthInFlight = null;
  });

  return refreshAuthInFlight;
}


async function requireLoginOrRedirect(){
  for (let i = 0; i < 3; i++){
    try{
      const ok = await refreshAuth();
      if (ok) return true;
    }catch(e){
      log("requireLoginOrRedirect refreshAuth err", String(e?.message || e));
    }
    await new Promise(r => setTimeout(r, 300));
  }
  clearSupabaseLocalStorage();
  goLogin();
  return false;
}

/* =================== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =================== */
function clearSupabaseLocalStorage(){
  try{
    for (const k of Object.keys(localStorage)){
      if (k.startsWith("sb-") || k.includes("supabase")) localStorage.removeItem(k);
    }
    for (const k of Object.keys(sessionStorage)){
      if (k.startsWith("sb-") || k.includes("supabase")) sessionStorage.removeItem(k);
    }
  }catch(e){
    console.warn("clear storage warn", e);
  }
}

async function signOut() {
  const btn = document.getElementById("signOutBtn");
  if (btn) btn.disabled = true;

  try {
    try { await sb.removeAllChannels?.(); } catch (e) { log("removeAllChannels warn", e); }
    clearSupabaseLocalStorage();
    try { await sb.auth.signOut({ scope: "local" }); } catch (e) { log("signOut warn", e); }
  } finally {
    location.replace("./login.html?_r=" + Date.now());
  }
}

/* =================== Realtime =================== */
async function startRealtime(){
  if (roomsChannel) return;

  roomsChannel = sb
    .channel("rooms-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, async () => {
      await loadRooms();
    })
    .subscribe();
}

async function startCallParticipantsRealtime(){
  if (callParticipantsChannel) return;

  callParticipantsChannel = sb
    .channel("call-participants-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async () => {
      await loadRooms();
    })
    .subscribe();
}

/* =================== é€šè©±ä¸­ã‹ã©ã†ã‹åˆ¤å®š =================== */
const CALL_ALIVE_SEC = 30;

async function isRoomInCall(roomName){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await withTimeout(
    sb.from("call_participants")
      .select("user_id")
      .eq("room_id", roomName)
      .gte("updated_at", cutoff)
      .limit(1),
    "call_participants select",
    8000
  );

  if (error){
    log("isRoomInCall error", error);
    return false;
  }
  return (data || []).length > 0;
}

async function fetchActiveCallUsersByRoom(){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await withTimeout(
    sb.from("call_participants")
      .select("room_id, name, user_id, updated_at")
      .gte("updated_at", cutoff)
      .order("updated_at", { ascending:false }),
    "call_participants list",
    8000
  );

  if (error){
    log("fetchActiveCallUsersByRoom error", error);
    return new Map();
  }

  const map = new Map();
  for (const row of (data || [])){
    const rid = row.room_id;
    if (!rid) continue;
    if (!map.has(rid)) map.set(rid, []);
    map.get(rid).push({
      name: (row.name || row.user_id || "").toString(),
      user_id: row.user_id
    });
  }

  for (const [rid, arr] of map.entries()){
    const seen = new Set();
    const out = [];
    for (const a of arr){
      const k = a.user_id || a.name;
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(a);
    }
    map.set(rid, out);
  }

  return map;
}

/* =================== éƒ¨å±‹ä¸€è¦§èª­ã¿è¾¼ã¿ =================== */
async function loadRooms(){
  // authUser ãŒã¾ã å…¥ã£ã¦ãªãã¦ã‚‚ã€ã“ã“ã§ç¢ºå®Ÿã«å–ã‚Šç›´ã™
  const ok = await refreshAuth();
  if (!ok || !authUser){
    setStatus("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼", false);
    return;
  }

  const { data, error } = await withTimeout(
    sb.from("rooms")
      .select("id, room_name, created_at, owner_id")
      .order("created_at", { ascending:true }),
    "rooms select",
    8000
  );

  if (error){
    log("loadRooms error", error);
    setStatus("éƒ¨å±‹ä¸€è¦§å–å¾—å¤±æ•—: " + error.message, false);
    return;
  }

  const activeMap = await fetchActiveCallUsersByRoom();

  const box = document.getElementById("roomsBox");
  box.innerHTML = "";

  if (!data || data.length === 0){
    box.innerHTML = "<div style='color:var(--muted);font-size:12px;'>ã¾ã éƒ¨å±‹ãŒãªã„ã‚ˆï¼ˆéƒ¨å±‹ä½œæˆã—ã¦ã­ï¼‰</div>";
    setStatus("éƒ¨å±‹ãªã—", true);
    return;
  }

  for (const r of data){
    const rn = r.room_name;

    const row = document.createElement("div");
    row.className = "roomRow";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "roomBtn";
    btn.textContent = rn;
    btn.onclick = () => document.getElementById("room").value = rn;
    btn.ondblclick = () => goRoom(r);

    const users = activeMap.get(rn) || [];
    if (users.length > 0){
      const names = users.map(x=>x.name).filter(Boolean);
      const line = document.createElement("div");
      line.className = "callLine";
      const shown = names.slice(0, 4).join("ã€");
      const more = names.length > 4 ? ` â€¦(+${names.length-4})` : "";
      line.innerHTML = `ğŸ“ é€šè©±ä¸­: ${escapeHtml(shown + more)} <span class="badge">${names.length}</span>`;
      btn.appendChild(line);
      btn.title = "é€šè©±ä¸­: " + names.join("ã€");
    }

    const del = document.createElement("button");
    del.type = "button";
    del.className = "delBtn";
    del.textContent = "ğŸ—‘";
    del.title = "æ ä¸»ãªã‚‰ã„ã¤ã§ã‚‚å‰Šé™¤ã§ãã¾ã™ï¼ˆé€šè©±/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã‚‚å…¨å“¡ãƒ­ãƒ“ãƒ¼ã¸ï¼‰";

    del.onclick = async () => {
      try {
        log("delete: start", rn);

        const ok = await refreshAuth();
        if (!ok || !authUser) {
          alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
          goLogin();
          return;
        }

        // rooms ã‚’å¼•ã„ã¦ room_id ã‚’ç¢ºå®šï¼ˆroom_events ã«ç†ç”±ã¤ãã§æµã™ãŸã‚ï¼‰
        const { data: rr, error: rErr } = await withTimeout(
          sb.from("rooms").select("id, owner_id").eq("room_name", rn).maybeSingle(),
          "rooms get for delete",
          8000
        );
        if (rErr){
          alert("éƒ¨å±‹æƒ…å ±å–å¾—ã«å¤±æ•—: " + rErr.message);
          log("delete get room error", rErr);
          return;
        }
        if (!rr){
          alert("ãã®éƒ¨å±‹ã¯æ—¢ã«ç„¡ã„ã¿ãŸã„ï¼");
          await loadRooms();
          return;
        }

        // æ ä¸»ãƒã‚§ãƒƒã‚¯ï¼ˆRLSã§ã‚‚å®ˆã‚‰ã‚Œã‚‹ã‘ã©ã€UIã§ã‚‚å…ˆã«å¼¾ãï¼‰
        if ((rr.owner_id || "") !== authUser.id){
          alert("æ ä¸»ã ã‘ãŒå‰Šé™¤ã§ãã‚‹ã‚ˆï¼");
          return;
        }

        if (!confirm(`éƒ¨å±‹ã€Œ${rn}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né€šè©±/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã§ã‚‚å…¨å“¡ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚`)) return;

        // å…ˆã«å…¨å“¡å‘ã‘ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç†ç”±ã¤ãï¼‰
        try{
          await withTimeout(
            sb.from("room_events").insert({
              room_id: rr.id,
              target_user_id: null,
              type: "room_deleted",
              reason: "éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ",
              actor_user_id: authUser.id
            }),
            "room_events insert",
            8000
          );
        }catch(e){
          log("room_events insert warn", String(e?.message || e));
        }

        // å‰Šé™¤
        const { error: dErr } = await withTimeout(
          sb.from("rooms").delete().eq("id", rr.id),
          "rooms delete",
          8000
        );

        if (dErr) {
          alert("å‰Šé™¤å¤±æ•—: " + dErr.message);
          log("delete error", dErr);
          return;
        }

        await loadRooms();
        log("delete: ok", rn);

      } catch (e) {
        console.error(e);
        log("delete: exception", String(e?.message || e));
        alert("å‰Šé™¤ã§ä¾‹å¤–:\n" + (e?.stack || e?.message || e));
      }
    };

    row.appendChild(btn);
    row.appendChild(del);
    box.appendChild(row);
  }

  setStatus(`éƒ¨å±‹ä¸€è¦§OKï¼ˆ${data.length}ä»¶ï¼‰`, true);
}

/* =================== éƒ¨å±‹ä½œæˆ / å…¥å®¤ =================== */
function setCreateButtonsDisabled(disabled){
  const t = document.getElementById("createTopBtn");
  const c = document.getElementById("createCardBtn");
  if (t) t.disabled = disabled;
  if (c) c.disabled = disabled;
}

async function createRoom(){
  log("=== createRoom start ===");

  try{
    log("createRoom: refreshAuth...");
    const ok = await refreshAuth();
    log("createRoom: refreshAuth done ->", ok, "uid=", authUser?.id || null);

    if (!ok || !authUser){
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
      goLogin();
      return;
    }

    const rn = document.getElementById("room").value.trim();
    log("createRoom: rn=", rn);

    if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

    // â‘  exists
    log("createRoom: exists check...");
    const q1 = await withTimeout(
      sb.from("rooms").select("id").eq("room_name", rn).maybeSingle(),
      "rooms exists",
      8000
    );
    log("createRoom: exists raw=", q1);

    if (q1.error){
      alert("å­˜åœ¨ãƒã‚§ãƒƒã‚¯å¤±æ•—(è©³ç´°):\n" + JSON.stringify(q1.error, null, 2));
      return;
    }

    if (q1.data){
      alert("ãã®éƒ¨å±‹ã¯ã‚‚ã†ã‚ã‚‹ã‚ˆï¼");
      // æ—¢å­˜ã®éƒ¨å±‹ã¸å…¥ã‚‹ï¼ˆæœ€æ–°è¡Œã‚’å–ã‚‹ï¼‰
      const { data: r2, error: e2 } = await withTimeout(
        sb.from("rooms").select("id, room_name, created_at").eq("room_name", rn).order("created_at", { ascending:false }).limit(1).maybeSingle(),
        "rooms select latest",
        8000
      );
      if (!e2 && r2) goRoom(r2);
      return;
    }

    // â‘¡ insert
    log("createRoom: insert...");
    const q2 = await withTimeout(
      sb.from("rooms").insert({ room_name: rn, owner_id: authUser.id }).select("id, room_name, created_at, owner_id").maybeSingle(),
      "rooms insert",
      8000
    );
    log("createRoom: insert raw=", q2);

    if (q2.error){
      alert("ä½œæˆå¤±æ•—(è©³ç´°):\n" + JSON.stringify(q2.error, null, 2));
      return;
    }

    alert("éƒ¨å±‹ä½œæˆOKï¼");
    await loadRooms();
    log("=== createRoom ok ===");

    // â‘¢ ä½œæˆã—ãŸéƒ¨å±‹ã«å…¥ã‚‹
    goRoom(q2.data);

  }catch(e){
    log("createRoom exception:", String(e?.message || e));
    alert("ä½œæˆã§ä¾‹å¤–:\n" + (e?.stack || e?.message || e));
  }finally{
    log("=== createRoom end ===");
  }
}

async function enterRoom(){
  const rn = document.getElementById("room").value.trim();
  if (!rn) return alert("éƒ¨å±‹åã‚’å…¥ã‚Œã¦ã­ï¼");

  const ok = await refreshAuth();
  if (!ok || !authUser){
    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã‚ˆã€‚ã‚‚ã†ä¸€å›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
    goLogin();
    return;
  }

  const { data: r, error } = await withTimeout(
    sb.from("rooms")
      .select("id, room_name, created_at, owner_id")
      .eq("room_name", rn)
      .order("created_at", { ascending:false })
      .limit(1)
      .maybeSingle(),
    "rooms enter select",
    8000
  );

  if (error){
    alert("å…¥å®¤ãƒã‚§ãƒƒã‚¯å¤±æ•—: " + error.message);
    log("enterRoom error", error);
    return;
  }

  if (!r){
    alert("ãã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆï¼å…ˆã«ä½œæˆã—ã¦ã­ï¼");
    return;
  }

  goRoom(r);
}

/* =================== HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— / Avatar =================== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('`','&#096;'); }
function getInitial(s){
  const t = String(s||'').trim();
  if(!t) return '?';
  return Array.from(t)[0] || '?';
}
function normalizeAvatarUrl(url, ver){
  const u = String(url||'').trim();
  if (!u) return '';
  const v = String(ver||'').trim();
  if (!v) return u;
  return u + (u.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(v);
}
function avatarHtml(url, label, ver){
  const u = normalizeAvatarUrl(url, ver);
  if (u) return `<img class="avatarSm" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  return `<span class="avatarSmFb">${escapeHtml(getInitial(label))}</span>`;
}
function getPreferredAvatar(){
  const um = authUser?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const url = hasCustom ? String(um.custom_avatar_url || "").trim() : String(um.avatar_url || "").trim();
  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();
  return { url, ver };
}

/* =================== èµ·å‹• =================== */
(async () => {
  try {
    const url = new URL(location.href);
    const hasAuthParams =
      url.searchParams.has("code") ||
      url.searchParams.has("type") ||
      url.searchParams.has("access_token") ||
      url.searchParams.has("refresh_token") ||
      (location.hash && (location.hash.includes("access_token=") || location.hash.includes("refresh_token=")));

    if (hasAuthParams) {
      const { data, error } = await sb.auth.getSessionFromUrl({ storeSession: true });
      if (error) log("getSessionFromUrl error", error);
      if (data?.session?.user) log("OAuth session OK", data.session.user.email);
      history.replaceState({}, document.title, "./lobby.html?_r=" + Date.now());
    }
  } catch (e) {
    log("init session url exception", e);
  }

  if (!(await requireLoginOrRedirect())) return;

  await loadRooms();
  await startRealtime();
  await startCallParticipantsRealtime();

  sb.auth.onAuthStateChange(async () => {
    try{
      const ok = await refreshAuth();
      if (!ok) { goLogin(); return; }
      await loadRooms();
    }catch(e){
      log("onAuthStateChange err", String(e?.message || e));
    }
  });

  log("ready");
})();
</script>

</body>
</html>





