<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„ÇÜ„Çã„Çã„ÉÅ„É£„ÉÉ„Éà - Lobby</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ================= UI: lobby(11) ================= -->
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 20px;
    }

    h2{ margin:0; }

    /* ===== Top ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }

    .userBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,06);
      box-shadow:var(--shadow);
      font-size:12px;
      flex-wrap: wrap;
      justify-content:flex-end;
      max-width: 62vw;
    }
    .userPill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,10);
      border:1px solid var(--line);
      white-space: nowrap;
    }
    .userBtn{ cursor:pointer; }
    .userText{
      color:var(--muted);
      max-width:30vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .avatarSm{
      width:26px;height:26px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,18);
      background:rgba(255,255,255,10);
      flex:0 0 auto;
      vertical-align:middle;
      margin-right:6px;
    }
    .avatarSmFb{
      width:26px;height:26px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      color:rgba(234,242,255,92);
      background:rgba(255,255,255,12);
      border:1px solid rgba(255,255,255,18);
      margin-right:6px;
      vertical-align:middle;
    }

    /* ===== Card ===== */
    .card{
      border:1px solid var(--line);
      background:var(--card);
      padding:14px 14px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin: 12px 0;
      backdrop-filter: blur(10px);
    }
    .sectionTitle{
      font-weight:800;
      letter-spacing:0.3px;
      margin: 0 0 8px 0;
    }
    .row{ display:flex; gap:8px; flex-wrap: wrap; align-items: center; }

    input{
      width: 300px;
      max-width: 92vw;
      padding: 10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,14);
      background:rgba(10,18,32,55);
      color:var(--text);
      outline:none;
    }
    input:focus{ border-color: rgba(110,231,255,55); }

    button{
      padding: 9px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,18);
      background:rgba(255,255,255,10);
      color:var(--text);
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
    }
    button:hover{ background:rgba(255,255,255,14); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .btnPrimary{
      background: linear-gradient(90deg, rgba(110,231,255,25), rgba(167,139,250,22));
      border-color: rgba(110,231,255,35);
    }
    .btnDanger{
      background: rgba(255,107,107,16);
      border-color: rgba(255,107,107,35);
    }

    .muted{ color:var(--muted); font-size:12px; }

    #roomsBox{
      border:1px solid rgba(255,255,255,12);
      border-radius: 14px;
      padding: 10px;
      background: rgba(10,18,32,30);
      max-width: 96vw;
    }
    .roomItem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,10);
      background: rgba(255,255,255,06);
      margin: 8px 0;
    }
    .roomName{ font-weight:900; }
    .badge{
      font-size:11px;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,18);
      background: rgba(255,255,255,08);
      color: rgba(234,242,255,92);
      margin-left: 8px;
    }
    .badgeCall{
      border-color: rgba(59,224,168,45);
      background: rgba(59,224,168,16);
      color: rgba(59,224,168,95);
    }

    details{ user-select:text; }
    #log{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      line-height: 1.4;
      color: rgba(234,242,255,85);
      margin-top: 8px;
    }

    #status{ margin-top: 8px; font-size: 12px; }
    .ok{ color: var(--good); }
    .ng{ color: var(--bad); }
  </style>
</head>

<body>
  <div class="topbar">
    <h2>üè† „É≠„Éì„Éº</h2>

    <div class="userBox">
      <div class="userPill userBtn" id="userNamePill" onclick="goProfile()">Êú™„É≠„Ç∞„Ç§„É≥</div>
      <button class="btnDanger" onclick="signOut()">üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    </div>
  </div>

  <div class="card">
    <div class="sectionTitle">üë§ Ë°®Á§∫Âêç</div>
    <div class="row">
      <input id="displayName" placeholder="Ë°®Á§∫ÂêçÔºà‰æã: „ÇÜ„Çã„Åü„ÅæÔºâ" />
      <button class="btnPrimary" onclick="saveDisplayName()">‰øùÂ≠ò</button>
    </div>
    <div id="status"></div>
  </div>

  <div class="card">
    <div class="sectionTitle">üß© ÈÉ®Â±ã‰∏ÄË¶ß</div>
    <div class="row" style="margin-bottom:10px;">
      <input id="newRoomName" placeholder="ÈÉ®Â±ãÂêçÔºà‰æã: testÔºâ" />
      <button class="btnPrimary" onclick="createRoom()">‚ûï ‰ΩúÊàê</button>
      <button onclick="loadRooms()">üîÑ Êõ¥Êñ∞</button>
    </div>
    <div id="roomsBox">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
  </div>

  <details class="card">
    <summary class="muted">üîß „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</summary>
    <div id="log"></div>
  </details>

<script>
/* =================== Supabase Ë®≠ÂÆöÔºàSYSTEM = lobby(10)Ôºâ =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

/* ‚òÖÈáçË¶ÅÔºölogin.html „Å®Âêå„Åò auth Ë®≠ÂÆö„Åß createClientÔºà„É≠„Éì„Éº„Åß„ÄåÂàá„Çå„Çã„Äç„ÇíÈò≤„ÅêÔºâ */
const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);

/* =================== Áä∂ÊÖã =================== */
let authUser = null;
let roomsChannel = null;
let callParticipantsChannel = null;

/* =================== „É≠„Ç∞ =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[lobby]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok=true){
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok?'ok':'ng'}">${escapeHtml(text)}</span>`;
}

/* =================== ÁßªÂãï =================== */
function goLogin(){ location.replace("./login.html?_r=" + Date.now()); }
function goRoom(roomName){
  location.replace("./room.html?room=" + encodeURIComponent(roomName) + "&_r=" + Date.now());
}
function goProfile(){
  location.replace("./profile.html?back=lobby&_r=" + Date.now());
}

/* =================== HTML„Ç®„Çπ„Ç±„Éº„Éó =================== */
function escapeAttr(s){ return escapeHtml(s).replaceAll('`','&#096;'); }
function getInitial(s){ const t=String(s||'').trim(); if(!t) return '?'; return Array.from(t)[0] || '?'; }
function avatarHtml(url, label){
  const u = String(url||'').trim();
  if (u) return `<img class="avatarSm" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  return `<span class="avatarSmFb">${escapeHtml(getInitial(label))}</span>`;
}

function bustAvatar(url){
  const u = String(url||'').trim();
  if (!u) return '';
  // „Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÁ≠ñÔºö„É¶„Éº„Ç∂„ÉºÊõ¥Êñ∞ÊôÇÂàª or ÁèæÂú®ÊôÇÂàª„Çí„ÇØ„Ç®„É™„Å´‰ªò‰∏é
  const v = (authUser && authUser.updated_at) ? authUser.updated_at : String(Date.now());
  return u + (u.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(v);
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =================== Âè≥‰∏ä„É¶„Éº„Ç∂„ÉºË°®Á§∫ =================== */
function updateTopRightUser(){
  const pill = document.getElementById("userNamePill");
  if (!pill) return;

  if (!authUser){
    pill.textContent = "Êú™„É≠„Ç∞„Ç§„É≥";
    return;
  }

  const dn = (authUser.user_metadata?.display_name || "").trim();
  const em = (authUser.email || "").trim();
  const shown = dn || em || "„É≠„Ç∞„Ç§„É≥‰∏≠";

  // ‚òÖ „Ç¢„Ç§„Ç≥„É≥„ÅØ„ÄåÂêçÂâç„ÅÆÊ®™„Å´1ÂÄã„Å†„Åë„Äç
  pill.innerHTML = `
    ${avatarHtml(bustAvatar(authUser.user_metadata?.avatar_url || ""), shown)}
    <span>${escapeHtml(shown)}</span>
  `;
}

/* =================== „Çª„ÉÉ„Ç∑„Éß„É≥Âæ©ÂÖÉ =================== */
async function refreshAuth(){
  // „Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™çÔºà„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Çã„ÅãÔºâ
  const { data: ses, error: sesErr } = await sb.auth.getSession();
  if (sesErr) log("getSession error", sesErr);

  const sessionUser = ses?.session?.user || null;
  if (!sessionUser){
    authUser = null;
    updateTopRightUser();
    return false;
  }

  // ‚òÖ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÊúÄÊñ∞user„ÇíÂèñ„ÇãÔºàÂà•Á´ØÊú´Â§âÊõ¥„ÇíÊãæ„ÅÜÔºâ
  try{ await sb.auth.refreshSession(); }catch{}

  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);

  authUser = u?.user || sessionUser;  // Âèñ„Çå„Åü„ÇâÊúÄÊñ∞„ÄÅ„ÉÄ„É°„Å™„Çâsession„ÅÆuser
  updateTopRightUser();

  // Ë°®Á§∫ÂêçÂÖ•ÂäõÊ¨Ñ„Å∏ÂèçÊò†ÔºàÁ©∫„ÅÆ„Å®„Åç„Å†„ÅëÔºâ
  const dn = (authUser.user_metadata?.display_name || "").trim();
  const dnEl = document.getElementById("displayName");
  if (dnEl && !dnEl.value) dnEl.value = dn;

  return true;
}

/* „É≠„Éì„Éº„Åß„ÅØ„ÄåÊú™„É≠„Ç∞„Ç§„É≥„Å™„Çâlogin„Å∏„Äç */
async function requireLoginOrRedirect(){
  const ok = await refreshAuth();
  if (!ok){
    goLogin();
    return false;
  }
  return true;
}

/* =================== „É≠„Ç∞„Ç¢„Ç¶„Éà =================== */
async function signOut(){
  try { await sb.auth.signOut({ scope:"local" }); } catch (e) { log("signOut", e); }
  authUser = null;
  updateTopRightUser();
  goLogin();
}

/* =================== Realtime =================== */
async function startRealtime(){
  if (roomsChannel) return;

  roomsChannel = sb
    .channel("rooms-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, async () => {
      await loadRooms();
    })
    .subscribe();
}

/* call_participants „ÅåÂãï„ÅÑ„Åü„ÇâÈÉ®Â±ã‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞ÔºàÈÄöË©±‰∏≠Ë°®Á§∫„ÅåÂ§â„Çè„ÇãÔºâ */
async function startCallParticipantsRealtime(){
  if (callParticipantsChannel) return;

  callParticipantsChannel = sb
    .channel("call-participants-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async () => {
      await loadRooms();
    })
    .subscribe();
}

/* =================== ÈÄöË©±‰∏≠„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö =================== */
const CALL_ALIVE_SEC = 30;

async function isRoomInCall(roomName){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await sb
    .from("call_participants")
    .select("user_id")
    .eq("room_id", roomName)
    .gte("updated_at", cutoff)
    .limit(1);

  if (error){
    log("isRoomInCall error", error);
    // Âà§ÂÆö„Åß„Åç„Å™„ÅÑÊôÇ„ÅØÂÆâÂÖ®ÂÅ¥ÔºàÂâäÈô§„Åï„Åõ„Å™„ÅÑÔºâ
    return true;
  }
  return (data || []).length > 0;
}

/* =================== roomsË°®Á§∫ =================== */
async function loadRooms(){
  const box = document.getElementById("roomsBox");
  box.textContent = "Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";

  const { data, error } = await sb
    .from("rooms")
    .select("*")
    .order("created_at", { ascending: false });

  if (error){
    box.textContent = "Ë™≠„ÅøËæº„ÅøÂ§±Êïó: " + error.message;
    log("loadRooms error", error);
    return;
  }

  box.innerHTML = "";
  (data || []).forEach(async (r)=>{
    const rn = (r.room_name || "").trim();
    if (!rn) return;

    const inCall = await isRoomInCall(rn);

    const div = document.createElement("div");
    div.className = "roomItem";

    div.innerHTML = `
      <div>
        <div class="roomName">
          ${escapeHtml(rn)}
          ${inCall ? `<span class="badge badgeCall">üìû ÈÄöË©±‰∏≠</span>` : ``}
        </div>
        <div class="muted">${escapeHtml(String(r.created_at || ""))}</div>
      </div>
      <div class="row">
        <button onclick="goRoom('${escapeAttr(rn)}')">ÂÖ•ÂÆ§</button>
      </div>
    `;
    box.appendChild(div);
  });
}

/* =================== rooms‰ΩúÊàê =================== */
async function createRoom(){
  const input = document.getElementById("newRoomName");
  const rn = (input.value || "").trim();
  if (!rn) return alert("ÈÉ®Â±ãÂêç„ÇíÂÖ•„Çå„Å¶„Å≠ÔºÅ");

  const { error } = await sb.from("rooms").insert({ room_name: rn });
  if (error){
    alert("‰ΩúÊàêÂ§±Êïó: " + error.message);
    return;
  }

  input.value = "";
  await loadRooms();
  goRoom(rn);
}

/* =================== Ë°®Á§∫Âêç‰øùÂ≠ò =================== */
async function saveDisplayName() {
  if (!authUser) return alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å≠ÔºÅ");

  const input = document.getElementById("displayName");
  if (!input) return;

  const dn = input.value.trim();
  if (!dn) return alert("Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠ÔºÅ");

  const { data, error } = await sb.auth.updateUser({
    data: { display_name: dn }
  });

  if (error) {
    alert("‰øùÂ≠òÂ§±Êïó: " + error.message);
    return;
  }

  // „É≠„Éº„Ç´„É´ÂèçÊò†
  if (data?.user) authUser = data.user;
  updateTopRightUser();

  setStatus("Ë°®Á§∫Âêç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ", true);
}

/* =================== Ëµ∑Âãï =================== */
(async () => {
  // ‚òÖ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåURL„Å´Âê´„Åæ„Çå„Çã„Ç±„Éº„Çπ„ÇÇÊãæ„ÅÜÔºàÂÆâÂÖ®„ÅÆ„Åü„ÇÅÔºâ
  try {
    const url = new URL(location.href);
    const hasAuthParams =
      url.searchParams.has("code") ||
      url.searchParams.has("type") ||
      url.searchParams.has("access_token") ||
      url.searchParams.has("refresh_token") ||
      (location.hash && (location.hash.includes("access_token=") || location.hash.includes("refresh_token=")));

    if (hasAuthParams) {
      const { data, error } = await sb.auth.getSessionFromUrl({ storeSession: true });
      if (error) log("getSessionFromUrl error", error);
      if (data?.session?.user) log("OAuth session OK", data.session.user.email);
      history.replaceState({}, document.title, "./lobby.html");
    }
  } catch (e) {
    log("init session url exception", e);
  }

  if (!(await requireLoginOrRedirect())) return;

  document.getElementById("displayName").value =
    (authUser.user_metadata?.display_name || "").trim();

  await loadRooms();
  await startRealtime();
  await startCallParticipantsRealtime();

  sb.auth.onAuthStateChange(async () => {
    const ok = await refreshAuth();
    if (!ok) { goLogin(); return; }
    await loadRooms();
  });

  log("ready");
})();
</script>

</body>
</html>
