
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Room</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===================== Notify (same as profile) ===================== */
let frChannel = null;
let roomNotifyChannel = null;
let inviteNotifyChannel = null;
let pendingCount = 0;
const shownToastIds = new Set();

let notifyInbox = []; // max 10, localStorage
function inboxKey(){
  return authUser?.id ? ("notify_inbox_" + authUser.id) : "notify_inbox_anon";
}
function loadNotifyInbox(){
  try{
    const raw = localStorage.getItem(inboxKey());
    if (!raw) { notifyInbox = []; return; }
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) notifyInbox = arr.slice(0,10);
    else notifyInbox = [];
  }catch{ notifyInbox = []; }
}
function saveNotifyInbox(){
  try{
    localStorage.setItem(inboxKey(), JSON.stringify(notifyInbox.slice(0,10)));
  }catch{}
}

function setNotifyBadge(n){
  const el = document.getElementById("notifyBadge");
  if (!el) return;
  const num = Math.max(0, Number(n||0)|0);
  if (num <= 0){
    el.style.display = "none";
    el.textContent = "";
  }else{
    el.style.display = "inline-flex";
    el.textContent = String(Math.min(99, num));
  }
}

function unreadOtherCount(){
  return notifyInbox.filter(n => !n.read && n.type !== "friend_request").length;
}
function updateNotifyBadgeTotal(){
  setNotifyBadge(pendingCount + unreadOtherCount());
}

function addNotify(item){
  if (!item) return;
  // åŒã˜IDã¯äºŒé‡è¿½åŠ ã—ãªã„
  if (item.id && notifyInbox.some(x => x.id === item.id)) return;
  notifyInbox.unshift({
    id: item.id || ("local_" + Date.now() + "_" + Math.random()),
    type: item.type || "other",
    title: item.title || "é€šçŸ¥",
    msg: item.msg || "",
    from_uid: item.from_uid || null,
    from_name: item.from_name || null,
    room_id: item.room_id || null,
    room_name: item.room_name || null,
    created_at: item.created_at || new Date().toISOString(),
    read: !!item.read
  });
  // 10å€‹ã¾ã§ä¿æŒã€‚ãã‚Œä»¥ä¸Šã¯å¤ã„ã®ã‚’å‰Šé™¤
  if (notifyInbox.length > 10) notifyInbox = notifyInbox.slice(0,10);
  saveNotifyInbox();
  updateNotifyBadgeTotal();
}

function markAllRead(){
  notifyInbox = notifyInbox.map(n => ({...n, read:true}));
  saveNotifyInbox();
  updateNotifyBadgeTotal();
  renderNotifyPanel();
}
function markOneRead(id){
  notifyInbox = notifyInbox.map(n => n.id === id ? ({...n, read:true}) : n);
  saveNotifyInbox();
  updateNotifyBadgeTotal();
  renderNotifyPanel();
}

function showToast({title, msg, onOpen, onAllowNotify}){
  const wrap = document.getElementById("toastWrap");
  if (!wrap) return;

  const el = document.createElement("div");
  el.className = "toast";
  el.innerHTML = `
    <div class="toastHead">
      <div class="toastTitle">${escapeHtml(title||"é€šçŸ¥")}</div>
      <button class="toastClose" aria-label="close">Ã—</button>
    </div>
    <div class="toastBody">${escapeHtml(msg||"")}</div>
    <div class="toastBtns">
      ${onOpen ? `<button class="btn btnPrimary" data-open>é–‹ã</button>` : ``}
      ${onAllowNotify ? `<button class="btn btnGhost" data-allow>é€šçŸ¥ON</button>` : ``}
      <button class="btn btnGhost" data-close>é–‰ã˜ã‚‹</button>
    </div>
  `;

  const close = ()=>{ try{ el.remove(); }catch{} };

  el.querySelector(".toastClose").onclick = close;
  el.querySelector("[data-close]").onclick = close;

  const openBtn = el.querySelector("[data-open]");
  if (openBtn && onOpen){
    openBtn.onclick = ()=>{ try{ onOpen(); }finally{ close(); } };
  }

  const allowBtn = el.querySelector("[data-allow]");
  if (allowBtn && onAllowNotify){
    allowBtn.onclick = async()=>{
      try{ await onAllowNotify(); }catch{}
      close();
    };
  }

  wrap.prepend(el);

  // 12ç§’ã§è‡ªå‹•æ¶ˆã—
  setTimeout(close, 12000);
}

async function requestBrowserNotifyPermission(){
  try{
    if (!("Notification" in window)) return false;
    if (Notification.permission === "granted") return true;
    if (Notification.permission === "denied") return false;
    const res = await Notification.requestPermission();
    return res === "granted";
  }catch{ return false; }
}

function pushBrowserNotify(title, body){
  try{
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;
    new Notification(title, { body });
  }catch{}
}

/* ====== é€šçŸ¥ãƒ‘ãƒãƒ«ï¼ˆè¶…ç°¡æ˜“ï¼‰ ====== */
function toggleNotifyPanel(){
  const panel = document.getElementById("notifyPanel");
  if (!panel) return;
  const open = panel.style.display !== "block";
  panel.style.display = open ? "block" : "none";
  if (open) renderNotifyPanel();
}
function renderNotifyPanel(){
  const panel = document.getElementById("notifyPanel");
  const list = document.getElementById("notifyList");
  if (!panel || !list) return;

  // æ–°ã—ã„é †
  const arr = notifyInbox.slice().sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));

  if (arr.length === 0){
    list.innerHTML = `<div class="hint">é€šçŸ¥ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  list.innerHTML = `<div class="list notifyList">` + arr.map(n=>{
    const unread = !n.read;
    const dot = unread ? `<span class="notifyDot">â—</span>` : ``;

    const safeId = String(n.id).replace(/'/g,"\\'");
    const hasProfile = !!n.from_uid;
    const hasRoom = (n.room_id && n.room_name);

    return `
      <div class="listItem nItem ${unread ? "unread" : ""}">
        <div class="name" style="min-width:0;">
          <div class="listMain" style="min-width:0;">
            <div class="listTitle" style="display:flex;align-items:center;gap:8px;min-width:0;">
              ${dot}<span class="titleText">${escapeHtml(n.title||"é€šçŸ¥")}</span>
            </div>
            <div class="listSub" style="white-space:normal;line-height:1.4;margin-top:4px;">
              ${escapeHtml(n.msg||"")}
            </div>
          </div>
        </div>

        <div class="notifyActions">
          <button class="btn btnMuted" onclick="markOneRead('${safeId}')">æ—¢èª­</button>
          ${hasProfile ? `<button class="btn btnMuted" onclick="location.href='./profile.html?uid=${encodeURIComponent(n.from_uid)}'">ç›¸æ‰‹</button>` : ``}
          ${hasRoom ? `<button class="btn btnPrimary" onclick="location.href='./room.html?room=${encodeURIComponent(n.room_name)}&room_id=${encodeURIComponent(n.room_id)}'">éƒ¨å±‹ã¸</button>` : ``}
        </div>
      </div>
    `;
  }).join("") + `</div>`;
}

/* ====== friend_requests: pendingæ•° åˆæœŸå–å¾—ï¼‹Realtime ====== */
async function refreshPendingCount(){
  if (!authUser?.id) return;
  try{
    const { count, error } = await sb
      .from("friend_requests")
      .select("id", { count: "exact", head: true })
      .eq("to_user", authUser.id)
      .eq("status", "pending");
    if (error) throw error;
    pendingCount = count || 0;
    updateNotifyBadgeTotal();
  }catch(e){
    console.error("refreshPendingCount error", e);
  }
}

async function startFriendRequestNotifications(){
  if (!authUser?.id) return;

  await refreshPendingCount();

  try{
    if (frChannel){
      await sb.removeChannel(frChannel);
      frChannel = null;
    }
  }catch(e){
    console.error("removeChannel error", e);
  }

  frChannel = sb.channel("fr_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "friend_requests",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      try{
        const r = payload?.new;
        if (!r) return;
        if (r.status !== "pending") return;

        pendingCount = pendingCount + 1;
        updateNotifyBadgeTotal();

        if (shownToastIds.has("fr_"+r.id)) return;
        shownToastIds.add("fr_"+r.id);

        let fromName = "èª°ã‹";
        try{
          const { data } = await sb.from("profiles")
            .select("display_name")
            .eq("user_id", r.from_user)
            .maybeSingle();
          if (data?.display_name) fromName = String(data.display_name);
        }catch{}

        // inboxä¿å­˜ï¼ˆè¦‹ã¦ã‚‚æ¶ˆãˆãªã„ï¼‰
        addNotify({
          id: "fr_" + r.id,
          type: "friend_request",
          title: "ğŸ¤ ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹",
          msg: `${fromName} ã•ã‚“ã‹ã‚‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`,
          from_uid: r.from_user,
          from_name: fromName,
          created_at: new Date().toISOString(),
          read: false
        });

        showToast({
          title: "ğŸ¤ ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒæ¥ãŸï¼",
          msg: `${fromName} ã•ã‚“ã‹ã‚‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`,
          onOpen: ()=>{
            location.href = `./profile.html?uid=${encodeURIComponent(r.from_user)}`;
          },
          onAllowNotify: async()=>{
            const ok = await requestBrowserNotifyPermission();
            if (typeof setStatus === "function"){
              setStatus(ok ? "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’ONã«ã—ã¾ã—ãŸ" : "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", ok);
            }
          }
        });

        pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${fromName} ã•ã‚“ã‹ã‚‰ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`);
      }catch(e){
        console.error("INSERT notify error", e);
      }
    })
    .on("postgres_changes", {
      event: "UPDATE",
      schema: "public",
      table: "friend_requests",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      try{
        const oldRow = payload?.old;
        const newRow = payload?.new;
        if (!oldRow || !newRow) return;

        const wasPending = oldRow.status === "pending";
        const isPending = newRow.status === "pending";

        if (wasPending && !isPending) pendingCount = Math.max(0, pendingCount - 1);
        if (!wasPending && isPending) pendingCount = pendingCount + 1;
        updateNotifyBadgeTotal();
      }catch(e){
        console.error("UPDATE notify error", e);
      }
    })
    .subscribe(()=>{});
}

/* ====== friends UIDä¸€è¦§ï¼ˆéƒ¨å±‹ä½œæˆé€šçŸ¥ç”¨ï¼‰ ====== */
let friendUidsCache = [];
async function loadFriendUids(){
  if (!authUser?.id) return [];
  try{
    // friends ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆuser_a, user_bï¼‰å‰æ
    const { data, error } = await sb
      .from("friends")
      .select("user_a,user_b")
      .or(`user_a.eq.${authUser.id},user_b.eq.${authUser.id}`);
    if (error) throw error;

    const uids = [];
    for (const row of (data||[])){
      if (row.user_a === authUser.id) uids.push(row.user_b);
      else uids.push(row.user_a);
    }
    friendUidsCache = Array.from(new Set(uids.filter(Boolean)));
  }catch(e){
    console.error("loadFriendUids error", e);
    friendUidsCache = [];
  }
  return friendUidsCache;
}

/* ====== rooms INSERTï¼ˆãƒ•ãƒ¬ãƒ³ãƒ‰ãŒéƒ¨å±‹ä½œæˆï¼‰ ====== */
async function startRoomCreateNotifications(){
  if (!authUser?.id) return;
  const friendUids = await loadFriendUids();
  if (friendUids.length === 0) return;

  if (roomNotifyChannel){
    try{ await sb.removeChannel(roomNotifyChannel); }catch{}
    roomNotifyChannel = null;
  }

  roomNotifyChannel = sb
    .channel("room_create_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "rooms"
    }, async(payload)=>{
      const r = payload?.new;
      if (!r) return;
      if (!friendUids.includes(r.owner_id)) return;

      let ownerName = "ãƒ•ãƒ¬ãƒ³ãƒ‰";
      try{
        const { data } = await sb
          .from("profiles")
          .select("display_name")
          .eq("user_id", r.owner_id)
          .maybeSingle();
        if (data?.display_name) ownerName = data.display_name;
      }catch{}

      addNotify({
        id: "room_" + r.id,
        type: "room_create",
        title: "ğŸ  éƒ¨å±‹ãŒä½œæˆã•ã‚ŒãŸ",
        msg: `${ownerName} ã•ã‚“ãŒã€Œ${r.room_name}ã€ã‚’ä½œã£ãŸã‚ˆ`,
        from_uid: r.owner_id,
        from_name: ownerName,
        room_id: r.id,
        room_name: r.room_name,
        created_at: new Date().toISOString(),
        read: false
      });

      showToast({
        title: "ğŸ  ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒéƒ¨å±‹ã‚’ä½œæˆï¼",
        msg: `${ownerName} ã•ã‚“ãŒã€Œ${r.room_name}ã€ã‚’ä½œã£ãŸã‚ˆ`,
        onOpen: ()=>{
          location.href = `./room.html?room=${encodeURIComponent(r.room_name)}&room_id=${encodeURIComponent(r.id)}`;
        }
      });

      pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${ownerName} ã•ã‚“ãŒéƒ¨å±‹ã€Œ${r.room_name}ã€ã‚’ä½œæˆ`);
    })
    .subscribe();
}

/* ====== room_invitesï¼ˆæ‹›å¾…ï¼‰ ====== */
async function startRoomInviteNotifications(){
  if (!authUser?.id) return;

  if (inviteNotifyChannel){
    try{ await sb.removeChannel(inviteNotifyChannel); }catch{}
    inviteNotifyChannel = null;
  }

  inviteNotifyChannel = sb
    .channel("room_invite_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "room_invites",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      const inv = payload?.new;
      if (!inv) return;

      if (shownToastIds.has("inv_"+inv.id)) return;
      shownToastIds.add("inv_"+inv.id);

      let fromName = "ãƒ•ãƒ¬ãƒ³ãƒ‰";
      try{
        const { data } = await sb
          .from("profiles")
          .select("display_name")
          .eq("user_id", inv.from_user)
          .maybeSingle();
        if (data?.display_name) fromName = data.display_name;
      }catch{}

      addNotify({
        id: "inv_" + inv.id,
        type: "room_invite",
        title: "ğŸ“© éƒ¨å±‹æ‹›å¾…",
        msg: `${fromName} ã•ã‚“ã‹ã‚‰ã€Œ${inv.room_name}ã€ã«æ‹›å¾…ãŒæ¥ãŸã‚ˆ`,
        from_uid: inv.from_user,
        from_name: fromName,
        room_id: inv.room_id,
        room_name: inv.room_name,
        created_at: new Date().toISOString(),
        read: false
      });

      showToast({
        title: "ğŸ“© éƒ¨å±‹æ‹›å¾…ãŒæ¥ãŸï¼",
        msg: `${fromName} ã•ã‚“ã‹ã‚‰ã€Œ${inv.room_name}ã€ã«æ‹›å¾…ãŒæ¥ãŸã‚ˆ`,
        onOpen: ()=>{
          location.href = `./room.html?room=${encodeURIComponent(inv.room_name)}&room_id=${encodeURIComponent(inv.room_id)}`;
        }
      });

      pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${fromName} ã•ã‚“ã‹ã‚‰éƒ¨å±‹æ‹›å¾…ã€Œ${inv.room_name}ã€`);
    })
    .subscribe();
}

/* ====== åˆæœŸåŒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ ====== */
function initNotify(){
  loadNotifyInbox();
  updateNotifyBadgeTotal();
  startFriendRequestNotifications();
  startRoomCreateNotifications();
  startRoomInviteNotifications();
}

</script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0d1a33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --muted2:rgba(234,242,255,.45);
      --good:#35d0a7;
      --warn:#ffb84d;
      --bad:#ff6b6b;
      --accent:#78a7ff;
      --accent2:#a68bff;
      --glow:rgba(120,167,255,.45);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(120,167,255,.20), transparent 55%),
        radial-gradient(900px 500px at 80% 40%, rgba(166,139,255,.18), transparent 55%),
        radial-gradient(800px 700px at 30% 90%, rgba(53,208,167,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(6,10,20,.78), rgba(6,10,20,.50));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbarInner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(120,167,255,.95), rgba(166,139,255,.65) 55%, rgba(53,208,167,.35));
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 10px 26px rgba(120,167,255,.18);
    }
    .brandText b{ display:block; font-size:14px; letter-spacing:.3px; }
    .brandText span{ display:block; font-size:12px; color:var(--muted); margin-top:2px; }

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      box-shadow: 0 10px 20px rgba(0,0,0,.14);
    }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(120,167,255,.35), rgba(166,139,255,.25));
      border-color: rgba(120,167,255,.35);
      box-shadow: 0 12px 26px rgba(120,167,255,.14);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,107,107,.25), rgba(166,139,255,.10));
      border-color: rgba(255,107,107,.35);
    }
    .pill{
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

.avatar{
  width:26px;height:26px;border-radius:50%;
  object-fit:cover;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  flex:0 0 auto;
}
.avatar.sm{ width:22px;height:22px; }
.avatarFallback{
  width:26px;height:26px;border-radius:50%;
  display:inline-flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:900;
  color:rgba(234,242,255,.9);
  border:1px solid rgba(255,255,255,.14);
  background: radial-gradient(circle at 30% 30%, rgba(120,167,255,.35), rgba(166,139,255,.22));
  flex:0 0 auto;
  user-select:none;
}
.avatarFallback.sm{ width:22px;height:22px;font-size:11px; }
.userBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  cursor:pointer;
  color:var(--muted);
  font-size:12px;
}
.userBtn:hover{ background: rgba(255,255,255,.06); }
.userLink{ cursor:pointer; }
.userLink:hover{ text-decoration: underline; opacity:.95; }

.nameText{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width: 240px;
}

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px 14px 26px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .brand{ min-width:auto; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .cardHeader b{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      letter-spacing:.2px;
    }
    .chip{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .cardBody{ padding:14px; }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }
    .field label{ font-size:12px; color:var(--muted); }
    input[type="text"], input[type="file"], textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,12,24,.45);
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(234,242,255,.45); }
    .hint{ font-size:12px; color:var(--muted2); line-height:1.5; }

    .statusRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(7,12,24,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius: 16px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(234,242,255,.25);
      box-shadow: 0 0 0 3px rgba(234,242,255,.06);
      flex:0 0 auto;
    }
    .dot.ok{ background: var(--good); box-shadow: 0 0 0 3px rgba(53,208,167,.18); }
    .dot.ng{ background: var(--bad); box-shadow: 0 0 0 3px rgba(255,107,107,.18); }
    .statusText{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }
    .statusText b{ font-size:12px; }
    .statusText span{ font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .divider{ height:1px; background: rgba(255,255,255,.08); margin:14px 0; }

    /* ===== call area ===== */
    .callTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      justify-content:space-between;
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
    }
    .btnAccent{
      background: linear-gradient(135deg, rgba(53,208,167,.20), rgba(120,167,255,.15));
      border-color: rgba(53,208,167,.30);
    }
    .btnAccent2{
      background: linear-gradient(135deg, rgba(120,167,255,.22), rgba(166,139,255,.18));
      border-color: rgba(120,167,255,.30);
    }
    .btnMuted{
      background: rgba(255,255,255,.05);
    }
    .rangeRow{
      margin-top:10px;
      background: rgba(7,12,24,.30);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .rangeRow .label{
      font-size:12px; color:var(--muted);
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    /* ===== lists ===== */
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    /* ===== member grid (ã‚¹ãƒãƒ›ã§3åˆ—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³å¤§ãã‚) ===== */
    .memberGrid{ display:flex; flex-direction:column; gap:8px; }

    @media (max-width: 560px){
      .memberGrid{
        display:grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap:10px;
      }
      .memberGrid .listItem{
        flex-direction:column;
        align-items:center;
        justify-content:flex-start;
        text-align:center;
        gap:8px;
        padding:12px 8px;
        position:relative;
      }
      .memberGrid .avatar,
      .memberGrid .avatarFallback{
        width:56px;
        height:56px;
      }
      .memberGrid .avatarFallback{ font-size:20px; }
      .memberGrid .listMain{ align-items:center; width:100%; }
      .memberGrid .listTitle{
        width:100%;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }
      .memberGrid .listSub{ display:none; }
      .memberGrid .chip{
        position:absolute;
        top:6px;
        right:6px;
      }

      /* é€šè©±ä¸­ä¸€è¦§ã®åˆ¥ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã«ã‚‚åŠ¹ã‹ã›ã‚‹ */
      .memberGrid .name{
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:8px;
      }
      .memberGrid .sub{ display:none; }
      .memberGrid .nameText{
        display:block;
        width:100%;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }
    }

.listItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,12,24,.25);
    }
    .listItem .name{
      font-size:13px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .listItem .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge{
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--muted);
    }
    
    .badge.admin{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.20));
      color: var(--text);
      font-weight: 900;
    }
.badge.good{ border-color: rgba(53,208,167,.30); color: rgba(165,255,230,.95); background: rgba(53,208,167,.10); }
    .badge.warn{ border-color: rgba(255,184,77,.35); color: rgba(255,220,170,.95); background: rgba(255,184,77,.10); }
    .badge.bad{ border-color: rgba(255,107,107,.35); color: rgba(255,190,190,.95); background: rgba(255,107,107,.10); }

    /* ===== right side ===== */
    .rightCol{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }
    .chatBox{
      height: 520px;
      overflow:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background: rgba(7,12,24,.25);
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.08);
    }
    @media (max-width: 980px){
      .chatBox{ height: 50vh; }
    }
    .msgHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .msgMeta{ color: rgba(234,242,255,.40); font-size:11px; }

    .msgActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .trashBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(234,242,255,.85);
      padding:6px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      line-height:1;
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .trashBtn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
    }
    .trashBtn:active{ transform: translateY(1px); }

    .msgBody{
      font-size:14px;
      line-height:1.5;
      color:var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    /* â˜…æœŸé™åˆ‡ã‚Œè¡¨ç¤ºç”¨ */
    .msgExpired{
      font-size:13px;
      line-height:1.5;
      color: rgba(234,242,255,.55);
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 6px;
    }
    .msgImg{
      margin-top:8px;
      width:100%;
      max-width:520px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 22px rgba(0,0,0,.22);
    }
    .composer{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
    }
    .composer .left{
      display:flex; flex-direction:column; gap:10px;
      min-width:0;
    }
    .composer textarea{
      min-height: 52px;
      resize: vertical;
    }
    .composer .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .fileRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(7,12,24,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius: 16px;
    }
    .fileName{
      font-size:12px; color:var(--muted);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .tiny{ font-size:11px; color: rgba(234,242,255,.45); }
    details{
      border-top:1px solid rgba(255,255,255,.08);
      margin-top:14px;
      padding-top:10px;
    }
    summary{ cursor:pointer; color: var(--muted); font-size:12px; }
    #debugLog{
  margin-top:10px;
  white-space:pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  font-size:12px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,10);
  background: rgba(7,12,24,35);
  max-height: 200px;
  overflow:auto;
  color: rgba(234,242,255,78);
}


    /* ===== audio cards ===== */
    #audios{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .audioWrap{
      background: rgba(7,12,24,.35);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:12px;
      overflow:hidden;
    }
    .audioTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-size:12px;
      color:var(--muted);
    }
    .audioCtl{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius: 16px;
    }
    .audioCtl .lbl{ font-size:12px; color:var(--muted); }
    .audioCtl .val{ font-size:12px; color:var(--text); min-width: 34px; text-align:right; }
  
/* ===================
   ğŸ“± Mobile Bottom Nav (iOSã£ã½ã„å›ºå®šãƒŠãƒ“)
   =================== */
body{ padding-bottom: 78px; } /* ãƒŠãƒ“ã®åˆ†ã ã‘ä¸‹ã«ä½™ç™½ */
.bottomNav{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  z-index: 9999;
  padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
  background: linear-gradient(180deg, rgba(6,10,20,.20), rgba(6,10,20,.86));
  backdrop-filter: blur(16px);
  border-top: 1px solid rgba(255,255,255,.10);
}
.bottomNavInner{
  max-width: 1100px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}
.navBtn{
  appearance:none;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(234,242,255,.78);
  border-radius: 18px;
  padding: 10px 6px;
  cursor: pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  min-height: 52px;
  box-shadow: 0 12px 22px rgba(0,0,0,.16);
}
.navBtn:hover{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.16); }
.navBtn:active{ transform: translateY(1px); }
.navIcon{ font-size: 18px; line-height: 1; }
.navLabel{ font-size: 10px; line-height: 1; color: rgba(234,242,255,.55); font-weight: 800; letter-spacing:.2px; }
.navBtn.active{
  background: linear-gradient(135deg, rgba(120,167,255,.22), rgba(166,139,255,.16));
  border-color: rgba(120,167,255,.35);
  color: rgba(234,242,255,.92);
}
.navBtn.active .navLabel{ color: rgba(234,242,255,.72); }

/* è¨­å®šã‚·ãƒ¼ãƒˆï¼ˆç°¡æ˜“ï¼‰ */
.sheetBackdrop{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(4px);
  z-index: 10000;
  display:none;
}
.sheet{
  position:absolute;
  left: 10px; right: 10px; bottom: calc(10px + env(safe-area-inset-bottom));
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 22px;
  box-shadow: 0 22px 60px rgba(0,0,0,.45);
  overflow:hidden;
}
.sheetHead{
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  color: rgba(234,242,255,.75);
  font-size: 12px;
  display:flex; align-items:center; justify-content:space-between;
}
.sheetBtns{
  padding: 12px 14px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.sheetBtns .btn{ flex: 1 1 140px; justify-content:center; }

/* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸Šã®ãƒœã‚¿ãƒ³ç¾¤ã‚’å°‘ã—è»½ãè¦‹ã›ã‚‹ */
@media (max-width: 980px){
  .topActions .btn{ padding: 10px 12px; }
  .topActions .btn span{ display:none; }
}

  
.toastWrap{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      width:min(380px, calc(100vw - 28px));
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(15,26,44,.92);
      box-shadow:var(--shadow);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation:toastIn .18s ease-out;
    }
    @keyframes toastIn{
      from{ transform:translateY(8px); opacity:0; }
      to{ transform:translateY(0); opacity:1; }
    }
    .toastTitle{ font-weight:900; margin-bottom:4px; }
    .toastMsg{ font-size:12px; color:var(--muted); line-height:1.5; }
    .toastBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    
/* ===== ğŸ”” é€šçŸ¥ã‚’ãƒ­ãƒ“ãƒ¼ã¨åŒã˜è‰²ã«çµ±ä¸€ ===== */

/* é€šçŸ¥1ä»¶ï¼ˆç™½ãè¦‹ãˆã¦ãŸå››è§’ï¼‰ */
#notifyPanel .nItem{
  background: rgba(7,12,24,.25) !important;   /* â† ãƒ­ãƒ“ãƒ¼ã¨åŒã˜ */
  border: 1px solid rgba(255,255,255,.08) !important;
  box-shadow: none !important;
}

/* æ—¢èª­ãƒ»æœªèª­ã©ã¡ã‚‰ã‚‚åŒã˜ãƒ™ãƒ¼ã‚¹è‰² */
#notifyPanel .nItem:hover{
  background: rgba(7,12,24,.35) !important;
}




/* ===== ğŸ”” Notify: ãƒ­ãƒ“ãƒ¼ã¨åŒã˜è¦‹ãŸç›®ï¼‹ã‚¹ãƒãƒ›æœ€é©åŒ– ===== */
#notifyPanel{
  background: var(--bg1) !important;
  border:1px solid rgba(255,255,255,.10) !important;
  box-shadow: var(--shadow) !important;
}
#notifyPanel .cardHeader{
  background: rgba(7,12,24,.35) !important;
  border-bottom:1px solid rgba(255,255,255,.10) !important;
}
#notifyPanel .cardBody{ background: transparent !important; }

/* é€šçŸ¥ãƒªã‚¹ãƒˆã¯ãƒ­ãƒ“ãƒ¼/ãƒ«ãƒ¼ãƒ ã® listItem ã‚’ãã®ã¾ã¾ä½¿ã† */
#notifyPanel .notifyList{ margin:0; }
#notifyPanel .nItem{
  background: rgba(7,12,24,.25) !important;  /* ãƒ­ãƒ“ãƒ¼ã® listItem ã¨åŒç³» */
  border:1px solid rgba(255,255,255,.08) !important;
  box-shadow:none !important;
  align-items:flex-start;
}
#notifyPanel .nItem:hover{ background: rgba(7,12,24,.35) !important; }
#notifyPanel .nItem.unread{ outline:1px solid rgba(110,231,255,.18); }

.notifyDot{
  color: var(--accent);
  font-size:12px;
  line-height:1;
  flex:0 0 auto;
}
.titleText{
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  display:block;
  max-width: 40vw;
}

/* å³å´ãƒœã‚¿ãƒ³ */
.notifyActions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  align-items:center;
  flex:0 0 auto;
}
.notifyActions .btn{ padding:8px 10px; border-radius:12px; font-size:12px; }

/* ã‚¹ãƒãƒ›ï¼šé€šçŸ¥ãƒ‘ãƒãƒ«ã‚’ç”»é¢å¹…ã„ã£ã±ã„ï¼†ãƒœã‚¿ãƒ³ã‚’ä¸‹ã¸ */
@media (max-width: 560px){
  #notifyPanel{
    right:10px !important;
    left:10px !important;
    top:64px !important;
    width: auto !important;
    max-height: calc(100vh - 88px);
    overflow:auto;
  }
  #notifyPanel .nItem{
    flex-direction:column;
    align-items:stretch;
    gap:10px;
  }
  .titleText{ max-width: 100%; }
  .notifyActions{
    justify-content:flex-start;
  }
}

</style>

<script>
window.toggleNotifyPanel = window.toggleNotifyPanel || function(){
  const panel = document.getElementById("notifyPanel");
  if (!panel) return;
  const open = panel.style.display !== "block";
  panel.style.display = open ? "block" : "none";
};
</script>

</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <b>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</b>
          <span id="subTitle">Room</span>
        </div>
      </div>
    <div id="notifyPanel" class="card" style="display:none; position:absolute; right:14px; top:64px; width:min(520px, calc(100vw - 28px)); z-index:9998;">
      <div class="cardHeader" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <b>ğŸ”” é€šçŸ¥</b>
        <div style="display:flex; gap:8px;">
          <button class="btn" onclick="markAllRead()">å…¨éƒ¨æ—¢èª­</button>
          <button class="btn" onclick="toggleNotifyPanel()">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div class="cardBody" style="padding:12px 12px;">
        <div id="notifyList"></div>
      </div>
    </div>


      <div class="topActions">
        <button class="userBtn" id="userPill" type="button" onclick="goProfile()">æœªãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="btn primary" onclick="goLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
        <button class="btn danger" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    <button class="notifyBtn" id="notifyBtn" onclick="toggleNotifyPanel()">ğŸ””<span class="badge" id="notifyBadge"></span></button>
    </div>
  </div>

  <div class="wrap">
    <!-- ===== left column ===== -->
    <div class="leftCol">
      <div class="card">
        <div class="cardHeader">
          <b>ğŸ  ç¾åœ¨ã®éƒ¨å±‹</b>
          <span class="chip" id="roomChip">-</span>
        </div>
        <div class="cardBody">
          <div class="field">
            <label>éƒ¨å±‹å</label>
            <input id="roomName" type="text" readonly />
          
            <div class="row" id="roomNameEditRow" style="display:none; gap:10px; flex-wrap:wrap;">
              <button class="btn btnSmall btnAccent2" type="button" id="saveRoomNameBtn" onclick="saveRoomName()">ğŸ’¾ éƒ¨å±‹åã‚’å¤‰æ›´</button>
              <button class="btn btnSmall" type="button" id="resetRoomNameBtn" onclick="resetRoomNameInput()">â†© å…ƒã«æˆ»ã™</button>
            </div>
            <div class="hint" id="roomNameHint">â€» éƒ¨å±‹åã¯æ ä¸»ã ã‘å¤‰æ›´ã§ãã¾ã™</div>
</div>
          <div class="row" id="roomActionRow" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btnSmall" onclick="leaveRoom()">ğŸšª é€€å®¤</button>
              <button class="btn btnSmall danger" id="deleteRoomBtn" style="display:none;" onclick="deleteRoomNow()">ğŸ—‘ éƒ¨å±‹ã‚’å‰Šé™¤</button>
          </div>

          <div style="margin-top:12px;" class="statusRow">
            <div class="statusText">
              <div class="dot" id="readyDot"></div>
              <div style="min-width:0;">
                <b id="readyTitle">æº–å‚™OK</b>
                <span id="readySub">å¾…æ©Ÿä¸­</span>
              </div>
            </div>
            <span class="badge good" id="readyBadge">Ready</span>
          </div>
        </div>
      </div>
      <div class="card" id="adminCard" style="display:none;">
        <div class="cardHeader">
          <b>ğŸ›¡ï¸ æ ä¸»ãƒ„ãƒ¼ãƒ«ï¼ˆKick / Ban / å¼·åˆ¶ãƒ­ãƒ“ãƒ¼æˆ»ã—ï¼‰</b>
          <span class="chip">æ ä¸»</span>
        </div>
        <div class="cardBody">
          <div class="hint">â€» ã“ã®éƒ¨å±‹ã®ã€Œä»Šå›ã®éƒ¨å±‹(roomsã®1è¡Œ)ã€ã ã‘ã«åŠ¹ãã€‚éƒ¨å±‹ã‚’å‰Šé™¤â†’åŒåã§ä½œã‚Šç›´ã—ã¦ã‚‚å‰ã®Banã¯å¼•ãç¶™ãŒã‚Œãªã„ã€‚</div>

          <div class="divider"></div>

          <div class="field">
            <label>å¯¾è±¡ï¼ˆä»Šã®éƒ¨å±‹ã«ã„ã‚‹/æœ€è¿‘ç™ºè¨€ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</label>
            <div class="list" id="adminUsersList">
              <div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆæ‰‹å…¥åŠ›ã‚‚OKï¼‰</label>
            <input id="adminTargetUid" type="text" placeholder="uuid" />
            <div class="hint">ä¸Šã®ãƒªã‚¹ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŠ¼ã™ã¨è‡ªå‹•ã§å…¥ã‚‹</div>
          </div>

          <div class="field">
            <label>ç†ç”±ï¼ˆç›¸æ‰‹ã«è¡¨ç¤ºï¼‰</label>
            <input id="adminReason" type="text" placeholder="ä¾‹: è¿·æƒ‘è¡Œç‚ºã®ãŸã‚" />
          </div>

          <div class="row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btnSmall btnAccent2" type="button" onclick="kickUser()">ğŸ‘¢ Kick</button>
            <button class="btn btnSmall danger" type="button" onclick="banUser()">â›” Ban</button>
            <button class="btn btnSmall danger" type="button" onclick="forceBackAll()">âš  å…¨å“¡ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã™</button>
          </div>

          <div class="hint" style="margin-top:10px;">Kick/Ban ã¯ãã®ç¬é–“ãƒ«ãƒ¼ãƒ ã«ã„ã‚‹äººã‚’ãƒ­ãƒ“ãƒ¼ã«æˆ»ã™ï¼ˆç†ç”±ä»˜ãï¼‰ã€‚Ban ã¯å†å…¥å®¤ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã€‚</div>
        
<div class="divider"></div>
<div class="field">
  <label>ğŸ‘¥ ã‚µãƒ–æ ä¸»ï¼ˆKickã®ã¿ï¼‰</label>
  <input id="subOwnerUidInput" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼UID" />
  <div style="display:flex; gap:8px; margin-top:6px;">
    <button class="btn btnSmall" type="button" onclick="addSubOwner()">â• è¿½åŠ </button>
  </div>
  <div class="list" id="subOwnerList" style="margin-top:8px;"></div>
  <div class="hint">â€» ã‚µãƒ–æ ä¸»ã¯ Kick ã®ã¿å¯èƒ½ï¼ˆBanä¸å¯ï¼‰</div>
</div>
</div>
      </div>


      
      <!-- ===== friend invite ===== -->
      <div class="card" id="inviteCard" style="display:none;">
        <div class="cardHeader">
          <b>ğŸ“© ãƒ•ãƒ¬ãƒ³ãƒ‰æ‹›å¾…ï¼ˆã“ã®éƒ¨å±‹ã¸ï¼‰</b>
          <span class="chip" id="inviteChip">Invite</span>
        </div>
        <div class="cardBody">
          <div class="field" style="margin-bottom:10px;">
            <label>ãƒ•ãƒ¬ãƒ³ãƒ‰æ¤œç´¢ï¼ˆè¡¨ç¤ºåï¼‰</label>
            <input id="inviteSearch" type="text" placeholder="ä¾‹ï¼šã‚†ã‚‹ãŸã¾" />
            <div class="hint">â€» æ‹›å¾…ã¯ã€Œç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é€šçŸ¥ã€ã«å±Šãæƒ³å®šï¼ˆroom_invitesï¼‰ã€‚</div>
          </div>

          <div class="list" id="inviteList">
            <div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
          </div>
        </div>
      </div>

<div class="card" id="callSection">
        <div class="cardHeader">
          <b>ğŸ™ï¸ éŸ³å£°é€šè©±ï¼ˆè¤‡æ•°äººï¼‰</b>
          <span class="chip">Call</span>
        </div>
        <div class="cardBody">
          <div class="callTop">
            <button class="btn btnSmall primary btnAccent2" onclick="joinCall()" id="joinBtn">é€šè©±ã«å‚åŠ ï¼ˆé–‹å§‹ï¼‰</button>
            <button class="btn btnSmall btnMuted" onclick="toggleMute()" id="muteBtn">ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF</button>
            <button class="btn btnSmall danger" onclick="leaveCall()" id="leaveBtn">é€šè©±é€€å‡º</button>
          </div>

          <div class="rangeRow">
            <div class="label">
              <span>è‡ªåˆ†ã®ãƒã‚¤ã‚¯éŸ³é‡: <b id="micGainLabel">100</b></span>
              <span class="tiny">â€» é€ä¿¡éŸ³é‡ï¼ˆã‚ãªãŸã®å£°ã®å¤§ãã•ï¼‰</span>
            </div>
            <input id="micGain" type="range" min="1" max="100" value="100" />
            <div class="hint" style="margin-top:8px;" id="callState">æœªæ¥ç¶šï¼ˆå¿…è¦ãªã‚‰é€šè©±ã«å‚åŠ ã‚’æŠ¼ã—ã¦ã­ï¼‰</div>
          </div>

          <div class="divider"></div>

          <div class="card" style="background:transparent;border:none;box-shadow:none;">
            <div class="cardHeader" style="border:1px solid rgba(255,255,255,.08); border-radius:18px; margin-bottom:10px;">
              <b>ğŸ‘¥ å‚åŠ è€…ï¼ˆé€šè©±ï¼šãƒãƒ£ãƒ³ãƒãƒ«æ¥ç¶šä¸­ã®ã¿è¡¨ç¤ºï¼‰</b>
              <span class="chip">Presence</span>
            </div>
            <div class="list memberGrid" id="callUsersList">
              <div class="hint">æœªæ¥ç¶š</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="card" style="background:transparent;border:none;box-shadow:none;">
            <div class="cardHeader" style="border:1px solid rgba(255,255,255,.08); border-radius:18px; margin-bottom:10px;">
              <b>ğŸ“ ä»Šã®éƒ¨å±‹ã§é€šè©±ã—ã¦ã‚‹äººï¼ˆé€šè©±ã«å‚åŠ ã—ãªãã¦ã‚‚è¦‹ãˆã‚‹ï¼‰</b>
              <span class="chip">call_participants</span>
            </div>
            <div class="list memberGrid" id="activeCallUsersList">
              <div class="hint">ä»Šã¯èª°ã‚‚é€šè©±ã—ã¦ãªã„ã‚ˆ</div>
            </div>
          
          <div class="card" style="background:transparent;border:none;box-shadow:none;">
            <div class="cardHeader" style="border:1px solid rgba(255,255,255,.08); border-radius:18px; margin-bottom:10px;">
              <b>ğŸ‘¥ ã“ã®éƒ¨å±‹ã«ã„ã‚‹äººï¼ˆå…¥å®¤ã—ã¦ã‚‹äººï¼‰</b>
              <span class="chip">room_members</span>
            </div>
            <div class="list memberGrid" id="roomMembersList">
              <div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            </div>
            <div class="hint" style="margin-top:6px;">â€» ã“ã“ã¯ã€Œé€šè©±ã«å‚åŠ ã—ã¦ãªã„äººã€ã‚‚å«ã‚€ã‚ˆã€‚æ ä¸»ã¯åå‰ã‚’æŠ¼ã™ã¨Kick/Banã®å¯¾è±¡ã«å…¥ã‚‹ã€‚</div>
          </div>
</div>

          <details>
            <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
            <div id="log"></div>
          </details>
        </div>
      </div>
    </div>

    <!-- ===== right column ===== -->
    <div class="rightCol">
      <div class="card">
        <div class="cardHeader">
          <b>ğŸ”Š ç›¸æ‰‹ã®éŸ³å£°ï¼ˆã“ã“ã§ç›¸æ‰‹ã®éŸ³é‡ã‚’èª¿æ•´ï¼‰</b>
          <span class="chip">Audio</span>
        </div>
        <div class="cardBody">
          <div id="audios"></div>
          <div class="hint" style="margin-top:10px;">
            â€» é€šè©±ã«å‚åŠ ã—ã¦ã€ç›¸æ‰‹ã¨ç¹‹ãŒã‚‹ã¨ã“ã“ã«éŸ³å£°ãŒå‡ºã‚‹ã‚ˆ
          </div>
        </div>
      </div>

      <div class="card" id="chatSection">
        <div class="cardHeader">
          <b>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆï¼ˆç”»åƒOKï¼‰</b>
          <span class="chip">Messages</span>
        </div>
        <div class="cardBody">
          <div id="chat" class="chatBox"></div>

          <div class="divider"></div>

          <div class="composer">
            <div class="left">
              <textarea id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç”»åƒã ã‘é€ã‚‹ãªã‚‰ç©ºã§ã‚‚OKï¼‰"></textarea>

              <div class="fileRow">
                <div class="fileName" id="imgName">æœªé¸æŠ</div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <input id="imgFile" type="file" accept="image/*" style="max-width:190px;" />
                </div>
              </div>

              <div class="hint" id="uploadHint" style="margin-top:-2px;">
                â€» ç”»åƒã¯ Storageï¼ˆpublicï¼‰ã«ã‚¢ãƒƒãƒ—â†’URLã‚’ãƒãƒ£ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã‚ˆï¼ˆ5MBã¾ã§ï¼‰
              </div>
            </div>

            <div class="actions">
              <button class="btn primary" onclick="sendMsg()">ğŸ“¨ é€ä¿¡</button>
              <button class="btn btnAccent2" onclick="sendImage()" id="sendImgBtn">ğŸ–¼ï¸ ç”»åƒé€ä¿¡</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
    const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

/* â˜…ãƒ­ã‚°ã‚¤ãƒ³åˆ‡ã‚Œå¯¾ç­–ï¼špkce/persistSession ã‚ã‚Š */
const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);
// ===== é‹å–¶åˆ¤å®šï¼ˆIDãƒ™ãƒ¼ã‚¹ãƒ»å®‰å…¨ï¼‰=====
function isAdmin(user){
  return user?.app_metadata?.is_admin === true || isAdminUserId(user?.id);
}


// ===== é‹å–¶ï¼ˆAdminï¼‰åˆ¤å®šï¼šåå‰ã§ã¯ãªã user_id ã§åˆ¤å®šã™ã‚‹ï¼ˆãªã‚Šã™ã¾ã—é˜²æ­¢ï¼‰=====
// ã“ã“ã«ã€Œé‹å–¶ã«ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã€ã‚’å…¥ã‚Œã¦ã­ï¼ˆSupabase Auth ã® user.idï¼‰
// ä¾‹: const ADMIN_UIDS = ["aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"];
const ADMIN_UIDS = [
  "054b7993-499d-45a7-ae15-c9f0e37bd2b9",
  "5f96d1c0-088e-4125-8670-e0fef1b563a6",
];

function isAdminUserId(userId){
  const uid = String(userId || "").trim();
  if (!uid) return false;
  return ADMIN_UIDS.includes(uid);
}
function adminBadgeHtmlByUserId(userId){
  if (!userId) return "";

  let html = "";

  if (userId === roomOwnerId){
    html += `<span class="badge admin">æ ä¸»</span>`;
  }
  if (SUB_OWNER_UIDS.includes(userId)){
    html += `<span class="badge warn">ã‚µãƒ–æ ä¸»</span>`;
  }
  if (isAdminUserId(userId)){
    html += `<span class="badge admin">é‹å–¶</span>`;
  }

  return html;
}


// ===== Sub Owner (Kick only / DBä¿å­˜ç‰ˆ) =====
const SUB_OWNER_UIDS = [];

// è‡ªåˆ†ã®UIDï¼ˆã‚ãªãŸã®æ—¢å­˜é–¢æ•°ãŒã‚ã‚‹å‰æã€‚ç„¡ã‘ã‚Œã° authUser?.id ã‚’ä½¿ã£ã¦ã­ï¼‰
function myUid(){
  return authUser?.id || "";
}

// ã‚µãƒ–æ ä¸»ã‹ï¼Ÿ
function isSubOwner(){
  const uid = myUid();
  if (!uid) return false;
  return SUB_OWNER_UIDS.includes(uid);
}

// Kickã§ãã‚‹ã‹
function canKick(){
  return isOwner || isSubOwner();
}

// Banã§ãã‚‹ã‹ï¼ˆæ ä¸»ã®ã¿ï¼‰
function canBan(){
  return isOwner;
}

// DBã‹ã‚‰ã‚µãƒ–æ ä¸»ä¸€è¦§ã‚’å–å¾—
async function loadSubOwnersFromDb(){
  if (!roomId) return;

  const { data, error } = await sb
    .from("room_subowners")
    .select("user_id")
    .eq("room_id", roomId);

  if (error){
    console.error("loadSubOwnersFromDb error", error);
    return;
  }

  SUB_OWNER_UIDS.length = 0;
  for (const r of (data || [])){
    if (r?.user_id) SUB_OWNER_UIDS.push(r.user_id);
  }

  renderSubOwners();
}

// è¡¨ç¤º
function renderSubOwners(){
  const box = document.getElementById("subOwnerList");
  if (!box) return;

  box.innerHTML = "";
  SUB_OWNER_UIDS.forEach(uid=>{
    const row = document.createElement("div");
    row.className = "listItem";
    row.innerHTML =
      '<div class="name">' + uid + '</div>' +
      (isOwner
        ? '<button class="btn btnSmall danger" type="button" onclick="removeSubOwner(\'' + uid + '\')">å‰Šé™¤</button>'
        : '');
    box.appendChild(row);
  });
}

// è¿½åŠ ï¼ˆæ ä¸»ã ã‘ï¼‰
async function addSubOwner(){
  if (!isOwner) return alert("æ ä¸»ã ã‘ï¼");
  const input = document.getElementById("subOwnerUidInput");
  const uid = (input?.value || "").trim();
  if (!uid) return alert("subOwner uid ã‚’å…¥ã‚Œã¦ã­ï¼");

  // è‡ªåˆ†ã‚’ã‚µãƒ–æ ä¸»ã«ã™ã‚‹ã®ã¯ä¸è¦
  if (uid === myUid()) return alert("è‡ªåˆ†è‡ªèº«ã¯è¿½åŠ ã—ãªãã¦OKï¼ï¼ˆæ ä¸»ã¯å¸¸ã«æ¨©é™ã‚ã‚‹ï¼‰");

  const { error } = await sb.from("room_subowners").insert({
    room_id: roomId,
    user_id: uid
  });

  if (error){
    console.error("addSubOwner error", error);
    return alert("è¿½åŠ ã§ããªã‹ã£ãŸ: " + (error.message || ""));
  }

  if (input) input.value = "";
  await loadSubOwnersFromDb();
ã€€updateTop();
 // æ—¢å­˜ã®ã‚ãªãŸã®é–¢æ•°æƒ³å®š
}

// å‰Šé™¤ï¼ˆæ ä¸»ã ã‘ï¼‰
async function removeSubOwner(uid){
  if (!isOwner) return;

  const { error } = await sb
    .from("room_subowners")
    .delete()
    .eq("room_id", roomId)
    .eq("user_id", uid);

  if (error){
    console.error("removeSubOwner error", error);
    return alert("å‰Šé™¤ã§ããªã‹ã£ãŸ: " + (error.message || ""));
  }

  await loadSubOwnersFromDb();
ã€€updateTop();
 // æ—¢å­˜ã®ã‚ãªãŸã®é–¢æ•°æƒ³å®š
}



/* ç”»åƒç”¨ï¼ˆPublic bucketåï¼‰ */
const IMAGE_BUCKET = "chat-images";
const MAX_IMAGE_BYTES = 5 * 1024 * 1024; // 5MB

/* â˜… ç”»åƒã ã‘æŠ•ç¨¿ã®ãƒ€ãƒŸãƒ¼æ–‡å­—ï¼ˆDBåˆ¶ç´„å›é¿ç”¨ï¼‰ */
const IMAGE_PLACEHOLDER = "[image]";

/* ===== çŠ¶æ…‹ ===== */
let authUser = null;
  try{ initNotify(); }catch(e){ console.warn("initNotify fail", e); }
let room = "";
let roomId = "";
let roomOwnerId = "";
let isOwner = false;
let name = "";
let myAvatarUrl = "";

let messagesChannel = null;

/* ===== call_participants ç›£è¦–ï¼ˆé€šè©±ä¸­ä¸€è¦§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰ ===== */
let callUsersChannel = null;

/* ===== room_members ç›£è¦–ï¼ˆéƒ¨å±‹ã«ã„ã‚‹äººä¸€è¦§ï¼‰ ===== */
let roomMembersChannel = null;

/* ===== room_events ç›£è¦–ï¼ˆkick/ban/forcebackï¼‰ ===== */
let roomEventsChannel = null;

/* ===== rooms ç›£è¦–ï¼ˆéƒ¨å±‹åãªã©ï¼‰ ===== */
let roomInfoChannel = null;
let roomNameSaveLock = false; // äºŒé‡é€ä¿¡é˜²æ­¢

let subOwnersChannel = null;

/* ===== é€šè©± ===== */
// ï¼ˆé€šè©±ã®çŠ¶æ…‹å¤‰æ•°ã¯ä¸‹ã®ã€Œé€šè©±ï¼ˆå®‰å®šç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®£è¨€ã—ã¦ã„ã¾ã™ï¼‰

/* ===== util ===== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[room]", ...args);

  const el = document.getElementById("log");
  if (el){
    el.textContent += s + "\n";
    el.scrollTop = el.scrollHeight;
  }
}





function setUploadHint(t){
  const el = document.getElementById("uploadHint");
  if (el) el.textContent = t;
}

function getRoomFromUrl(){
  const p = new URLSearchParams(location.search);
  return (p.get("room") || "").trim();
}

function getRoomIdFromUrl(){
  const p = new URLSearchParams(location.search);
  return (p.get("room_id") || "").trim();
}

function myUid(){
  return authUser?.id || "";
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function escapeAttr(s){
  return escapeHtml(s).replaceAll("`","&#096;");
}
function getInitial(s){
  const t = String(s || "").trim();
  if (!t) return "?";
  return Array.from(t)[0] || "?";
}
function normalizeAvatarUrl(url, ver){
  const u = String(url||"").trim();
  if (!u) return "";
  const v = String(ver||"").trim();
  if (!v) return u;
  return u + (u.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(v);
}
function avatarHtml(url, label, size="", ver=""){
  const cls = size ? `avatar ${size}` : "avatar";
  const fbCls = size ? `avatarFallback ${size}` : "avatarFallback";
  const u = normalizeAvatarUrl(url, ver);
  if (u){
    return `<img class="${cls}" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  }
  return `<div class="${fbCls}">${escapeHtml(getInitial(label))}</div>`;
}

// â˜…å¿…ãš avatarHtml ã®å¤–ï¼ˆã“ã“ï¼‰ã«ç½®ãï¼ï¼
function getPreferredAvatarMeta(){
  const um = authUser?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const url = hasCustom
    ? String(um.custom_avatar_url || "").trim()
    : String(um.avatar_url || "").trim();
  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();
  return { url, ver };
}

/* =================== ãƒŠãƒ“ =================== */
function goLobby(){
  location.href = "./lobby.html";
}
function goProfile(){
  const rn = encodeURIComponent(room || "");
  location.href = "./profile.html?back=room&room=" + rn + "&_r=" + Date.now();
}
async function doLogout(){
  await sb.auth.signOut();
  location.href = "./login.html";
}
function leaveRoom(){
  try{ deleteRoomMember(); }catch(e){}
  goLobby();
}

/* =================== è¡¨ç¤ºæ›´æ–° =================== */
function setReady(ok, sub){
  const dot = document.getElementById("readyDot");
  const subEl = document.getElementById("readySub");
  const badge = document.getElementById("readyBadge");

  if(ok){
    dot.classList.add("ok"); dot.classList.remove("ng");
    badge.className = "badge good";
    badge.textContent = "Ready";
  }else{
    dot.classList.add("ng"); dot.classList.remove("ok");
    badge.className = "badge bad";
    badge.textContent = "NG";
  }
  subEl.textContent = sub || "";
}

function updateTop(){
  const pill = document.getElementById("userPill");
  const dn = (authUser?.user_metadata?.display_name || "").trim();
  const em = (authUser?.email || "").trim();
  const shown = dn ? dn : (em ? em : "æœªãƒ­ã‚°ã‚¤ãƒ³");

  const avm = getPreferredAvatarMeta();
  pill.innerHTML = `${avatarHtml(avm.url, shown, "", avm.ver)} <span class="nameText">ğŸ‘¤ ${escapeHtml(shown)}</span>${adminBadgeHtmlByUserId(authUser.id)}`;
}

// ===== adminCard è¡¨ç¤ºåˆ¶å¾¡ =====
(function(){
  const origUpdateTop = updateTop;
  updateTop = function(){
    try{ origUpdateTop(); }catch{}

    const card = document.getElementById("adminCard");
    if (!card) return;

    card.style.display = "none";

    if (isOwner){
      card.style.display = "block";
    }else if (isSubOwner()){
      card.style.display = "block";

      const banBtn = card.querySelector('button[onclick="banUser()"]');
      const backAllBtn = card.querySelector('button[onclick="forceBackAll()"]');

      if (banBtn){
        banBtn.style.display = "none";
        banBtn.disabled = true;
      }
      if (backAllBtn){
        backAllBtn.style.display = "none";
        backAllBtn.disabled = true;
      }

      const editRow = document.getElementById("subOwnerEditRow");
      if (editRow){
        editRow.style.display = "none";
      }
    }

    renderSubOwners();
  };
})();





async function reloadName(){
  // authUser ã¯ requireLoginOrRedirect() ã§æœ€æ–°ã‚’å–ã‚Šç›´ã—ã¦ã„ã‚‹æƒ³å®š
  const dn = (authUser?.user_metadata?.display_name || "").trim();
  const em = (authUser?.email || "").trim();
  name = dn || em || "åç„¡ã—ã•ã‚“";

  // â˜…Googleãƒ­ã‚°ã‚¤ãƒ³å¯¾ç­–ï¼šcustom_avatar_url ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
  const avm = getPreferredAvatarMeta();
  myAvatarUrl = normalizeAvatarUrl(avm.url, avm.ver);

  // å…¥åŠ›æ¬„ãªã©ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§åæ˜ ã—ã¦OKï¼ˆä»Šã¯ãƒˆãƒƒãƒ—è¡¨ç¤ºã§ä½¿ã†ã ã‘ï¼‰
}

/* =================== ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆ =================== */
async function requireLoginOrRedirect(){
  const { data: ses, error: sesErr } = await sb.auth.getSession();
  if (sesErr) log("getSession error", sesErr);

  const sessionUser = ses?.session?.user || null;
  if (!sessionUser){
    location.href = "./login.html";
    return false;
  }

  // â˜…é‡è¦ï¼šrefreshSession ã¯è©°ã¾ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼ˆãƒ­ãƒ“ãƒ¼ã¨åŒã˜æ–¹é‡ï¼‰
  try{
    const t = Promise.race([
      sb.auth.refreshSession(),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('refreshSession timeout')), 20000))
    ]);
    await t;
  }catch(e){ log('refreshSession warn', e); }

  // â˜…è¿½åŠ ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°userã‚’å–ã‚Šç›´ã™
  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);

  authUser = u?.user || sessionUser;
  return true;
}
  
async function startSubOwnersRealtime(){
  if (!roomId) return;
  if (subOwnersChannel) return;

  subOwnersChannel = sb
    .channel("room-subowners-" + roomId)
    .on(
      "postgres_changes",
      { event:"*", schema:"public", table:"room_subowners", filter:`room_id=eq.${roomId}` },
      async ()=> {
        await loadSubOwnersFromDb(); // SUB_OWNER_UIDS ã‚’æ›´æ–°
        updateTop();                 // isSubOwner() ã®çµæœã§UIåˆ‡æ›¿
        if (canKick()) await loadRoomMembersForAdmin(); // æ¨©é™ãŒå¢—ãˆãŸç¬é–“ã«å€™è£œè¡¨ç¤ºã‚‚å‡ºã™
      }
    )
    .subscribe();
}
  /* ===================
   ğŸŸ¢ Online Heartbeatï¼ˆRoomç”¨ï¼‰
   =================== */
let onlineHeartbeatTimer = null;

async function heartbeatLastSeenRoom(){
  try{
    if (!authUser?.id) return;

    await sb.from("profiles").upsert({
      user_id: authUser.id,
      last_seen: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }, { onConflict: "user_id" });
  }catch(e){
    console.warn("heartbeatLastSeenRoom error", e);
  }
}

function startOnlineHeartbeatRoom(){
  // åˆå›å³æ›´æ–°
  heartbeatLastSeenRoom();

  // 60ç§’ã”ã¨ã«æ›´æ–°
  onlineHeartbeatTimer = setInterval(heartbeatLastSeenRoom, 60_000);

  // ã‚¿ãƒ–å¾©å¸°æ™‚ã‚‚å³æ›´æ–°
  document.addEventListener("visibilitychange", ()=>{
    if (!document.hidden){
      heartbeatLastSeenRoom();
    }
  });
}

/* =========================================================
   ãƒãƒ£ãƒƒãƒˆï¼ˆmessagesï¼‰
   ========================================================= */
async function startMessagesRealtime(){
  if (messagesChannel) return;

  messagesChannel = sb
    .channel("messages-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"messages_v3" }, async (payload)=>{
      const nr = payload.new || {};
      const or = payload.old || {};
      const rid = nr.room_id || or.room_id;
      if (rid === roomId) await loadMessages();
    })
    .subscribe();
}


function goUserProfile(uid){
  const id = String(uid || "").trim();
  if (!id) return;

  // profile.html ã¯ uid ãŒã‚ã‚‹ã¨ã€Œç›¸æ‰‹é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã€ã«ãªã‚‹ï¼ˆprofile(32)ã®å®Ÿè£…ï¼‰
  const p = new URLSearchParams();
  p.set("uid", id);
  p.set("back", "room");
  if (room) p.set("room", room);
  // room_id ãŒã‚ã‚Œã°æ¸¡ã™ï¼ˆprofileå´ãŒæœªä½¿ç”¨ã§ã‚‚å®³ãªã—ï¼‰
  if (roomId) p.set("room_id", roomId);

  location.href = "./profile.html?" + p.toString();
}

function fmtTime(iso){
  try{
    const d = new Date(iso);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }catch{
    return "";
  }
}

async function loadMessages(){
  if (!roomId) return;
  const { data, error } = await sb
    .from("messages_v3")
    .select("id, room_id, name, avatar_url, message, image_url, image_path, created_at, user_id, deleted, deleted_at, deleted_by")
    .eq("room_id", roomId)
    .order("created_at", { ascending:true })
    .limit(200);

  if (error){ log("loadMessages error", error); return; }

  // æ ä¸»ãƒ„ãƒ¼ãƒ«ç”¨ï¼šæœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œã‚’æ›´æ–°
    (data || []).forEach(mm=>{ if (mm.user_id) upsertRecentUser(mm.user_id, mm.name, mm.avatar_url); });
    renderAdminUsers();

    const box = document.getElementById("chat");
    box.innerHTML = "";

    (data || []).forEach(m=>{
      const wrap = document.createElement("div");

      const head = document.createElement("div");
      head.className = "msgHead";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.alignItems = "center";
      left.style.gap = "8px";
      left.innerHTML = `${avatarHtml(m.avatar_url, (m.name || ""), "sm")} <span class="nameText">${escapeHtml(m.name || "")}</span>${adminBadgeHtmlByUserId(m.user_id)}`;
      // â˜…åå‰/ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸
      left.classList.add("userLink");
      left.title = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹";
      left.onclick = ()=>{
        if (m.user_id) goUserProfile(m.user_id);
      };


      // å³å´ï¼ˆæ™‚åˆ» + å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
      const actions = document.createElement("div");
      actions.className = "msgActions";

      const meta = document.createElement("div");
      meta.className = "msgMeta";
      meta.textContent = fmtTime(m.created_at);

      actions.appendChild(meta);

      // âœ… è‡ªåˆ†ãŒé€ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã‚´ãƒŸç®±ã‚’è¡¨ç¤ºï¼ˆæœ¬äººã ã‘æ¶ˆã›ã‚‹ï¼‰
      if (m.user_id && m.user_id === myUid() && !m.deleted){
        const del = document.createElement("button");
        del.className = "trashBtn";
        del.type = "button";
        del.title = "è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤";
        del.textContent = "ğŸ—‘ï¸";
        del.onclick = async ()=>{
          await deleteMessage(m);
        };
        actions.appendChild(del);
      }

      head.appendChild(left);
      head.appendChild(actions);
      wrap.appendChild(head);

      const bodyText = (m.message || "").trim();
      const isImagePlaceholder = (bodyText === IMAGE_PLACEHOLDER);
      const hasImage = !!m.image_url;

      if (m.deleted){
        // âœ… å‰Šé™¤æ¸ˆã¿ï¼šæœ¬æ–‡ã‚„ç”»åƒã¯è¡¨ç¤ºã—ãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ã¯æ®‹ã™ï¼‰
        if (!isImagePlaceholder){
          const delMsg = document.createElement("div");
          delMsg.className = "msgExpired";
          delMsg.textContent = "ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
          wrap.appendChild(delMsg);
        }

        if (hasImage || isImagePlaceholder){
          const delImg = document.createElement("div");
          delImg.className = "msgExpired";
          delImg.textContent = "ğŸ—‘ï¸ ç”»åƒã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
          wrap.appendChild(delImg);
        }
      }else{
        // âœ… é€šå¸¸è¡¨ç¤º
        if (bodyText && !isImagePlaceholder){
          const body = document.createElement("div");
          body.className = "msgBody";
          body.textContent = bodyText;
          wrap.appendChild(body);
        }

        // âœ… ç”»åƒãŒã‚ã‚‹ãªã‚‰è¡¨ç¤º
        // âœ… ç”»åƒãŒã‚ã‚‹ãªã‚‰è¡¨ç¤º
  if (hasImage){
    const img = document.createElement("img");
    img.className = "msgImg";
    img.src = m.image_url;
    img.loading = "lazy";
    img.alt = "image";

    // â˜…è¿½åŠ ï¼šã‚µãƒ¼ãƒãƒ¼å´ã§å‰Šé™¤ã•ã‚Œã¦ãŸã‚‰ã€Œå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€ã«ç½®ãæ›ãˆã‚‹
    img.onerror = () => {
      try { img.remove(); } catch {}
      const delImg = document.createElement("div");
      delImg.className = "msgExpired";
      delImg.textContent = "ğŸ—‘ï¸ ç”»åƒã¯ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
      wrap.appendChild(delImg);
    };

    wrap.appendChild(img);
  }


        // âœ… æœŸé™åˆ‡ã‚Œã§ç”»åƒãŒæ¶ˆã•ã‚ŒãŸã‚±ãƒ¼ã‚¹ï¼š [image] ãªã®ã« image_url ãŒç„¡ã„
        if (isImagePlaceholder && !hasImage){
          const ex = document.createElement("div");
          ex.className = "msgExpired";
          ex.textContent = "ğŸ—‘ï¸ ç”»åƒã¯æœŸé™åˆ‡ã‚Œã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
          wrap.appendChild(ex);
        }
      }

      box.appendChild(wrap);
    });

    box.scrollTop = box.scrollHeight;
  }

async function sendMsg(){
  const v = document.getElementById("msg").value.trim();
  if (!v) return;
  document.getElementById("msg").value = "";

  const { error } = await sb.from("messages_v3").insert({
    room_id: roomId,
    name,
    avatar_url: myAvatarUrl,
    message: v,
    image_url: null,
    user_id: myUid()
  });

  if (error){ alert("é€ä¿¡å¤±æ•—: " + error.message); }
}

/* ===== ç”»åƒé€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‰ãªã„ç‰ˆï¼‰ ===== */
async function sendImage(){
  const btn = document.getElementById("sendImgBtn");
  const fileInput = document.getElementById("imgFile");
  const oldHint = document.getElementById("uploadHint")?.textContent || "";

  // ä½•ãŒã‚ã£ã¦ã‚‚ UI ã‚’æˆ»ã™ãŸã‚ã®é–¢æ•°
  const restoreUI = ()=>{
    try{ if (btn) btn.disabled = false; }catch{}
    try{ setUploadHint(oldHint || "â€» ç”»åƒã¯ Storageï¼ˆpublicï¼‰ã«ã‚¢ãƒƒãƒ—â†’URLã‚’ãƒãƒ£ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã‚ˆï¼ˆ5MBã¾ã§ï¼‰"); }catch{}
  };

  try{
    if (btn) btn.disabled = true;

    const file = fileInput?.files?.[0];
    if (!file){
      alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ï¼");
      return;
    }
    if (file.size > MAX_IMAGE_BYTES){
      alert("ç”»åƒãŒå¤§ãã™ãã‚‹ã‚ˆï¼ˆæœ€å¤§5MBï¼‰");
      return;
    }
    if (!room || !myUid()){
      alert("éƒ¨å±‹ or ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã­ï¼");
      return;
    }

    // â˜…è¡çªã—ãªã„ ID ã‚’ä½œã‚‹ï¼ˆcrypto.randomUUID ãŒç„¡ã„ç’°å¢ƒã‚‚è€ƒæ…®ï¼‰
    let uidPart = "";
    try{
      uidPart = (crypto?.randomUUID?.() || "");
    }catch{}
    if (!uidPart){
      uidPart = "u" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }

    const safeName = String(file.name || "image")
      .replace(/[^\w.\-]+/g, "_")
      .slice(0, 80);

    const roomKey = safeKey(room);

    // â˜…çµ¶å¯¾ã«è¢«ã‚‰ãªã„ãƒ‘ã‚¹
    const path = `${roomKey}/${myUid()}/${uidPart}_${safeName}`;

    setUploadHint("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");

    // â˜…ã‚³ã‚±ãªã„ãŸã‚ã« upsert:trueï¼ˆã“ã“ãŒé‡è¦ï¼‰
    const { error: upErr } = await sb
      .storage
      .from(IMAGE_BUCKET)
      .upload(path, file, {
        cacheControl: "60",     // 1åˆ†ï¼ˆé•·ã™ãã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥äº‹æ•…ã‚’é¿ã‘ã‚‹ï¼‰
        upsert: true,           // â˜…è¡çªã—ã¦ã‚‚ä¸Šæ›¸ã
        contentType: file.type || "image/*"
      });

    if (upErr) throw upErr;

    const { data: pub } = sb.storage.from(IMAGE_BUCKET).getPublicUrl(path);
    const imageUrl = pub?.publicUrl;
    if (!imageUrl) throw new Error("publicUrl ãŒå–å¾—ã§ããªã‹ã£ãŸâ€¦");

    // DBã«ä¿å­˜ï¼ˆç”»åƒã ã‘æŠ•ç¨¿ï¼‰
    const { error: insErr } = await sb.from("messages_v3").insert({
      room_id: roomId,
      name,
      avatar_url: myAvatarUrl,
      message: IMAGE_PLACEHOLDER,
      image_url: imageUrl,
      image_path: path,
      user_id: myUid()
    });

    if (insErr) throw insErr;

    // æˆåŠŸï¼šUIãƒªã‚»ãƒƒãƒˆ
    try{ fileInput.value = ""; }catch{}
    try{ document.getElementById("imgName").textContent = "æœªé¸æŠ"; }catch{}
    setUploadHint("â€» ç”»åƒã¯ Storageï¼ˆpublicï¼‰ã«ã‚¢ãƒƒãƒ—â†’URLã‚’ãƒãƒ£ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã‚ˆï¼ˆ5MBã¾ã§ï¼‰");

    // è¡¨ç¤ºæ›´æ–°ï¼ˆå¤±æ•—ã—ã¦ã‚‚æ­¢ã‚ãªã„ï¼‰
    try{ await loadMessages(); }catch{}
  }catch(e){
    // â˜…çµ¶å¯¾ã«è½ã¨ã•ãªã„ï¼šãƒ­ã‚°ï¼‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘
    log("sendImage error FULL", e);

    // ã‚ˆãã‚ã‚‹ statusCode ã‚’å‡ºã™ã¨åŸå› ç‰¹å®šã—ã‚„ã™ã„
    const msg =
      (e?.message ? e.message : String(e)) +
      (e?.statusCode ? ` (statusCode: ${e.statusCode})` : "") +
      (e?.status ? ` (status: ${e.status})` : "");

    alert("ç”»åƒé€ä¿¡ã«å¤±æ•—: " + msg);
  }finally{
    restoreUI();
  }
}


/* =========================================================
   ğŸ—‘ï¸ è‡ªåˆ†ã®æŠ•ç¨¿ã ã‘å‰Šé™¤ï¼ˆæœ¬æ–‡ + ç”»åƒï¼‰
   - deletedãƒ•ãƒ©ã‚°ã§ã€Œå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€è¡¨ç¤ºã«ã™ã‚‹
   ========================================================= */
async function deleteMessage(m){
  try{
    if (!m?.id) return;

    const uid = myUid();
    console.log("[delete] uid=", uid, "m.id=", m.id, "m.user_id=", m.user_id);

    if (!uid){
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã£ã½ã„ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã­");
      location.href = "./login.html";
      return;
    }
    if ((m.user_id || "") !== uid) return;

    const payload = {
      deleted: true,
      deleted_at: new Date().toISOString(),
      deleted_by: uid,
      // â˜…ç”»åƒãŒã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã€Œ3æ—¥å¾Œã«Storageã‹ã‚‰æ¶ˆã™ã€äºˆç´„ã‚’å…¥ã‚Œã‚‹
      image_purge_at: (m.image_path ? new Date(Date.now() + 3*24*60*60*1000).toISOString() : null),
      image_purged: false
    };
    console.log("[delete] payload=", payload);

    const { data, error } = await sb
      .from("messages_v3")
      .update(payload)
      .eq("id", m.id)
      .eq("user_id", uid)
      .select("id, deleted, deleted_at, deleted_by");

    console.log("[delete] data=", data);
    if (error){
      console.log("[delete] error(full)=", error);
      throw error;
    }

    await loadMessages();
  }catch(e){
    console.log("[delete] catch=", e);
    alert("å‰Šé™¤ã«å¤±æ•—: " + (e?.message || e));
  }
}

/* =========================================================
   ãƒ«ãƒ¼ãƒ å†…ã€Œé€šè©±ä¸­ã®äººã€è¡¨ç¤ºï¼ˆcall_participants ã‹ã‚‰èª­ã‚€ï¼‰
   ========================================================= */
async function loadActiveCallUsers(){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await sb
    .from("call_participants")
    .select("user_id, name, avatar_url, updated_at")
    .eq("room_id", roomId)
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  const box = document.getElementById("activeCallUsersList");
  box.innerHTML = "";

  if (error){
    log("loadActiveCallUsers error", error);
    box.innerHTML = "<div class='hint' style='color:#ff6b6b;'>é€šè©±ä¸­ãƒ¡ãƒ³ãƒãƒ¼å–å¾—å¤±æ•—</div>";
    return;
  }

  
  // æ ä¸»ãƒ„ãƒ¼ãƒ«ç”¨ï¼šé€šè©±å‚åŠ è€…ã‚‚å€™è£œã«è¿½åŠ 
  (data || []).forEach(u=>{ if (u.user_id) upsertRecentUser(u.user_id, u.name, u.avatar_url); });
  renderAdminUsers();
const list = (data || []).map(x=>({
    user_id: x.user_id,
    name: (x.name || x.user_id || "").toString(),
    avatar_url: (x.avatar_url || "").toString()
  }));

  if (list.length === 0){
    box.innerHTML = "<div class='hint'>ä»Šã¯èª°ã‚‚é€šè©±ã—ã¦ãªã„ã‚ˆ</div>";
    return;
  }

  const seen = new Set();
  const uniq = [];
  for (const p of list){
    const k = p.user_id || p.name;
    if (seen.has(k)) continue;
    seen.add(k);
    uniq.push(p);
  }

  for (const p of uniq){
    const row = document.createElement("div");
    row.className = "listItem";
    row.innerHTML = `
      <div class="name">ğŸ§ ${avatarHtml(p.avatar_url, p.name, "sm")} <span class="nameText">${escapeHtml(p.name)}</span>${adminBadgeHtmlByUserId(p.user_id)}</div>
      <div class="sub"><span class="badge good">é€šè©±ä¸­</span></div>
    `;
     // â˜…åå‰/ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸
     row.classList.add("userLink");
     row.title = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹";
     row.onclick = ()=>{ goUserProfile(p.user_id); };

    box.appendChild(row);
  }
}

/* ===== call_participants realtimeï¼ˆéƒ¨å±‹ã®é€šè©±ä¸­ä¸€è¦§ï¼‰ ===== */
async function startCallParticipantsRealtime(){
  if (callUsersChannel) return;

  callUsersChannel = sb
    .channel("call-users-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async (payload)=>{
      const nr = payload.new || {};
      const or = payload.old || {};
      const rid = nr.room_id || or.room_id;
      if (rid === roomId) await loadActiveCallUsers();
    })
    .subscribe();
}

/* =========================================================
   âœ… é€šè©±ï¼ˆå®‰å®šç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰
   - Presence ã¨ Signal(Broadcast) ã‚’åˆ¥ãƒãƒ£ãƒ³ãƒãƒ«ã«åˆ†é›¢
   - joinCall å¤šé‡å®Ÿè¡Œé˜²æ­¢
   - Perfect Negotiationï¼ˆè¡çªã«å¼·ã„ï¼‰
   - ãƒŸãƒ¥ãƒ¼ãƒˆåŒæœŸ/ç›¸æ‰‹éŸ³é‡UI/ãƒã‚¤ã‚¯é€ä¿¡éŸ³é‡ï¼ˆGainï¼‰
   â€» micGainã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸‹ã®ã€ŒUI eventsã€å´ã‚’ãã®ã¾ã¾ä½¿ãˆã‚‹
   ========================================================= */

/* ===== é€šè©±ï¼šçŠ¶æ…‹ ===== */
let callPresenceChannel = null;  // presence å°‚ç”¨
let callSignalChannel = null;    // signaling(broadcast) å°‚ç”¨

let localStream = null;

// â˜…é€ä¿¡éŸ³é‡ï¼ˆãƒã‚¤ã‚¯ï¼‰ã‚’ 1-100 ã§èª¿æ•´ã™ã‚‹ãŸã‚ã® WebAudio
let audioCtx = null;
let micSource = null;
let micGainNode = null;
let processedStream = null;   // Gainé€šéå¾Œã®é€ä¿¡ç”¨Stream
let myMicGain = 1.0;          // 0.0-1.0ï¼ˆUIã¯1-100ï¼‰

let micMuted = false;

const pcs = new Map();        // peerId -> RTCPeerConnection
const mutedMap = new Map();   // peerId -> muted(boolean)
const makingOffer = new Map(); // peerId -> boolean
const ignoreOffer = new Map(); // peerId -> boolean

let joiningCall = false;
let joinedCall = false;

let heartbeatTimer = null;
const CALL_ALIVE_SEC = 30;

// â˜…ç›¸æ‰‹ã”ã¨ã®å—ä¿¡éŸ³é‡
const peerVolume = new Map(); // peerId -> 0.0-1.0

const ICE_SERVERS = [
  { urls: "stun:stun.l.google.com:19302" },
  { urls: "stun:global.stun.twilio.com:3478" }
];

/* ===== util ===== */
function setCallState(text){
  const el = document.getElementById("callState");
  if (el) el.textContent = text;
}
function setJoinBtn(enabled){
  const b = document.getElementById("joinBtn");
  if (b) b.disabled = !enabled;
}
function setMuteBtn(){
  const b = document.getElementById("muteBtn");
  if (b) b.textContent = "ãƒŸãƒ¥ãƒ¼ãƒˆ: " + (micMuted ? "ON" : "OFF");
}
function getIsPolite(peerId){
  // Perfect Negotiation: UUIDã®å¤§å°ã§å›ºå®šï¼ˆå¿…ãšç‰‡æ–¹ã ã‘ãŒpoliteï¼‰
  return String(myUid()) > String(peerId);
}

/* ===== Presence/Singal ãƒãƒ£ãƒ³ãƒãƒ«é–‹å§‹ ===== */
async function startCallChannels(){
  if (callPresenceChannel && callSignalChannel) return;

  // presence å°‚ç”¨
  callPresenceChannel = sb.channel(`call-presence-${room}`, {
    config: { presence: { key: myUid() } }
  });

  callPresenceChannel
    .on("presence", { event: "sync" }, ()=> onPresenceSync())
    .on("presence", { event: "join" }, ({ key, newPresences })=> onPresenceJoin(key, newPresences))
    .on("presence", { event: "leave" }, ({ key, leftPresences })=> onPresenceLeave(key, leftPresences));

  // signal å°‚ç”¨ï¼ˆbroadcastï¼‰
  callSignalChannel = sb.channel(`call-signal-${room}`, {
    config: { broadcast: { self: false } }
  });

  callSignalChannel
    .on("broadcast", { event: "signal" }, async ({ payload })=>{
      await onSignal(payload);
    });

  await Promise.all([
    callPresenceChannel.subscribe(async (status)=>{
      log("presence channel status:", status);
      if (status === "SUBSCRIBED"){
        await safeTrackPresence();
        await refreshPresenceList();
        refreshAudioTitles();
      }
    }),
    callSignalChannel.subscribe((status)=>{
      log("signal channel status:", status);
    })
  ]);
}

async function safeTrackPresence(){
  try{
    if (!callPresenceChannel) return;
    await callPresenceChannel.track({
      user_id: myUid(),
      name,
      avatar_url: myAvatarUrl,
      muted: micMuted,
      joined_at: new Date().toISOString()
    });
  }catch(e){
    log("presence track warn", e);
  }
}

/* ===== WebAudio: é€ä¿¡éŸ³é‡ ===== */
async function ensureAudioContextRunning(){
  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended"){
    try{ await audioCtx.resume(); }catch{}
  }
}

function buildProcessedMicStreamIfNeeded(){
  if (!localStream) return;
  if (processedStream && micGainNode && audioCtx) return;

  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  micSource = audioCtx.createMediaStreamSource(localStream);
  micGainNode = audioCtx.createGain();
  micGainNode.gain.value = myMicGain;

  const dest = audioCtx.createMediaStreamDestination();
  micSource.connect(micGainNode);
  micGainNode.connect(dest);

  processedStream = dest.stream;
}

function applyMicGain(){
  const v = Math.max(0.01, Math.min(1.0, myMicGain));
  if (micGainNode) micGainNode.gain.value = v;
}

function getSendStream(){
  return processedStream || localStream;
}

/* ===== PeerConnection ===== */
async function ensurePC(peerId){
  if (!peerId || peerId === myUid()) return;
  if (pcs.has(peerId)) return;

  const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
  pcs.set(peerId, pc);

  makingOffer.set(peerId, false);
  ignoreOffer.set(peerId, false);

  pc.onicecandidate = async (ev)=>{
    if (ev.candidate){
      await sendSignal(peerId, { kind:"ice", candidate: ev.candidate });
    }
  };

  pc.onconnectionstatechange = ()=>{
    log("pc state", peerId, pc.connectionState);
  };
  pc.oniceconnectionstatechange = ()=>{
    log("ice state", peerId, pc.iceConnectionState);
  };

  pc.ontrack = (ev)=>{
    const el = ensureAudioEl(peerId);
    el.srcObject = ev.streams[0];
  };

  pc.onnegotiationneeded = async ()=>{
    try{
      makingOffer.set(peerId, true);
      const offer = await pc.createOffer();
      if (pc.signalingState !== "stable") return;
      await pc.setLocalDescription(offer);
      await sendSignal(peerId, { kind:"sdp", sdp: pc.localDescription });
    }catch(e){
      log("negotiationneeded error", peerId, e);
    }finally{
      makingOffer.set(peerId, false);
    }
  };

  // é€ä¿¡ãƒˆãƒ©ãƒƒã‚¯ä»˜ä¸
  const sendStream = getSendStream();
  if (sendStream){
    for (const t of sendStream.getTracks()){
      pc.addTrack(t, sendStream);
    }
  }
}

function attachTracksToPC(peerId){
  const pc = pcs.get(peerId);
  const sendStream = getSendStream();
  if (!pc || !sendStream) return;

  const senders = pc.getSenders ? pc.getSenders() : [];
  const audioTrack = sendStream.getAudioTracks?.()[0];
  if (!audioTrack) return;

  const sender = senders.find(s => s.track && s.track.kind === "audio");
  if (!sender){
    pc.addTrack(audioTrack, sendStream);
  }else{
    if (sender.track !== audioTrack){
      try{ sender.replaceTrack(audioTrack); }catch{}
    }
  }
}

function attachTracksToAllPCs(){
  for (const [peerId] of pcs){
    attachTracksToPC(peerId);
  }
}

function closePC(peerId){
  const pc = pcs.get(peerId);
  if (!pc) return;
  try{ pc.close(); }catch{}
  pcs.delete(peerId);

  const wrap = document.getElementById("audioWrap-" + peerId);
  if (wrap) wrap.remove();
}

/* ===== Signal ===== */
async function sendSignal(to, data){
  if (!callSignalChannel) return;
  await callSignalChannel.send({
    type: "broadcast",
    event: "signal",
    payload: { from: myUid(), to, data }
  });
}

async function onSignal(payload){
  const from = payload?.from;
  const to = payload?.to;
  const data = payload?.data;

  if (!from || !data) return;
  if (to && to !== myUid()) return;
  if (!joinedCall) return;

  await ensurePC(from);
  const pc = pcs.get(from);
  if (!pc) return;

  if (data.kind === "hello"){
    attachTracksToPC(from);
    return;
  }

  if (data.kind === "mute"){
    mutedMap.set(from, !!data.muted);
    refreshAudioTitles();
    await refreshPresenceList();
    return;
  }

  if (data.kind === "ice"){
    try{ await pc.addIceCandidate(data.candidate); }catch(e){ log("addIceCandidate error", e); }
    return;
  }

  if (data.kind === "sdp"){
    const desc = data.sdp;
    if (!desc) return;

    const polite = getIsPolite(from);
    const offerCollision = desc.type === "offer" && (makingOffer.get(from) || pc.signalingState !== "stable");
    ignoreOffer.set(from, !polite && offerCollision);
    if (ignoreOffer.get(from)){
      log("ignore offer due to collision", from);
      return;
    }

    try{
      await pc.setRemoteDescription(desc);

      if (desc.type === "offer"){
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await sendSignal(from, { kind:"sdp", sdp: pc.localDescription });
      }
    }catch(e){
      log("handle sdp error", from, e);
    }
    return;
  }
}

/* ===== UI: ç›¸æ‰‹éŸ³å£°ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ & éŸ³é‡ ===== */
function ensureAudioEl(peerId){
  const id = "audio-" + peerId;
  let el = document.getElementById(id);
  if (el) return el;

  const wrap = document.createElement("div");
  wrap.className = "audioWrap";
  wrap.id = "audioWrap-" + peerId;

  const titleRow = document.createElement("div");
  titleRow.className = "audioTitle";
  titleRow.innerHTML = `<span id="audioTitle-${peerId}">ğŸ”Š ç›¸æ‰‹: ${peerId}</span> <span class="badge" id="muteBadge-${peerId}">...</span>`;

  el = document.createElement("audio");
  el.id = id;
  el.autoplay = true;
  el.playsInline = true;
  el.controls = true;

  const v = peerVolume.get(peerId) ?? 1.0;
  el.volume = v;

  const ctl = document.createElement("div");
  ctl.className = "audioCtl";

  const labelText = document.createElement("div");
  labelText.className = "lbl";
  labelText.textContent = "ç›¸æ‰‹ã®éŸ³é‡";

  const label = document.createElement("div");
  label.className = "val";
  label.textContent = String(Math.round(v * 100));

  const range = document.createElement("input");
  range.type = "range";
  range.min = "1";
  range.max = "100";
  range.value = String(Math.round(v * 100));
  range.oninput = ()=>{
    const n = Math.max(1, Math.min(100, Number(range.value)));
    const vv = n / 100;
    peerVolume.set(peerId, vv);
    label.textContent = String(n);
    el.volume = vv;
  };

  ctl.appendChild(labelText);
  ctl.appendChild(label);
  ctl.appendChild(range);

  wrap.appendChild(titleRow);
  wrap.appendChild(el);
  wrap.appendChild(ctl);

  document.getElementById("audios").appendChild(wrap);
  refreshAudioTitles();
  return el;
}

function refreshAudioTitles(){
  const st = callPresenceChannel?.presenceState?.() || {};
  for (const [peerId] of pcs){
    const pres = st[peerId]?.[0];
    const nm = pres?.name || peerId;

    const t = document.getElementById("audioTitle-" + peerId);
    if (t) t.textContent = `ğŸ”Š ç›¸æ‰‹: ${nm}`;

    const badge = document.getElementById("muteBadge-" + peerId);
    const muted = mutedMap.get(peerId);
    if (badge){
      badge.textContent = muted ? "MUTE" : "ON";
      badge.className = "badge " + (muted ? "bad" : "good");
    }
  }
}

/* ===== Presence ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
function onPresenceSync(){
  refreshPresenceList();
  refreshAudioTitles();

  const st = callPresenceChannel?.presenceState?.() || {};
  for (const peerId of Object.keys(st)){
    if (peerId === myUid()) continue;
    if (!pcs.has(peerId)){
      ensurePC(peerId).then(()=>{
        attachTracksToPC(peerId);
        sendSignal(peerId, { kind:"hello" });
      });
    }
  }
}

function onPresenceJoin(key, newPresences){
  refreshPresenceList();
  refreshAudioTitles();

  if (!joinedCall) return;
  if (!key || key === myUid()) return;
  ensurePC(key).then(()=>{
    attachTracksToPC(key);
    sendSignal(key, { kind:"hello" });
  });
}

function onPresenceLeave(key, leftPresences){
  closePC(key);
  refreshPresenceList();
  refreshAudioTitles();
}

async function refreshPresenceList(){
  const box = document.getElementById("callUsersList");
  if (!box) return;

  box.innerHTML = "";

  const st = callPresenceChannel?.presenceState?.() || {};
  const ids = Object.keys(st).filter(id => id && id !== myUid());

  if (ids.length === 0){
    box.innerHTML = "<div class='hint'>æœªæ¥ç¶š</div>";
    return;
  }

  for (const id of ids){
    const p = st[id]?.[0] || {};
    const nm = p.name || id;
    const muted = !!p.muted;

    const row = document.createElement("div");
    row.className = "listItem";
    row.innerHTML = `
      <div class="name">${muted ? "ğŸ”‡" : "ğŸ¤"} ${avatarHtml(p.avatar_url, nm, "sm")} <span class="nameText">${escapeHtml(nm)}</span></div>
      <div class="sub"><span class="badge ${muted ? "bad" : "good"}">${muted ? "ãƒŸãƒ¥ãƒ¼ãƒˆ" : "ç™ºè©±OK"}</span></div>
    `;
     // â˜…åå‰/ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸
     row.classList.add("userLink");
     row.title = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹";
     row.onclick = ()=>{ goUserProfile(id); };

    box.appendChild(row);

    mutedMap.set(id, muted);
  }
}


/* ===== call_participantsï¼ˆaliveï¼‰ ===== */
async function upsertCallParticipant(){
  const { error } = await sb.from("call_participants").upsert({
    room_id: roomId,
    user_id: myUid(),
    name,
    avatar_url: myAvatarUrl,
    updated_at: new Date().toISOString()
  }, { onConflict: "room_id,user_id" });

  if (error) log("upsertCallParticipant error", error);
}

function startHeartbeat(){
  stopHeartbeat();
  heartbeatTimer = setInterval(async ()=>{
    await upsertCallParticipant();
  }, Math.max(5000, (CALL_ALIVE_SEC * 1000) / 3));
}
function stopHeartbeat(){
  if (heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; }
}

/* ===== ãƒ¡ã‚¤ãƒ³æ“ä½œ ===== */
async function joinCall(){
  if (joiningCall || joinedCall) return;
  joiningCall = true;
  setJoinBtn(false);

  try{
    setCallState("æº–å‚™ä¸­â€¦");
    await ensureAudioContextRunning();
    await startCallChannels();

    if (!localStream){
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    }

    buildProcessedMicStreamIfNeeded();
    applyMicGain();

    // ãƒŸãƒ¥ãƒ¼ãƒˆåæ˜ 
    try{
      for (const t of localStream.getAudioTracks()){
        t.enabled = !micMuted;
      }
    }catch{}

    attachTracksToAllPCs();

    // æ—¢ã«å±…ã‚‹äººã¸ hello + PC ç”¨æ„
    const st = callPresenceChannel.presenceState() || {};
    for (const peerId of Object.keys(st)){
      if (peerId === myUid()) continue;
      await ensurePC(peerId);
      attachTracksToPC(peerId);
      await sendSignal(peerId, { kind:"hello" });
    }

    await safeTrackPresence();

    await upsertCallParticipant();
    startHeartbeat();

    joinedCall = true;
    setMuteBtn();
    setCallState("é€šè©±ã«å‚åŠ ä¸­");
    setReady(true, "é€šè©±æº–å‚™OK");
  }catch(e){
    log("joinCall error", e);
    alert("é€šè©±ã®é–‹å§‹ã«å¤±æ•—: " + (e?.message || e));
    await leaveCall();
  }finally{
    joiningCall = false;
    setJoinBtn(true);
  }
}

async function leaveCall(){
  joiningCall = false;
  joinedCall = false;

  try{
    await sb.from("call_participants")
      .delete()
      .eq("room_id", roomId)
      .eq("user_id", myUid());
  }catch(e){
    log("call_participants delete error", e);
  }

  stopHeartbeat();

  for (const [peerId] of pcs){
    closePC(peerId);
  }
  pcs.clear();

  if (localStream){
    for (const t of localStream.getTracks()){
      try{ t.stop(); }catch{}
    }
    localStream = null;
  }
  processedStream = null;
  micSource = null;
  micGainNode = null;

  if (callPresenceChannel){
    try{ await callPresenceChannel.untrack(); }catch{}
    try{ await callPresenceChannel.unsubscribe(); }catch{}
    callPresenceChannel = null;
  }
  if (callSignalChannel){
    try{ await callSignalChannel.unsubscribe(); }catch{}
    callSignalChannel = null;
  }

  const aud = document.getElementById("audios");
  if (aud) aud.innerHTML = "";
  const list = document.getElementById("callUsersList");
  if (list) list.innerHTML = "<div class='hint'>æœªæ¥ç¶š</div>";

  setCallState("æœªæ¥ç¶šï¼ˆå¿…è¦ãªã‚‰é€šè©±ã«å‚åŠ ã‚’æŠ¼ã—ã¦ã­ï¼‰");
  setReady(true, "å¾…æ©Ÿä¸­");
  setMuteBtn();
}

async function toggleMute(){
  micMuted = !micMuted;
  setMuteBtn();

  try{
    if (localStream){
      for (const t of localStream.getAudioTracks()){
        t.enabled = !micMuted;
      }
    }
  }catch(e){
    log("toggleMute localStream warn", e);
  }

  await safeTrackPresence();

  try{
    for (const [peerId] of pcs){
      await sendSignal(peerId, { kind:"mute", muted: micMuted });
    }
  }catch(e){
    log("toggleMute sendSignal warn", e);
  }

  refreshAudioTitles();
}


/* ===== UI events ===== */
document.getElementById("imgFile").addEventListener("change", ()=>{
  const f = document.getElementById("imgFile").files?.[0];
  document.getElementById("imgName").textContent = f ? f.name : "æœªé¸æŠ";
});

document.getElementById("micGain").addEventListener("input", (ev)=>{
  const n = Math.max(1, Math.min(100, Number(ev.target.value)));
  document.getElementById("micGainLabel").textContent = String(n);
  myMicGain = n / 100;
  applyMicGain();
});


/* =================== æ ä¸»ãƒ„ãƒ¼ãƒ«ï¼ˆKick / Ban / Room deleteï¼‰ =================== */

let recentUsers = new Map(); // user_id -> { name, avatar_url, last_seen }

function upsertRecentUser(uid, nm, av){
  if (!uid) return;
  const prev = recentUsers.get(uid) || {};
  recentUsers.set(uid, {
    user_id: uid,
    name: (nm || prev.name || "").toString(),
    avatar_url: (av || prev.avatar_url || "").toString(),
    last_seen: Date.now()
  });
}

function isValidUuid(v){
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test((v||"").trim());
}

function setOwnerUI(){
  const delBtn = document.getElementById("deleteRoomBtn");
  const adminCard = document.getElementById("adminCard");

  // éƒ¨å±‹å‰Šé™¤ã¯æ ä¸»ã®ã¿
  if (delBtn) delBtn.style.display = isOwner ? "" : "none";

  // æ ä¸»ãƒ„ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã¯ã€ŒKickã§ãã‚‹äººã€ã«è¡¨ç¤ºï¼ˆæ ä¸» or ã‚µãƒ–æ ä¸»ï¼‰
  if (adminCard) adminCard.style.display = canKick() ? "" : "none";

  // â˜…éƒ¨å±‹åç·¨é›†ï¼ˆæ ä¸»ã®ã¿ï¼‰
  const rn = document.getElementById("roomName");
  const row = document.getElementById("roomNameEditRow");
  const hint = document.getElementById("roomNameHint");

  if (rn){
    rn.readOnly = !isOwner;
    rn.style.opacity = isOwner ? "1" : "0.85";
  }
  if (row) row.style.display = isOwner ? "flex" : "none";
  if (hint) hint.style.display = isOwner ? "none" : "";

  // â˜…ã‚µãƒ–æ ä¸»ç®¡ç†ï¼ˆè¿½åŠ /å‰Šé™¤ï¼‰ã¯æ ä¸»ã ã‘è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  const subOwnerField = document.getElementById("subOwnerUidInput")?.closest(".field");
  if (subOwnerField) subOwnerField.style.display = isOwner ? "" : "none";
}

function updateOwnerToolsVisibility(){
  setOwnerUI();
}



async function saveRoomName(){
  try{
    if (!isOwner){
      alert("æ ä¸»ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã ã‘ãŒéƒ¨å±‹åã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆï¼");
      return;
    }
    if (!roomId){
      alert("roomId ãŒç„¡ã„ã®ã§å¤‰æ›´ã§ããªã„ã‚ˆ");
      return;
    }
    if (roomNameSaveLock) return;
    roomNameSaveLock = true;

    const el = document.getElementById("roomName");
    if (!el){
      alert("roomName input ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆ");
      return;
    }

    const newName = (el.value || "").trim();
    if (!newName){
      alert("éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ã­ï¼");
      el.value = room || "";
      return;
    }
    if (newName.length > 60){
      alert("éƒ¨å±‹åãŒé•·ã™ãã‚‹ã‚ˆï¼ˆ60æ–‡å­—ã¾ã§ï¼‰");
      el.value = room || "";
      return;
    }

    const uid = myUid();
    if (!uid){
      alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼ˆuidï¼‰ãŒå–ã‚Œãªã„ã‚ˆã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
      return;
    }

    // æ›´æ–°ãŒæˆåŠŸã—ãŸã‹ã‚’ data ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã« select ã™ã‚‹
    const { data, error } = await sb
      .from("rooms")
      .update({ room_name: newName })
      .eq("id", roomId)
      .eq("owner_id", uid)
      .select("id, room_name, owner_id")
      .maybeSingle();

    if (error){
      log("saveRoomName error", error);
      alert("éƒ¨å±‹åã®å¤‰æ›´ã«å¤±æ•—ã—ãŸã‚ˆ: " + (error.message || ""));
      el.value = room || "";
      return;
    }

    // â˜…ã“ã“ãŒé‡è¦ï¼š0ä»¶æ›´æ–°ï¼ˆæ¡ä»¶ä¸ä¸€è‡´ / RLSï¼‰ã‚’æ¤œå‡º
    if (!data){
      alert("æ›´æ–°ã§ããªã‹ã£ãŸã‚ˆï¼ˆã‚ªãƒ¼ãƒŠãƒ¼åˆ¤å®š/æ¨©é™/RLS/roomIdä¸ä¸€è‡´ã®å¯èƒ½æ€§ï¼‰ã€‚");
      el.value = room || "";
      return;
    }

    // UI å³æ™‚åæ˜ 
    applyRoomInfoRow({ id: data.id, room_name: data.room_name, owner_id: data.owner_id });
    alert("éƒ¨å±‹åã‚’å¤‰æ›´ã—ãŸã‚ˆï¼");
  }catch(e){
    log("saveRoomName exception", e);
    alert("éƒ¨å±‹åã®å¤‰æ›´ã§ã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
  }finally{
    roomNameSaveLock = false;
  }
}


function resetRoomNameInput(){
  const el = document.getElementById("roomName");
  if (el) el.value = room || "";
}

// Enter ã§ä¿å­˜ï¼ˆæ ä¸»ã®ã¿ï¼‰
document.addEventListener("keydown", (ev)=>{
  try{
    if (!isOwner) return;
    const el = document.getElementById("roomName");
    if (!el) return;
    if (document.activeElement !== el) return;
    if (ev.key === "Enter"){
      ev.preventDefault();
      saveRoomName();
    }
  }catch{}
});

function applyRoomInfoRow(row){
  if (!row) return;

  // owner_id ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ä¿æŒã—ã¦UIæ›´æ–°
  if (row.owner_id !== undefined && row.owner_id !== null){
    roomOwnerId = String(row.owner_id || "");
    isOwner = (roomOwnerId && roomOwnerId === myUid());
  }

  const newRoomName = (row.room_name || room || "").toString();
  if (newRoomName){
    room = newRoomName;
    const rn = document.getElementById("roomName");
    const chip = document.getElementById("roomChip");
    const sub = document.getElementById("subTitle");
    if (rn) rn.value = room;
    if (chip) chip.textContent = room;
    if (sub) sub.textContent = "Room: " + room;
    document.title = "ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Room (" + room + ")";
  }
  setOwnerUI();
}

/* ===== rooms realtimeï¼ˆéƒ¨å±‹åãªã©ã‚’å…¨å“¡ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ï¼‰ ===== */
async function startRoomInfoRealtime(){
  if (roomInfoChannel) return;
  roomInfoChannel = sb
    .channel("room-info-" + (roomId || ""))
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, (payload)=>{
      const nr = payload.new || {};
      const or = payload.old || {};
      const id = nr.id || or.id;
      if (!id || id !== roomId) return;

      if (payload.eventType === "DELETE"){
        alert("ã“ã®éƒ¨å±‹ã¯å‰Šé™¤ã•ã‚ŒãŸã‚ˆã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ã­ï¼");
        goLobby();
        return;
      }
      applyRoomInfoRow(nr);
    })
    .subscribe();
}


function renderAdminUsers(){
  const box = document.getElementById("adminUsersList");
  if (!box) return;

  // âœ… è¿½åŠ ï¼šå¤ã„å€™è£œã¯æ¶ˆã™ï¼ˆå‰ã®æ ã®æ®‹éª¸å¯¾ç­–ï¼‰
  const TTL_MS = 3 * 60 * 1000; // 3åˆ†
  const now = Date.now();

  // è‡ªåˆ†ä»¥å¤–ã‚’ä¸Šã« + å¤ã„ã®ã¯é™¤å¤–
  const arr = Array.from(recentUsers.values())
    .filter(u => u.user_id && u.user_id !== myUid())
    .filter(u => (now - (u.last_seen || 0)) <= TTL_MS)
    .sort((a,b)=>(b.last_seen||0)-(a.last_seen||0))
    .slice(0, 40);

  box.innerHTML = "";

  if (arr.length === 0){
    box.innerHTML = "<div class='hint'>ã¾ã å€™è£œãŒãªã„ã‚ˆï¼ˆé€šè©±å‚åŠ /ç™ºè¨€ãŒã‚ã‚‹ã¨å‡ºã‚‹ï¼‰</div>";
    return;
  }

  for (const u of arr){
    const it = document.createElement("div");
    it.className = "listItem";

    const left = document.createElement("div");
    left.className = "name";
    const shown = (u.name || "").trim() || u.user_id;
    left.innerHTML = `${avatarInline(u.avatar_url || "", shown)}<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:210px;">${escapeHtml(shown)}</span>`;

    const right = document.createElement("div");
    right.className = "sub";
    right.textContent = u.user_id.slice(0, 8) + "â€¦";

    it.appendChild(left);
    it.appendChild(right);

    it.onclick = ()=>{
      const t = document.getElementById("adminTargetUid");
      if (t) t.value = u.user_id;
    };

    box.appendChild(it);
  }
}


function avatarInline(url, alt){
  if (url){
    return `<img class="avatar sm" src="${escapeHtml(url)}" alt="${escapeHtml(alt||'')}" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex';" />` +
           `<span class="avatarFallback sm" style="display:none;">${escapeHtml((alt||'?').slice(0,1).toUpperCase())}</span>`;
  }
  return `<span class="avatarFallback sm">${escapeHtml((alt||'?').slice(0,1).toUpperCase())}</span>`;
}

async function resolveRoomRow(){
  // å„ªå…ˆ: room_id ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const ridParam = getRoomIdFromUrl();
  if (ridParam && isValidUuid(ridParam)){
    const { data, error } = await sb.from("rooms").select("id, room_name, owner_id, created_at").eq("id", ridParam).maybeSingle();
    if (!error && data) return data;
    

  }

  // fallback: room åã‹ã‚‰æœ€æ–°ã® 1 è¡Œ
  const rn = room;
  const { data, error } = await sb.from("rooms")
    .select("id, room_name, owner_id, created_at")
    .eq("room_name", rn)
    .order("created_at", { ascending:false })
    .limit(1)
    .maybeSingle();
  await loadSubOwnersFromDb();


  if (error) throw error;
  return data || null;
}

async function checkBanned(){
  if (!roomId) return;
  const { data, error } = await sb.from("room_bans").select("reason, created_at").eq("room_id", roomId).eq("user_id", myUid()).maybeSingle();
  if (error) {
    log("checkBanned error", error);
    return;
  }
  if (data){
    alert("ã“ã®éƒ¨å±‹ã§ã¯BANã•ã‚Œã¦ã„ã¾ã™ã€‚\nç†ç”±: " + (data.reason || "ãªã—"));
    goLobby();
  }
}

async function startRoomDeleteWatch(){
  // rooms ã® delete ã‚’æ¤œçŸ¥ã—ã¦å¼·åˆ¶ãƒ­ãƒ“ãƒ¼æˆ»ã—
  sb.channel("rooms-watch")
    .on("postgres_changes", { event:"DELETE", schema:"public", table:"rooms" }, (payload)=>{
      const old = payload.old || {};
      if (old.id && old.id === roomId){
        alert("éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚Šã¾ã™ã€‚");
        goLobby();
      }
    })
    .subscribe();
}

async function startRoomEventsWatch(){
  // room_events ã‚’ç›£è¦–ï¼ˆkick/ban/forceback/deleteï¼‰
  // â€»Realtime ãŒåŠ¹ã‹ãªã„ç’°å¢ƒãŒã‚ã‚‹ã®ã§ã€2ç§’ãƒãƒ¼ãƒªãƒ³ã‚°ã‚‚ä½µç”¨ã™ã‚‹ï¼ˆã“ã‚Œã§Kick/å…¨å“¡æˆ»ã™ãŒç¢ºå®Ÿã«å‹•ãï¼‰
  if (window.__roomEventsWatchStarted) return;
  window.__roomEventsWatchStarted = true;

  // ã“ã“ã‚ˆã‚Šå¾Œã«ä½œã‚‰ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã ã‘è¦‹ã‚‹ï¼ˆå…¥å®¤å‰ã®å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã§é£›ã°ãªã„ã‚ˆã†ã«ï¼‰
  window.__roomEventsLastAt = new Date().toISOString();

  function handleRoomEvent(ev){
    if (!ev) return;
    if (ev.room_id !== roomId) return;

    // è‡ªåˆ†å®›ã¦ or å…¨å“¡
    if (ev.target_user_id && ev.target_user_id !== myUid()) return;

    const typ = (ev.type || "").toString();
    const reason = (ev.reason || "").toString();

    // å—ä¿¡æ¸ˆã¿ã®æœ€æ–°æ™‚åˆ»ã‚’æ›´æ–°ï¼ˆnullå®‰å…¨ï¼‰
    if (ev.created_at){
      window.__roomEventsLastAt = ev.created_at;
    }

    if (typ === "kicked"){
      alert(`Kick ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }else if (typ === "banned"){
      alert(`Ban ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }else if (typ === "force_back_all"){
      alert(`æ ä¸»ã«ã‚ˆã‚Šãƒ­ãƒ“ãƒ¼ã¸æˆ»ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }else if (typ === "room_deleted"){
      alert(`éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }
  }

  // --- Realtimeï¼ˆåŠ¹ããªã‚‰æœ€é€Ÿï¼‰ ---
  try{
    roomEventsChannel = sb.channel("room-events-" + (roomId || ""))
      .on("postgres_changes", { event:"INSERT", schema:"public", table:"room_events" }, (payload)=>{
        const ev = payload.new || {};
        handleRoomEvent(ev);
      })
      .subscribe();
  }catch(e){
    log("room_events realtime warn", e);
  }

  // --- Pollingï¼ˆRealtimeãŒæ­»ã‚“ã§ã‚‚ç¢ºå®Ÿï¼‰ ---
  async function pollRoomEvents(){
    if (!roomId || !myUid()) return;
    const since = window.__roomEventsLastAt || new Date(Date.now() - 60*1000).toISOString();

    // target_user_id ãŒ nullï¼ˆå…¨å“¡ï¼‰ or è‡ªåˆ†å®›ã¦ ã®ã‚‚ã®ã ã‘ã‚’æ‹¾ã†
    // Supabaseã®or()ã¯ "a.is.null,a.eq.xxx" ã®å½¢ã§æ›¸ã‘ã‚‹
    const { data, error } = await sb.from("room_events")
      .select("id, room_id, target_user_id, type, reason, created_at")
      .eq("room_id", roomId)
      .gt("created_at", since)
      .or(`target_user_id.is.null,target_user_id.eq.${myUid()}`)
      .order("created_at", { ascending:true })
      .limit(50);

    if (error){
      // ãšã£ã¨ã‚¨ãƒ©ãƒ¼ãªã‚‰ãƒ­ã‚°ã ã‘ï¼ˆUIã‚’å£Šã•ãªã„ï¼‰
      log("room_events poll error", error);
      return;
    }

    if (!data || !data.length) return;
    for (const ev of data){
      handleRoomEvent(ev);
    }
  }

  // 2ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆè»½ã„ï¼‰
  window.__roomEventsPollTimer = setInterval(pollRoomEvents, 2000);
}

async function deleteRoomNow(){
  if (!confirm("æœ¬å½“ã«éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  // å­ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å…ˆã«æ¶ˆã™
  await sb.from("messages_v3").delete().eq("room_id", roomId);
  await sb.from("room_members").delete().eq("room_id", roomId);
  await sb.from("call_participants").delete().eq("room_id", roomId);

  // æœ€å¾Œã« rooms
  const { error } = await sb
    .from("rooms")
    .delete()
    .eq("id", roomId)
    .eq("owner_id", myUid());

  if (error){
    alert("éƒ¨å±‹å‰Šé™¤å¤±æ•—: " + error.message);
    console.error(error);
    return;
  }

  alert("éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  location.href = "./lobby.html";
}


function getAdminTargetUid(){
  const uid = (document.getElementById("adminTargetUid")?.value || "").trim();
  if (!isValidUuid(uid)) return "";
  return uid;
}
function getAdminReason(){
  return (document.getElementById("adminReason")?.value || "").trim().slice(0, 200);
}

 async function kickUser(){
  if (!canKick()) return alert("Kickã§ãã‚‹ã®ã¯æ ä¸»ã¾ãŸã¯ã‚µãƒ–æ ä¸»ã ã‘ã§ã™");

  const targetUidRaw = (document.getElementById("adminTargetUid")?.value || "").trim();
  if (!targetUidRaw) return;

  // ğŸš« é‹å–¶ã¯Kickä¸å¯ï¼ˆæ—¢å­˜ï¼‰
  if (isAdminUserId(targetUidRaw)){
    alert("é‹å–¶ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ Kick ã§ãã¾ã›ã‚“");
    return;
  }

  const target = getAdminTargetUid();
  if (!target) return alert("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ­£ã ã‚ˆï¼");
  const reason = getAdminReason();

  // =========================
  // âœ… è¿½åŠ ï¼šKickå¯¾è±¡ã®åˆ¶é™
  // =========================

  // â‘  ã‚µãƒ–æ ä¸»ã¯ã€Œæ ä¸»ã€ã‚’Kickã§ããªã„ï¼ˆã¤ã„ã§ã«æ ä¸»è‡ªä½“ã‚‚Kickä¸å¯ã«ã—ã¦å®‰å…¨ï¼‰
  if (target === roomOwnerId){
    alert("æ ä¸»ã¯ Kick ã§ãã¾ã›ã‚“");
    return;
  }

  // â‘¡ ã‚µãƒ–æ ä¸»ã¯ã€Œä»–ã®ã‚µãƒ–æ ä¸»ã€ã‚’Kickã§ããªã„ï¼ˆå¸Œæœ›ãŒã‚ã‚Œã°ï¼‰
  if (isSubOwner() && SUB_OWNER_UIDS.includes(target)){
    alert("ã‚µãƒ–æ ä¸»ã¯ä»–ã®ã‚µãƒ–æ ä¸»ã‚’ Kick ã§ãã¾ã›ã‚“");
    return;
  }

  // ï¼ˆä»»æ„ï¼‰è‡ªåˆ†è‡ªèº«ã‚’Kickã•ã›ãŸããªã„ãªã‚‰
  // if (target === myUid()){
  //   alert("è‡ªåˆ†è‡ªèº«ã¯ Kick ã§ãã¾ã›ã‚“");
  //   return;
  // }

  await sb.from("room_kicks").insert({
    room_id: roomId,
    user_id: target,
    reason: reason || null
  });

  await sb.from("room_events").insert({
    room_id: roomId,
    target_user_id: target,
    type: "kicked",
    reason: reason || null,
    actor_user_id: myUid()
  });

  alert("Kickã—ã¾ã—ãŸ");
}


async function banUser(){
  if (!canBan()) return alert("æ ä¸»ã ã‘ï¼");

  const targetUid = (document.getElementById("adminTargetUid")?.value || "").trim();
  if (!targetUid) return;

  if (isAdminUserId(targetUid)){
    alert("é‹å–¶ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ Ban ã§ãã¾ã›ã‚“");
    return;
  }

  const target = getAdminTargetUid();
  if (!target) return alert("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ­£ã ã‚ˆï¼");
  const reason = getAdminReason();

  await sb.from("room_bans").insert({
    room_id: roomId,
    user_id: target,
    reason: reason || null
  });

  await sb.from("room_events").insert({
    room_id: roomId,
    target_user_id: target,
    type: "banned",
    reason: reason || null,
    actor_user_id: myUid()
  });

  alert("Banã—ã¾ã—ãŸ");
}


async function forceBackAll(){
  if (!isOwner) return alert("æ ä¸»ã ã‘ï¼");
  const reason = getAdminReason();

  const { error } = await sb.from("room_events").insert({
    room_id: roomId,
    target_user_id: null,
    type: "force_back_all",
    reason: reason || "æ ä¸»ã«ã‚ˆã‚Šãƒ­ãƒ“ãƒ¼ã¸æˆ»ã•ã‚Œã¾ã—ãŸ",
    actor_user_id: myUid()
  });

  if (error){
    alert("å…¨å“¡æˆ»ã—å¤±æ•—: " + error.message);
    log("forceBackAll error", error);
    return;
  }

  alert("å…¨å“¡ã‚’ãƒ­ãƒ“ãƒ¼ã«æˆ»ã—ã¾ã—ãŸã€‚");
}

async function upsertRoomMember(){
  if (!roomId || !myUid()) return;
  try{
    await sb.from("room_members").upsert({
      room_id: roomId,
      user_id: myUid(),
      name: name || null,
      avatar_url: myAvatarUrl || null,
      updated_at: new Date().toISOString()
    }, { onConflict: "room_id,user_id" });
  }catch(e){ log("upsertRoomMember warn", e); }
}

async function deleteRoomMember(){
  if (!roomId || !myUid()) return;
  try{ await sb.from("room_members").delete().eq("room_id", roomId).eq("user_id", myUid()); }catch(e){}
}

let roomMemberTimer = null;

async function startRoomMemberHeartbeat(){
  await upsertRoomMember();
  await loadRoomMembersForUI();
  if (canKick()) await loadRoomMembersForAdmin();

  if (roomMemberTimer) clearInterval(roomMemberTimer);
  roomMemberTimer = setInterval(()=>{
    upsertRoomMember();
    loadRoomMembersForUI();
    if (canKick()) loadRoomMembersForAdmin();
  }, 20000);

  window.addEventListener("beforeunload", ()=>{ deleteRoomMember(); });
}

async function loadRoomMembersForAdmin(){
  if (!roomId) return;
  const cutoff = new Date(Date.now() - 1000*60*2).toISOString(); // 2åˆ†ä»¥å†…ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ‰±ã„
  const { data, error } = await sb.from("room_members")
    .select("user_id, name, avatar_url, updated_at")
    .eq("room_id", roomId)
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  if (error){ log("loadRoomMembersForAdmin error", error); return; }

  (data || []).forEach(u=>upsertRecentUser(u.user_id, u.name, u.avatar_url));
  renderAdminUsers();
}

async function loadRoomMembersForUI(){
  const box = document.getElementById("roomMembersList");
  if (!box) return;
  if (!roomId){
    box.innerHTML = `<div class="hint">éƒ¨å±‹æƒ…å ±ãŒã¾ã æº–å‚™ä¸­â€¦</div>`;
    return;
  }

  const cutoff = new Date(Date.now() - 1000*60*2).toISOString(); // 2åˆ†ä»¥å†…ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ‰±ã„
  const { data, error } = await sb.from("room_members")
    .select("user_id, name, avatar_url, updated_at")
    .eq("room_id", roomId)
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  if (error){
    log("loadRoomMembersForUI error", error);
    box.innerHTML = `<div class="hint">å–å¾—å¤±æ•—: ${escapeHtml(error.message)}</div>`;
    return;
  }

  const arr = (data || []);

  // æ‹›å¾…UIã§ã€Œæ—¢ã«éƒ¨å±‹ã«ã„ã‚‹ã€ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ä¿æŒ
  try{ currentRoomUserIds = new Set(arr.map(x=>x.user_id)); }catch{}
  try{ renderInviteFriends(); }catch{}

  if (arr.length === 0){
    box.innerHTML = `<div class="hint">ä»Šã¯èª°ã‚‚ã„ãªã„ã‚ˆï¼ˆã¾ãŸã¯æ›´æ–°å¾…ã¡ï¼‰</div>`;
    return;
  }

  box.innerHTML = "";
  for (const u of arr){
    const uid = u.user_id;
    const dn = (u.name || uid || "unknown").toString();
    const av = (u.avatar_url || "").toString();

    const item = document.createElement("div");
    item.className = "listItem";
    item.style.cursor = isOwner ? "pointer" : "default";
    item.title = isOwner ? "ã‚¯ãƒªãƒƒã‚¯ã§Kick/Banã®å¯¾è±¡ã«å…¥ã‚‹" : "";

    item.innerHTML = `
      ${avatarHtml(av, dn)}
      <div class="listMain">
        <div class="listTitle">${escapeHtml(dn)}</div>
        <div class="listSub">${escapeHtml(uid)}</div>
      </div>
      ${isOwner ? `<span class="chip">é¸æŠ</span>` : ``}
    `;

    if (isOwner){
      item.onclick = ()=>{
        const t = document.getElementById("adminTargetUid");
        if (t) t.value = uid || "";
        setStatus(`å¯¾è±¡ã‚’é¸æŠ: ${dn}`, true);
      };
    }

    box.appendChild(item);
  }
}

async function startRoomMembersRealtime(){
  if (!roomId) return;
  if (roomMembersChannel) return;

  roomMembersChannel = sb
    .channel("room-members-" + roomId)
    .on("postgres_changes",
      { event:"*", schema:"public", table:"room_members", filter:`room_id=eq.${roomId}` },
      async ()=>{ await loadRoomMembersForUI(); if (canKick()) await loadRoomMembersForAdmin(); }
    )
    .subscribe();
}




/* =================== ãƒ•ãƒ¬ãƒ³ãƒ‰æ‹›å¾…ï¼ˆroom_invitesï¼‰ =================== */
let inviteFriendsCache = []; // [{uid, display_name, avatar_url}]
let inviteFriendsLoadedOnce = false;
let currentRoomUserIds = new Set(); // room_membersï¼ˆ2åˆ†ä»¥å†…ï¼‰ã‚’å…¥ã‚Œã¦ãŠã

function otherUidFromFriendRow(row){
  if (!row || !authUser?.id) return "";
  if (row.user_a === authUser.id) return row.user_b || "";
  if (row.user_b === authUser.id) return row.user_a || "";
  return "";
}

function setupInviteUI(){
  const card = document.getElementById("inviteCard");
  const search = document.getElementById("inviteSearch");
  if (card) card.style.display = ""; // ã¨ã‚Šã‚ãˆãšè¡¨ç¤ºï¼ˆä¸­èº«ã¯ render ã§èª¿æ•´ï¼‰
  if (search){
    search.addEventListener("input", ()=> renderInviteFriends());
  }
}

async function loadInviteFriends(force=false){
  if (!authUser?.id) return;
  if (inviteFriendsLoadedOnce && !force) return;

  const list = document.getElementById("inviteList");
  if (list) list.innerHTML = `<div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>`;

  try{
    const { data: fr, error: ferr } = await sb
      .from("friends")
      .select("user_a, user_b")
      .or(`user_a.eq.${authUser.id},user_b.eq.${authUser.id}`);
    if (ferr) throw ferr;

    const uids = (fr || []).map(otherUidFromFriendRow).filter(Boolean);
    const unique = Array.from(new Set(uids));

    if (unique.length === 0){
      inviteFriendsCache = [];
      inviteFriendsLoadedOnce = true;
      renderInviteFriends();
      return;
    }

    const { data: ps, error: perr } = await sb
      .from("profiles")
      .select("user_id, display_name, avatar_url")
      .in("user_id", unique);
    if (perr) throw perr;

    const map = new Map();
    (ps || []).forEach(p => map.set(p.user_id, p));

    inviteFriendsCache = unique.map(uid=>{
      const p = map.get(uid) || {};
      return {
        uid,
        display_name: p.display_name || "ï¼ˆæœªè¨­å®šï¼‰",
        avatar_url: p.avatar_url || ""
      };
    });

    inviteFriendsCache.sort((a,b)=> String(a.display_name).localeCompare(String(b.display_name), "ja"));
    inviteFriendsLoadedOnce = true;
    renderInviteFriends();
  }catch(e){
    console.error("loadInviteFriends error", e);
    inviteFriendsCache = [];
    inviteFriendsLoadedOnce = true;
    const list2 = document.getElementById("inviteList");
    if (list2) list2.innerHTML = `<div class="hint">ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ãŒå–ã‚Œã¾ã›ã‚“ï¼ˆfriends / profiles ã®RLSç¢ºèªï¼‰</div>`;
  }
}

function renderInviteFriends(){
  const list = document.getElementById("inviteList");
  const q = String(document.getElementById("inviteSearch")?.value || "").trim().toLowerCase();
  if (!list) return;

  let arr = inviteFriendsCache.slice();
  if (q){
    arr = arr.filter(x => String(x.display_name || "").toLowerCase().includes(q));
  }

  if (arr.length === 0){
    list.innerHTML = `<div class="hint">ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ãªã„ï¼ˆã¾ãŸã¯æ¤œç´¢ã«ä¸€è‡´ã—ãªã„ï¼‰</div>`;
    return;
  }

  list.innerHTML = "";
  for (const f of arr){
    const inRoom = currentRoomUserIds.has(f.uid);
    const row = document.createElement("div");
    row.className = "memberItem";

    row.innerHTML = `
      ${avatarHtml(f.avatar_url, f.display_name, "", 0)}
      <div class="memberMeta">
        <div class="memberName">${escapeHtml(f.display_name)}</div>
        <div class="memberSub">${inRoom ? "ã“ã®éƒ¨å±‹ã«ã„ã‚‹ã‚ˆ" : "æ‹›å¾…ã§ãã¾ã™"}</div>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button class="btn btnSmall ${inRoom ? "btnMuted" : "btnAccent2"}" ${inRoom ? "disabled" : ""} data-invite>ğŸ“© æ‹›å¾…</button>
      </div>
    `;

    row.querySelector("[data-invite]").onclick = async(e)=>{
      e.stopPropagation();
      if (inRoom) return;
      await sendRoomInvite(f.uid, f.display_name);
    };

    // ã‚«ãƒ¼ãƒ‰æŠ¼ã—ãŸã‚‰ç›¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸
    row.onclick = ()=>{
      location.href = `./profile.html?uid=${encodeURIComponent(f.uid)}&back=room&room=${encodeURIComponent(room||"")}&room_id=${encodeURIComponent(roomId||"")}&_r=${Date.now()}`;
    };

    list.appendChild(row);
  }
}

async function sendRoomInvite(targetUid, targetName){
  if (!authUser?.id) return;
  if (!roomId) return alert("éƒ¨å±‹æƒ…å ±ãŒã¾ã æº–å‚™ä¸­â€¦");
  if (!targetUid) return;

  // äºŒé‡æ‹›å¾…ã‚’é¿ã‘ãŸã„å ´åˆï¼šåŒã˜(éƒ¨å±‹,ç›¸æ‰‹)ã®æœ€æ–°1ä»¶ã ã‘ã€ã¨ã„ã†åˆ¶ç´„ã‚’DBå´ã§uniqueã«ã—ã¦ã‚‚OK
  try{
    const { error } = await sb
      .from("room_invites")
      .insert({
        room_id: roomId,
        room_name: room || null,
        from_user: authUser.id,
        to_user: targetUid
      });
    if (error) throw error;

    alert(`${targetName || "ãƒ•ãƒ¬ãƒ³ãƒ‰"} ã«æ‹›å¾…ã‚’é€ã‚Šã¾ã—ãŸï¼`);
  }catch(e){
    console.error("sendRoomInvite error", e);
    alert("æ‹›å¾…ã®é€ä¿¡ã«å¤±æ•—: " + (e?.message || "unknown"));
  }
}


/* =================== èµ·å‹• =================== */
/* =================== èµ·å‹• =================== */
(async ()=>{
  try{
    if (!(await requireLoginOrRedirect())) return;

ã€€ã€€startOnlineHeartbeatRoom();
    
    await reloadName();
    updateTop();

    // URL params
    const urlRoom = getRoomFromUrl();
    const urlRoomId = getRoomIdFromUrl(); // â˜…è¿½åŠ ï¼šroom_id ã‚‚èª­ã‚€

    // room ã‚‚ room_id ã‚‚ç„¡ã„ãªã‚‰ã‚¢ã‚¦ãƒˆ
    if (!urlRoom && !urlRoomId){
      alert("éƒ¨å±‹ãŒæŒ‡å®šã•ã‚Œã¦ãªã„ã‚ˆï¼");
      goLobby();
      return;
    }

    // â˜…roomã®åˆæœŸå€¤
    room = urlRoom || "";
    roomId = ""; // ã“ã“ã§ä¸€æ—¦ç©ºã«ã—ã¦ã€resolveRoomRowã§ç¢ºå®šã™ã‚‹

    // rooms ã®ã€Œã“ã®å›ã®éƒ¨å±‹ã€ã‚’ç¢ºå®šï¼ˆidå„ªå…ˆï¼‰
    let row = null;
    try{
      row = await resolveRoomRow(urlRoom, urlRoomId); // â˜…å¤‰æ›´
    }catch(e){
      log("resolveRoomRow error", e);
    }

    if (!row){
      alert("ãã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆï¼ï¼ˆã™ã§ã«å‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ï¼‰");
      goLobby();
      return;
    }

    roomId = row.id;

    // ğŸ‘‡ æ‹›å¾…UIæº–å‚™ï¼ˆãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰ï¼‰
    try{ setupInviteUI(); }catch{}
    try{ await loadInviteFriends(true); }catch{}

    roomOwnerId = row.owner_id || "";
    isOwner = (roomOwnerId && roomOwnerId === myUid());

    // âœ… éƒ¨å±‹ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰æ ä¸»ãƒ„ãƒ¼ãƒ«å€™è£œã‚’åˆæœŸåŒ–ï¼ˆå‰ã®æ ã®äººã‚’æ®‹ã•ãªã„ï¼‰
    // â€» recentUsers ãŒ const ãªã‚‰ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€å®£è¨€ã¯å¿…ãš `let recentUsers = new Map();` ã«ã—ã¦ã­
    recentUsers = new Map();
    renderAdminUsers();

    // è¡¨ç¤ºã¯ room_name ã‚’å„ªå…ˆ
    room = (row.room_name || room).toString();

    document.getElementById("roomName").value = room;
    document.getElementById("roomChip").textContent = room;
    document.getElementById("subTitle").textContent = "Room: " + room;

    setOwnerUI();

ã€€ã€€// â˜…è¿½åŠ ï¼šã‚µãƒ–æ ä¸»ã‚’DBã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆã“ã‚Œã‚’ã—ãªã„ã¨åæ˜ ã•ã‚Œãªã„ï¼‰
ã€€ã€€await loadSubOwnersFromDb();

ã€€ã€€// â˜…è¿½åŠ ï¼šã‚µãƒ–æ ä¸»ã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
ã€€ã€€await startSubOwnersRealtime();

ã€€ã€€// â˜…è¿½åŠ ï¼šæ¨©é™UIæ›´æ–°ï¼ˆadminCardè¡¨ç¤ºãªã©ï¼‰
ã€€ã€€updateTop();


    // BANãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®éƒ¨å±‹ã®ã“ã®å›ã ã‘ï¼‰
    await checkBanned();

    // ç›£è¦–é–‹å§‹ï¼ˆéƒ¨å±‹å‰Šé™¤ / kick / ban / forcebackï¼‰
    await startRoomInfoRealtime();
    await startRoomDeleteWatch();
    await startRoomEventsWatch();
    await startRoomMemberHeartbeat();
    await startRoomMembersRealtime();
    await loadRoomMembersForUI();
    if (canKick()) await loadRoomMembersForAdmin();

    await loadMessages();
    await startMessagesRealtime();

    await loadActiveCallUsers();
    await startCallParticipantsRealtime();

    setReady(true, "å¾…æ©Ÿä¸­");

    // èªè¨¼çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰è¡¨ç¤ºæ›´æ–°ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œå¯¾å¿œï¼‰
    sb.auth.onAuthStateChange(async (event, session)=> {
      const sessionUser = session?.user || null;
      if (!sessionUser){
        authUser = null;
        updateTop();
        location.href = "./login.html";
        return;
      }

      const { data: u, error: uErr } = await sb.auth.getUser();
      if (uErr) log("getUser error", uErr);

      authUser = u?.user || sessionUser;

      await reloadName();
      updateTop();
    });

    log("ready room=", room, "roomId=", roomId);
  }catch(e){
    log("init fatal error", e);
    alert("åˆæœŸåŒ–ã«å¤±æ•—: " + (e?.message || e));
    goLobby();
  }
})();

/* =================== rooms ã®è¡Œã‚’ç¢ºå®šï¼ˆidå„ªå…ˆï¼‰ =================== */
async function resolveRoomRow(urlRoom, urlRoomId){
  // â˜…1) URLã« room_id ãŒã‚ã‚‹ãªã‚‰æœ€å„ªå…ˆã§ãã‚Œã‚’å–ã‚Šã«è¡Œã
  if (urlRoomId){
    const { data: byId, error: e1 } = await sb
      .from("rooms")
      .select("id, room_name, created_at, owner_id")
      .eq("id", urlRoomId)
      .maybeSingle();

    if (!e1 && byId) return byId;

    // room_id ãŒå£Šã‚Œã¦ã‚‹/æ¶ˆã•ã‚ŒãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
    log("resolveRoomRow: room_id not found -> fallback", { urlRoomId, e1 });
  }

  // â˜…2) room_name ã§æœ€æ–°ã®éƒ¨å±‹ï¼ˆåŒåãŒè¤‡æ•°ã‚ã£ã¦ã‚‚æœ€æ–°ã‚’å–ã‚‹ï¼‰
  const rn = (urlRoom || "").trim();
  if (!rn) return null;

  const { data: byName, error: e2 } = await sb
    .from("rooms")
    .select("id, room_name, created_at, owner_id")
    .eq("room_name", rn)
    .order("created_at", { ascending:false })
    .limit(1)
    .maybeSingle();

  if (e2) throw e2;
  return byName || null;
}

function safeKey(s){
  // Storageã®ã‚­ãƒ¼ã«ä½¿ãˆã‚‹æ–‡å­—ã ã‘ã«ã™ã‚‹ï¼ˆè‹±æ•°å­— _ -ï¼‰
  let t = String(s || "").trim();
  t = t.replace(/[^a-zA-Z0-9_-]+/g, "_");
  t = t.replace(/_+/g, "_").replace(/^_+|_+$/g, "");
  return t || "room";
}
  
function scrollToSection(id){
  const el = document.getElementById(id);
  if (!el) return;

  const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
  window.scrollTo({
    top: y,
    behavior: "smooth"
  });
}



</script>

  <!-- ===================
       ğŸ“± Bottom Navigation
       =================== -->
  <nav class="bottomNav" aria-label="bottom navigation">
    <div class="bottomNavInner">
      <button class="navBtn" type="button" onclick="goLobby()" aria-label="ãƒ­ãƒ“ãƒ¼">
        <div class="navIcon">ğŸ </div><div class="navLabel">ãƒ­ãƒ“ãƒ¼</div>
      </button>

      <button class="navBtn active" type="button" onclick="scrollToTopSafe()" aria-label="ãƒ«ãƒ¼ãƒ ">
        <div class="navIcon">ğŸ—¨ï¸</div><div class="navLabel">ãƒ«ãƒ¼ãƒ </div>
      </button>

      <button class="navBtn" onclick="scrollToSection('callSection')">
  <div class="navIcon">ğŸ™ï¸</div>
  <div class="navLabel">é€šè©±</div>
</button>


      <button class="navBtn" onclick="scrollToSection('chatSection')">
  <div class="navIcon">ğŸ’¬</div>
  <div class="navLabel">ãƒãƒ£ãƒƒãƒˆ</div>
</button>


      <button class="navBtn" type="button" onclick="openSheet()" aria-label="è¨­å®š">
        <div class="navIcon">âš™ï¸</div><div class="navLabel">è¨­å®š</div>
      </button>
    </div>
  </nav>

  <!-- è¨­å®šã‚·ãƒ¼ãƒˆï¼ˆç°¡æ˜“ï¼‰ -->
  <div class="sheetBackdrop" id="sheetBackdrop" role="dialog" aria-modal="true" aria-label="è¨­å®š">
    <div class="sheet">
      <div class="sheetHead">
        <b>âš™ï¸ è¨­å®š</b>
        <button class="btn btnSmall" type="button" onclick="closeSheet()">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sheetBtns">
        <button class="btn btnSmall btnAccent2" type="button" onclick="goProfile()">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
        <button class="btn btnSmall" type="button" onclick="goLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
        <button class="btn btnSmall danger" type="button" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div class="hint" style="padding: 0 14px 14px;">
        â€» ç”»é¢ä¸‹ã®ãƒŠãƒ“ã§ã€Œé€šè©±ã€ã€Œãƒãƒ£ãƒƒãƒˆã€ã«ã™ãé£›ã¹ã‚‹ã‚ˆ
      </div>
    </div>
  </div>


<!-- ãƒˆãƒ¼ã‚¹ãƒˆç½®ãå ´ï¼ˆé€šçŸ¥ï¼‰ -->
<div class="toastWrap" id="toastWrap"></div>

</body>
</html>





