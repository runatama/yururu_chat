
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Room</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0d1a33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --muted2:rgba(234,242,255,.45);
      --good:#35d0a7;
      --warn:#ffb84d;
      --bad:#ff6b6b;
      --accent:#78a7ff;
      --accent2:#a68bff;
      --glow:rgba(120,167,255,.45);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(120,167,255,.20), transparent 55%),
        radial-gradient(900px 500px at 80% 40%, rgba(166,139,255,.18), transparent 55%),
        radial-gradient(800px 700px at 30% 90%, rgba(53,208,167,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(6,10,20,.78), rgba(6,10,20,.50));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbarInner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(120,167,255,.95), rgba(166,139,255,.65) 55%, rgba(53,208,167,.35));
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 10px 26px rgba(120,167,255,.18);
    }
    .brandText b{ display:block; font-size:14px; letter-spacing:.3px; }
    .brandText span{ display:block; font-size:12px; color:var(--muted); margin-top:2px; }

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      box-shadow: 0 10px 20px rgba(0,0,0,.14);
    }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(120,167,255,.35), rgba(166,139,255,.25));
      border-color: rgba(120,167,255,.35);
      box-shadow: 0 12px 26px rgba(120,167,255,.14);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,107,107,.25), rgba(166,139,255,.10));
      border-color: rgba(255,107,107,.35);
    }
    .pill{
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

.avatar{
  width:26px;height:26px;border-radius:50%;
  object-fit:cover;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  flex:0 0 auto;
}
.avatar.sm{ width:22px;height:22px; }
.avatarFallback{
  width:26px;height:26px;border-radius:50%;
  display:inline-flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:900;
  color:rgba(234,242,255,.9);
  border:1px solid rgba(255,255,255,.14);
  background: radial-gradient(circle at 30% 30%, rgba(120,167,255,.35), rgba(166,139,255,.22));
  flex:0 0 auto;
  user-select:none;
}
.avatarFallback.sm{ width:22px;height:22px;font-size:11px; }
.userBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  cursor:pointer;
  color:var(--muted);
  font-size:12px;
}
.userBtn:hover{ background: rgba(255,255,255,.06); }
.nameText{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width: 240px;
}

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px 14px 26px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .brand{ min-width:auto; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .cardHeader b{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      letter-spacing:.2px;
    }
    .chip{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .cardBody{ padding:14px; }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }
    .field label{ font-size:12px; color:var(--muted); }
    input[type="text"], input[type="file"], textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,12,24,.45);
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(234,242,255,.45); }
    .hint{ font-size:12px; color:var(--muted2); line-height:1.5; }

    .statusRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(7,12,24,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius: 16px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(234,242,255,.25);
      box-shadow: 0 0 0 3px rgba(234,242,255,.06);
      flex:0 0 auto;
    }
    .dot.ok{ background: var(--good); box-shadow: 0 0 0 3px rgba(53,208,167,.18); }
    .dot.ng{ background: var(--bad); box-shadow: 0 0 0 3px rgba(255,107,107,.18); }
    .statusText{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }
    .statusText b{ font-size:12px; }
    .statusText span{ font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .divider{ height:1px; background: rgba(255,255,255,.08); margin:14px 0; }

    /* ===== call area ===== */
    .callTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      justify-content:space-between;
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
    }
    .btnAccent{
      background: linear-gradient(135deg, rgba(53,208,167,.20), rgba(120,167,255,.15));
      border-color: rgba(53,208,167,.30);
    }
    .btnAccent2{
      background: linear-gradient(135deg, rgba(120,167,255,.22), rgba(166,139,255,.18));
      border-color: rgba(120,167,255,.30);
    }
    .btnMuted{
      background: rgba(255,255,255,.05);
    }
    .rangeRow{
      margin-top:10px;
      background: rgba(7,12,24,.30);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .rangeRow .label{
      font-size:12px; color:var(--muted);
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    /* ===== lists ===== */
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .listItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,12,24,.25);
    }
    .listItem .name{
      font-size:13px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .listItem .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge{
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--muted);
    }
    
    .badge.admin{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.20));
      color: var(--text);
      font-weight: 900;
    }
.badge.good{ border-color: rgba(53,208,167,.30); color: rgba(165,255,230,.95); background: rgba(53,208,167,.10); }
    .badge.warn{ border-color: rgba(255,184,77,.35); color: rgba(255,220,170,.95); background: rgba(255,184,77,.10); }
    .badge.bad{ border-color: rgba(255,107,107,.35); color: rgba(255,190,190,.95); background: rgba(255,107,107,.10); }

    /* ===== right side ===== */
    .rightCol{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }
    .chatBox{
      height: 520px;
      overflow:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background: rgba(7,12,24,.25);
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.08);
    }
    @media (max-width: 980px){
      .chatBox{ height: 50vh; }
    }
    .msgHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .msgMeta{ color: rgba(234,242,255,.40); font-size:11px; }

    .msgActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .trashBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(234,242,255,.85);
      padding:6px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      line-height:1;
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .trashBtn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
    }
    .trashBtn:active{ transform: translateY(1px); }

    .msgBody{
      font-size:14px;
      line-height:1.5;
      color:var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    /* â˜…æœŸé™åˆ‡ã‚Œè¡¨ç¤ºç”¨ */
    .msgExpired{
      font-size:13px;
      line-height:1.5;
      color: rgba(234,242,255,.55);
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 6px;
    }
    .msgImg{
      margin-top:8px;
      width:100%;
      max-width:520px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 22px rgba(0,0,0,.22);
    }
    .composer{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
    }
    .composer .left{
      display:flex; flex-direction:column; gap:10px;
      min-width:0;
    }
    .composer textarea{
      min-height: 52px;
      resize: vertical;
    }
    .composer .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .fileRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(7,12,24,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius: 16px;
    }
    .fileName{
      font-size:12px; color:var(--muted);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .tiny{ font-size:11px; color: rgba(234,242,255,.45); }
    details{
      border-top:1px solid rgba(255,255,255,.08);
      margin-top:14px;
      padding-top:10px;
    }
    summary{ cursor:pointer; color: var(--muted); font-size:12px; }
    #log{
      margin-top:10px;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,12,24,.35);
      max-height: 200px;
      overflow:auto;
      color: rgba(234,242,255,.78);
    }

    /* ===== audio cards ===== */
    #audios{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .audioWrap{
      background: rgba(7,12,24,.35);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:12px;
      overflow:hidden;
    }
    .audioTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-size:12px;
      color:var(--muted);
    }
    .audioCtl{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius: 16px;
    }
    .audioCtl .lbl{ font-size:12px; color:var(--muted); }
    .audioCtl .val{ font-size:12px; color:var(--text); min-width: 34px; text-align:right; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <b>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</b>
          <span id="subTitle">Room</span>
        </div>
      </div>

      <div class="topActions">
        <button class="userBtn" id="userPill" type="button" onclick="goProfile()">æœªãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="btn primary" onclick="goLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
        <button class="btn danger" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- ===== left column ===== -->
    <div class="leftCol">
      <div class="card">
        <div class="cardHeader">
          <b>ğŸ  ç¾åœ¨ã®éƒ¨å±‹</b>
          <span class="chip" id="roomChip">-</span>
        </div>
        <div class="cardBody">
          <div class="field">
            <label>éƒ¨å±‹å</label>
            <input id="roomName" type="text" readonly />
          
            <div class="row" id="roomNameEditRow" style="display:none; gap:10px; flex-wrap:wrap;">
              <button class="btn btnSmall btnAccent2" type="button" id="saveRoomNameBtn" onclick="saveRoomName()">ğŸ’¾ éƒ¨å±‹åã‚’å¤‰æ›´</button>
              <button class="btn btnSmall" type="button" id="resetRoomNameBtn" onclick="resetRoomNameInput()">â†© å…ƒã«æˆ»ã™</button>
            </div>
            <div class="hint" id="roomNameHint">â€» éƒ¨å±‹åã¯æ ä¸»ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã ã‘å¤‰æ›´ã§ãã¾ã™</div>
</div>
          <div class="row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btnSmall" onclick="leaveRoom()">ğŸšª é€€å®¤</button>
              <button class="btn btnSmall danger" id="deleteRoomBtn" style="display:none;" onclick="deleteRoomNow()">ğŸ—‘ éƒ¨å±‹ã‚’å‰Šé™¤</button>
          </div>

          <div style="margin-top:12px;" class="statusRow">
            <div class="statusText">
              <div class="dot" id="readyDot"></div>
              <div style="min-width:0;">
                <b id="readyTitle">æº–å‚™OK</b>
                <span id="readySub">å¾…æ©Ÿä¸­</span>
              </div>
            </div>
            <span class="badge good" id="readyBadge">Ready</span>
          </div>
        </div>
      </div>
      <div class="card" id="adminCard" style="display:none;">
        <div class="cardHeader">
          <b>ğŸ›¡ï¸ æ ä¸»ãƒ„ãƒ¼ãƒ«ï¼ˆKick / Ban / å¼·åˆ¶ãƒ­ãƒ“ãƒ¼æˆ»ã—ï¼‰</b>
          <span class="chip">Owner</span>
        </div>
        <div class="cardBody">
          <div class="hint">â€» ã“ã®éƒ¨å±‹ã®ã€Œä»Šå›ã®éƒ¨å±‹(roomsã®1è¡Œ)ã€ã ã‘ã«åŠ¹ãã€‚éƒ¨å±‹ã‚’å‰Šé™¤â†’åŒåã§ä½œã‚Šç›´ã—ã¦ã‚‚å‰ã®Banã¯å¼•ãç¶™ãŒã‚Œãªã„ã€‚</div>

          <div class="divider"></div>

          <div class="field">
            <label>å¯¾è±¡ï¼ˆä»Šã®éƒ¨å±‹ã«ã„ã‚‹/æœ€è¿‘ç™ºè¨€ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</label>
            <div class="list" id="adminUsersList">
              <div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆæ‰‹å…¥åŠ›ã‚‚OKï¼‰</label>
            <input id="adminTargetUid" type="text" placeholder="uuid" />
            <div class="hint">ä¸Šã®ãƒªã‚¹ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŠ¼ã™ã¨è‡ªå‹•ã§å…¥ã‚‹</div>
          </div>

          <div class="field">
            <label>ç†ç”±ï¼ˆç›¸æ‰‹ã«è¡¨ç¤ºï¼‰</label>
            <input id="adminReason" type="text" placeholder="ä¾‹: è¿·æƒ‘è¡Œç‚ºã®ãŸã‚" />
          </div>

          <div class="row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btnSmall btnAccent2" type="button" onclick="kickUser()">ğŸ‘¢ Kick</button>
            <button class="btn btnSmall danger" type="button" onclick="banUser()">â›” Ban</button>
            <button class="btn btnSmall danger" type="button" onclick="forceBackAll()">âš  å…¨å“¡ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã™</button>
          </div>

          <div class="hint" style="margin-top:10px;">Kick/Ban ã¯ãã®ç¬é–“ãƒ«ãƒ¼ãƒ ã«ã„ã‚‹äººã‚’ãƒ­ãƒ“ãƒ¼ã«æˆ»ã™ï¼ˆç†ç”±ä»˜ãï¼‰ã€‚Ban ã¯å†å…¥å®¤ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã€‚</div>
        </div>
      </div>


      <div class="card">
        <div class="cardHeader">
          <b>ğŸ™ï¸ éŸ³å£°é€šè©±ï¼ˆè¤‡æ•°äººï¼‰</b>
          <span class="chip">Call</span>
        </div>
        <div class="cardBody">
          <div class="callTop">
            <button class="btn btnSmall primary btnAccent2" onclick="joinCall()" id="joinBtn">é€šè©±ã«å‚åŠ ï¼ˆé–‹å§‹ï¼‰</button>
            <button class="btn btnSmall btnMuted" onclick="toggleMute()" id="muteBtn">ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF</button>
            <button class="btn btnSmall danger" onclick="leaveCall()" id="leaveBtn">é€šè©±é€€å‡º</button>
          </div>

          <div class="rangeRow">
            <div class="label">
              <span>è‡ªåˆ†ã®ãƒã‚¤ã‚¯éŸ³é‡: <b id="micGainLabel">100</b></span>
              <span class="tiny">â€» é€ä¿¡éŸ³é‡ï¼ˆã‚ãªãŸã®å£°ã®å¤§ãã•ï¼‰</span>
            </div>
            <input id="micGain" type="range" min="1" max="100" value="100" />
            <div class="hint" style="margin-top:8px;" id="callState">æœªæ¥ç¶šï¼ˆå¿…è¦ãªã‚‰é€šè©±ã«å‚åŠ ã‚’æŠ¼ã—ã¦ã­ï¼‰</div>
          </div>

          <div class="divider"></div>

          <div class="card" style="background:transparent;border:none;box-shadow:none;">
            <div class="cardHeader" style="border:1px solid rgba(255,255,255,.08); border-radius:18px; margin-bottom:10px;">
              <b>ğŸ‘¥ å‚åŠ è€…ï¼ˆé€šè©±ï¼šãƒãƒ£ãƒ³ãƒãƒ«æ¥ç¶šä¸­ã®ã¿è¡¨ç¤ºï¼‰</b>
              <span class="chip">Presence</span>
            </div>
            <div class="list" id="callUsersList">
              <div class="hint">æœªæ¥ç¶š</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="card" style="background:transparent;border:none;box-shadow:none;">
            <div class="cardHeader" style="border:1px solid rgba(255,255,255,.08); border-radius:18px; margin-bottom:10px;">
              <b>ğŸ“ ä»Šã®éƒ¨å±‹ã§é€šè©±ã—ã¦ã‚‹äººï¼ˆé€šè©±ã«å‚åŠ ã—ãªãã¦ã‚‚è¦‹ãˆã‚‹ï¼‰</b>
              <span class="chip">call_participants</span>
            </div>
            <div class="list" id="activeCallUsersList">
              <div class="hint">ä»Šã¯èª°ã‚‚é€šè©±ã—ã¦ãªã„ã‚ˆ</div>
            </div>
          
          <div class="card" style="background:transparent;border:none;box-shadow:none;">
            <div class="cardHeader" style="border:1px solid rgba(255,255,255,.08); border-radius:18px; margin-bottom:10px;">
              <b>ğŸ‘¥ ã“ã®éƒ¨å±‹ã«ã„ã‚‹äººï¼ˆå…¥å®¤ã—ã¦ã‚‹äººï¼‰</b>
              <span class="chip">room_members</span>
            </div>
            <div class="list" id="roomMembersList">
              <div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            </div>
            <div class="hint" style="margin-top:6px;">â€» ã“ã“ã¯ã€Œé€šè©±ã«å‚åŠ ã—ã¦ãªã„äººã€ã‚‚å«ã‚€ã‚ˆã€‚æ ä¸»ã¯åå‰ã‚’æŠ¼ã™ã¨Kick/Banã®å¯¾è±¡ã«å…¥ã‚‹ã€‚</div>
          </div>
</div>

          <details>
            <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
            <div id="log"></div>
          </details>
        </div>
      </div>
    </div>

    <!-- ===== right column ===== -->
    <div class="rightCol">
      <div class="card">
        <div class="cardHeader">
          <b>ğŸ”Š ç›¸æ‰‹ã®éŸ³å£°ï¼ˆã“ã“ã§ç›¸æ‰‹ã®éŸ³é‡ã‚’èª¿æ•´ï¼‰</b>
          <span class="chip">Audio</span>
        </div>
        <div class="cardBody">
          <div id="audios"></div>
          <div class="hint" style="margin-top:10px;">
            â€» é€šè©±ã«å‚åŠ ã—ã¦ã€ç›¸æ‰‹ã¨ç¹‹ãŒã‚‹ã¨ã“ã“ã«éŸ³å£°ãŒå‡ºã‚‹ã‚ˆ
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <b>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆï¼ˆç”»åƒOKï¼‰</b>
          <span class="chip">Messages</span>
        </div>
        <div class="cardBody">
          <div id="chat" class="chatBox"></div>

          <div class="divider"></div>

          <div class="composer">
            <div class="left">
              <textarea id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç”»åƒã ã‘é€ã‚‹ãªã‚‰ç©ºã§ã‚‚OKï¼‰"></textarea>

              <div class="fileRow">
                <div class="fileName" id="imgName">æœªé¸æŠ</div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <input id="imgFile" type="file" accept="image/*" style="max-width:190px;" />
                </div>
              </div>

              <div class="hint" id="uploadHint" style="margin-top:-2px;">
                â€» ç”»åƒã¯ Storageï¼ˆpublicï¼‰ã«ã‚¢ãƒƒãƒ—â†’URLã‚’ãƒãƒ£ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã‚ˆï¼ˆ5MBã¾ã§ï¼‰
              </div>
            </div>

            <div class="actions">
              <button class="btn primary" onclick="sendMsg()">ğŸ“¨ é€ä¿¡</button>
              <button class="btn btnAccent2" onclick="sendImage()" id="sendImgBtn">ğŸ–¼ï¸ ç”»åƒé€ä¿¡</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
    const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

/* â˜…ãƒ­ã‚°ã‚¤ãƒ³åˆ‡ã‚Œå¯¾ç­–ï¼špkce/persistSession ã‚ã‚Š */
const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);
// ===== é‹å–¶åˆ¤å®šï¼ˆIDãƒ™ãƒ¼ã‚¹ãƒ»å®‰å…¨ï¼‰=====
function isAdmin(user){
  return user?.app_metadata?.is_admin === true || isAdminUserId(user?.id);
}


// ===== é‹å–¶ï¼ˆAdminï¼‰åˆ¤å®šï¼šåå‰ã§ã¯ãªã user_id ã§åˆ¤å®šã™ã‚‹ï¼ˆãªã‚Šã™ã¾ã—é˜²æ­¢ï¼‰=====
// ã“ã“ã«ã€Œé‹å–¶ã«ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã€ã‚’å…¥ã‚Œã¦ã­ï¼ˆSupabase Auth ã® user.idï¼‰
// ä¾‹: const ADMIN_UIDS = ["aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"];
const ADMIN_UIDS = [
  "054b7993-499d-45a7-ae15-c9f0e37bd2b9",
  "5f96d1c0-088e-4125-8670-e0fef1b563a6",
];

function isAdminUserId(userId){
  const uid = String(userId || "").trim();
  if (!uid) return false;
  return ADMIN_UIDS.includes(uid);
}

function adminBadgeHtmlByUserId(userId){
  return isAdminUserId(userId) ? '<span class="badge admin">é‹å–¶</span>' : '';
}
/* ç”»åƒç”¨ï¼ˆPublic bucketåï¼‰ */
const IMAGE_BUCKET = "chat-images";
const MAX_IMAGE_BYTES = 5 * 1024 * 1024; // 5MB

/* â˜… ç”»åƒã ã‘æŠ•ç¨¿ã®ãƒ€ãƒŸãƒ¼æ–‡å­—ï¼ˆDBåˆ¶ç´„å›é¿ç”¨ï¼‰ */
const IMAGE_PLACEHOLDER = "[image]";

/* ===== çŠ¶æ…‹ ===== */
let authUser = null;
let room = "";
let roomId = "";
let roomOwnerId = "";
let isOwner = false;
let name = "";
let myAvatarUrl = "";

let messagesChannel = null;

/* ===== call_participants ç›£è¦–ï¼ˆé€šè©±ä¸­ä¸€è¦§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰ ===== */
let callUsersChannel = null;

/* ===== room_members ç›£è¦–ï¼ˆéƒ¨å±‹ã«ã„ã‚‹äººä¸€è¦§ï¼‰ ===== */
let roomMembersChannel = null;

/* ===== room_events ç›£è¦–ï¼ˆkick/ban/forcebackï¼‰ ===== */
let roomEventsChannel = null;

/* ===== rooms ç›£è¦–ï¼ˆéƒ¨å±‹åãªã©ï¼‰ ===== */
let roomInfoChannel = null;
let roomNameSaveLock = false; // äºŒé‡é€ä¿¡é˜²æ­¢

/* ===== é€šè©± ===== */
// ï¼ˆé€šè©±ã®çŠ¶æ…‹å¤‰æ•°ã¯ä¸‹ã®ã€Œé€šè©±ï¼ˆå®‰å®šç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®£è¨€ã—ã¦ã„ã¾ã™ï¼‰

/* ===== util ===== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[room]", ...args); // lobbyãªã‚‰ "[lobby]"
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}



function setUploadHint(t){
  const el = document.getElementById("uploadHint");
  if (el) el.textContent = t;
}

function getRoomFromUrl(){
  const p = new URLSearchParams(location.search);
  return (p.get("room") || "").trim();
}

function getRoomIdFromUrl(){
  const p = new URLSearchParams(location.search);
  return (p.get("room_id") || "").trim();
}

function myUid(){
  return authUser?.id || "";
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function escapeAttr(s){
  return escapeHtml(s).replaceAll("`","&#096;");
}
function getInitial(s){
  const t = String(s || "").trim();
  if (!t) return "?";
  return Array.from(t)[0] || "?";
}
function normalizeAvatarUrl(url, ver){
  const u = String(url||"").trim();
  if (!u) return "";
  const v = String(ver||"").trim();
  if (!v) return u;
  return u + (u.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(v);
}
function avatarHtml(url, label, size="", ver=""){
  const cls = size ? `avatar ${size}` : "avatar";
  const fbCls = size ? `avatarFallback ${size}` : "avatarFallback";
  const u = normalizeAvatarUrl(url, ver);
  if (u){
    return `<img class="${cls}" src="${escapeAttr(u)}" alt="avatar" loading="lazy" />`;
  }
  return `<div class="${fbCls}">${escapeHtml(getInitial(label))}</div>`;
}

// â˜…å¿…ãš avatarHtml ã®å¤–ï¼ˆã“ã“ï¼‰ã«ç½®ãï¼ï¼
function getPreferredAvatarMeta(){
  const um = authUser?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const url = hasCustom
    ? String(um.custom_avatar_url || "").trim()
    : String(um.avatar_url || "").trim();
  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();
  return { url, ver };
}

/* =================== ãƒŠãƒ“ =================== */
function goLobby(){
  location.href = "./lobby.html";
}
function goProfile(){
  const rn = encodeURIComponent(room || "");
  location.href = "./profile.html?back=room&room=" + rn + "&_r=" + Date.now();
}
async function doLogout(){
  await sb.auth.signOut();
  location.href = "./login.html";
}
function leaveRoom(){
  try{ deleteRoomMember(); }catch(e){}
  goLobby();
}

/* =================== è¡¨ç¤ºæ›´æ–° =================== */
function setReady(ok, sub){
  const dot = document.getElementById("readyDot");
  const subEl = document.getElementById("readySub");
  const badge = document.getElementById("readyBadge");

  if(ok){
    dot.classList.add("ok"); dot.classList.remove("ng");
    badge.className = "badge good";
    badge.textContent = "Ready";
  }else{
    dot.classList.add("ng"); dot.classList.remove("ok");
    badge.className = "badge bad";
    badge.textContent = "NG";
  }
  subEl.textContent = sub || "";
}

function updateTop(){
  const pill = document.getElementById("userPill");
  const dn = (authUser?.user_metadata?.display_name || "").trim();
  const em = (authUser?.email || "").trim();
  const shown = dn ? dn : (em ? em : "æœªãƒ­ã‚°ã‚¤ãƒ³");

  const avm = getPreferredAvatarMeta();
  pill.innerHTML = `${avatarHtml(avm.url, shown, "", avm.ver)} <span class="nameText">ğŸ‘¤ ${escapeHtml(shown)}</span>${adminBadgeHtmlByUserId(authUser.id)}`;
}

async function reloadName(){
  // authUser ã¯ requireLoginOrRedirect() ã§æœ€æ–°ã‚’å–ã‚Šç›´ã—ã¦ã„ã‚‹æƒ³å®š
  const dn = (authUser?.user_metadata?.display_name || "").trim();
  const em = (authUser?.email || "").trim();
  name = dn || em || "åç„¡ã—ã•ã‚“";

  // â˜…Googleãƒ­ã‚°ã‚¤ãƒ³å¯¾ç­–ï¼šcustom_avatar_url ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
  const avm = getPreferredAvatarMeta();
  myAvatarUrl = normalizeAvatarUrl(avm.url, avm.ver);

  // å…¥åŠ›æ¬„ãªã©ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§åæ˜ ã—ã¦OKï¼ˆä»Šã¯ãƒˆãƒƒãƒ—è¡¨ç¤ºã§ä½¿ã†ã ã‘ï¼‰
}

/* =================== ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆ =================== */
async function requireLoginOrRedirect(){
  const { data: ses, error: sesErr } = await sb.auth.getSession();
  if (sesErr) log("getSession error", sesErr);

  const sessionUser = ses?.session?.user || null;
  if (!sessionUser){
    location.href = "./login.html";
    return false;
  }

  // â˜…é‡è¦ï¼šrefreshSession ã¯è©°ã¾ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼ˆãƒ­ãƒ“ãƒ¼ã¨åŒã˜æ–¹é‡ï¼‰
  try{
    const t = Promise.race([
      sb.auth.refreshSession(),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('refreshSession timeout')), 8000))
    ]);
    await t;
  }catch(e){ log('refreshSession warn', e); }

  // â˜…è¿½åŠ ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°userã‚’å–ã‚Šç›´ã™
  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) log("getUser error", uErr);

  authUser = u?.user || sessionUser;
  return true;
}



/* =========================================================
   ãƒãƒ£ãƒƒãƒˆï¼ˆmessagesï¼‰
   ========================================================= */
async function startMessagesRealtime(){
  if (messagesChannel) return;

  messagesChannel = sb
    .channel("messages-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"messages_v3" }, async (payload)=>{
      const nr = payload.new || {};
      const or = payload.old || {};
      const rid = nr.room_id || or.room_id;
      if (rid === roomId) await loadMessages();
    })
    .subscribe();
}

function fmtTime(iso){
  try{
    const d = new Date(iso);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }catch{
    return "";
  }
}

async function loadMessages(){
  if (!roomId) return;
  const { data, error } = await sb
    .from("messages_v3")
    .select("id, room_id, name, avatar_url, message, image_url, image_path, created_at, user_id, deleted, deleted_at, deleted_by")
    .eq("room_id", roomId)
    .order("created_at", { ascending:true })
    .limit(200);

  if (error){ log("loadMessages error", error); return; }

  // æ ä¸»ãƒ„ãƒ¼ãƒ«ç”¨ï¼šæœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œã‚’æ›´æ–°
    (data || []).forEach(mm=>{ if (mm.user_id) upsertRecentUser(mm.user_id, mm.name, mm.avatar_url); });
    renderAdminUsers();

    const box = document.getElementById("chat");
    box.innerHTML = "";

    (data || []).forEach(m=>{
      const wrap = document.createElement("div");

      const head = document.createElement("div");
      head.className = "msgHead";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.alignItems = "center";
      left.style.gap = "8px";
      left.innerHTML = `${avatarHtml(m.avatar_url, (m.name || ""), "sm")} <span class="nameText">${escapeHtml(m.name || "")}</span>${adminBadgeHtmlByUserId(m.user_id)}`;

      // å³å´ï¼ˆæ™‚åˆ» + å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
      const actions = document.createElement("div");
      actions.className = "msgActions";

      const meta = document.createElement("div");
      meta.className = "msgMeta";
      meta.textContent = fmtTime(m.created_at);

      actions.appendChild(meta);

      // âœ… è‡ªåˆ†ãŒé€ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã‚´ãƒŸç®±ã‚’è¡¨ç¤ºï¼ˆæœ¬äººã ã‘æ¶ˆã›ã‚‹ï¼‰
      if (m.user_id && m.user_id === myUid() && !m.deleted){
        const del = document.createElement("button");
        del.className = "trashBtn";
        del.type = "button";
        del.title = "è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤";
        del.textContent = "ğŸ—‘ï¸";
        del.onclick = async ()=>{
          await deleteMessage(m);
        };
        actions.appendChild(del);
      }

      head.appendChild(left);
      head.appendChild(actions);
      wrap.appendChild(head);

      const bodyText = (m.message || "").trim();
      const isImagePlaceholder = (bodyText === IMAGE_PLACEHOLDER);
      const hasImage = !!m.image_url;

      if (m.deleted){
        // âœ… å‰Šé™¤æ¸ˆã¿ï¼šæœ¬æ–‡ã‚„ç”»åƒã¯è¡¨ç¤ºã—ãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ã¯æ®‹ã™ï¼‰
        if (!isImagePlaceholder){
          const delMsg = document.createElement("div");
          delMsg.className = "msgExpired";
          delMsg.textContent = "ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
          wrap.appendChild(delMsg);
        }

        if (hasImage || isImagePlaceholder){
          const delImg = document.createElement("div");
          delImg.className = "msgExpired";
          delImg.textContent = "ğŸ—‘ï¸ ç”»åƒã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
          wrap.appendChild(delImg);
        }
      }else{
        // âœ… é€šå¸¸è¡¨ç¤º
        if (bodyText && !isImagePlaceholder){
          const body = document.createElement("div");
          body.className = "msgBody";
          body.textContent = bodyText;
          wrap.appendChild(body);
        }

        // âœ… ç”»åƒãŒã‚ã‚‹ãªã‚‰è¡¨ç¤º
        // âœ… ç”»åƒãŒã‚ã‚‹ãªã‚‰è¡¨ç¤º
  if (hasImage){
    const img = document.createElement("img");
    img.className = "msgImg";
    img.src = m.image_url;
    img.loading = "lazy";
    img.alt = "image";

    // â˜…è¿½åŠ ï¼šã‚µãƒ¼ãƒãƒ¼å´ã§å‰Šé™¤ã•ã‚Œã¦ãŸã‚‰ã€Œå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€ã«ç½®ãæ›ãˆã‚‹
    img.onerror = () => {
      try { img.remove(); } catch {}
      const delImg = document.createElement("div");
      delImg.className = "msgExpired";
      delImg.textContent = "ğŸ—‘ï¸ ç”»åƒã¯ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
      wrap.appendChild(delImg);
    };

    wrap.appendChild(img);
  }


        // âœ… æœŸé™åˆ‡ã‚Œã§ç”»åƒãŒæ¶ˆã•ã‚ŒãŸã‚±ãƒ¼ã‚¹ï¼š [image] ãªã®ã« image_url ãŒç„¡ã„
        if (isImagePlaceholder && !hasImage){
          const ex = document.createElement("div");
          ex.className = "msgExpired";
          ex.textContent = "ğŸ—‘ï¸ ç”»åƒã¯æœŸé™åˆ‡ã‚Œã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
          wrap.appendChild(ex);
        }
      }

      box.appendChild(wrap);
    });

    box.scrollTop = box.scrollHeight;
  }

async function sendMsg(){
  const v = document.getElementById("msg").value.trim();
  if (!v) return;
  document.getElementById("msg").value = "";

  const { error } = await sb.from("messages_v3").insert({
    room_id: roomId,
    name,
    avatar_url: myAvatarUrl,
    message: v,
    image_url: null,
    user_id: myUid()
  });

  if (error){ alert("é€ä¿¡å¤±æ•—: " + error.message); }
}

/* ===== ç”»åƒé€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‰ãªã„ç‰ˆï¼‰ ===== */
async function sendImage(){
  const btn = document.getElementById("sendImgBtn");
  const fileInput = document.getElementById("imgFile");
  const oldHint = document.getElementById("uploadHint")?.textContent || "";

  // ä½•ãŒã‚ã£ã¦ã‚‚ UI ã‚’æˆ»ã™ãŸã‚ã®é–¢æ•°
  const restoreUI = ()=>{
    try{ if (btn) btn.disabled = false; }catch{}
    try{ setUploadHint(oldHint || "â€» ç”»åƒã¯ Storageï¼ˆpublicï¼‰ã«ã‚¢ãƒƒãƒ—â†’URLã‚’ãƒãƒ£ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã‚ˆï¼ˆ5MBã¾ã§ï¼‰"); }catch{}
  };

  try{
    if (btn) btn.disabled = true;

    const file = fileInput?.files?.[0];
    if (!file){
      alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ï¼");
      return;
    }
    if (file.size > MAX_IMAGE_BYTES){
      alert("ç”»åƒãŒå¤§ãã™ãã‚‹ã‚ˆï¼ˆæœ€å¤§5MBï¼‰");
      return;
    }
    if (!room || !myUid()){
      alert("éƒ¨å±‹ or ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã­ï¼");
      return;
    }

    // â˜…è¡çªã—ãªã„ ID ã‚’ä½œã‚‹ï¼ˆcrypto.randomUUID ãŒç„¡ã„ç’°å¢ƒã‚‚è€ƒæ…®ï¼‰
    let uidPart = "";
    try{
      uidPart = (crypto?.randomUUID?.() || "");
    }catch{}
    if (!uidPart){
      uidPart = "u" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }

    const safeName = String(file.name || "image")
      .replace(/[^\w.\-]+/g, "_")
      .slice(0, 80);

    const roomKey = safeKey(room);

    // â˜…çµ¶å¯¾ã«è¢«ã‚‰ãªã„ãƒ‘ã‚¹
    const path = `${roomKey}/${myUid()}/${uidPart}_${safeName}`;

    setUploadHint("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");

    // â˜…ã‚³ã‚±ãªã„ãŸã‚ã« upsert:trueï¼ˆã“ã“ãŒé‡è¦ï¼‰
    const { error: upErr } = await sb
      .storage
      .from(IMAGE_BUCKET)
      .upload(path, file, {
        cacheControl: "60",     // 1åˆ†ï¼ˆé•·ã™ãã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥äº‹æ•…ã‚’é¿ã‘ã‚‹ï¼‰
        upsert: true,           // â˜…è¡çªã—ã¦ã‚‚ä¸Šæ›¸ã
        contentType: file.type || "image/*"
      });

    if (upErr) throw upErr;

    const { data: pub } = sb.storage.from(IMAGE_BUCKET).getPublicUrl(path);
    const imageUrl = pub?.publicUrl;
    if (!imageUrl) throw new Error("publicUrl ãŒå–å¾—ã§ããªã‹ã£ãŸâ€¦");

    // DBã«ä¿å­˜ï¼ˆç”»åƒã ã‘æŠ•ç¨¿ï¼‰
    const { error: insErr } = await sb.from("messages_v3").insert({
      room_id: roomId,
      name,
      avatar_url: myAvatarUrl,
      message: IMAGE_PLACEHOLDER,
      image_url: imageUrl,
      image_path: path,
      user_id: myUid()
    });

    if (insErr) throw insErr;

    // æˆåŠŸï¼šUIãƒªã‚»ãƒƒãƒˆ
    try{ fileInput.value = ""; }catch{}
    try{ document.getElementById("imgName").textContent = "æœªé¸æŠ"; }catch{}
    setUploadHint("â€» ç”»åƒã¯ Storageï¼ˆpublicï¼‰ã«ã‚¢ãƒƒãƒ—â†’URLã‚’ãƒãƒ£ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã‚ˆï¼ˆ5MBã¾ã§ï¼‰");

    // è¡¨ç¤ºæ›´æ–°ï¼ˆå¤±æ•—ã—ã¦ã‚‚æ­¢ã‚ãªã„ï¼‰
    try{ await loadMessages(); }catch{}
  }catch(e){
    // â˜…çµ¶å¯¾ã«è½ã¨ã•ãªã„ï¼šãƒ­ã‚°ï¼‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘
    log("sendImage error FULL", e);

    // ã‚ˆãã‚ã‚‹ statusCode ã‚’å‡ºã™ã¨åŸå› ç‰¹å®šã—ã‚„ã™ã„
    const msg =
      (e?.message ? e.message : String(e)) +
      (e?.statusCode ? ` (statusCode: ${e.statusCode})` : "") +
      (e?.status ? ` (status: ${e.status})` : "");

    alert("ç”»åƒé€ä¿¡ã«å¤±æ•—: " + msg);
  }finally{
    restoreUI();
  }
}


/* =========================================================
   ğŸ—‘ï¸ è‡ªåˆ†ã®æŠ•ç¨¿ã ã‘å‰Šé™¤ï¼ˆæœ¬æ–‡ + ç”»åƒï¼‰
   - deletedãƒ•ãƒ©ã‚°ã§ã€Œå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€è¡¨ç¤ºã«ã™ã‚‹
   ========================================================= */
async function deleteMessage(m){
  try{
    if (!m?.id) return;

    const uid = myUid();
    console.log("[delete] uid=", uid, "m.id=", m.id, "m.user_id=", m.user_id);

    if (!uid){
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‹ã£ã½ã„ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã­");
      location.href = "./login.html";
      return;
    }
    if ((m.user_id || "") !== uid) return;

    const payload = {
      deleted: true,
      deleted_at: new Date().toISOString(),
      deleted_by: uid,
      // â˜…ç”»åƒãŒã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã€Œ3æ—¥å¾Œã«Storageã‹ã‚‰æ¶ˆã™ã€äºˆç´„ã‚’å…¥ã‚Œã‚‹
      image_purge_at: (m.image_path ? new Date(Date.now() + 3*24*60*60*1000).toISOString() : null),
      image_purged: false
    };
    console.log("[delete] payload=", payload);

    const { data, error } = await sb
      .from("messages_v3")
      .update(payload)
      .eq("id", m.id)
      .eq("user_id", uid)
      .select("id, deleted, deleted_at, deleted_by");

    console.log("[delete] data=", data);
    if (error){
      console.log("[delete] error(full)=", error);
      throw error;
    }

    await loadMessages();
  }catch(e){
    console.log("[delete] catch=", e);
    alert("å‰Šé™¤ã«å¤±æ•—: " + (e?.message || e));
  }
}

/* =========================================================
   ãƒ«ãƒ¼ãƒ å†…ã€Œé€šè©±ä¸­ã®äººã€è¡¨ç¤ºï¼ˆcall_participants ã‹ã‚‰èª­ã‚€ï¼‰
   ========================================================= */
async function loadActiveCallUsers(){
  const cutoff = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();

  const { data, error } = await sb
    .from("call_participants")
    .select("user_id, name, avatar_url, updated_at")
    .eq("room_id", roomId)
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  const box = document.getElementById("activeCallUsersList");
  box.innerHTML = "";

  if (error){
    log("loadActiveCallUsers error", error);
    box.innerHTML = "<div class='hint' style='color:#ff6b6b;'>é€šè©±ä¸­ãƒ¡ãƒ³ãƒãƒ¼å–å¾—å¤±æ•—</div>";
    return;
  }

  
  // æ ä¸»ãƒ„ãƒ¼ãƒ«ç”¨ï¼šé€šè©±å‚åŠ è€…ã‚‚å€™è£œã«è¿½åŠ 
  (data || []).forEach(u=>{ if (u.user_id) upsertRecentUser(u.user_id, u.name, u.avatar_url); });
  renderAdminUsers();
const list = (data || []).map(x=>({
    user_id: x.user_id,
    name: (x.name || x.user_id || "").toString(),
    avatar_url: (x.avatar_url || "").toString()
  }));

  if (list.length === 0){
    box.innerHTML = "<div class='hint'>ä»Šã¯èª°ã‚‚é€šè©±ã—ã¦ãªã„ã‚ˆ</div>";
    return;
  }

  const seen = new Set();
  const uniq = [];
  for (const p of list){
    const k = p.user_id || p.name;
    if (seen.has(k)) continue;
    seen.add(k);
    uniq.push(p);
  }

  for (const p of uniq){
    const row = document.createElement("div");
    row.className = "listItem";
    row.innerHTML = `
      <div class="name">ğŸ§ ${avatarHtml(p.avatar_url, p.name, "sm")} <span class="nameText">${escapeHtml(p.name)}</span>${adminBadgeHtmlByUserId(p.user_id)}</div>
      <div class="sub"><span class="badge good">é€šè©±ä¸­</span></div>
    `;
    box.appendChild(row);
  }
}

/* ===== call_participants realtimeï¼ˆéƒ¨å±‹ã®é€šè©±ä¸­ä¸€è¦§ï¼‰ ===== */
async function startCallParticipantsRealtime(){
  if (callUsersChannel) return;

  callUsersChannel = sb
    .channel("call-users-ch")
    .on("postgres_changes", { event:"*", schema:"public", table:"call_participants" }, async (payload)=>{
      const nr = payload.new || {};
      const or = payload.old || {};
      const rid = nr.room_id || or.room_id;
      if (rid === roomId) await loadActiveCallUsers();
    })
    .subscribe();
}

/* =========================================================
   âœ… é€šè©±ï¼ˆå®‰å®šç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰
   - Presence ã¨ Signal(Broadcast) ã‚’åˆ¥ãƒãƒ£ãƒ³ãƒãƒ«ã«åˆ†é›¢
   - joinCall å¤šé‡å®Ÿè¡Œé˜²æ­¢
   - Perfect Negotiationï¼ˆè¡çªã«å¼·ã„ï¼‰
   - ãƒŸãƒ¥ãƒ¼ãƒˆåŒæœŸ/ç›¸æ‰‹éŸ³é‡UI/ãƒã‚¤ã‚¯é€ä¿¡éŸ³é‡ï¼ˆGainï¼‰
   â€» micGainã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸‹ã®ã€ŒUI eventsã€å´ã‚’ãã®ã¾ã¾ä½¿ãˆã‚‹
   ========================================================= */

/* ===== é€šè©±ï¼šçŠ¶æ…‹ ===== */
let callPresenceChannel = null;  // presence å°‚ç”¨
let callSignalChannel = null;    // signaling(broadcast) å°‚ç”¨

let localStream = null;

// â˜…é€ä¿¡éŸ³é‡ï¼ˆãƒã‚¤ã‚¯ï¼‰ã‚’ 1-100 ã§èª¿æ•´ã™ã‚‹ãŸã‚ã® WebAudio
let audioCtx = null;
let micSource = null;
let micGainNode = null;
let processedStream = null;   // Gainé€šéå¾Œã®é€ä¿¡ç”¨Stream
let myMicGain = 1.0;          // 0.0-1.0ï¼ˆUIã¯1-100ï¼‰

let micMuted = false;

const pcs = new Map();        // peerId -> RTCPeerConnection
const mutedMap = new Map();   // peerId -> muted(boolean)
const makingOffer = new Map(); // peerId -> boolean
const ignoreOffer = new Map(); // peerId -> boolean

let joiningCall = false;
let joinedCall = false;

let heartbeatTimer = null;
const CALL_ALIVE_SEC = 30;

// â˜…ç›¸æ‰‹ã”ã¨ã®å—ä¿¡éŸ³é‡
const peerVolume = new Map(); // peerId -> 0.0-1.0

const ICE_SERVERS = [
  { urls: "stun:stun.l.google.com:19302" },
  { urls: "stun:global.stun.twilio.com:3478" }
];

/* ===== util ===== */
function setCallState(text){
  const el = document.getElementById("callState");
  if (el) el.textContent = text;
}
function setJoinBtn(enabled){
  const b = document.getElementById("joinBtn");
  if (b) b.disabled = !enabled;
}
function setMuteBtn(){
  const b = document.getElementById("muteBtn");
  if (b) b.textContent = "ãƒŸãƒ¥ãƒ¼ãƒˆ: " + (micMuted ? "ON" : "OFF");
}
function getIsPolite(peerId){
  // Perfect Negotiation: UUIDã®å¤§å°ã§å›ºå®šï¼ˆå¿…ãšç‰‡æ–¹ã ã‘ãŒpoliteï¼‰
  return String(myUid()) > String(peerId);
}

/* ===== Presence/Singal ãƒãƒ£ãƒ³ãƒãƒ«é–‹å§‹ ===== */
async function startCallChannels(){
  if (callPresenceChannel && callSignalChannel) return;

  // presence å°‚ç”¨
  callPresenceChannel = sb.channel(`call-presence-${room}`, {
    config: { presence: { key: myUid() } }
  });

  callPresenceChannel
    .on("presence", { event: "sync" }, ()=> onPresenceSync())
    .on("presence", { event: "join" }, ({ key, newPresences })=> onPresenceJoin(key, newPresences))
    .on("presence", { event: "leave" }, ({ key, leftPresences })=> onPresenceLeave(key, leftPresences));

  // signal å°‚ç”¨ï¼ˆbroadcastï¼‰
  callSignalChannel = sb.channel(`call-signal-${room}`, {
    config: { broadcast: { self: false } }
  });

  callSignalChannel
    .on("broadcast", { event: "signal" }, async ({ payload })=>{
      await onSignal(payload);
    });

  await Promise.all([
    callPresenceChannel.subscribe(async (status)=>{
      log("presence channel status:", status);
      if (status === "SUBSCRIBED"){
        await safeTrackPresence();
        await refreshPresenceList();
        refreshAudioTitles();
      }
    }),
    callSignalChannel.subscribe((status)=>{
      log("signal channel status:", status);
    })
  ]);
}

async function safeTrackPresence(){
  try{
    if (!callPresenceChannel) return;
    await callPresenceChannel.track({
      user_id: myUid(),
      name,
      avatar_url: myAvatarUrl,
      muted: micMuted,
      joined_at: new Date().toISOString()
    });
  }catch(e){
    log("presence track warn", e);
  }
}

/* ===== WebAudio: é€ä¿¡éŸ³é‡ ===== */
async function ensureAudioContextRunning(){
  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended"){
    try{ await audioCtx.resume(); }catch{}
  }
}

function buildProcessedMicStreamIfNeeded(){
  if (!localStream) return;
  if (processedStream && micGainNode && audioCtx) return;

  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  micSource = audioCtx.createMediaStreamSource(localStream);
  micGainNode = audioCtx.createGain();
  micGainNode.gain.value = myMicGain;

  const dest = audioCtx.createMediaStreamDestination();
  micSource.connect(micGainNode);
  micGainNode.connect(dest);

  processedStream = dest.stream;
}

function applyMicGain(){
  const v = Math.max(0.01, Math.min(1.0, myMicGain));
  if (micGainNode) micGainNode.gain.value = v;
}

function getSendStream(){
  return processedStream || localStream;
}

/* ===== PeerConnection ===== */
async function ensurePC(peerId){
  if (!peerId || peerId === myUid()) return;
  if (pcs.has(peerId)) return;

  const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
  pcs.set(peerId, pc);

  makingOffer.set(peerId, false);
  ignoreOffer.set(peerId, false);

  pc.onicecandidate = async (ev)=>{
    if (ev.candidate){
      await sendSignal(peerId, { kind:"ice", candidate: ev.candidate });
    }
  };

  pc.onconnectionstatechange = ()=>{
    log("pc state", peerId, pc.connectionState);
  };
  pc.oniceconnectionstatechange = ()=>{
    log("ice state", peerId, pc.iceConnectionState);
  };

  pc.ontrack = (ev)=>{
    const el = ensureAudioEl(peerId);
    el.srcObject = ev.streams[0];
  };

  pc.onnegotiationneeded = async ()=>{
    try{
      makingOffer.set(peerId, true);
      const offer = await pc.createOffer();
      if (pc.signalingState !== "stable") return;
      await pc.setLocalDescription(offer);
      await sendSignal(peerId, { kind:"sdp", sdp: pc.localDescription });
    }catch(e){
      log("negotiationneeded error", peerId, e);
    }finally{
      makingOffer.set(peerId, false);
    }
  };

  // é€ä¿¡ãƒˆãƒ©ãƒƒã‚¯ä»˜ä¸
  const sendStream = getSendStream();
  if (sendStream){
    for (const t of sendStream.getTracks()){
      pc.addTrack(t, sendStream);
    }
  }
}

function attachTracksToPC(peerId){
  const pc = pcs.get(peerId);
  const sendStream = getSendStream();
  if (!pc || !sendStream) return;

  const senders = pc.getSenders ? pc.getSenders() : [];
  const audioTrack = sendStream.getAudioTracks?.()[0];
  if (!audioTrack) return;

  const sender = senders.find(s => s.track && s.track.kind === "audio");
  if (!sender){
    pc.addTrack(audioTrack, sendStream);
  }else{
    if (sender.track !== audioTrack){
      try{ sender.replaceTrack(audioTrack); }catch{}
    }
  }
}

function attachTracksToAllPCs(){
  for (const [peerId] of pcs){
    attachTracksToPC(peerId);
  }
}

function closePC(peerId){
  const pc = pcs.get(peerId);
  if (!pc) return;
  try{ pc.close(); }catch{}
  pcs.delete(peerId);

  const wrap = document.getElementById("audioWrap-" + peerId);
  if (wrap) wrap.remove();
}

/* ===== Signal ===== */
async function sendSignal(to, data){
  if (!callSignalChannel) return;
  await callSignalChannel.send({
    type: "broadcast",
    event: "signal",
    payload: { from: myUid(), to, data }
  });
}

async function onSignal(payload){
  const from = payload?.from;
  const to = payload?.to;
  const data = payload?.data;

  if (!from || !data) return;
  if (to && to !== myUid()) return;
  if (!joinedCall) return;

  await ensurePC(from);
  const pc = pcs.get(from);
  if (!pc) return;

  if (data.kind === "hello"){
    attachTracksToPC(from);
    return;
  }

  if (data.kind === "mute"){
    mutedMap.set(from, !!data.muted);
    refreshAudioTitles();
    await refreshPresenceList();
    return;
  }

  if (data.kind === "ice"){
    try{ await pc.addIceCandidate(data.candidate); }catch(e){ log("addIceCandidate error", e); }
    return;
  }

  if (data.kind === "sdp"){
    const desc = data.sdp;
    if (!desc) return;

    const polite = getIsPolite(from);
    const offerCollision = desc.type === "offer" && (makingOffer.get(from) || pc.signalingState !== "stable");
    ignoreOffer.set(from, !polite && offerCollision);
    if (ignoreOffer.get(from)){
      log("ignore offer due to collision", from);
      return;
    }

    try{
      await pc.setRemoteDescription(desc);

      if (desc.type === "offer"){
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await sendSignal(from, { kind:"sdp", sdp: pc.localDescription });
      }
    }catch(e){
      log("handle sdp error", from, e);
    }
    return;
  }
}

/* ===== UI: ç›¸æ‰‹éŸ³å£°ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ & éŸ³é‡ ===== */
function ensureAudioEl(peerId){
  const id = "audio-" + peerId;
  let el = document.getElementById(id);
  if (el) return el;

  const wrap = document.createElement("div");
  wrap.className = "audioWrap";
  wrap.id = "audioWrap-" + peerId;

  const titleRow = document.createElement("div");
  titleRow.className = "audioTitle";
  titleRow.innerHTML = `<span id="audioTitle-${peerId}">ğŸ”Š ç›¸æ‰‹: ${peerId}</span> <span class="badge" id="muteBadge-${peerId}">...</span>`;

  el = document.createElement("audio");
  el.id = id;
  el.autoplay = true;
  el.playsInline = true;
  el.controls = true;

  const v = peerVolume.get(peerId) ?? 1.0;
  el.volume = v;

  const ctl = document.createElement("div");
  ctl.className = "audioCtl";

  const labelText = document.createElement("div");
  labelText.className = "lbl";
  labelText.textContent = "ç›¸æ‰‹ã®éŸ³é‡";

  const label = document.createElement("div");
  label.className = "val";
  label.textContent = String(Math.round(v * 100));

  const range = document.createElement("input");
  range.type = "range";
  range.min = "1";
  range.max = "100";
  range.value = String(Math.round(v * 100));
  range.oninput = ()=>{
    const n = Math.max(1, Math.min(100, Number(range.value)));
    const vv = n / 100;
    peerVolume.set(peerId, vv);
    label.textContent = String(n);
    el.volume = vv;
  };

  ctl.appendChild(labelText);
  ctl.appendChild(label);
  ctl.appendChild(range);

  wrap.appendChild(titleRow);
  wrap.appendChild(el);
  wrap.appendChild(ctl);

  document.getElementById("audios").appendChild(wrap);
  refreshAudioTitles();
  return el;
}

function refreshAudioTitles(){
  const st = callPresenceChannel?.presenceState?.() || {};
  for (const [peerId] of pcs){
    const pres = st[peerId]?.[0];
    const nm = pres?.name || peerId;

    const t = document.getElementById("audioTitle-" + peerId);
    if (t) t.textContent = `ğŸ”Š ç›¸æ‰‹: ${nm}`;

    const badge = document.getElementById("muteBadge-" + peerId);
    const muted = mutedMap.get(peerId);
    if (badge){
      badge.textContent = muted ? "MUTE" : "ON";
      badge.className = "badge " + (muted ? "bad" : "good");
    }
  }
}

/* ===== Presence ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
function onPresenceSync(){
  refreshPresenceList();
  refreshAudioTitles();

  const st = callPresenceChannel?.presenceState?.() || {};
  for (const peerId of Object.keys(st)){
    if (peerId === myUid()) continue;
    if (!pcs.has(peerId)){
      ensurePC(peerId).then(()=>{
        attachTracksToPC(peerId);
        sendSignal(peerId, { kind:"hello" });
      });
    }
  }
}

function onPresenceJoin(key, newPresences){
  refreshPresenceList();
  refreshAudioTitles();

  if (!joinedCall) return;
  if (!key || key === myUid()) return;

  ensurePC(key).then(()=>{
    attachTracksToPC(key);
    sendSignal(key, { kind:"hello" });
  });
}

function onPresenceLeave(key, leftPresences){
  closePC(key);
  refreshPresenceList();
  refreshAudioTitles();
}

async function refreshPresenceList(){
  const box = document.getElementById("callUsersList");
  if (!box) return;

  if (!callPresenceChannel){
    box.innerHTML = "<div class='hint'>æœªæ¥ç¶š</div>";
    return;
  }

  const st = callPresenceChannel.presenceState() || {};
  const ids = Object.keys(st);
  box.innerHTML = "";

  if (ids.length === 0){
    box.innerHTML = "<div class='hint'>æœªæ¥ç¶š</div>";
    return;
  }

  for (const id of ids){
    const p = st[id]?.[0] || {};
    const nm = p.name || id;
    const muted = !!p.muted;

    const row = document.createElement("div");
    row.className = "listItem";
    row.innerHTML = `
      <div class="name">${muted ? "ğŸ”‡" : "ğŸ¤"} ${avatarHtml(p.avatar_url, nm, "sm")} <span class="nameText">${escapeHtml(nm)}</span></div>
      <div class="sub"><span class="badge ${muted ? "bad" : "good"}">${muted ? "ãƒŸãƒ¥ãƒ¼ãƒˆ" : "ç™ºè©±OK"}</span></div>
    `;
    box.appendChild(row);

    mutedMap.set(id, muted);
  }
}

/* ===== call_participantsï¼ˆaliveï¼‰ ===== */
async function upsertCallParticipant(){
  const { error } = await sb.from("call_participants").upsert({
    room_id: roomId,
    user_id: myUid(),
    name,
    avatar_url: myAvatarUrl,
    updated_at: new Date().toISOString()
  }, { onConflict: "room_id,user_id" });

  if (error) log("upsertCallParticipant error", error);
}

function startHeartbeat(){
  stopHeartbeat();
  heartbeatTimer = setInterval(async ()=>{
    await upsertCallParticipant();
  }, Math.max(5000, (CALL_ALIVE_SEC * 1000) / 3));
}
function stopHeartbeat(){
  if (heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; }
}

/* ===== ãƒ¡ã‚¤ãƒ³æ“ä½œ ===== */
async function joinCall(){
  if (joiningCall || joinedCall) return;
  joiningCall = true;
  setJoinBtn(false);

  try{
    setCallState("æº–å‚™ä¸­â€¦");
    await ensureAudioContextRunning();
    await startCallChannels();

    if (!localStream){
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    }

    buildProcessedMicStreamIfNeeded();
    applyMicGain();

    // ãƒŸãƒ¥ãƒ¼ãƒˆåæ˜ 
    try{
      for (const t of localStream.getAudioTracks()){
        t.enabled = !micMuted;
      }
    }catch{}

    attachTracksToAllPCs();

    // æ—¢ã«å±…ã‚‹äººã¸ hello + PC ç”¨æ„
    const st = callPresenceChannel.presenceState() || {};
    for (const peerId of Object.keys(st)){
      if (peerId === myUid()) continue;
      await ensurePC(peerId);
      attachTracksToPC(peerId);
      await sendSignal(peerId, { kind:"hello" });
    }

    await safeTrackPresence();

    await upsertCallParticipant();
    startHeartbeat();

    joinedCall = true;
    setMuteBtn();
    setCallState("é€šè©±ã«å‚åŠ ä¸­");
    setReady(true, "é€šè©±æº–å‚™OK");
  }catch(e){
    log("joinCall error", e);
    alert("é€šè©±ã®é–‹å§‹ã«å¤±æ•—: " + (e?.message || e));
    await leaveCall();
  }finally{
    joiningCall = false;
    setJoinBtn(true);
  }
}

async function leaveCall(){
  joiningCall = false;
  joinedCall = false;

  try{
    await sb.from("call_participants")
      .delete()
      .eq("room_id", roomId)
      .eq("user_id", myUid());
  }catch(e){
    log("call_participants delete error", e);
  }

  stopHeartbeat();

  for (const [peerId] of pcs){
    closePC(peerId);
  }
  pcs.clear();

  if (localStream){
    for (const t of localStream.getTracks()){
      try{ t.stop(); }catch{}
    }
    localStream = null;
  }
  processedStream = null;
  micSource = null;
  micGainNode = null;

  if (callPresenceChannel){
    try{ await callPresenceChannel.untrack(); }catch{}
    try{ await callPresenceChannel.unsubscribe(); }catch{}
    callPresenceChannel = null;
  }
  if (callSignalChannel){
    try{ await callSignalChannel.unsubscribe(); }catch{}
    callSignalChannel = null;
  }

  const aud = document.getElementById("audios");
  if (aud) aud.innerHTML = "";
  const list = document.getElementById("callUsersList");
  if (list) list.innerHTML = "<div class='hint'>æœªæ¥ç¶š</div>";

  setCallState("æœªæ¥ç¶šï¼ˆå¿…è¦ãªã‚‰é€šè©±ã«å‚åŠ ã‚’æŠ¼ã—ã¦ã­ï¼‰");
  setReady(true, "å¾…æ©Ÿä¸­");
  setMuteBtn();
}

async function toggleMute(){
  micMuted = !micMuted;
  setMuteBtn();

  try{
    if (localStream){
      for (const t of localStream.getAudioTracks()){
        t.enabled = !micMuted;
      }
    }
  }catch(e){
    log("toggleMute localStream warn", e);
  }

  await safeTrackPresence();

  try{
    for (const [peerId] of pcs){
      await sendSignal(peerId, { kind:"mute", muted: micMuted });
    }
  }catch(e){
    log("toggleMute sendSignal warn", e);
  }

  refreshAudioTitles();
}


/* ===== UI events ===== */
document.getElementById("imgFile").addEventListener("change", ()=>{
  const f = document.getElementById("imgFile").files?.[0];
  document.getElementById("imgName").textContent = f ? f.name : "æœªé¸æŠ";
});

document.getElementById("micGain").addEventListener("input", (ev)=>{
  const n = Math.max(1, Math.min(100, Number(ev.target.value)));
  document.getElementById("micGainLabel").textContent = String(n);
  myMicGain = n / 100;
  applyMicGain();
});


/* =================== æ ä¸»ãƒ„ãƒ¼ãƒ«ï¼ˆKick / Ban / Room deleteï¼‰ =================== */

let recentUsers = new Map(); // user_id -> { name, avatar_url, last_seen }

function upsertRecentUser(uid, nm, av){
  if (!uid) return;
  const prev = recentUsers.get(uid) || {};
  recentUsers.set(uid, {
    user_id: uid,
    name: (nm || prev.name || "").toString(),
    avatar_url: (av || prev.avatar_url || "").toString(),
    last_seen: Date.now()
  });
}

function isValidUuid(v){
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test((v||"").trim());
}

function setOwnerUI(){
  const delBtn = document.getElementById("deleteRoomBtn");
  const adminCard = document.getElementById("adminCard");
  if (delBtn) delBtn.style.display = isOwner ? "" : "none";
  if (adminCard) adminCard.style.display = isOwner ? "" : "none";

  // â˜…éƒ¨å±‹åç·¨é›†ï¼ˆæ ä¸»ã®ã¿ï¼‰
  const rn = document.getElementById("roomName");
  const row = document.getElementById("roomNameEditRow");
  const hint = document.getElementById("roomNameHint");

  if (rn){
    rn.readOnly = !isOwner;
    rn.style.opacity = isOwner ? "1" : "0.85";
  }
  if (row) row.style.display = isOwner ? "flex" : "none";
  if (hint) hint.style.display = isOwner ? "none" : "";
}


async function saveRoomName(){
  try{
    if (!isOwner){
      alert("æ ä¸»ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã ã‘ãŒéƒ¨å±‹åã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆï¼");
      return;
    }
    if (!roomId){
      alert("roomId ãŒç„¡ã„ã®ã§å¤‰æ›´ã§ããªã„ã‚ˆ");
      return;
    }
    if (roomNameSaveLock) return;
    roomNameSaveLock = true;

    const el = document.getElementById("roomName");
    if (!el){
      alert("roomName input ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆ");
      return;
    }

    const newName = (el.value || "").trim();
    if (!newName){
      alert("éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ã­ï¼");
      el.value = room || "";
      return;
    }
    if (newName.length > 60){
      alert("éƒ¨å±‹åãŒé•·ã™ãã‚‹ã‚ˆï¼ˆ60æ–‡å­—ã¾ã§ï¼‰");
      el.value = room || "";
      return;
    }

    const uid = myUid();
    if (!uid){
      alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼ˆuidï¼‰ãŒå–ã‚Œãªã„ã‚ˆã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
      return;
    }

    // æ›´æ–°ãŒæˆåŠŸã—ãŸã‹ã‚’ data ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã« select ã™ã‚‹
    const { data, error } = await sb
      .from("rooms")
      .update({ room_name: newName })
      .eq("id", roomId)
      .eq("owner_id", uid)
      .select("id, room_name, owner_id")
      .maybeSingle();

    if (error){
      log("saveRoomName error", error);
      alert("éƒ¨å±‹åã®å¤‰æ›´ã«å¤±æ•—ã—ãŸã‚ˆ: " + (error.message || ""));
      el.value = room || "";
      return;
    }

    // â˜…ã“ã“ãŒé‡è¦ï¼š0ä»¶æ›´æ–°ï¼ˆæ¡ä»¶ä¸ä¸€è‡´ / RLSï¼‰ã‚’æ¤œå‡º
    if (!data){
      alert("æ›´æ–°ã§ããªã‹ã£ãŸã‚ˆï¼ˆã‚ªãƒ¼ãƒŠãƒ¼åˆ¤å®š/æ¨©é™/RLS/roomIdä¸ä¸€è‡´ã®å¯èƒ½æ€§ï¼‰ã€‚");
      el.value = room || "";
      return;
    }

    // UI å³æ™‚åæ˜ 
    applyRoomInfoRow({ id: data.id, room_name: data.room_name, owner_id: data.owner_id });
    alert("éƒ¨å±‹åã‚’å¤‰æ›´ã—ãŸã‚ˆï¼");
  }catch(e){
    log("saveRoomName exception", e);
    alert("éƒ¨å±‹åã®å¤‰æ›´ã§ã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
  }finally{
    roomNameSaveLock = false;
  }
}


function resetRoomNameInput(){
  const el = document.getElementById("roomName");
  if (el) el.value = room || "";
}

// Enter ã§ä¿å­˜ï¼ˆæ ä¸»ã®ã¿ï¼‰
document.addEventListener("keydown", (ev)=>{
  try{
    if (!isOwner) return;
    const el = document.getElementById("roomName");
    if (!el) return;
    if (document.activeElement !== el) return;
    if (ev.key === "Enter"){
      ev.preventDefault();
      saveRoomName();
    }
  }catch{}
});

function applyRoomInfoRow(row){
  if (!row) return;

  // owner_id ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ä¿æŒã—ã¦UIæ›´æ–°
  if (row.owner_id !== undefined && row.owner_id !== null){
    roomOwnerId = String(row.owner_id || "");
    isOwner = (roomOwnerId && roomOwnerId === myUid());
  }

  const newRoomName = (row.room_name || room || "").toString();
  if (newRoomName){
    room = newRoomName;
    const rn = document.getElementById("roomName");
    const chip = document.getElementById("roomChip");
    const sub = document.getElementById("subTitle");
    if (rn) rn.value = room;
    if (chip) chip.textContent = room;
    if (sub) sub.textContent = "Room: " + room;
    document.title = "ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Room (" + room + ")";
  }
  setOwnerUI();
}

/* ===== rooms realtimeï¼ˆéƒ¨å±‹åãªã©ã‚’å…¨å“¡ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ï¼‰ ===== */
async function startRoomInfoRealtime(){
  if (roomInfoChannel) return;
  roomInfoChannel = sb
    .channel("room-info-" + (roomId || ""))
    .on("postgres_changes", { event:"*", schema:"public", table:"rooms" }, (payload)=>{
      const nr = payload.new || {};
      const or = payload.old || {};
      const id = nr.id || or.id;
      if (!id || id !== roomId) return;

      if (payload.eventType === "DELETE"){
        alert("ã“ã®éƒ¨å±‹ã¯å‰Šé™¤ã•ã‚ŒãŸã‚ˆã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ã­ï¼");
        goLobby();
        return;
      }
      applyRoomInfoRow(nr);
    })
    .subscribe();
}


function renderAdminUsers(){
  const box = document.getElementById("adminUsersList");
  if (!box) return;

  // âœ… è¿½åŠ ï¼šå¤ã„å€™è£œã¯æ¶ˆã™ï¼ˆå‰ã®æ ã®æ®‹éª¸å¯¾ç­–ï¼‰
  const TTL_MS = 3 * 60 * 1000; // 3åˆ†
  const now = Date.now();

  // è‡ªåˆ†ä»¥å¤–ã‚’ä¸Šã« + å¤ã„ã®ã¯é™¤å¤–
  const arr = Array.from(recentUsers.values())
    .filter(u => u.user_id && u.user_id !== myUid())
    .filter(u => (now - (u.last_seen || 0)) <= TTL_MS)
    .sort((a,b)=>(b.last_seen||0)-(a.last_seen||0))
    .slice(0, 40);

  box.innerHTML = "";

  if (arr.length === 0){
    box.innerHTML = "<div class='hint'>ã¾ã å€™è£œãŒãªã„ã‚ˆï¼ˆé€šè©±å‚åŠ /ç™ºè¨€ãŒã‚ã‚‹ã¨å‡ºã‚‹ï¼‰</div>";
    return;
  }

  for (const u of arr){
    const it = document.createElement("div");
    it.className = "listItem";

    const left = document.createElement("div");
    left.className = "name";
    const shown = (u.name || "").trim() || u.user_id;
    left.innerHTML = `${avatarInline(u.avatar_url || "", shown)}<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:210px;">${escapeHtml(shown)}</span>`;

    const right = document.createElement("div");
    right.className = "sub";
    right.textContent = u.user_id.slice(0, 8) + "â€¦";

    it.appendChild(left);
    it.appendChild(right);

    it.onclick = ()=>{
      const t = document.getElementById("adminTargetUid");
      if (t) t.value = u.user_id;
    };

    box.appendChild(it);
  }
}


function avatarInline(url, alt){
  if (url){
    return `<img class="avatar sm" src="${escapeHtml(url)}" alt="${escapeHtml(alt||'')}" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex';" />` +
           `<span class="avatarFallback sm" style="display:none;">${escapeHtml((alt||'?').slice(0,1).toUpperCase())}</span>`;
  }
  return `<span class="avatarFallback sm">${escapeHtml((alt||'?').slice(0,1).toUpperCase())}</span>`;
}

async function resolveRoomRow(){
  // å„ªå…ˆ: room_id ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const ridParam = getRoomIdFromUrl();
  if (ridParam && isValidUuid(ridParam)){
    const { data, error } = await sb.from("rooms").select("id, room_name, owner_id, created_at").eq("id", ridParam).maybeSingle();
    if (!error && data) return data;
  }

  // fallback: room åã‹ã‚‰æœ€æ–°ã® 1 è¡Œ
  const rn = room;
  const { data, error } = await sb.from("rooms")
    .select("id, room_name, owner_id, created_at")
    .eq("room_name", rn)
    .order("created_at", { ascending:false })
    .limit(1)
    .maybeSingle();

  if (error) throw error;
  return data || null;
}

async function checkBanned(){
  if (!roomId) return;
  const { data, error } = await sb.from("room_bans").select("reason, created_at").eq("room_id", roomId).eq("user_id", myUid()).maybeSingle();
  if (error) {
    log("checkBanned error", error);
    return;
  }
  if (data){
    alert("ã“ã®éƒ¨å±‹ã§ã¯BANã•ã‚Œã¦ã„ã¾ã™ã€‚\nç†ç”±: " + (data.reason || "ãªã—"));
    goLobby();
  }
}

async function startRoomDeleteWatch(){
  // rooms ã® delete ã‚’æ¤œçŸ¥ã—ã¦å¼·åˆ¶ãƒ­ãƒ“ãƒ¼æˆ»ã—
  sb.channel("rooms-watch")
    .on("postgres_changes", { event:"DELETE", schema:"public", table:"rooms" }, (payload)=>{
      const old = payload.old || {};
      if (old.id && old.id === roomId){
        alert("éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚Šã¾ã™ã€‚");
        goLobby();
      }
    })
    .subscribe();
}

async function startRoomEventsWatch(){
  // room_events ã‚’ç›£è¦–ï¼ˆkick/ban/forceback/deleteï¼‰
  // â€»Realtime ãŒåŠ¹ã‹ãªã„ç’°å¢ƒãŒã‚ã‚‹ã®ã§ã€2ç§’ãƒãƒ¼ãƒªãƒ³ã‚°ã‚‚ä½µç”¨ã™ã‚‹ï¼ˆã“ã‚Œã§Kick/å…¨å“¡æˆ»ã™ãŒç¢ºå®Ÿã«å‹•ãï¼‰
  if (window.__roomEventsWatchStarted) return;
  window.__roomEventsWatchStarted = true;

  // ã“ã“ã‚ˆã‚Šå¾Œã«ä½œã‚‰ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã ã‘è¦‹ã‚‹ï¼ˆå…¥å®¤å‰ã®å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã§é£›ã°ãªã„ã‚ˆã†ã«ï¼‰
  window.__roomEventsLastAt = new Date().toISOString();

  function handleRoomEvent(ev){
    // è‡ªåˆ†ãŒé‹å–¶ãªã‚‰ kick/ban/forceback ã‚’ç„¡åŠ¹åŒ–
    if (isAdminUserId(myUid())) return;
    if (!ev) return;
    if (ev.room_id !== roomId) return;

    // è‡ªåˆ†å®›ã¦ or å…¨å“¡
    if (ev.target_user_id && ev.target_user_id !== myUid()) return;

    const typ = (ev.type || "").toString();
    const reason = (ev.reason || "").toString();

    // å—ä¿¡æ¸ˆã¿ã®æœ€æ–°æ™‚åˆ»ã‚’æ›´æ–°ï¼ˆnullå®‰å…¨ï¼‰
    if (ev.created_at){
      window.__roomEventsLastAt = ev.created_at;
    }

    if (typ === "kicked"){
      alert(`Kick ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }else if (typ === "banned"){
      alert(`Ban ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }else if (typ === "force_back_all"){
      alert(`æ ä¸»ã«ã‚ˆã‚Šãƒ­ãƒ“ãƒ¼ã¸æˆ»ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }else if (typ === "room_deleted"){
      alert(`éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${reason || "ãªã—"}`);
      goLobby();
    }
  }

  // --- Realtimeï¼ˆåŠ¹ããªã‚‰æœ€é€Ÿï¼‰ ---
  try{
    roomEventsChannel = sb.channel("room-events-" + (roomId || ""))
      .on("postgres_changes", { event:"INSERT", schema:"public", table:"room_events" }, (payload)=>{
        const ev = payload.new || {};
        handleRoomEvent(ev);
      })
      .subscribe();
  }catch(e){
    log("room_events realtime warn", e);
  }

  // --- Pollingï¼ˆRealtimeãŒæ­»ã‚“ã§ã‚‚ç¢ºå®Ÿï¼‰ ---
  async function pollRoomEvents(){
    if (!roomId || !myUid()) return;
    const since = window.__roomEventsLastAt || new Date(Date.now() - 60*1000).toISOString();

    // target_user_id ãŒ nullï¼ˆå…¨å“¡ï¼‰ or è‡ªåˆ†å®›ã¦ ã®ã‚‚ã®ã ã‘ã‚’æ‹¾ã†
    // Supabaseã®or()ã¯ "a.is.null,a.eq.xxx" ã®å½¢ã§æ›¸ã‘ã‚‹
    const { data, error } = await sb.from("room_events")
      .select("id, room_id, target_user_id, type, reason, created_at")
      .eq("room_id", roomId)
      .gt("created_at", since)
      .or(`target_user_id.is.null,target_user_id.eq.${myUid()}`)
      .order("created_at", { ascending:true })
      .limit(50);

    if (error){
      // ãšã£ã¨ã‚¨ãƒ©ãƒ¼ãªã‚‰ãƒ­ã‚°ã ã‘ï¼ˆUIã‚’å£Šã•ãªã„ï¼‰
      log("room_events poll error", error);
      return;
    }

    if (!data || !data.length) return;
    for (const ev of data){
      handleRoomEvent(ev);
    }
  }

  // 2ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆè»½ã„ï¼‰
  window.__roomEventsPollTimer = setInterval(pollRoomEvents, 2000);
}

async function deleteRoomNow(){
  if (!confirm("æœ¬å½“ã«éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  // å­ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å…ˆã«æ¶ˆã™
  await sb.from("messages_v3").delete().eq("room_id", roomId);
  await sb.from("room_members").delete().eq("room_id", roomId);
  await sb.from("call_participants").delete().eq("room_id", roomId);

  // æœ€å¾Œã« rooms
  const { error } = await sb
    .from("rooms")
    .delete()
    .eq("id", roomId)
    .eq("owner_id", myUid());

  if (error){
    alert("éƒ¨å±‹å‰Šé™¤å¤±æ•—: " + error.message);
    console.error(error);
    return;
  }

  alert("éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  location.href = "./lobby.html";
}


function getAdminTargetUid(){
  const uid = (document.getElementById("adminTargetUid")?.value || "").trim();
  if (!isValidUuid(uid)) return "";
  return uid;
}
function getAdminReason(){
  return (document.getElementById("adminReason")?.value || "").trim().slice(0, 200);
}

async async function kickUser(){
  if (!isOwner) return alert("æ ä¸»ã ã‘ï¼");
  const target = getAdminTargetUid();
  if (!target) return alert("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ­£ã ã‚ˆï¼");
  if (isAdminUserId(target)) {
    alert("é‹å–¶ã¯ Kick / Ban ã®å¯¾è±¡ã«ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  const reason = getAdminReason();


  // kick å±¥æ­´ï¼ˆä»»æ„ï¼‰
  {
    const { error: kerr } = await sb.from("room_kicks").insert({
      room_id: roomId,
      user_id: target,
      reason: reason || null
    });
    if (kerr && !String(kerr.message||"").toLowerCase().includes("duplicate")){
      log("kick record error", kerr);
    }
  }

  // â˜…å³æ™‚åæ˜ ç”¨ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã“ã“ãŒå‹•ã‹ãªã„ã¨ã€Œèª­ã¿è¾¼ã¿ã—ãŸã‚‰åŠ¹ãã€çŠ¶æ…‹ã«ãªã‚‹ï¼‰
  const { error: eerr } = await sb.from("room_events").insert({
    room_id: roomId,
    target_user_id: target,
    type: "kicked",
    reason: reason || null,
    actor_user_id: myUid()
  });

  if (eerr){
    alert("Kick å¤±æ•—: " + eerr.message);
    log("kick event error", eerr);
    return;
  }

  alert("Kick ã—ã¾ã—ãŸã€‚");
}

async async function banUser(){
  if (!isOwner) return alert("æ ä¸»ã ã‘ï¼");
  const target = getAdminTargetUid();
  if (!target) return alert("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ­£ã ã‚ˆï¼");
  if (isAdminUserId(target)) {
    alert("é‹å–¶ã¯ Kick / Ban ã®å¯¾è±¡ã«ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  const reason = getAdminReason();


  const { error: berr } = await sb.from("room_bans").insert({
    room_id: roomId,
    user_id: target,
    reason: reason || null
  });

  // duplicate ã¯OKï¼ˆæ—¢ã«BANæ¸ˆã¿ï¼‰
  if (berr && !String(berr.message||"").toLowerCase().includes("duplicate")){
    alert("BAN å¤±æ•—: " + berr.message);
    log("ban error", berr);
    return;
  }

  // â˜…å³æ™‚åæ˜ ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
  const { error: eerr } = await sb.from("room_events").insert({
    room_id: roomId,
    target_user_id: target,
    type: "banned",
    reason: reason || null,
    actor_user_id: myUid()
  });

  if (eerr){
    // BANã¯DBçš„ã«ã¯å…¥ã£ã¦ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã®ã§ã€å†èª­ã¿è¾¼ã¿ã§åŠ¹ã
    alert("BAN ã¯ç™»éŒ²ã§ããŸã‹ã‚‚ã ã‘ã©ã€å³æ™‚é€šçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆã«å¤±æ•—: " + eerr.message + "\nï¼ˆå¯¾è±¡ãŒå†èª­ã¿è¾¼ã¿ã™ã‚‹ã¨BANãŒåŠ¹ãã¾ã™ï¼‰");
    log("ban event error", eerr);
    return;
  }

  alert("Ban ã—ã¾ã—ãŸã€‚");
}

async function forceBackAll(){
  if (!isOwner) return alert("æ ä¸»ã ã‘ï¼");
  const reason = getAdminReason();

  const { error } = await sb.from("room_events").insert({
    room_id: roomId,
    target_user_id: null,
    type: "force_back_all",
    reason: reason || "æ ä¸»ã«ã‚ˆã‚Šãƒ­ãƒ“ãƒ¼ã¸æˆ»ã•ã‚Œã¾ã—ãŸ",
    actor_user_id: myUid()
  });

  if (error){
    alert("å…¨å“¡æˆ»ã—å¤±æ•—: " + error.message);
    log("forceBackAll error", error);
    return;
  }

  alert("å…¨å“¡ã‚’ãƒ­ãƒ“ãƒ¼ã«æˆ»ã—ã¾ã—ãŸã€‚");
}

async function upsertRoomMember(){
  if (!roomId || !myUid()) return;
  try{
    await sb.from("room_members").upsert({
      room_id: roomId,
      user_id: myUid(),
      name: name || null,
      avatar_url: myAvatarUrl || null,
      updated_at: new Date().toISOString()
    }, { onConflict: "room_id,user_id" });
  }catch(e){ log("upsertRoomMember warn", e); }
}

async function deleteRoomMember(){
  if (!roomId || !myUid()) return;
  try{ await sb.from("room_members").delete().eq("room_id", roomId).eq("user_id", myUid()); }catch(e){}
}

let roomMemberTimer = null;

async function startRoomMemberHeartbeat(){
  await upsertRoomMember();
  await loadRoomMembersForUI();
  if (isOwner) await loadRoomMembersForAdmin();

  if (roomMemberTimer) clearInterval(roomMemberTimer);
  roomMemberTimer = setInterval(()=>{
    upsertRoomMember();
    loadRoomMembersForUI();
    if (isOwner) loadRoomMembersForAdmin();
  }, 20000);

  window.addEventListener("beforeunload", ()=>{ deleteRoomMember(); });
}

async function loadRoomMembersForAdmin(){
  if (!roomId) return;
  const cutoff = new Date(Date.now() - 1000*60*2).toISOString(); // 2åˆ†ä»¥å†…ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ‰±ã„
  const { data, error } = await sb.from("room_members")
    .select("user_id, name, avatar_url, updated_at")
    .eq("room_id", roomId)
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  if (error){ log("loadRoomMembersForAdmin error", error); return; }

  (data || []).forEach(u=>upsertRecentUser(u.user_id, u.name, u.avatar_url));
  renderAdminUsers();
}

async function loadRoomMembersForUI(){
  const box = document.getElementById("roomMembersList");
  if (!box) return;
  if (!roomId){
    box.innerHTML = `<div class="hint">éƒ¨å±‹æƒ…å ±ãŒã¾ã æº–å‚™ä¸­â€¦</div>`;
    return;
  }

  const cutoff = new Date(Date.now() - 1000*60*2).toISOString(); // 2åˆ†ä»¥å†…ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ‰±ã„
  const { data, error } = await sb.from("room_members")
    .select("user_id, name, avatar_url, updated_at")
    .eq("room_id", roomId)
    .gte("updated_at", cutoff)
    .order("updated_at", { ascending:false });

  if (error){
    log("loadRoomMembersForUI error", error);
    box.innerHTML = `<div class="hint">å–å¾—å¤±æ•—: ${escapeHtml(error.message)}</div>`;
    return;
  }

  const arr = (data || []);
  if (arr.length === 0){
    box.innerHTML = `<div class="hint">ä»Šã¯èª°ã‚‚ã„ãªã„ã‚ˆï¼ˆã¾ãŸã¯æ›´æ–°å¾…ã¡ï¼‰</div>`;
    return;
  }

  box.innerHTML = "";
  for (const u of arr){
    const uid = u.user_id;
    const dn = (u.name || uid || "unknown").toString();
    const av = (u.avatar_url || "").toString();

    const item = document.createElement("div");
    item.className = "listItem";
    item.style.cursor = isOwner ? "pointer" : "default";
    item.title = isOwner ? "ã‚¯ãƒªãƒƒã‚¯ã§Kick/Banã®å¯¾è±¡ã«å…¥ã‚‹" : "";

    item.innerHTML = `
      ${avatarHtml(av, dn)}
      <div class="listMain">
        <div class="listTitle">${escapeHtml(dn)}</div>
        <div class="listSub">${escapeHtml(uid)}</div>
      </div>
      ${isOwner ? `<span class="chip">é¸æŠ</span>` : ``}
    `;

    if (isOwner){
      item.onclick = ()=>{
        const t = document.getElementById("adminTargetUid");
        if (t) t.value = uid || "";
        setStatus(`å¯¾è±¡ã‚’é¸æŠ: ${dn}`, true);
      };
    }

    box.appendChild(item);
  }
}

async function startRoomMembersRealtime(){
  if (!roomId) return;
  if (roomMembersChannel) return;

  roomMembersChannel = sb
    .channel("room-members-" + roomId)
    .on("postgres_changes",
      { event:"*", schema:"public", table:"room_members", filter:`room_id=eq.${roomId}` },
      async ()=>{ await loadRoomMembersForUI(); if (isOwner) await loadRoomMembersForAdmin(); }
    )
    .subscribe();
}


/* =================== èµ·å‹• =================== */
/* =================== èµ·å‹• =================== */
(async ()=>{
  try{
    if (!(await requireLoginOrRedirect())) return;

    await reloadName();
    updateTop();

    // URL params
    const urlRoom = getRoomFromUrl();
    const urlRoomId = getRoomIdFromUrl(); // â˜…è¿½åŠ ï¼šroom_id ã‚‚èª­ã‚€

    // room ã‚‚ room_id ã‚‚ç„¡ã„ãªã‚‰ã‚¢ã‚¦ãƒˆ
    if (!urlRoom && !urlRoomId){
      alert("éƒ¨å±‹ãŒæŒ‡å®šã•ã‚Œã¦ãªã„ã‚ˆï¼");
      goLobby();
      return;
    }

    // â˜…roomã®åˆæœŸå€¤
    room = urlRoom || "";
    roomId = ""; // ã“ã“ã§ä¸€æ—¦ç©ºã«ã—ã¦ã€resolveRoomRowã§ç¢ºå®šã™ã‚‹

    // rooms ã®ã€Œã“ã®å›ã®éƒ¨å±‹ã€ã‚’ç¢ºå®šï¼ˆidå„ªå…ˆï¼‰
    let row = null;
    try{
      row = await resolveRoomRow(urlRoom, urlRoomId); // â˜…å¤‰æ›´
    }catch(e){
      log("resolveRoomRow error", e);
    }

    if (!row){
      alert("ãã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆï¼ï¼ˆã™ã§ã«å‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ï¼‰");
      goLobby();
      return;
    }

    roomId = row.id;
    roomOwnerId = row.owner_id || "";
    isOwner = (roomOwnerId && roomOwnerId === myUid());

    // âœ… éƒ¨å±‹ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰æ ä¸»ãƒ„ãƒ¼ãƒ«å€™è£œã‚’åˆæœŸåŒ–ï¼ˆå‰ã®æ ã®äººã‚’æ®‹ã•ãªã„ï¼‰
    // â€» recentUsers ãŒ const ãªã‚‰ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€å®£è¨€ã¯å¿…ãš `let recentUsers = new Map();` ã«ã—ã¦ã­
    recentUsers = new Map();
    renderAdminUsers();

    // è¡¨ç¤ºã¯ room_name ã‚’å„ªå…ˆ
    room = (row.room_name || room).toString();

    document.getElementById("roomName").value = room;
    document.getElementById("roomChip").textContent = room;
    document.getElementById("subTitle").textContent = "Room: " + room;

    setOwnerUI();

    // BANãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®éƒ¨å±‹ã®ã“ã®å›ã ã‘ï¼‰
    await checkBanned();

    // ç›£è¦–é–‹å§‹ï¼ˆéƒ¨å±‹å‰Šé™¤ / kick / ban / forcebackï¼‰
    await startRoomInfoRealtime();
    await startRoomDeleteWatch();
    await startRoomEventsWatch();
    await startRoomMemberHeartbeat();
    await startRoomMembersRealtime();
    await loadRoomMembersForUI();
    if (isOwner) await loadRoomMembersForAdmin();

    await loadMessages();
    await startMessagesRealtime();

    await loadActiveCallUsers();
    await startCallParticipantsRealtime();

    setReady(true, "å¾…æ©Ÿä¸­");

    // èªè¨¼çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰è¡¨ç¤ºæ›´æ–°ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œå¯¾å¿œï¼‰
    sb.auth.onAuthStateChange(async (event, session)=> {
      const sessionUser = session?.user || null;
      if (!sessionUser){
        authUser = null;
        updateTop();
        location.href = "./login.html";
        return;
      }

      const { data: u, error: uErr } = await sb.auth.getUser();
      if (uErr) log("getUser error", uErr);

      authUser = u?.user || sessionUser;

      await reloadName();
      updateTop();
    });

    log("ready room=", room, "roomId=", roomId);
  }catch(e){
    log("init fatal error", e);
    alert("åˆæœŸåŒ–ã«å¤±æ•—: " + (e?.message || e));
    goLobby();
  }
})();

/* =================== rooms ã®è¡Œã‚’ç¢ºå®šï¼ˆidå„ªå…ˆï¼‰ =================== */
async function resolveRoomRow(urlRoom, urlRoomId){
  // â˜…1) URLã« room_id ãŒã‚ã‚‹ãªã‚‰æœ€å„ªå…ˆã§ãã‚Œã‚’å–ã‚Šã«è¡Œã
  if (urlRoomId){
    const { data: byId, error: e1 } = await sb
      .from("rooms")
      .select("id, room_name, created_at, owner_id")
      .eq("id", urlRoomId)
      .maybeSingle();

    if (!e1 && byId) return byId;

    // room_id ãŒå£Šã‚Œã¦ã‚‹/æ¶ˆã•ã‚ŒãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
    log("resolveRoomRow: room_id not found -> fallback", { urlRoomId, e1 });
  }

  // â˜…2) room_name ã§æœ€æ–°ã®éƒ¨å±‹ï¼ˆåŒåãŒè¤‡æ•°ã‚ã£ã¦ã‚‚æœ€æ–°ã‚’å–ã‚‹ï¼‰
  const rn = (urlRoom || "").trim();
  if (!rn) return null;

  const { data: byName, error: e2 } = await sb
    .from("rooms")
    .select("id, room_name, created_at, owner_id")
    .eq("room_name", rn)
    .order("created_at", { ascending:false })
    .limit(1)
    .maybeSingle();

  if (e2) throw e2;
  return byName || null;
}

function safeKey(str){
  return String(str || "")
    .trim()
    .replace(/[^\w\-]/g, "_")
    .slice(0, 64);
}




</script>
</body>
</html>























