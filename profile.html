<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Profile</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:20px;
      min-height:100vh;
    }

    h2{ margin:0; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ filter:brightness(1.1); }
    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
      max-width:760px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
    }

    .hint{ font-size:12px; color:var(--muted); line-height:1.6; }

    .avatarBig{
      width:96px;height:96px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .avatarFallback{
      width:96px;height:96px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:32px;font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.28), rgba(167,139,250,.18));
      color: rgba(234,242,255,.92);
      user-select:none;
    }

    #status{ margin-top:10px; font-size:12px; }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }
  </style>
</head>

<body>

<div class="topbar">
  <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div class="row">
    <button class="btn" onclick="goBack()">â¬… æˆ»ã‚‹</button>
    <button class="btn btnDanger" onclick="signOut()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="card">
  <div class="row" style="align-items:flex-start;">
    <div id="avatarBox"></div>
    <div style="flex:1; min-width:260px;">
      <div style="font-weight:900;margin-bottom:8px;">ğŸ“ è¡¨ç¤ºå</div>
      <div class="row">
        <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" />
        <button class="btn btnPrimary" onclick="saveDisplayName()">ä¿å­˜</button>
      </div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ–¼ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</div>
      <div class="row">
        <input id="avatarFile" type="file" accept="image/*" />
        <button class="btn btnPrimary" onclick="uploadAvatar()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn btnDanger" onclick="removeAvatar()">å‰Šé™¤</button>
      </div>

      <div class="hint" style="margin-top:8px;">
        ãƒ»æ­£æ–¹å½¢ï¼ˆ1:1ï¼‰æ¨å¥¨ / 2MBä»¥ä¸‹<br>
        ãƒ»ä»–ç«¯æœ«ã§ã‚‚å³åæ˜ ã•ã‚Œã¾ã™
      </div>

      <div id="status"></div>
    </div>
  </div>
</div>

<script>
/* ================= Supabase ================= */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY,
  {
    auth:{
      flowType:"pkce",
      persistSession:true,
      autoRefreshToken:true,
      detectSessionInUrl:true
    }
  }
);

const AVATAR_BUCKET = "avatar-images";
const MAX_AVATAR_BYTES = 2 * 1024 * 1024;

let authUser = null;

/* ================= util ================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function getInitial(s){
  const t = String(s||"").trim();
  return t ? Array.from(t)[0] : "?";
}
function setStatus(msg, ok=true){
  document.getElementById("status").innerHTML =
    `<span class="${ok?"ok":"ng"}">${escapeHtml(msg)}</span>`;
}
function getBackUrl(){
  const p = new URLSearchParams(location.search);
  if (p.get("back")==="room" && p.get("room")){
    return "./room.html?room="+encodeURIComponent(p.get("room"));
  }
  return "./lobby.html";
}

/* ================= auth ================= */

  async function signOut(){
  try{
    await sb.auth.signOut();
  }catch(e){
    console.error(e);
  }

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
  location.replace("./login.html");
}
  
async function requireLogin(){
  // 1) ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
  const { data: ses } = await sb.auth.getSession();
  if (!ses?.session){
    location.replace("./login.html");
    return false;
  }

  // 2) æœ€æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const { data: u } = await sb.auth.getUser();
  if (!u?.user){
    location.replace("./login.html");
    return false;
  }

  // 3) ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
  authUser = u.user;

  // 4) Googleãƒ­ã‚°ã‚¤ãƒ³å¯¾ç­–ï¼šè‡ªåˆ†ã®ç”»åƒã¯ custom_avatar_* ã«ä¿å­˜ã™ã‚‹
  const um = authUser?.user_metadata || {};
  const legacyUrl = String(um.avatar_url || "").trim();
  const legacyVer = String(um.avatar_ver ?? "").trim();
  const customUrl = String(um.custom_avatar_url || "").trim();

  // 4-1) æ—§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼šéå»ã« avatar_url ã«ä¿å­˜ã—ã¦ã„ãŸäººç”¨ï¼ˆStorageã®URLãªã‚‰ customã¸ã‚³ãƒ”ãƒ¼ï¼‰
  const looksLikeStorage =
    legacyUrl.includes("/storage/v1/object/public/") &&
    legacyUrl.includes("/" + AVATAR_BUCKET + "/");

  if (!customUrl && looksLikeStorage){
    const now = Date.now();
    await sb.auth.updateUser({
      data: {
        custom_avatar_url: legacyUrl,
        custom_avatar_ver: legacyVer || String(now)
      }
    });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  // 4-2) verãŒç„¡ã„å ´åˆã®è£œå®Œï¼ˆcustomå´ï¼‰
  const um2 = authUser?.user_metadata || {};
  const cUrl2 = String(um2.custom_avatar_url || "").trim();
  const cVer2 = String(um2.custom_avatar_ver ?? "").trim();
  if (cUrl2 && !cVer2){
    await sb.auth.updateUser({ data: { custom_avatar_ver: Date.now() } });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  return true;
}


  // 3) ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
  authUser = u.user;
async function requireLogin(){
  // 1) ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
  const { data: ses } = await sb.auth.getSession();
  if (!ses?.session){
    location.replace("./login.html");
    return false;
  }

  // 2) æœ€æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆâ†ã“ã“è¶…é‡è¦ï¼‰
  const { data: u } = await sb.auth.getUser();
  if (!u?.user){
    location.replace("./login.html");
    return false;
  }

  // 3) ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
  authUser = u.user;

  // 4) â˜…Googleãƒ­ã‚°ã‚¤ãƒ³å¯¾ç­–ï¼š
  //    Googleã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã« user_metadata.avatar_url ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
  //    ãªã®ã§è‡ªåˆ†ã®ç”»åƒã¯ custom_avatar_url/custom_avatar_ver ã‚’ä½¿ã†ï¼ˆã“ã“ãŒæ ¸å¿ƒï¼‰
  const um = authUser?.user_metadata || {};
  const legacyUrl = String(um.avatar_url || "").trim();
  const legacyVer = String(um.avatar_ver ?? "").trim();
  const customUrl = String(um.custom_avatar_url || "").trim();
  const customVer = String(um.custom_avatar_ver ?? "").trim();

  // 4-1) æ—§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼šéå»ã« avatar_url ã«ä¿å­˜ã—ã¦ã„ãŸäººã®ãŸã‚ã«ã€Storageã£ã½ã„URLãªã‚‰ customã¸ã‚³ãƒ”ãƒ¼
  const looksLikeStorage = legacyUrl.includes("/storage/v1/object/public/") && legacyUrl.includes("/" + AVATAR_BUCKET + "/");
  if (!customUrl && looksLikeStorage){
    const now = Date.now();
    await sb.auth.updateUser({
      data: {
        custom_avatar_url: legacyUrl,
        custom_avatar_ver: legacyVer || String(now)
      }
    });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  // 4-2) verãŒç„¡ã„å ´åˆã®è£œå®Œï¼ˆcustomå´ï¼‰
  const um2 = authUser?.user_metadata || {};
  const cUrl2 = String(um2.custom_avatar_url || "").trim();
  const cVer2 = String(um2.custom_avatar_ver ?? "").trim();
  if (cUrl2 && !cVer2){
    await sb.auth.updateUser({ data: { custom_avatar_ver: Date.now() } });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  return true;
}


/* ================= UI ================= */
function buildAvatarUrl(){
  const um = authUser?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const base = hasCustom
    ? String(um.custom_avatar_url || "").trim()
    : String(um.avatar_url || "").trim();

  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();

  if (!base) return "";
  if (!ver) return base;
  return base + (base.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(ver);
}

function renderAvatar(){
  const box = document.getElementById("avatarBox");
  const dn = authUser?.user_metadata?.display_name || "";
  const url = buildAvatarUrl();

  if (url){
    box.innerHTML = `<img class="avatarBig" src="${url}" />`;
  }else{
    box.innerHTML = `<div class="avatarFallback">${escapeHtml(getInitial(dn))}</div>`;
  }
}

function refreshUI(){
  document.getElementById("displayName").value =
    authUser?.user_metadata?.display_name || "";
  renderAvatar();
}

/* ================= save ================= */
async function saveDisplayName(){
  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return setStatus("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ã­", false);

  const { data, error } = await sb.auth.updateUser({
    data:{ display_name: dn }
  });
  if (error) return setStatus(error.message,false);

  authUser = data.user;
  refreshUI();
  setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼");
}

async function uploadAvatar(){
  const file = document.getElementById("avatarFile").files[0];
  if (!file) return setStatus("ç”»åƒã‚’é¸ã‚“ã§ã­", false);
  if (file.size > MAX_AVATAR_BYTES) return setStatus("2MBä»¥ä¸‹ã«ã—ã¦ã­", false);

  const safeName = file.name.replace(/[^\w.-]+/g, "_");
  const path = `${authUser.id}/${Date.now()}_${safeName}`;

  setStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");

  const { error: upErr } = await sb.storage
    .from(AVATAR_BUCKET)
    .upload(path, file, {
      upsert: false,
      cacheControl: "0"   // âœ… è¿½åŠ ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã›ãªã„ï¼ˆæˆ»ã‚‹å•é¡Œã®æ±ºå®šæ‰“ï¼‰
    });

  if (upErr) return setStatus(upErr.message, false);

  const { data } = sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
  const url = data.publicUrl;

  const now = Date.now();
  const { data: ud, error } = await sb.auth.updateUser({
    data: {
      custom_avatar_url: url,
      custom_avatar_ver: now  // â˜…ã“ã“ãŒæœ€é‡è¦ï¼ˆURLã« ?v= ãŒä»˜ãï¼‰
    }
  });
  if (error) return setStatus(error.message, false);

  // âœ… å¿µæŠ¼ã—ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã® user_metadata ã‚’å–ã‚Šç›´ã™ï¼ˆç«¯æœ«å·®ã®ãƒã‚°æ½°ã—ï¼‰
  const { data: uu } = await sb.auth.getUser();
  authUser = uu?.user || ud.user;

  document.getElementById("avatarFile").value = "";
  refreshUI();
  setStatus("ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
}

async function removeAvatar(){
  const { data, error } = await sb.auth.updateUser({
    data:{
      custom_avatar_url:"",
      custom_avatar_ver: Date.now()
    }
  });
  if (error) return setStatus(error.message,false);

  authUser = data.user;
  refreshUI();
  setStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
}

/* ================= init ================= */
function goBack(){ location.replace(getBackUrl()); }

(async()=>{
  if (!await requireLogin()) return;
  refreshUI();
})();
</script>

</body>
</html>
