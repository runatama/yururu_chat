<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 20px;
      min-height:100vh;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    h2{ margin:0; }

    .btn{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ filter:brightness(1.1); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
      max-width: 760px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
    }

    .hint{ font-size:12px; color:var(--muted); line-height:1.6; }

    .avatarBig{
      width:96px;height:96px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .avatarFallback{
      width:96px;height:96px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:32px;font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.28), rgba(167,139,250,.18));
      color: rgba(234,242,255,.92);
      user-select:none;
    }

    #status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }
  </style>
</head>

<body>
  <div class="topbar">
    <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
    <div class="row">
      <button class="btn" type="button" onclick="goBack()">â¬… æˆ»ã‚‹</button>
      <button class="btn btnDanger" type="button" onclick="signOut()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:flex-start;">
      <div id="avatarBox"></div>
      <div style="flex:1; min-width:260px;">
        <div style="font-weight:900;margin-bottom:8px;">ğŸ“ è¡¨ç¤ºå</div>
        <div class="row">
          <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" />
          <button class="btn btnPrimary" type="button" onclick="saveDisplayName()">ä¿å­˜</button>
        </div>

        <div style="height:12px;"></div>

        <div style="font-weight:900;margin-bottom:8px;">ğŸ–¼ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç”»åƒã‚¢ãƒƒãƒ—æ–¹å¼ï¼‰</div>
        <div class="row">
          <input id="avatarFile" type="file" accept="image/*" style="max-width:320px;" />
          <button class="btn btnPrimary" type="button" onclick="uploadAvatar()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          <button class="btn btnDanger" type="button" onclick="removeAvatar()">å‰Šé™¤</button>
        </div>
        <div class="hint" style="margin-top:8px;">
          ãƒ»ãŠã™ã™ã‚: æ­£æ–¹å½¢ï¼ˆ1:1ï¼‰ / 2MBä»¥ä¸‹<br>
          ãƒ»ã‚¢ãƒƒãƒ—ã—ãŸç”»åƒã¯ Storage ã® <b>avatar-images</b> ã«ä¿å­˜ã—ã¦ã€URLã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆuser_metadataï¼‰ã«ä¿å­˜ã™ã‚‹ã‚ˆ
        </div>

        <div id="status"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;margin-bottom:8px;">âœ… åæ˜ ã•ã‚Œã‚‹å ´æ‰€</div>
    <div class="hint">
      ãƒ»å³ä¸Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ­ãƒ“ãƒ¼/ãƒ«ãƒ¼ãƒ ï¼‰<br>
      ãƒ»ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ï¼ˆåå‰ã®å·¦ï¼‰<br>
      ãƒ»é€šè©±å‚åŠ ä¸€è¦§ï¼ˆPresenceï¼‰<br>
      ãƒ»ã€Œä»Šã®éƒ¨å±‹ã§é€šè©±ã—ã¦ã‚‹äººã€ï¼ˆcall_participantsï¼‰
    </div>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "").trim(),
  {
    auth: {
      flowType: "pkce",
      detectSessionInUrl: true,
      autoRefreshToken: true,
      persistSession: true
    }
  }
);

/* ç”»åƒç”¨ï¼ˆPublic bucketåï¼‰ */
const AVATAR_BUCKET = "avatar-images";
const MAX_AVATAR_BYTES = 2 * 1024 * 1024; // 2MB

let authUser = null;

/* =================== util =================== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){
  // å±æ€§å€¤å‘ã‘ï¼ˆsrcãªã©ï¼‰
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll('"',"&quot;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function getInitial(s){
  const t = String(s || "").trim();
  if (!t) return "?";
  return Array.from(t)[0] || "?";
}
function setStatus(text, ok=true){
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok?'ok':'ng'}">${escapeHtml(text)}</span>`;
}
function safeFileName(name){
  return String(name || "avatar.png").replace(/[^\w.\-]+/g, "_");
}
function getBackUrl(){
  const p = new URLSearchParams(location.search);
  const back = (p.get("back") || "").trim();
  const room = (p.get("room") || "").trim();
  if (back === "room" && room){
    return "./room.html?room=" + encodeURIComponent(room);
  }
  return "./lobby.html";
}
function goBack(){
  location.replace(getBackUrl());
}

/* =================== auth =================== */
async function requireLoginOrRedirect(){
  const { data: ses, error: sesErr } = await sb.auth.getSession();
  if (sesErr) setStatus("getSession error: " + sesErr.message, false);

  const sessionUser = ses?.session?.user || null;
  if (!sessionUser){
    location.replace("./login.html");
    return false;
  }

  // â˜…é‡è¦ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°userã‚’å–å¾—
  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) setStatus("getUser error: " + uErr.message, false);

  authUser = u?.user || sessionUser;
  return true;
}

async function signOut(){
  try { await sb.auth.signOut({ scope:"local" }); } catch {}
  location.replace("./login.html");
}

/* =================== UI =================== */
function renderAvatar(){
  const box = document.getElementById("avatarBox");
  const dn = (authUser?.user_metadata?.display_name || "").trim();
  const em = (authUser?.email || "").trim();
  const label = dn || (em ? em.split("@")[0] : "user");
  const url = (authUser?.user_metadata?.avatar_url || "").trim();

  if (url){
    box.innerHTML = `<img class="avatarBig" src="${escapeAttr(url)}" alt="avatar" loading="lazy" referrerpolicy="no-referrer" />`;
  }else{
    box.innerHTML = `<div class="avatarFallback">${escapeHtml(getInitial(label))}</div>`;
  }
}

async function refreshUI(){
  const dn = (authUser?.user_metadata?.display_name || "").trim();
  document.getElementById("displayName").value = dn;
  renderAvatar();
}

/* =================== å…±é€šï¼šæœ€æ–°userã‚’å–ã‚Šç›´ã™ï¼ˆåˆ¥ç«¯æœ«åæ˜ ã®ã‚³ã‚¢ï¼‰ =================== */
async function refetchLatestUser(fallbackUser){
  try{
    await sb.auth.refreshSession();
  }catch{}
  const { data: u, error: uErr } = await sb.auth.getUser();
  if (uErr) console.warn("getUser error:", uErr);
  if (u?.user) return u.user;
  return fallbackUser || null;
}

/* =================== ä¿å­˜ï¼ˆè¡¨ç¤ºåï¼‰ =================== */
async function saveDisplayName(){
  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return setStatus("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ã­ï¼", false);

  // â‘  Supabase ã«è¡¨ç¤ºåã‚’ä¿å­˜
  const { data, error } = await sb.auth.updateUser({
    data: { display_name: dn }
  });
  if (error) return setStatus("ä¿å­˜å¤±æ•—: " + error.message, false);

  // â‘¡ã€œâ‘£ æœ€æ–°userã‚’å–ã‚Šç›´ã™
  authUser = await refetchLatestUser(data?.user || authUser);

  // â‘¤ ç”»é¢å†æç”»
  await refreshUI();
  setStatus("è¡¨ç¤ºåã‚’ä¿å­˜ã—ã¾ã—ãŸï¼", true);
}

/* =================== ã‚¢ãƒã‚¿ãƒ¼UP =================== */
async function uploadAvatar(){
  const file = document.getElementById("avatarFile").files?.[0];
  if (!file) return setStatus("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ï¼", false);
  if (file.size > MAX_AVATAR_BYTES) return setStatus("ç”»åƒãŒå¤§ãã™ãã‚‹ã‚ˆï¼ˆæœ€å¤§2MBï¼‰", false);

  const safeName = safeFileName(file.name);
  const path = `${authUser.id}/${Date.now()}_${safeName}`;

  setStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦", true);

  const { error: upErr } = await sb
    .storage
    .from(AVATAR_BUCKET)
    .upload(path, file, {
      cacheControl: "3600",
      upsert: false,
      contentType: file.type || "image/*"
    });

  if (upErr) return setStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + upErr.message, false);

  const { data: pub } = sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
  const url = pub?.publicUrl;
  if (!url) return setStatus("publicUrl ãŒå–ã‚Œãªã‹ã£ãŸâ€¦", false);

  const { data, error } = await sb.auth.updateUser({ data: { avatar_url: url } });
  if (error) return setStatus("ä¿å­˜å¤±æ•—: " + error.message, false);

  // â˜…åˆ¥ç«¯æœ«åæ˜ ã®ãŸã‚ï¼šæœ€æ–°userã‚’å–ã‚Šç›´ã™
  authUser = await refetchLatestUser(data?.user || authUser);

  // UIãƒªã‚»ãƒƒãƒˆ
  document.getElementById("avatarFile").value = "";
  await refreshUI();
  setStatus("ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼", true);
}

async function removeAvatar(){
  const { data, error } = await sb.auth.updateUser({ data: { avatar_url: "" } });
  if (error) return setStatus("å‰Šé™¤å¤±æ•—: " + error.message, false);

  // â˜…åˆ¥ç«¯æœ«åæ˜ ã®ãŸã‚ï¼šæœ€æ–°userã‚’å–ã‚Šç›´ã™
  authUser = await refetchLatestUser(data?.user || authUser);

  await refreshUI();
  setStatus("ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼", true);
}

/* =================== èµ·å‹• =================== */
(async ()=>{
  // URLã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ãŸã‚‰æ‹¾ã†ï¼ˆä¿é™ºï¼‰
  try{
    const url = new URL(location.href);
    const hasAuthParams =
      url.searchParams.has("code") ||
      url.searchParams.has("type") ||
      url.searchParams.has("access_token") ||
      url.searchParams.has("refresh_token") ||
      (location.hash && (location.hash.includes("access_token=") || location.hash.includes("refresh_token=")));

    if (hasAuthParams) {
      const { data, error } = await sb.auth.getSessionFromUrl({ storeSession: true });
      if (!error && data?.session?.user) authUser = data.session.user;

      // back/roomã ã‘æ®‹ã—ã¦URLã‚’ãã‚Œã„ã«ã™ã‚‹
      const sp = new URLSearchParams(location.search);
      const back = sp.get("back") || "";
      const room = sp.get("room") || "";
      history.replaceState({}, document.title,
        "./profile.html?back=" + encodeURIComponent(back) + "&room=" + encodeURIComponent(room)
      );
    }
  }catch{}

  if (!(await requireLoginOrRedirect())) return;

  // ã“ã“ã§ã‚‚æœ€æ–°userã‚’å–ã‚Šç›´ã—ã¦ãŠãï¼ˆè¶…å®‰å®šï¼‰
  authUser = await refetchLatestUser(authUser);

  await refreshUI();

  sb.auth.onAuthStateChange(async (event, session)=>{
    const sessionUser = session?.user || null;
    if (!sessionUser){
      location.replace("./login.html");
      return;
    }

    // â˜…çŠ¶æ…‹å¤‰åŒ–å¾Œã‚‚æœ€æ–°userã¸
    const { data: u } = await sb.auth.getUser();
    authUser = u?.user || sessionUser;

    await refreshUI();
  });

})();
</script>
</body>
</html>
