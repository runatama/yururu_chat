<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family: system-ui, sans-serif;
  background:#0b1220;
  color:#eaf2ff;
  padding:20px;
}
.card{
  max-width:600px;
  margin:auto;
  background:#0f1a2c;
  padding:16px;
  border-radius:16px;
}
input, textarea{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  border:none;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}
.save{ background:#6ee7ff; color:#08131f; }
img{
  width:96px;height:96px;
  border-radius:50%;
  object-fit:cover;
}
</style>
</head>

<body>

<div class="card">
  <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>

  <div id="avatarBox"></div>

  <div>è¡¨ç¤ºå</div>
  <input id="displayName">

  <div>è‡ªå·±ç´¹ä»‹</div>
  <textarea id="bio" rows="4"></textarea>

  <input type="file" id="avatarFile" accept="image/*">

  <button class="save" id="saveBtn" onclick="saveAll()">ä¿å­˜</button>
</div>

<script>
const sb = supabase.createClient(
  "https://gqqkjytefyllfomtqcqd.supabase.co",
  "å…¬é–‹anonã‚­ãƒ¼"
);

let me = null;
let isOther = false;

function esc(s){ return s||""; }

function avatar(url){
  if(url){
    avatarBox.innerHTML = `<img src="${url}">`;
  }else{
    avatarBox.innerHTML = `<div>no image</div>`;
  }
}

async function init(){
  const { data:{user} } = await sb.auth.getUser();
  if(!user){ location.href="./login.html"; return; }
  me = user;

  const uid = new URLSearchParams(location.search).get("uid");
  if(uid && uid !== me.id){
    isOther = true;
    loadOther(uid);
  }else{
    loadMe();
  }
}

function loadMe(){
  displayName.value = me.user_metadata.display_name || "";
  bio.value = me.user_metadata.bio || "";
  avatar(me.user_metadata.custom_avatar_url || "");
}

async function loadOther(uid){
  const { data } = await sb
    .from("profiles")
    .select("*")
    .eq("user_id", uid)
    .single();

  displayName.value = esc(data.display_name);
  bio.value = esc(data.bio);
  avatar(data.avatar_url);

  displayName.disabled = true;
  bio.disabled = true;
  saveBtn.style.display = "none";
}

async function saveAll(){
  const dn = displayName.value.trim();
  const b = bio.value.trim();

  // Auth ã«ä¿å­˜
  const { data } = await sb.auth.updateUser({
    data:{ display_name:dn, bio:b }
  });
  me = data.user;

  let avatarUrl = me.user_metadata.custom_avatar_url || "";

  // ç”»åƒãŒã‚ã‚Œã°ã‚¢ãƒƒãƒ—
  const f = avatarFile.files[0];
  if(f){
    const path = me.id + "/" + Date.now();
    await sb.storage.from("avatar-images").upload(path,f);
    avatarUrl = sb.storage.from("avatar-images").getPublicUrl(path).data.publicUrl;
    await sb.auth.updateUser({
      data:{ custom_avatar_url:avatarUrl }
    });
  }

  // profiles ã«ä¿å­˜ï¼ˆä»–äººç”¨ï¼‰
  await sb.from("profiles").upsert({
    user_id: me.id,
    display_name: dn,
    bio: b,
    avatar_url: avatarUrl
  });

  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
}

init();
</script>

</body>
</html>
