<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Profile</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:20px;
      min-height:100vh;
    }

    h2{ margin:0; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ filter:brightness(1.1); }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:none;
    }
    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
      max-width:760px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input, textarea{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
      font-family:inherit;
      font-size:14px;
    }
    textarea{ min-height:110px; resize:vertical; }

    .hint{ font-size:12px; color:var(--muted); line-height:1.6; }

    .avatarBig{
      width:96px;height:96px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .avatarFallback{
      width:96px;height:96px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:32px;font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.28), rgba(167,139,250,.18));
      color: rgba(234,242,255,.92);
      user-select:none;
    }

    #status{ margin-top:10px; font-size:12px; }
    .statusRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 14px 0;}
    .statusBadge{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);font-weight:900;font-size:12px;}
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(234,242,255,.75);}
    .statusSub{font-size:12px;color:var(--muted);}
    #onlineSub{display:none;}

    /* ===== online color buckets ===== */
    .st-green{
      background:rgba(74,222,128,.18);
      border-color:rgba(74,222,128,.60);
      color:#c8f7dc;
    }
    .st-yellow{
      background:rgba(253,224,71,.18);
      border-color:rgba(253,224,71,.60);
      color:#fff3b0;
    }
    .st-gray{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.25);
      color:#e5e7eb;
    }
    .dot-green{ background:#4ade80; }
    .dot-yellow{ background:#fde047; }
    .dot-gray{ background:#9ca3af; }

    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }

    /* ===== friend ui ===== */
    .miniCard{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .miniTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      font-size:12px;
      font-weight:900;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
  </style>
</head>

<body>

<div class="topbar">
  <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div class="row">
    <button class="btn" onclick="goBack()">â¬… æˆ»ã‚‹</button>
    <button class="btn btnDanger" id="logoutBtn" onclick="signOut()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="card">
  <div class="row" style="align-items:flex-start;">
    <div id="avatarBox"></div>

    <div style="flex:1; min-width:260px;">
      <div class="statusRow">
        <div class="statusBadge st-gray" id="onlineBadge"><span class="dot dot-gray" id="onlineDot"></span><span id="onlineStatus">--</span></div>
        <div class="statusSub" id="onlineSub"></div>
      </div>

      <!-- â˜… ç›¸æ‰‹é–²è¦§æ™‚ã ã‘å‡ºã™ï¼šã‚†ã‚‹å‹UI -->
      <div class="miniCard" id="friendCard" style="display:none;">
        <div class="miniTitle">ğŸ¤ ã‚†ã‚‹å‹ <span class="tag" id="friendTag">--</span></div>
        <div class="row" id="friendBtns"></div>
        <div class="hint" id="friendHint" style="margin-top:6px;"></div>
      </div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ“ è¡¨ç¤ºå</div>
      <div class="row">
        <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" />
        <button class="btn btnPrimary" id="saveNameBtn" onclick="saveAll()">ä¿å­˜</button>
      </div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ’¬ è‡ªå·±ç´¹ä»‹</div>
      <div class="row">
        <textarea id="bio" placeholder="è‡ªå·±ç´¹ä»‹ã‚’æ›¸ã„ã¦ã­ï¼ˆä¾‹ï¼šã‚²ãƒ¼ãƒ å¥½ãï¼Among Usã¨ã‹ã‚„ã£ã¦ã‚‹ã‚ˆã€œï¼‰"></textarea>
        <button class="btn btnPrimary" id="saveBioBtn" onclick="saveAll()">ä¿å­˜</button>
      </div>
      <div class="hint" style="margin-top:6px;">ãƒ»æœ€å¤§ 300 æ–‡å­—ãã‚‰ã„æ¨å¥¨ï¼ˆé•·ã™ãã‚‹ã¨èª­ã¿ã«ãã„ã®ã§ï¼‰</div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ–¼ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</div>
      <div class="row">
        <input id="avatarFile" type="file" accept="image/*" />
        <button class="btn btnPrimary" id="uploadBtn" onclick="uploadAvatar()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn btnDanger" id="removeBtn" onclick="removeAvatar()">å‰Šé™¤</button>
      </div>

      <div class="hint" style="margin-top:8px;">
        ãƒ»æ­£æ–¹å½¢ï¼ˆ1:1ï¼‰æ¨å¥¨ / 2MBä»¥ä¸‹<br>
        ãƒ»ä»–ç«¯æœ«ã§ã‚‚å³åæ˜ ã•ã‚Œã¾ã™
      </div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ•¶ï¸ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³</div>
      <div class="row">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;">
          <input type="checkbox" id="hideOnline" style="width:auto;transform:scale(1.2);" />
          <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã‚’éå…¬é–‹ã«ã™ã‚‹</span>
        </label>
        <button class="btn btnPrimary" id="savePrivacyBtn" onclick="savePrivacy()">ä¿å­˜</button>
      </div>
      <div class="hint" style="margin-top:6px;">
        ãƒ»ONã«ã™ã‚‹ã¨ã€ä»–ã®äººã®ç”»é¢ã§ã‚ãªãŸã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã¯ã€Œéå…¬é–‹ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™<br>
        ãƒ»éå…¬é–‹ä¸­ã¯æœ€çµ‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³(last_seen)ã®æ›´æ–°ã‚‚ã—ã¾ã›ã‚“
      </div>

      <div id="status"></div>
    </div>
  </div>
</div>

<script>
/* ================= Supabase ================= */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM"; // â† å¿µã®ãŸã‚å·®ã—æ›¿ãˆæ¨å¥¨ï¼ˆä»Šã®ã¾ã¾ã§ã‚‚å‹•ãï¼‰

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY,
  {
    auth:{
      flowType:"pkce",
      persistSession:true,
      autoRefreshToken:true,
      detectSessionInUrl:true
    }
  }
);

const AVATAR_BUCKET = "avatar-images";
const MAX_AVATAR_BYTES = 2 * 1024 * 1024;

let authUser = null;
let viewUid = "";       // URLã§æŒ‡å®šã•ã‚ŒãŸ uidï¼ˆç›¸æ‰‹é–²è¦§ï¼‰
let isViewOnly = false; // ç›¸æ‰‹é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‹ï¼Ÿ

/* ================= util ================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function getInitial(s){
  const t = String(s||"").trim();
  return t ? Array.from(t)[0] : "?";
}
function setStatus(msg, ok=true){
  document.getElementById("status").innerHTML =
    `<span class="${ok?"ok":"ng"}">${escapeHtml(msg)}</span>`;
}
function getBackUrl(){
  const p = new URLSearchParams(location.search);
  if (p.get("back")==="room" && p.get("room")){
    return "./room.html?room="+encodeURIComponent(p.get("room"));
  }
  return "./lobby.html";
}
function getUidFromUrl(){
  const p = new URLSearchParams(location.search);
  return String(p.get("uid") || "").trim();
}
function clampBio(s){
  const t = String(s||"").replaceAll("\r\n","\n").trim();
  if (t.length <= 300) return t;
  return t.slice(0,300);
}

// 60ç§’é–“éš”heartbeatæƒ³å®šï¼š5åˆ†ä»¥å†…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ‰±ã„ï¼ˆç·‘ï¼‰
function onlineBucket(lastSeenIso){
  if (!lastSeenIso) return { label:"ä¸æ˜", color:"gray" };

  const t = new Date(lastSeenIso).getTime();
  if (isNaN(t)) return { label:"ä¸æ˜", color:"gray" };

  const diff = Date.now() - t;
  if (diff < 0) return { label:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³", color:"green" };
  if (diff <= 5*60*1000) return { label:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³", color:"green" };

  let label = "";
  if (diff <= 10*60*1000) label = "10åˆ†ä»¥å†…";
  else if (diff <= 30*60*1000) label = "30åˆ†ä»¥å†…";
  else if (diff <= 60*60*1000) label = "ä¸€æ™‚é–“ä»¥å†…";
  else if (diff <= 3*60*60*1000) label = "ä¸‰æ™‚é–“ä»¥å†…";
  else if (diff <= 6*60*60*1000) label = "å…­æ™‚é–“ä»¥å†…";
  else if (diff <= 12*60*60*1000) label = "åäºŒæ™‚é–“ä»¥å†…";
  else if (diff <= 24*60*60*1000) label = "äºŒåå››æ™‚é–“ä»¥å†…";
  else if (diff <= 3*24*60*60*1000) label = "ä¸‰æ—¥ä»¥å†…";
  else if (diff <= 7*24*60*60*1000) label = "ä¸€é€±é–“ä»¥å†…";
  else if (diff <= 14*24*60*60*1000) label = "äºŒé€±é–“ä»¥å†…";
  else if (diff <= 30*24*60*60*1000) label = "ä¸€ã‚«æœˆä»¥å†…";
  else label = "ä¸€ã‚«æœˆä»¥ä¸Š";

  const color = (diff <= 24*60*60*1000) ? "yellow" : "gray";
  return { label, color };
}

function setOnlineUI(lastSeenOrObj){
  const statusEl = document.getElementById("onlineStatus");
  const dotEl = document.getElementById("onlineDot");
  const badgeEl = document.getElementById("onlineBadge");

  const hidden = (typeof lastSeenOrObj === "object" && lastSeenOrObj) ? !!lastSeenOrObj.online_hidden : false;
  const lastSeenIso = (typeof lastSeenOrObj === "string") ? lastSeenOrObj : (lastSeenOrObj?.last_seen || "");

  if (hidden){
    if (statusEl) statusEl.textContent = "éå…¬é–‹";
    if (badgeEl){
      badgeEl.classList.remove("st-green","st-yellow","st-gray");
      badgeEl.classList.add("st-gray");
    }
    if (dotEl){
      dotEl.classList.remove("dot-green","dot-yellow","dot-gray");
      dotEl.classList.add("dot-gray");
      dotEl.style.opacity = "1";
    }
    return;
  }

  const b = onlineBucket(lastSeenIso);
  if (statusEl) statusEl.textContent = b.label;

  const color = b.color || "gray";
  if (badgeEl){
    badgeEl.classList.remove("st-green","st-yellow","st-gray");
    badgeEl.classList.add(color === "green" ? "st-green" : (color === "yellow" ? "st-yellow" : "st-gray"));
  }
  if (dotEl){
    dotEl.classList.remove("dot-green","dot-yellow","dot-gray");
    dotEl.classList.add(color === "green" ? "dot-green" : (color === "yellow" ? "dot-yellow" : "dot-gray"));
    dotEl.style.opacity = "1";
  }
}

/* ================= auth ================= */
async function signOut(){
  try{ await sb.auth.signOut(); }catch(e){ console.error(e); }
  location.replace("./login.html");
}

async function requireLogin(){
  const { data: ses } = await sb.auth.getSession();
  if (!ses?.session){
    location.replace("./login.html");
    return false;
  }
  const { data: u } = await sb.auth.getUser();
  if (!u?.user){
    location.replace("./login.html");
    return false;
  }
  authUser = u.user;

  // Googleãƒ­ã‚°ã‚¤ãƒ³å¯¾ç­–ï¼ˆcustom_avataræ–¹å¼ï¼‰â€»å…ƒã‚³ãƒ¼ãƒ‰ç¶­æŒ
  const um = authUser.user_metadata || {};
  const legacyUrl = String(um.avatar_url || "").trim();
  const legacyVer = String(um.avatar_ver ?? "").trim();
  const customUrl = String(um.custom_avatar_url || "").trim();

  const looksLikeStorage =
    legacyUrl.includes("/storage/v1/object/public/") &&
    legacyUrl.includes("/" + AVATAR_BUCKET + "/");

  if (!customUrl && looksLikeStorage){
    const now = Date.now();
    await sb.auth.updateUser({
      data:{
        custom_avatar_url: legacyUrl,
        custom_avatar_ver: legacyVer || String(now)
      }
    });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  const um2 = authUser.user_metadata || {};
  if (um2.custom_avatar_url && !um2.custom_avatar_ver){
    await sb.auth.updateUser({ data:{ custom_avatar_ver: Date.now() } });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  return true;
}

/* ================= profiles table helpers ================= */
function buildAvatarUrlFromUser(u){
  const um = u?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const base = hasCustom
    ? String(um.custom_avatar_url || "").trim()
    : String(um.avatar_url || "").trim();

  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();

  if (!base) return "";
  if (!ver) return base;
  return base + (base.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(ver);
}

async function upsertPublicProfile(payload){
  const { error } = await sb
    .from("profiles")
    .upsert(payload, { onConflict: "user_id" });
  if (error) throw error;
}

async function loadPublicProfile(uid){
  const { data, error } = await sb
    .from("profiles")
    .select("user_id, display_name, avatar_url, bio, updated_at, last_seen, online_hidden")
    .eq("user_id", uid)
    .maybeSingle();
  if (error) throw error;
  return data || null;
}

async function syncPublicProfileFromAuth(){
  if (!authUser?.id) return;

  const dn = String(authUser?.user_metadata?.display_name || "").trim();
  const bio = clampBio(String(authUser?.user_metadata?.bio || "").trim());
  const avatarUrl = buildAvatarUrlFromUser(authUser);

  const payload = {
    user_id: authUser.id,
    display_name: dn || null,
    avatar_url: avatarUrl || null,
    bio: bio || null,
    updated_at: new Date().toISOString(),
    last_seen: new Date().toISOString(),
    online_hidden: !!(authUser?.user_metadata?.online_hidden)
  };

  try{
    await upsertPublicProfile(payload);
  }catch(e){
    console.error("syncPublicProfileFromAuth error", e);
  }
}

async function heartbeatLastSeen(){
  try{
    if (!authUser?.id) return;
    if (!!(authUser?.user_metadata?.online_hidden)) return;

    await sb.from("profiles").upsert({
      user_id: authUser.id,
      last_seen: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      online_hidden: false
    }, { onConflict: "user_id" });
  }catch(e){
    console.error("heartbeatLastSeen error", e);
  }
}

/* ================= UI ================= */
function renderAvatarBy(displayName, url){
  const box = document.getElementById("avatarBox");
  if (url){
    box.innerHTML = `<img class="avatarBig" src="${escapeHtml(url)}" />`;
  }else{
    box.innerHTML = `<div class="avatarFallback">${escapeHtml(getInitial(displayName))}</div>`;
  }
}

function setViewOnlyMode(on){
  isViewOnly = !!on;

  document.getElementById("displayName").disabled = isViewOnly;
  document.getElementById("bio").disabled = isViewOnly;
  document.getElementById("avatarFile").disabled = isViewOnly;

  document.getElementById("saveNameBtn").style.display = isViewOnly ? "none" : "";
  document.getElementById("saveBioBtn").style.display  = isViewOnly ? "none" : "";
  document.getElementById("uploadBtn").style.display   = isViewOnly ? "none" : "";
  document.getElementById("removeBtn").style.display   = isViewOnly ? "none" : "";

  const privacyBtn = document.getElementById("savePrivacyBtn");
  const privacyChk = document.getElementById("hideOnline");
  if (privacyBtn) privacyBtn.style.display = isViewOnly ? "none" : "";
  if (privacyChk) privacyChk.disabled = isViewOnly;
}

function refreshSelfUI(){
  const dn = String(authUser?.user_metadata?.display_name || "");
  const bio = String(authUser?.user_metadata?.bio || "");
  const url = buildAvatarUrlFromUser(authUser);

  document.getElementById("displayName").value = dn;
  document.getElementById("bio").value = bio;

  renderAvatarBy(dn, url);

  const hide = !!(authUser?.user_metadata?.online_hidden);
  const chk = document.getElementById("hideOnline");
  if (chk) chk.checked = hide;
}

async function savePrivacy(){
  if (isViewOnly) return;

  const hide = !!document.getElementById("hideOnline")?.checked;

  const { data, error } = await sb.auth.updateUser({
    data:{ online_hidden: hide }
  });
  if (error) return setStatus(error.message, false);

  authUser = data.user;

  try{
    await sb.from("profiles").upsert({
      user_id: authUser.id,
      online_hidden: hide,
      updated_at: new Date().toISOString(),
      ...(hide ? {} : { last_seen: new Date().toISOString() })
    }, { onConflict: "user_id" });
  }catch(e){
    console.error("savePrivacy profiles upsert error", e);
  }

  if (hide){
    setOnlineUI({ online_hidden: true });
    setStatus("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã‚’éå…¬é–‹ã«ã—ã¾ã—ãŸ");
  }else{
    await heartbeatLastSeen();
    setOnlineUI({ last_seen: new Date().toISOString(), online_hidden: !!(authUser?.user_metadata?.online_hidden) });
    setStatus("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã®éå…¬é–‹ã‚’è§£é™¤ã—ã¾ã—ãŸ");
  }
}

/* ================= save (self) ================= */
async function saveAll(){
  if (isViewOnly) return;

  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return setStatus("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ã­", false);

  const bio = clampBio(document.getElementById("bio").value);

  const { data, error } = await sb.auth.updateUser({
    data:{ display_name: dn, bio: bio }
  });
  if (error) return setStatus(error.message, false);

  authUser = data.user;
  refreshSelfUI();

  await syncPublicProfileFromAuth();
  setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼");
}

async function uploadAvatar(){
  if (isViewOnly) return;

  const file = document.getElementById("avatarFile").files[0];
  if (!file) return setStatus("ç”»åƒã‚’é¸ã‚“ã§ã­", false);
  if (file.size > MAX_AVATAR_BYTES) return setStatus("2MBä»¥ä¸‹ã«ã—ã¦ã­", false);

  const safeName = file.name.replace(/[^\w.-]+/g, "_");
  const path = `${authUser.id}/${Date.now()}_${safeName}`;

  setStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");

  const { error: upErr } = await sb.storage
    .from(AVATAR_BUCKET)
    .upload(path, file, { upsert:false, cacheControl:"0" });
  if (upErr) return setStatus(upErr.message, false);

  const { data } = sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
  const url = data.publicUrl;

  const now = Date.now();
  const { data: ud, error } = await sb.auth.updateUser({
    data: { custom_avatar_url: url, custom_avatar_ver: now }
  });
  if (error) return setStatus(error.message, false);

  const { data: uu } = await sb.auth.getUser();
  authUser = uu?.user || ud.user;

  document.getElementById("avatarFile").value = "";
  refreshSelfUI();

  await syncPublicProfileFromAuth();
  setStatus("ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
}

async function removeAvatar(){
  if (isViewOnly) return;

  const { data, error } = await sb.auth.updateUser({
    data:{ custom_avatar_url:"", custom_avatar_ver: Date.now() }
  });
  if (error) return setStatus(error.message,false);

  authUser = data.user;
  refreshSelfUI();

  await syncPublicProfileFromAuth();
  setStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
}

/* ================= ã‚†ã‚‹å‹ï¼ˆFriendï¼‰ ================= */

function el(id){ return document.getElementById(id); }

function setFriendLoading(on){
  const box = el("friendBtns");
  if (!box) return;
  [...box.querySelectorAll("button")].forEach(b=> b.disabled = !!on);
}

async function getFriendState(targetUid){
  const me = authUser?.id;
  if (!me || !targetUid) return { state:"none" };

  // 1) friends ã‚ã‚‹ï¼Ÿ
  {
    const { data, error } = await sb
      .from("friends")
      .select("id")
      .or(`and(user_a.eq.${me},user_b.eq.${targetUid}),and(user_a.eq.${targetUid},user_b.eq.${me})`)
      .limit(1);
    if (error) throw error;
    if (data && data.length) return { state:"friends" };
  }

  // 2) pending request ã‚ã‚‹ï¼Ÿï¼ˆæ–¹å‘ä¸¡æ–¹ï¼‰
  {
    const { data, error } = await sb
      .from("friend_requests")
      .select("id, from_user, to_user, status")
      .eq("status","pending")
      .or(`and(from_user.eq.${me},to_user.eq.${targetUid}),and(from_user.eq.${targetUid},to_user.eq.${me})`)
      .limit(1);
    if (error) throw error;

    const r = data && data[0];
    if (!r) return { state:"none" };

    if (r.from_user === me) return { state:"outgoing", req_id: r.id };
    return { state:"incoming", req_id: r.id };
  }
}

function renderFriendUI(stateObj){
  const card = el("friendCard");
  const tag  = el("friendTag");
  const btns = el("friendBtns");
  const hint = el("friendHint");

  if (!card || !tag || !btns || !hint) return;

  card.style.display = "";
  btns.innerHTML = "";
  hint.textContent = "";

  const makeBtn = (text, cls, onClick)=>{
    const b = document.createElement("button");
    b.className = "btn " + (cls||"");
    b.textContent = text;
    b.onclick = onClick;
    return b;
  };

  const s = stateObj?.state || "none";

  if (s === "friends"){
    tag.textContent = "å‹é”";
    btns.appendChild(makeBtn("ğŸ’” å‹é”è§£é™¤", "btnDanger", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("remove_friend", { target_uid: viewUid });
        if (error) throw error;
        setStatus("å‹é”è§£é™¤ã—ã¾ã—ãŸ");
      }catch(e){
        console.error(e);
        setStatus(e.message || "è§£é™¤å¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
      }
    }));
    hint.textContent = "å‹é”åŒå£«ã§ã™ã€‚è§£é™¤ã‚‚ã§ãã¾ã™ã€‚";
    return;
  }

  if (s === "outgoing"){
    tag.textContent = "ç”³è«‹ä¸­";
    btns.appendChild(makeBtn("â³ ç”³è«‹ä¸­ï¼ˆå–ã‚Šæ¶ˆã™ï¼‰", "btnDanger", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("cancel_friend_request", { req_id: stateObj.req_id });
        if (error) throw error;
        setStatus("ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
      }catch(e){
        console.error(e);
        setStatus(e.message || "å–æ¶ˆå¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
      }
    }));
    hint.textContent = "ç›¸æ‰‹ãŒæ‰¿èªã™ã‚‹ã¾ã§å¾…ã¡ã§ã™ã€‚";
    return;
  }

  if (s === "incoming"){
    tag.textContent = "æ‰¿èªå¾…ã¡";
    btns.appendChild(makeBtn("âœ… æ‰¿èª", "btnPrimary", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("accept_friend_request", { req_id: stateObj.req_id });
        if (error) throw error;
        setStatus("ã‚†ã‚‹å‹ã«ãªã‚Šã¾ã—ãŸï¼");
      }catch(e){
        console.error(e);
        setStatus(e.message || "æ‰¿èªå¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
      }
    }));
    btns.appendChild(makeBtn("âŒ æ‹’å¦", "btnDanger", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("reject_friend_request", { req_id: stateObj.req_id });
        if (error) throw error;
        setStatus("ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ");
      }catch(e){
        console.error(e);
        setStatus(e.message || "æ‹’å¦å¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
      }
    }));
    hint.textContent = "ç›¸æ‰‹ã‹ã‚‰ç”³è«‹ãŒæ¥ã¦ã„ã¾ã™ã€‚";
    return;
  }

  // none
  tag.textContent = "æœªç™»éŒ²";
  btns.appendChild(makeBtn("ğŸ¤ ã‚†ã‚‹å‹ç”³è«‹", "btnPrimary", async()=>{
    try{
      setFriendLoading(true);
      const { error } = await sb.rpc("send_friend_request", { to_uid: viewUid });
      if (error) throw error;
      setStatus("ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸï¼");
    }catch(e){
      console.error(e);
      setStatus(e.message || "ç”³è«‹å¤±æ•—", false);
    }finally{
      setFriendLoading(false);
      await refreshFriendUI();
    }
  }));
  hint.textContent = "ã‚†ã‚‹å‹ã«ãªã‚‹ã¨ã€ä»Šå¾Œãƒ•ãƒ¬ãƒ³ãƒ‰é™å®šæ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã¾ã™ã€‚";
}

async function refreshFriendUI(){
  if (!viewUid || viewUid === authUser?.id) return;
  try{
    const st = await getFriendState(viewUid);
    renderFriendUI(st);
  }catch(e){
    console.error("refreshFriendUI error", e);
    // UIã¯å‡ºã—ãŸã¾ã¾ã«ã—ã¦è»½ãè¡¨ç¤º
    const card = el("friendCard");
    if (card) card.style.display = "";
    if (el("friendTag")) el("friendTag").textContent = "ä¸æ˜";
    if (el("friendHint")) el("friendHint").textContent = "ã‚†ã‚‹å‹çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ï¼ˆRLSã‚„RPCã‚’ç¢ºèªã—ã¦ã­ï¼‰";
  }
}

/* ================= init ================= */
function goBack(){ location.replace(getBackUrl()); }

(async()=>{
  if (!await requireLogin()) return;

  heartbeatLastSeen();
  setInterval(heartbeatLastSeen, 60_000);
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) heartbeatLastSeen(); });

  viewUid = getUidFromUrl();

  // ç›¸æ‰‹é–²è¦§ãƒ¢ãƒ¼ãƒ‰
  if (viewUid && viewUid !== authUser.id){
    setViewOnlyMode(true);

    try{
      const p = await loadPublicProfile(viewUid);
      const dn = String(p?.display_name || "ï¼ˆæœªè¨­å®šï¼‰");
      const bio = String(p?.bio || "");
      const av = String(p?.avatar_url || "");

      document.getElementById("displayName").value = dn;
      document.getElementById("bio").value = bio;

      renderAvatarBy(dn, av);
      setOnlineUI({ last_seen: p?.last_seen, online_hidden: !!p?.online_hidden });

      // â˜… ã‚†ã‚‹å‹UI
      await refreshFriendUI();

      setStatus("é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼ˆç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰", true);
    }catch(e){
      console.error(e);
      setStatus("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—", false);
    }
    return;
  }

  // è‡ªåˆ†ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
  setViewOnlyMode(false);
  refreshSelfUI();
  setOnlineUI(new Date().toISOString());

  // è‡ªåˆ†ã®ã¨ãã¯å‹é”ã‚«ãƒ¼ãƒ‰éè¡¨ç¤º
  const fc = document.getElementById("friendCard");
  if (fc) fc.style.display = "none";

  await syncPublicProfileFromAuth();
})();
</script>

</body>
</html>
