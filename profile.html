<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - Profile</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2a;
      --card:#0f1a2cdd;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#3be0a8;
      --bad:#ff6b6b;
      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:20px;
      min-height:100vh;
    }

    h2{ margin:0; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      position:relative;
    }
    .btn:hover{ filter:brightness(1.1); }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:none;
    }
    .btnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }
    .btnDanger{
      background:rgba(255,107,107,.18);
      border-color:rgba(255,107,107,.4);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
      max-width:760px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input, textarea{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      width:100%;
      font-family:inherit;
      font-size:14px;
    }
    textarea{ min-height:110px; resize:vertical; }

    .hint{ font-size:12px; color:var(--muted); line-height:1.6; }

    .avatarBig{
      width:96px;height:96px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .avatarFallback{
      width:96px;height:96px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:32px;font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.28), rgba(167,139,250,.18));
      color: rgba(234,242,255,.92);
      user-select:none;
    }

    #status{ margin-top:10px; font-size:12px; }
    .statusRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 14px 0;}
    .statusBadge{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);font-weight:900;font-size:12px;}
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(234,242,255,.75);}
    .statusSub{font-size:12px;color:var(--muted);}
    #onlineSub{display:none;}

    /* ===== online color buckets ===== */
    .st-green{
      background:rgba(74,222,128,.18);
      border-color:rgba(74,222,128,.60);
      color:#c8f7dc;
    }
    .st-yellow{
      background:rgba(253,224,71,.18);
      border-color:rgba(253,224,71,.60);
      color:#fff3b0;
    }
    .st-gray{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.25);
      color:#e5e7eb;
    }
    .dot-green{ background:#4ade80; }
    .dot-yellow{ background:#fde047; }
    .dot-gray{ background:#9ca3af; }

    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }

    /* ===== friend ui (profile view) ===== */
    .miniCard{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .miniTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      font-size:12px;
      font-weight:900;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }

    /* ===== notification ===== */
    .badgeCount{
      position:absolute;
      top:-6px;
      right:-6px;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      color:#08131f;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
    }

    .toastWrap{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      width:min(380px, calc(100vw - 28px));
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(15,26,44,.92);
      box-shadow:var(--shadow);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation:toastIn .18s ease-out;
    }
    @keyframes toastIn{
      from{ transform:translateY(8px); opacity:0; }
      to{ transform:translateY(0); opacity:1; }
    }
    .toastTitle{ font-weight:900; margin-bottom:4px; }
    .toastMsg{ font-size:12px; color:var(--muted); line-height:1.5; }
    .toastBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .toastSmallBtn{
      pointer-events:auto;
      cursor:pointer;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
    }
    .toastSmallBtnPrimary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#08131f;
      border:none;
    }

    /* ===== friends list ===== */
    .friendsHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .friendsCount{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .friendsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 720px){
      .friendsGrid{ grid-template-columns: 1fr 1fr; }
    }
    .fItem{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .fAv{
      width:44px;height:44px;border-radius:50%;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .fAvFallback{
      width:44px;height:44px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.24), rgba(167,139,250,.14));
      color: rgba(234,242,255,.92);
      flex:0 0 auto;
      user-select:none;
    }
    .fMain{ flex:1; min-width: 160px; }
    .fNameRow{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .fName{ font-weight:900; }
    .fSub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .fBtns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-size:12px;
      font-weight:900;
    }
    .pillGreen{ border-color:rgba(74,222,128,.60); background:rgba(74,222,128,.16); color:#c8f7dc; }
    .pillYellow{ border-color:rgba(253,224,71,.60); background:rgba(253,224,71,.16); color:#fff3b0; }
    .pillGray{ border-color:rgba(255,255,255,.25); background:rgba(255,255,255,.06); color:#e5e7eb; }
  </style>
</head>

<body>

<div class="topbar">
  <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div class="row">
    <!-- ğŸ””é€šçŸ¥ãƒœã‚¿ãƒ³ -->
    <button class="btn" id="notifyBtn" onclick="openFriendInbox()">ğŸ”” é€šçŸ¥
      <span class="badgeCount" id="notifyBadge">0</span>
    </button>

    <button class="btn" onclick="goBack()">â¬… æˆ»ã‚‹</button>
    <button class="btn btnDanger" id="logoutBtn" onclick="signOut()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="card">
  <div class="row" style="align-items:flex-start;">
    <div id="avatarBox"></div>

    <div style="flex:1; min-width:260px;">
      <div class="statusRow">
        <div class="statusBadge st-gray" id="onlineBadge"><span class="dot dot-gray" id="onlineDot"></span><span id="onlineStatus">--</span></div>
        <div class="statusSub" id="onlineSub"></div>
      </div>

      <!-- â˜… ç›¸æ‰‹é–²è¦§æ™‚ã ã‘å‡ºã™ï¼šã‚†ã‚‹å‹UI -->
      <div class="miniCard" id="friendCard" style="display:none;">
        <div class="miniTitle">ğŸ¤ ã‚†ã‚‹å‹ <span class="tag" id="friendTag">--</span></div>
        <div class="row" id="friendBtns"></div>
        <div class="hint" id="friendHint" style="margin-top:6px;"></div>
      </div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ“ è¡¨ç¤ºå</div>
      <div class="row">
        <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" />
        <button class="btn btnPrimary" id="saveNameBtn" onclick="saveAll()">ä¿å­˜</button>
      </div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ’¬ è‡ªå·±ç´¹ä»‹</div>
      <div class="row">
        <textarea id="bio" placeholder="è‡ªå·±ç´¹ä»‹ã‚’æ›¸ã„ã¦ã­ï¼ˆä¾‹ï¼šã‚²ãƒ¼ãƒ å¥½ãï¼Among Usã¨ã‹ã‚„ã£ã¦ã‚‹ã‚ˆã€œï¼‰"></textarea>
        <button class="btn btnPrimary" id="saveBioBtn" onclick="saveAll()">ä¿å­˜</button>
      </div>
      <div class="hint" style="margin-top:6px;">ãƒ»æœ€å¤§ 300 æ–‡å­—ãã‚‰ã„æ¨å¥¨ï¼ˆé•·ã™ãã‚‹ã¨èª­ã¿ã«ãã„ã®ã§ï¼‰</div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ–¼ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</div>
      <div class="row">
        <input id="avatarFile" type="file" accept="image/*" />
        <button class="btn btnPrimary" id="uploadBtn" onclick="uploadAvatar()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn btnDanger" id="removeBtn" onclick="removeAvatar()">å‰Šé™¤</button>
      </div>

      <div class="hint" style="margin-top:8px;">
        ãƒ»æ­£æ–¹å½¢ï¼ˆ1:1ï¼‰æ¨å¥¨ / 2MBä»¥ä¸‹<br>
        ãƒ»ä»–ç«¯æœ«ã§ã‚‚å³åæ˜ ã•ã‚Œã¾ã™
      </div>

      <div style="height:14px;"></div>

      <div style="font-weight:900;margin-bottom:8px;">ğŸ•¶ï¸ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³</div>
      <div class="row">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;">
          <input type="checkbox" id="hideOnline" style="width:auto;transform:scale(1.2);" />
          <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã‚’éå…¬é–‹ã«ã™ã‚‹</span>
        </label>
        <button class="btn btnPrimary" id="savePrivacyBtn" onclick="savePrivacy()">ä¿å­˜</button>
      </div>
      <div class="hint" style="margin-top:6px;">
        ãƒ»ONã«ã™ã‚‹ã¨ã€ä»–ã®äººã®ç”»é¢ã§ã‚ãªãŸã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã¯ã€Œéå…¬é–‹ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™<br>
        ãƒ»éå…¬é–‹ä¸­ã¯æœ€çµ‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³(last_seen)ã®æ›´æ–°ã‚‚ã—ã¾ã›ã‚“
      </div>

      <div id="status"></div>
    </div>
  </div>
</div>

<!-- âœ… è‡ªåˆ†ã®ç”»é¢ã ã‘è¡¨ç¤ºï¼šãƒ•ãƒ¬ãƒ³ãƒ‰æ¬„ -->
<div class="card" id="friendsCard" style="display:none;">
  <div class="friendsHeader">
    <div style="font-weight:900;">ğŸ‘¥ ãƒ•ãƒ¬ãƒ³ãƒ‰</div>
    <div class="row" style="flex:1;justify-content:flex-end;">
      <input id="friendsSearch" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰æ¤œç´¢ï¼ˆè¡¨ç¤ºåï¼‰" style="max-width:320px;" />
      <button class="btn" onclick="reloadFriends()">ğŸ”„ æ›´æ–°</button>
    </div>
  </div>

  <div class="friendsCount" id="friendsCount">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <div style="height:10px;"></div>
  <div class="friendsGrid" id="friendsGrid"></div>
  <div class="hint" style="margin-top:10px;">
    ãƒ»ç›¸æ‰‹ã‚’é–‹ã â†’ ç›¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸<br>
    ãƒ»è§£é™¤ â†’ å‹é”è§£é™¤ï¼ˆæˆ»ã›ãªã„ã®ã§æ³¨æ„ï¼‰
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆç½®ãå ´ -->
<div class="toastWrap" id="toastWrap"></div>

<script>
/* ================= Supabase ================= */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM"; // â†æ—¢ã«å…¥ã£ã¦ã‚‹ãªã‚‰ãã®ã¾ã¾ã§OKï¼ˆã“ã“ã ã‘è‡ªåˆ†ã®å€¤ã«ï¼‰
const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY,
  {
    auth:{
      flowType:"pkce",
      persistSession:true,
      autoRefreshToken:true,
      detectSessionInUrl:true
    }
  }
);

const AVATAR_BUCKET = "avatar-images";
const MAX_AVATAR_BYTES = 2 * 1024 * 1024;

let authUser = null;
let viewUid = "";
let isViewOnly = false;

/* =============== notify state =============== */
let frChannel = null;
let pendingCount = 0;
const shownToastIds = new Set();

// =============== notify inbox ===============
let notifyInbox = []; // [{id,type,from_uid,from_name,room_id,room_name,created_at,read}]


/* =============== friends state =============== */
let friendsCache = []; // [{uid, display_name, avatar_url, last_seen, online_hidden}]
let friendsLoadedOnce = false;

/* ================= util ================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function getInitial(s){
  const t = String(s||"").trim();
  return t ? Array.from(t)[0] : "?";
}
function setStatus(msg, ok=true){
  const el = document.getElementById("status");
  if (!el) return;
  el.innerHTML = `<span class="${ok?"ok":"ng"}">${escapeHtml(msg)}</span>`;
}
function getBackUrl(){
  const p = new URLSearchParams(location.search);

  // ãƒ«ãƒ¼ãƒ ã‹ã‚‰æ¥ãŸå ´åˆã¯ãƒ«ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆä»Šã¾ã§é€šã‚Šï¼‰
  if (p.get("back")==="room" && p.get("room")){
    return "./room.html?room="+encodeURIComponent(p.get("room"));
  }

  // â˜… è‡ªåˆ†ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰ç›¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸æ¥ãŸå ´åˆã¯ã€è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸æˆ»ã™
  if (p.get("back")==="profile"){
    return "./profile.html";
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ­ãƒ“ãƒ¼
  return "./lobby.html";
}

function getUidFromUrl(){
  const p = new URLSearchParams(location.search);
  return String(p.get("uid") || "").trim();
}
function clampBio(s){
  const t = String(s||"").replaceAll("\r\n","\n").trim();
  if (t.length <= 300) return t;
  return t.slice(0,300);
}

/* ================= toast ================= */
function showToast({title, msg, onOpen, onAllowNotify}){
  const wrap = document.getElementById("toastWrap");
  if (!wrap) return;

  const el = document.createElement("div");
  el.className = "toast";
  el.innerHTML = `
    <div style="flex:1;">
      <div class="toastTitle">${escapeHtml(title||"é€šçŸ¥")}</div>
      <div class="toastMsg">${escapeHtml(msg||"")}</div>
      <div class="toastBtns" id="tb"></div>
    </div>
  `;

  const tb = el.querySelector("#tb");
  const addBtn = (text, cls, fn)=>{
    const b = document.createElement("button");
    b.className = "toastSmallBtn " + (cls||"");
    b.textContent = text;
    b.onclick = ()=>{
      try{ fn && fn(); }catch(e){ console.error(e); }
      el.remove();
    };
    tb.appendChild(b);
  };

  if (onOpen) addBtn("é–‹ã", "toastSmallBtnPrimary", onOpen);
  if (onAllowNotify) addBtn("ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ON", "", onAllowNotify);
  addBtn("é–‰ã˜ã‚‹", "", ()=>{});

  wrap.appendChild(el);
  setTimeout(()=>{ try{ el.remove(); }catch{} }, 8000);
}

/* ================= notify badge ================= */
function setNotifyBadge(n){
  pendingCount = Math.max(0, Number(n||0));
  const b = document.getElementById("notifyBadge");
  if (!b) return;
  if (pendingCount <= 0){
    b.style.display = "none";
    b.textContent = "0";
  }else{
    b.style.display = "inline-flex";
    b.textContent = String(pendingCount);
  }
}
async function requestBrowserNotifyPermission(){
  if (!("Notification" in window)) return false;
  if (Notification.permission === "granted") return true;
  if (Notification.permission === "denied") return false;
  const p = await Notification.requestPermission();
  return p === "granted";
}
function pushBrowserNotify(title, body){
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;
  try{ new Notification(title, { body }); }catch(e){ console.error("Notification error", e); }
}
function fmtTime(iso){
  try{
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}/${m}/${dd} ${hh}:${mm}`;
  }catch{ return ""; }
}

function openFriendInbox(){
  // ç©ºãªã‚‰æ¡ˆå†…
  if (notifyInbox.length === 0){
    showToast({
      title:"ğŸ”” é€šçŸ¥",
      msg:"ã¾ã é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“",
      onAllowNotify: async()=>{
        const ok = await requestBrowserNotifyPermission();
        setStatus(ok ? "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’ONã«ã—ã¾ã—ãŸ" : "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", ok);
      }
    });
    return;
  }

  // ä¸€è¦§ã‚’ãƒˆãƒ¼ã‚¹ãƒˆã§â€œå›ºå®šè¡¨ç¤ºâ€ã£ã½ãè¦‹ã›ã‚‹ï¼ˆä»Šã‚ã‚‹toastã‚’æµç”¨ï¼‰
  const wrap = document.getElementById("toastWrap");
  if (!wrap) return;

  const box = document.createElement("div");
  box.className = "toast";
  box.style.width = "min(520px, calc(100vw - 28px))";
  box.innerHTML = `
    <div style="flex:1;">
      <div class="toastTitle">ğŸ”” é€šçŸ¥ä¸€è¦§</div>
      <div class="toastMsg" style="margin-bottom:8px;">æœªèª­ï¼š${notifyInbox.filter(x=>!x.read).length} ä»¶</div>
      <div id="inboxList" style="display:flex;flex-direction:column;gap:8px;max-height:50vh;overflow:auto;"></div>
      <div class="toastBtns" style="margin-top:10px;">
        <button class="toastSmallBtn" id="markAll">âœ… å…¨éƒ¨æ—¢èª­</button>
        <button class="toastSmallBtn" id="clearRead">ğŸ§¹ æ—¢èª­ã‚’æ¶ˆã™</button>
        <button class="toastSmallBtn" id="closeInbox">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  `;

  const list = box.querySelector("#inboxList");
  const render = ()=>{
    list.innerHTML = "";
    for (const n of notifyInbox){
      const row = document.createElement("div");
      row.style.border = "1px solid rgba(255,255,255,.10)";
      row.style.borderRadius = "14px";
      row.style.padding = "10px";
      row.style.background = n.read ? "rgba(255,255,255,.05)" : "rgba(110,231,255,.10)";
      row.style.cursor = "pointer";

      let title = "";
      let msg = "";
      if (n.type === "friend_request"){
        title = "ğŸ¤ ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹";
        msg = `${n.from_name} ã•ã‚“ã‹ã‚‰ç”³è«‹`;
      }else if (n.type === "friend_room"){
        title = "ğŸ  éƒ¨å±‹ä½œæˆ";
        msg = `${n.from_name} ã•ã‚“ãŒã€Œ${n.room_name}ã€ã‚’ä½œæˆ`;
      }else{
        title = "ğŸ”” é€šçŸ¥";
        msg = `${n.from_name}ï¼š${n.type}`;
      }

      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;">${escapeHtml(title)}</div>
          <div style="font-size:12px;opacity:.7;">${escapeHtml(fmtTime(n.created_at))}</div>
        </div>
        <div style="font-size:12px;opacity:.85;margin-top:4px;">${escapeHtml(msg)}</div>
        <div style="font-size:12px;opacity:.7;margin-top:6px;">
          ${n.read ? "æ—¢èª­" : "æœªèª­"} ãƒ» ${escapeHtml(n.from_name)}
        </div>
      `;

      row.onclick = ()=>{
        n.read = true;
        setNotifyBadge(notifyInbox.filter(x=>!x.read).length);

        // ç¨®é¡ã”ã¨ã«é–‹ãå…ˆã‚’åˆ†ã‘ã‚‹
        if (n.type === "friend_request" && n.from_uid){
          location.href = `./profile.html?uid=${encodeURIComponent(n.from_uid)}`;
          return;
        }
        if (n.type === "friend_room" && n.room_id){
          location.href = `./room.html?room_id=${encodeURIComponent(n.room_id)}&room=${encodeURIComponent(n.room_name||"")}`;
          return;
        }
        render();
      };

      list.appendChild(row);
    }
  };

  render();

  box.querySelector("#markAll").onclick = ()=>{
    notifyInbox.forEach(x=> x.read = true);
    setNotifyBadge(0);
    render();
  };
  box.querySelector("#clearRead").onclick = ()=>{
    notifyInbox = notifyInbox.filter(x=>!x.read);
    setNotifyBadge(notifyInbox.filter(x=>!x.read).length);
    render();
  };
  box.querySelector("#closeInbox").onclick = ()=> box.remove();

  wrap.appendChild(box);
};


/* ================= online logic ================= */
function onlineBucket(lastSeenIso){
  if (!lastSeenIso) return { label:"ä¸æ˜", color:"gray" };
  const t = new Date(lastSeenIso).getTime();
  if (isNaN(t)) return { label:"ä¸æ˜", color:"gray" };

  const diff = Date.now() - t;
  if (diff < 0) return { label:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³", color:"green" };
  if (diff <= 5*60*1000) return { label:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³", color:"green" };

  let label = "";
  if (diff <= 10*60*1000) label = "10åˆ†ä»¥å†…";
  else if (diff <= 30*60*1000) label = "30åˆ†ä»¥å†…";
  else if (diff <= 60*60*1000) label = "ä¸€æ™‚é–“ä»¥å†…";
  else if (diff <= 3*60*60*1000) label = "ä¸‰æ™‚é–“ä»¥å†…";
  else if (diff <= 6*60*60*1000) label = "å…­æ™‚é–“ä»¥å†…";
  else if (diff <= 12*60*60*1000) label = "åäºŒæ™‚é–“ä»¥å†…";
  else if (diff <= 24*60*60*1000) label = "äºŒåå››æ™‚é–“ä»¥å†…";
  else if (diff <= 3*24*60*60*1000) label = "ä¸‰æ—¥ä»¥å†…";
  else if (diff <= 7*24*60*60*1000) label = "ä¸€é€±é–“ä»¥å†…";
  else if (diff <= 14*24*60*60*1000) label = "äºŒé€±é–“ä»¥å†…";
  else if (diff <= 30*24*60*60*1000) label = "ä¸€ã‚«æœˆä»¥å†…";
  else label = "ä¸€ã‚«æœˆä»¥ä¸Š";

  const color = (diff <= 24*60*60*1000) ? "yellow" : "gray";
  return { label, color };
}
function setOnlineUI(lastSeenOrObj){
  const statusEl = document.getElementById("onlineStatus");
  const dotEl = document.getElementById("onlineDot");
  const badgeEl = document.getElementById("onlineBadge");

  const hidden = (typeof lastSeenOrObj === "object" && lastSeenOrObj) ? !!lastSeenOrObj.online_hidden : false;
  const lastSeenIso = (typeof lastSeenOrObj === "string") ? lastSeenOrObj : (lastSeenOrObj?.last_seen || "");

  if (hidden){
    if (statusEl) statusEl.textContent = "éå…¬é–‹";
    if (badgeEl){
      badgeEl.classList.remove("st-green","st-yellow","st-gray");
      badgeEl.classList.add("st-gray");
    }
    if (dotEl){
      dotEl.classList.remove("dot-green","dot-yellow","dot-gray");
      dotEl.classList.add("dot-gray");
      dotEl.style.opacity = "1";
    }
    return;
  }

  const b = onlineBucket(lastSeenIso);
  if (statusEl) statusEl.textContent = b.label;

  const color = b.color || "gray";
  if (badgeEl){
    badgeEl.classList.remove("st-green","st-yellow","st-gray");
    badgeEl.classList.add(color === "green" ? "st-green" : (color === "yellow" ? "st-yellow" : "st-gray"));
  }
  if (dotEl){
    dotEl.classList.remove("dot-green","dot-yellow","dot-gray");
    dotEl.classList.add(color === "green" ? "dot-green" : (color === "yellow" ? "dot-yellow" : "dot-gray"));
    dotEl.style.opacity = "1";
  }
}

/* ================= auth ================= */
async function signOut(){
  try{ await sb.auth.signOut(); }catch(e){ console.error(e); }
  location.replace("./login.html");
}
async function requireLogin(){
  const { data: ses } = await sb.auth.getSession();
  if (!ses?.session){
    location.replace("./login.html");
    return false;
  }
  const { data: u } = await sb.auth.getUser();
  if (!u?.user){
    location.replace("./login.html");
    return false;
  }
  authUser = u.user;

  const um = authUser.user_metadata || {};
  const legacyUrl = String(um.avatar_url || "").trim();
  const legacyVer = String(um.avatar_ver ?? "").trim();
  const customUrl = String(um.custom_avatar_url || "").trim();

  const looksLikeStorage =
    legacyUrl.includes("/storage/v1/object/public/") &&
    legacyUrl.includes("/" + AVATAR_BUCKET + "/");

  if (!customUrl && looksLikeStorage){
    const now = Date.now();
    await sb.auth.updateUser({
      data:{
        custom_avatar_url: legacyUrl,
        custom_avatar_ver: legacyVer || String(now)
      }
    });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  const um2 = authUser.user_metadata || {};
  if (um2.custom_avatar_url && !um2.custom_avatar_ver){
    await sb.auth.updateUser({ data:{ custom_avatar_ver: Date.now() } });
    const { data: uu } = await sb.auth.getUser();
    if (uu?.user) authUser = uu.user;
  }

  return true;
}

/* ================= profiles helpers ================= */
function buildAvatarUrlFromUser(u){
  const um = u?.user_metadata || {};
  const hasCustom = !!String(um.custom_avatar_url || "").trim();
  const base = hasCustom
    ? String(um.custom_avatar_url || "").trim()
    : String(um.avatar_url || "").trim();

  const verRaw = hasCustom ? um.custom_avatar_ver : um.avatar_ver;
  const ver = String(verRaw ?? "").trim();

  if (!base) return "";
  if (!ver) return base;
  return base + (base.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(ver);
}
async function upsertPublicProfile(payload){
  const { error } = await sb.from("profiles").upsert(payload, { onConflict: "user_id" });
  if (error) throw error;
}
async function loadPublicProfile(uid){
  const { data, error } = await sb
    .from("profiles")
    .select("user_id, display_name, avatar_url, bio, updated_at, last_seen, online_hidden")
    .eq("user_id", uid)
    .maybeSingle();
  if (error) throw error;
  return data || null;
}
async function syncPublicProfileFromAuth(){
  if (!authUser?.id) return;

  const dn = String(authUser?.user_metadata?.display_name || "").trim();
  const bio = clampBio(String(authUser?.user_metadata?.bio || "").trim());
  const avatarUrl = buildAvatarUrlFromUser(authUser);

  const payload = {
    user_id: authUser.id,
    display_name: dn || null,
    avatar_url: avatarUrl || null,
    bio: bio || null,
    updated_at: new Date().toISOString(),
    last_seen: new Date().toISOString(),
    online_hidden: !!(authUser?.user_metadata?.online_hidden)
  };
  try{ await upsertPublicProfile(payload); }catch(e){ console.error("syncPublicProfileFromAuth error", e); }
}
async function heartbeatLastSeen(){
  try{
    if (!authUser?.id) return;
    if (!!(authUser?.user_metadata?.online_hidden)) return;
    await sb.from("profiles").upsert({
      user_id: authUser.id,
      last_seen: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      online_hidden: false
    }, { onConflict: "user_id" });
  }catch(e){
    console.error("heartbeatLastSeen error", e);
  }
}

/* ================= UI ================= */
function renderAvatarBy(displayName, url){
  const box = document.getElementById("avatarBox");
  if (url){
    box.innerHTML = `<img class="avatarBig" src="${escapeHtml(url)}" />`;
  }else{
    box.innerHTML = `<div class="avatarFallback">${escapeHtml(getInitial(displayName))}</div>`;
  }
}
function setViewOnlyMode(on){
  isViewOnly = !!on;

  document.getElementById("displayName").disabled = isViewOnly;
  document.getElementById("bio").disabled = isViewOnly;
  document.getElementById("avatarFile").disabled = isViewOnly;

  document.getElementById("saveNameBtn").style.display = isViewOnly ? "none" : "";
  document.getElementById("saveBioBtn").style.display  = isViewOnly ? "none" : "";
  document.getElementById("uploadBtn").style.display   = isViewOnly ? "none" : "";
  document.getElementById("removeBtn").style.display   = isViewOnly ? "none" : "";

  const privacyBtn = document.getElementById("savePrivacyBtn");
  const privacyChk = document.getElementById("hideOnline");
  if (privacyBtn) privacyBtn.style.display = isViewOnly ? "none" : "";
  if (privacyChk) privacyChk.disabled = isViewOnly;
}
function refreshSelfUI(){
  const dn = String(authUser?.user_metadata?.display_name || "");
  const bio = String(authUser?.user_metadata?.bio || "");
  const url = buildAvatarUrlFromUser(authUser);

  document.getElementById("displayName").value = dn;
  document.getElementById("bio").value = bio;

  renderAvatarBy(dn, url);

  const hide = !!(authUser?.user_metadata?.online_hidden);
  const chk = document.getElementById("hideOnline");
  if (chk) chk.checked = hide;
}

/* ================= privacy ================= */
async function savePrivacy(){
  if (isViewOnly) return;
  const hide = !!document.getElementById("hideOnline")?.checked;

  const { data, error } = await sb.auth.updateUser({ data:{ online_hidden: hide } });
  if (error) return setStatus(error.message, false);

  authUser = data.user;

  try{
    await sb.from("profiles").upsert({
      user_id: authUser.id,
      online_hidden: hide,
      updated_at: new Date().toISOString(),
      ...(hide ? {} : { last_seen: new Date().toISOString() })
    }, { onConflict: "user_id" });
  }catch(e){
    console.error("savePrivacy profiles upsert error", e);
  }

  if (hide){
    setOnlineUI({ online_hidden: true });
    setStatus("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã‚’éå…¬é–‹ã«ã—ã¾ã—ãŸ");
  }else{
    await heartbeatLastSeen();
    setOnlineUI({ last_seen: new Date().toISOString(), online_hidden: !!(authUser?.user_metadata?.online_hidden) });
    setStatus("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ³ã®éå…¬é–‹ã‚’è§£é™¤ã—ã¾ã—ãŸ");
  }
}

/* ================= save (self) ================= */
async function saveAll(){
  if (isViewOnly) return;

  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return setStatus("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ã­", false);

  const bio = clampBio(document.getElementById("bio").value);

  const { data, error } = await sb.auth.updateUser({ data:{ display_name: dn, bio: bio } });
  if (error) return setStatus(error.message, false);

  authUser = data.user;
  refreshSelfUI();

  await syncPublicProfileFromAuth();
  setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼");
}

async function uploadAvatar(){
  if (isViewOnly) return;

  const file = document.getElementById("avatarFile").files[0];
  if (!file) return setStatus("ç”»åƒã‚’é¸ã‚“ã§ã­", false);
  if (file.size > MAX_AVATAR_BYTES) return setStatus("2MBä»¥ä¸‹ã«ã—ã¦ã­", false);

  const safeName = file.name.replace(/[^\w.-]+/g, "_");
  const path = `${authUser.id}/${Date.now()}_${safeName}`;

  setStatus("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");

  const { error: upErr } = await sb.storage.from(AVATAR_BUCKET).upload(path, file, { upsert:false, cacheControl:"0" });
  if (upErr) return setStatus(upErr.message, false);

  const { data } = sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
  const url = data.publicUrl;

  const now = Date.now();
  const { data: ud, error } = await sb.auth.updateUser({ data: { custom_avatar_url: url, custom_avatar_ver: now } });
  if (error) return setStatus(error.message, false);

  const { data: uu } = await sb.auth.getUser();
  authUser = uu?.user || ud.user;

  document.getElementById("avatarFile").value = "";
  refreshSelfUI();

  await syncPublicProfileFromAuth();
  setStatus("ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
}

async function removeAvatar(){
  if (isViewOnly) return;

  const { data, error } = await sb.auth.updateUser({ data:{ custom_avatar_url:"", custom_avatar_ver: Date.now() } });
  if (error) return setStatus(error.message,false);

  authUser = data.user;
  refreshSelfUI();

  await syncPublicProfileFromAuth();
  setStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
}

/* ================= ã‚†ã‚‹å‹ï¼ˆFriend on other profileï¼‰ ================= */
function el(id){ return document.getElementById(id); }
function setFriendLoading(on){
  const box = el("friendBtns");
  if (!box) return;
  [...box.querySelectorAll("button")].forEach(b=> b.disabled = !!on);
}
async function getFriendState(targetUid){
  const me = authUser?.id;
  if (!me || !targetUid) return { state:"none" };

  {
    const { data, error } = await sb
      .from("friends")
      .select("id")
      .or(`and(user_a.eq.${me},user_b.eq.${targetUid}),and(user_a.eq.${targetUid},user_b.eq.${me})`)
      .limit(1);
    if (error) throw error;
    if (data && data.length) return { state:"friends" };
  }

  {
    const { data, error } = await sb
      .from("friend_requests")
      .select("id, from_user, to_user, status")
      .eq("status","pending")
      .or(`and(from_user.eq.${me},to_user.eq.${targetUid}),and(from_user.eq.${targetUid},to_user.eq.${me})`)
      .limit(1);
    if (error) throw error;

    const r = data && data[0];
    if (!r) return { state:"none" };

    if (r.from_user === me) return { state:"outgoing", req_id: r.id };
    return { state:"incoming", req_id: r.id };
  }
}
function renderFriendUI(stateObj){
  const card = el("friendCard");
  const tag  = el("friendTag");
  const btns = el("friendBtns");
  const hint = el("friendHint");
  if (!card || !tag || !btns || !hint) return;

  card.style.display = "";
  btns.innerHTML = "";
  hint.textContent = "";

  const makeBtn = (text, cls, onClick)=>{
    const b = document.createElement("button");
    b.className = "btn " + (cls||"");
    b.textContent = text;
    b.onclick = onClick;
    return b;
  };

  const s = stateObj?.state || "none";

  if (s === "friends"){
  tag.textContent = "å‹é”";

  // â˜… DMï¼ˆå·¦ï¼‰
  btns.appendChild(makeBtn("ğŸ’¬ DM", "btnPrimary", async()=>{
    try{
      setFriendLoading(true);

      // RPC: get_or_create_dm_room(target_uid) ã‚’ä½¿ã†ï¼ˆãƒ•ãƒ¬ãƒ³ãƒ‰æ¬„ã¨åŒã˜ï¼‰
      const { data, error } = await sb.rpc(
        "get_or_create_dm_room",
        { target_uid: viewUid }
      );
      if (error) throw error;

      const roomId = data;
      if (!roomId) throw new Error("roomId ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");

      location.href = `./dm.html?room_id=${encodeURIComponent(roomId)}`;
    }catch(e){
      console.error(e);
      setStatus(e.message || "DMã‚’é–‹å§‹ã§ãã¾ã›ã‚“ï¼ˆRPC / RLS / dm.htmlï¼‰", false);
    }finally{
      setFriendLoading(false);
    }
  }));

  // ğŸ’” å‹é”è§£é™¤ï¼ˆå³ï¼‰
  btns.appendChild(makeBtn("ğŸ’” å‹é”è§£é™¤", "btnDanger", async()=>{
    try{
      setFriendLoading(true);
      const { error } = await sb.rpc("remove_friend", { target_uid: viewUid });
      if (error) throw error;
      setStatus("å‹é”è§£é™¤ã—ã¾ã—ãŸ");
    }catch(e){
      console.error(e);
      setStatus(e.message || "è§£é™¤å¤±æ•—", false);
    }finally{
      setFriendLoading(false);
      await refreshFriendUI();
      await reloadFriends(true);
      startRoomCreateNotifications();
    }
  }));

  hint.textContent = "å‹é”åŒå£«ã§ã™ã€‚DMã‚„è§£é™¤ãŒã§ãã¾ã™ã€‚";
  return;
}


  if (s === "outgoing"){
    tag.textContent = "ç”³è«‹ä¸­";
    btns.appendChild(makeBtn("â³ ç”³è«‹ä¸­ï¼ˆå–ã‚Šæ¶ˆã™ï¼‰", "btnDanger", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("cancel_friend_request", { req_id: stateObj.req_id });
        if (error) throw error;
        setStatus("ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
      }catch(e){
        console.error(e);
        setStatus(e.message || "å–æ¶ˆå¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
      }
    }));
    hint.textContent = "ç›¸æ‰‹ãŒæ‰¿èªã™ã‚‹ã¾ã§å¾…ã¡ã§ã™ã€‚";
    return;
  }

  if (s === "incoming"){
    tag.textContent = "æ‰¿èªå¾…ã¡";
    btns.appendChild(makeBtn("âœ… æ‰¿èª", "btnPrimary", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("accept_friend_request", { req_id: stateObj.req_id });
        if (error) throw error;
        setStatus("ã‚†ã‚‹å‹ã«ãªã‚Šã¾ã—ãŸï¼");
      }catch(e){
        console.error(e);
        setStatus(e.message || "æ‰¿èªå¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
        await reloadFriends(true);
        startRoomCreateNotifications();
      }
    }));
    btns.appendChild(makeBtn("âŒ æ‹’å¦", "btnDanger", async()=>{
      try{
        setFriendLoading(true);
        const { error } = await sb.rpc("reject_friend_request", { req_id: stateObj.req_id });
        if (error) throw error;
        setStatus("ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ");
      }catch(e){
        console.error(e);
        setStatus(e.message || "æ‹’å¦å¤±æ•—", false);
      }finally{
        setFriendLoading(false);
        await refreshFriendUI();
      }
    }));
    hint.textContent = "ç›¸æ‰‹ã‹ã‚‰ç”³è«‹ãŒæ¥ã¦ã„ã¾ã™ã€‚";
    return;
  }

  tag.textContent = "æœªç™»éŒ²";
  btns.appendChild(makeBtn("ğŸ¤ ã‚†ã‚‹å‹ç”³è«‹", "btnPrimary", async()=>{
    try{
      setFriendLoading(true);
      const { error } = await sb.rpc("send_friend_request", { to_uid: viewUid });
      if (error) throw error;
      setStatus("ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸï¼");
    }catch(e){
      console.error(e);
      setStatus(e.message || "ç”³è«‹å¤±æ•—", false);
    }finally{
      setFriendLoading(false);
      await refreshFriendUI();
    }
  }));
  hint.textContent = "ã‚†ã‚‹å‹ã«ãªã‚‹ã¨ã€ä»Šå¾Œãƒ•ãƒ¬ãƒ³ãƒ‰é™å®šæ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã¾ã™ã€‚";
}
async function refreshFriendUI(){
  if (!viewUid || viewUid === authUser?.id) return;
  try{
    const st = await getFriendState(viewUid);
    renderFriendUI(st);
  }catch(e){
    console.error("refreshFriendUI error", e);
    const card = el("friendCard");
    if (card) card.style.display = "";
    if (el("friendTag")) el("friendTag").textContent = "ä¸æ˜";
    if (el("friendHint")) el("friendHint").textContent = "ã‚†ã‚‹å‹çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ï¼ˆRLSã‚„RPCã‚’ç¢ºèªï¼‰";
  }
}

/* ================= é€šçŸ¥ï¼špendingæ•° åˆæœŸå–å¾—ï¼‹Realtime ================= */
async function refreshPendingCount(){
  if (!authUser?.id) return;
  try{
    const { count, error } = await sb
      .from("friend_requests")
      .select("id", { count: "exact", head: true })
      .eq("to_user", authUser.id)
      .eq("status", "pending");
    if (error) throw error;
    setNotifyBadge(count || 0);
  }catch(e){
    console.error("refreshPendingCount error", e);
  }
}
async function startFriendRequestNotifications(){
  if (!authUser?.id) return;

  await refreshPendingCount();

  try{
    if (frChannel){
      await sb.removeChannel(frChannel);
      frChannel = null;
    }
  }catch(e){
    console.error("removeChannel error", e);
  }

  frChannel = sb.channel("fr_notify_" + authUser.id)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "friend_requests",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      try{
        const r = payload?.new;
        if (!r) return;
        if (r.status !== "pending") return;

        setNotifyBadge(pendingCount + 1);

        if (shownToastIds.has(r.id)) return;
        shownToastIds.add(r.id);

        let fromName = "èª°ã‹";
        try{
          const { data } = await sb.from("profiles")
            .select("display_name")
            .eq("user_id", r.from_user)
            .maybeSingle();
          if (data?.display_name) fromName = String(data.display_name);
        }catch{}

        showToast({
          title: "ğŸ¤ ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒæ¥ãŸï¼",
          msg: `${fromName} ã•ã‚“ã‹ã‚‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`,
          onOpen: ()=>{
            location.href = `./profile.html?uid=${encodeURIComponent(r.from_user)}`;
          },
          onAllowNotify: async()=>{
            const ok = await requestBrowserNotifyPermission();
            setStatus(ok ? "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’ONã«ã—ã¾ã—ãŸ" : "ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", ok);
          }
        });

        pushBrowserNotify("ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ", `${fromName} ã•ã‚“ã‹ã‚‰ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒå±Šã„ãŸã‚ˆ`);
      }catch(e){
        console.error("INSERT notify error", e);
      }
    })
    .on("postgres_changes", {
      event: "UPDATE",
      schema: "public",
      table: "friend_requests",
      filter: `to_user=eq.${authUser.id}`
    }, async(payload)=>{
      try{
        const oldRow = payload?.old;
        const newRow = payload?.new;
        if (!oldRow || !newRow) return;

        const wasPending = oldRow.status === "pending";
        const isPending = newRow.status === "pending";

        if (wasPending && !isPending) setNotifyBadge(pendingCount - 1);
        if (!wasPending && isPending) setNotifyBadge(pendingCount + 1);

        // accepted ã«ãªã£ãŸã‚‰ãƒ•ãƒ¬ãƒ³ãƒ‰æ¬„ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè‡ªåˆ†ç”»é¢ã®ã¨ãã ã‘ï¼‰
        if (newRow.status === "accepted" && !isViewOnly){
          await reloadFriends(true);
          startRoomCreateNotifications();
        }
      }catch(e){
        console.error("UPDATE notify error", e);
      }
    })
    .subscribe(()=>{});
}
// ================= éƒ¨å±‹ä½œæˆ é€šçŸ¥ =================
let roomNotifyChannel = null;

async function startRoomCreateNotifications(){
  if (!authUser?.id) return;

  // ãƒ•ãƒ¬ãƒ³ãƒ‰UIDä¸€è¦§ã‚’å–å¾—
  const friendUids = friendsCache.map(f => f.uid);
  if (friendUids.length === 0) return;

  // æ—¢å­˜ãƒãƒ£ãƒ³ãƒãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
  if (roomNotifyChannel){
    try{ await sb.removeChannel(roomNotifyChannel); }catch{}
    roomNotifyChannel = null;
  }

  roomNotifyChannel = sb
    .channel("room_create_notify_" + authUser.id)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "rooms"
      },
      async(payload)=>{
        const r = payload?.new;
        if (!r) return;

        // ãƒ•ãƒ¬ãƒ³ãƒ‰ä»¥å¤–ã¯ç„¡è¦–
        if (!friendUids.includes(r.owner_id)) return;

        // ãƒ•ãƒ¬ãƒ³ãƒ‰åã‚’å–å¾—
        let ownerName = "ãƒ•ãƒ¬ãƒ³ãƒ‰";
        try{
          const { data } = await sb
            .from("profiles")
            .select("display_name")
            .eq("user_id", r.owner_id)
            .maybeSingle();
          if (data?.display_name) ownerName = data.display_name;
        }catch{}

        // ğŸ”” é€šçŸ¥ã‚’å‡ºã™
        showToast({
          title: "ğŸ  ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒéƒ¨å±‹ã‚’ä½œæˆï¼",
          msg: `${ownerName} ã•ã‚“ãŒã€Œ${r.room_name}ã€ã‚’ä½œã£ãŸã‚ˆ`,
          onOpen: ()=>{
            location.href =
              `./room.html?room=${encodeURIComponent(r.room_name)}&room_id=${encodeURIComponent(r.id)}`;
          }
        });

        // ãƒãƒƒã‚¸æ•°ã‚‚å¢—ã‚„ã™ï¼ˆä»»æ„ï¼‰
        setNotifyBadge(pendingCount + 1);
      }
    )
    .subscribe();
}

/* ================= Friends list (self only) ================= */
function otherUidFromFriendRow(row){
  if (!row) return "";
  if (row.user_a === authUser.id) return row.user_b;
  return row.user_a;
}
function onlinePillFor(p){
  if (p?.online_hidden) return { text:"éå…¬é–‹", cls:"pillGray" };
  const b = onlineBucket(p?.last_seen);
  if (b.color === "green") return { text:b.label, cls:"pillGreen" };
  if (b.color === "yellow") return { text:b.label, cls:"pillYellow" };
  return { text:b.label, cls:"pillGray" };
}
function renderFriends(){
  const grid = document.getElementById("friendsGrid");
  const countEl = document.getElementById("friendsCount");
  const q = String(document.getElementById("friendsSearch")?.value || "").trim().toLowerCase();

  if (!grid || !countEl) return;

  let arr = friendsCache.slice();
  if (q){
    arr = arr.filter(x => String(x.display_name||"").toLowerCase().includes(q));
  }

  countEl.textContent = `ãƒ•ãƒ¬ãƒ³ãƒ‰ï¼š${arr.length} äºº`;

  grid.innerHTML = "";
  if (arr.length === 0){
    grid.innerHTML = `<div class="hint">ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ã¾ã›ã‚“ï¼ˆã¾ãŸã¯æ¤œç´¢ã«ä¸€è‡´ã—ã¾ã›ã‚“ï¼‰</div>`;
    return;
  }

  for (const f of arr){
    const pill = onlinePillFor(f);

    const item = document.createElement("div");
item.className = "fItem";

// â†ã“ã“ã«è¿½åŠ 
item.onclick = ()=>{
  location.href = `./profile.html?uid=${encodeURIComponent(f.uid)}&back=profile`;
};
;

    const av = f.avatar_url
      ? `<img class="fAv" src="${escapeHtml(f.avatar_url)}" />`
      : `<div class="fAvFallback">${escapeHtml(getInitial(f.display_name))}</div>`;

    item.innerHTML = `
      ${av}
      <div class="fMain">
        <div class="fNameRow">
          <div class="fName">${escapeHtml(f.display_name || "ï¼ˆæœªè¨­å®šï¼‰")}</div>
          <span class="pill ${pill.cls}">
            <span style="width:7px;height:7px;border-radius:50%;background:${
              pill.cls==="pillGreen" ? "#4ade80" : (pill.cls==="pillYellow" ? "#fde047" : "#9ca3af")
            };display:inline-block;"></span>
            ${escapeHtml(pill.text)}
          </span>
        </div>
        <div class="fSub">${escapeHtml(f.bio || "")}</div>
      </div>
      <div class="fBtns">
        <button class="btn btnPrimary" data-dm>ğŸ’¬ DM</button>
        <button class="btn btnDanger" data-remove>ğŸ’” è§£é™¤</button>
      </div>
    `;

    // ğŸ’¬ DMé–‹å§‹ï¼ˆDMãƒ«ãƒ¼ãƒ å–å¾—/ä½œæˆ â†’ dm.htmlã¸ï¼‰
    item.querySelector("[data-dm]").onclick = async(e)=>{
  e.stopPropagation(); // â˜…ã“ã‚Œè¶…å¤§äº‹

  try{
    item.querySelector("[data-dm]").disabled = true;

    const { data, error } = await sb.rpc(
      "get_or_create_dm_room",
      { target_uid: f.uid }
    );
    if (error) throw error;

    const roomId = data;
    if (!roomId) throw new Error("roomId ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");

    location.href = `./dm.html?room_id=${encodeURIComponent(roomId)}`;
  }catch(err){
    console.error(err);
    setStatus(err.message || "DMã‚’é–‹å§‹ã§ãã¾ã›ã‚“", false);
  }finally{
    try{ item.querySelector("[data-dm]").disabled = false; }catch{}
  }
};


    // ğŸ’” å‹é”è§£é™¤
    item.querySelector("[data-remove]").onclick = async(e)=>{
  e.stopPropagation(); // â˜…ã“ã‚Œè¶…å¤§äº‹

  if (!confirm("å‹é”è§£é™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ã‚ˆï¼‰")) return;
  try{
    item.querySelector("[data-remove]").disabled = true;
    const { error } = await sb.rpc("remove_friend", { target_uid: f.uid });
    if (error) throw error;

    setStatus("å‹é”è§£é™¤ã—ã¾ã—ãŸ");
    await reloadFriends(true);
    startRoomCreateNotifications();
  }catch(err){
    console.error(err);
    setStatus(err.message || "è§£é™¤å¤±æ•—", false);
  }finally{
    try{ item.querySelector("[data-remove]").disabled = false; }catch{}
  }
};


    grid.appendChild(item);
  }
}


async function reloadFriends(force=false){
  if (isViewOnly) return;
  if (!authUser?.id) return;
  if (friendsLoadedOnce && !force) return;

  const card = document.getElementById("friendsCard");
  const grid = document.getElementById("friendsGrid");
  const countEl = document.getElementById("friendsCount");
  if (card) card.style.display = "";
  if (grid) grid.innerHTML = `<div class="hint">èª­ã¿è¾¼ã¿ä¸­â€¦</div>`;
  if (countEl) countEl.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

  try{
    // friends ã‹ã‚‰è‡ªåˆ†ã®é–¢ä¿‚ã‚’å–ã‚‹
    const { data: fr, error: ferr } = await sb
      .from("friends")
      .select("user_a, user_b")
      .or(`user_a.eq.${authUser.id},user_b.eq.${authUser.id}`);

    if (ferr) throw ferr;

    const uids = (fr || []).map(otherUidFromFriendRow).filter(Boolean);
    const unique = Array.from(new Set(uids));

    if (unique.length === 0){
      friendsCache = [];
      friendsLoadedOnce = true;
      renderFriends();
      return;
    }

    // profiles ã‚’ã¾ã¨ã‚ã¦å¼•ã
    const { data: ps, error: perr } = await sb
      .from("profiles")
      .select("user_id, display_name, avatar_url, bio, last_seen, online_hidden")
      .in("user_id", unique);

    if (perr) throw perr;

    // map
    const map = new Map();
    (ps||[]).forEach(p=> map.set(p.user_id, p));

    friendsCache = unique.map(uid=>{
      const p = map.get(uid) || {};
      return {
        uid,
        display_name: p.display_name || "ï¼ˆæœªè¨­å®šï¼‰",
        avatar_url: p.avatar_url || "",
        bio: p.bio || "",
        last_seen: p.last_seen || null,
        online_hidden: !!p.online_hidden
      };
    });

    // åå‰ã§è»½ãä¸¦ã¹ã‚‹
    friendsCache.sort((a,b)=> String(a.display_name).localeCompare(String(b.display_name), "ja"));

    friendsLoadedOnce = true;
    renderFriends();
  }catch(e){
    console.error("reloadFriends error", e);
    friendsCache = [];
    friendsLoadedOnce = true;
    if (countEl) countEl.textContent = "èª­ã¿è¾¼ã¿å¤±æ•—";
    if (grid) grid.innerHTML = `<div class="hint">ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ï¼ˆRLS / RPC / friendsãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰</div>`;
  }
}

/* ================= init ================= */
function goBack(){ location.replace(getBackUrl()); }

(async()=>{
  if (!await requireLogin()) return;

  // last_seen
  heartbeatLastSeen();
  setInterval(heartbeatLastSeen, 60_000);
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) heartbeatLastSeen(); });

  // notify
  startFriendRequestNotifications();

  viewUid = getUidFromUrl();

  // ç›¸æ‰‹é–²è¦§ãƒ¢ãƒ¼ãƒ‰
  if (viewUid && viewUid !== authUser.id){
    setViewOnlyMode(true);

    // friends card hide
    const fc2 = document.getElementById("friendsCard");
    if (fc2) fc2.style.display = "none";

    try{
      const p = await loadPublicProfile(viewUid);
      const dn = String(p?.display_name || "ï¼ˆæœªè¨­å®šï¼‰");
      const bio = String(p?.bio || "");
      const av = String(p?.avatar_url || "");

      document.getElementById("displayName").value = dn;
      document.getElementById("bio").value = bio;

      renderAvatarBy(dn, av);
      setOnlineUI({ last_seen: p?.last_seen, online_hidden: !!p?.online_hidden });

      await refreshFriendUI();
      setStatus("é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼ˆç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰", true);
    }catch(e){
      console.error(e);
      setStatus("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—", false);
    }
    return;
  }

  // è‡ªåˆ†ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
  setViewOnlyMode(false);
  refreshSelfUI();
  setOnlineUI(new Date().toISOString());

  const fc = document.getElementById("friendCard");
  if (fc) fc.style.display = "none";

  await syncPublicProfileFromAuth();

  // âœ… ãƒ•ãƒ¬ãƒ³ãƒ‰æ¬„ è¡¨ç¤ºï¼†ãƒ­ãƒ¼ãƒ‰
  const friendsCard = document.getElementById("friendsCard");
  if (friendsCard) friendsCard.style.display = "";
  const search = document.getElementById("friendsSearch");
  if (search){
    search.addEventListener("input", ()=> renderFriends());
  }
  await reloadFriends(true);
  startRoomCreateNotifications();
})();
</script>

</body>
</html>
