<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ゆるるチャット</title>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: sans-serif;
            padding: 12px;
        }

        input {
            width: 260px;
            padding: 6px;
            margin: 4px 0;
        }

        button {
            padding: 6px 10px;
            margin: 4px 2px;
            cursor: pointer;
        }

        #roomsBox {
            border: 1px solid #ccc;
            width: 260px;
            height: 180px;
            overflow: auto;
            padding: 6px;
            margin: 10px 0;
            background: #fafafa;
        }

        .roomRow {
            display: flex;
            gap: 6px;
            margin: 3px 0;
            align-items: center;
        }

        .roomBtn {
            flex: 1;
            width: auto;
            text-align: left;
            padding: 6px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: #fff;
        }

            .roomBtn:hover {
                background: #f0f0f0;
            }

        .delBtn {
            width: 44px;
            padding: 6px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
        }

            .delBtn:hover {
                background: #ffecec;
            }

        #chat {
            border: 1px solid #ccc;
            height: 240px;
            overflow: auto;
            padding: 8px;
            background: #fff;
            width: min(720px, 95vw);
            margin-top: 10px;
        }

        .row {
            margin: 6px 0;
        }

        .small {
            font-size: 12px;
            color: #666;
        }

        .ok {
            color: #0a7;
        }

        .ng {
            color: #c33;
        }

        /* ✅ システムメッセージの見た目 */
        .sys {
            color: #666;
            font-size: 12px;
            margin: 4px 0;
        }
    </style>
</head>

<body>
    <h2>ゆるるチャット</h2>

    <div class="row">
        <input id="name" placeholder="名前" />
    </div>

    <div class="row">
        <input id="room" placeholder="部屋名（例: test）" />
    </div>

    <div class="row">
        <button onclick="createRoom()">部屋作成</button>
        <button onclick="join()">入室</button>
        <button onclick="leave()">退室</button>
        <button onclick="loadRooms()">部屋一覧更新</button>
    </div>

    <div class="row">
        <b>部屋一覧（スクロール）</b>
        <div id="roomsBox"></div>
        <div class="small">
            ・部屋名クリック：入力欄へ / ・部屋名ダブルクリック：その部屋に入室<br />
            ・🗑：部屋削除（※その部屋のメッセージも削除）
        </div>
    </div>

    <hr />

    <div id="status" class="small"></div>
    <div id="chat"></div>

    <div class="row">
        <input id="msg" placeholder="メッセージ" />
        <button onclick="send()">送信</button>
    </div>

    <script>
    // ========= ここだけ自分のSupabaseに合わせる =========
    const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";
    // ================================================

    const sb = supabase.createClient(
      SUPABASE_URL.trim(),
      (SUPABASE_KEY || "").replace(/\s+/g, "")
    );

    let room = "";
    let name = "";

    // Realtime購読（部屋一覧/メッセージ）
    let roomsChannel = null;
    let messagesChannel = null;

    // ✅ システムメッセージ用の固定名
    const SYSTEM_NAME = "__system__";

    function setStatus(text, ok = true) {
      const el = document.getElementById("status");
      el.innerHTML = `<span class="${ok ? "ok" : "ng"}">${text}</span>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ✅ システムメッセージをDBに保存（＝みんなに見える）
    async function sendSystem(text) {
      if (!room) return;
      const { error } = await sb.from("messages").insert({
        room_id: room,
        name: SYSTEM_NAME,
        message: text
      });
      if (error) {
        console.error(error);
        // ここはalertしない（邪魔になる）けど、必要ならalertにしてOK
      }
    }

    // ------------------------------
    // Realtime開始（固定）
    // ------------------------------
    async function startRealtime() {
      if (roomsChannel || messagesChannel) return;

      roomsChannel = sb
        .channel("rooms-ch")
        .on("postgres_changes", { event: "*", schema: "public", table: "rooms" }, async () => {
          await loadRooms();
        })
        .subscribe();

      messagesChannel = sb
        .channel("messages-ch")
        .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, async (payload) => {
          if (!room) return;

          const newRow = payload.new || {};
          const oldRow = payload.old || {};
          const rid = newRow.room_id || oldRow.room_id;

          if (rid === room) {
            await loadMessages();
          }
        })
        .subscribe();

      setStatus("リアルタイム接続OK（変更があれば自動反映）");
    }

    // ------------------------------
    // 部屋一覧
    // ------------------------------
    async function loadRooms() {
      let res = await sb
        .from("rooms")
        .select("room_name, created_at")
        .order("created_at", { ascending: true });

      if (res.error && String(res.error.message || "").includes("created_at")) {
        res = await sb.from("rooms").select("room_name");
      }

      const { data, error } = res;

      if (error) {
        console.error(error);
        setStatus("部屋一覧取得失敗: " + error.message, false);
        return;
      }

      const box = document.getElementById("roomsBox");
      box.innerHTML = "";

      if (!data || data.length === 0) {
        box.innerHTML = "<div>まだ部屋がないよ（部屋作成してね）</div>";
        if (!room) setStatus("部屋なし（新しく作ってOK）");
        return;
      }

      data.forEach(r => {
        const row = document.createElement("div");
        row.className = "roomRow";

        const btn = document.createElement("button");
        btn.className = "roomBtn";
        btn.textContent = r.room_name;

        btn.onclick = () => { document.getElementById("room").value = r.room_name; };

        btn.ondblclick = async () => {
          document.getElementById("room").value = r.room_name;
          await join();
        };

        const del = document.createElement("button");
        del.className = "delBtn";
        del.textContent = "🗑";
        del.title = "部屋削除";

        del.onclick = async () => {
          const rn = r.room_name;
          if (!confirm(`部屋「${rn}」を削除しますか？\n※その部屋のメッセージも消えます`)) return;
          await deleteRoom(rn);
        };

        row.appendChild(btn);
        row.appendChild(del);
        box.appendChild(row);
      });

      if (!room) setStatus(`部屋一覧OK（${data.length}件）`);
    }

    // ------------------------------
    // 部屋作成（同名禁止）
    // ------------------------------
    async function createRoom() {
      const roomName = document.getElementById("room").value.trim();
      if (!roomName) return alert("部屋名を入れてね！");

      const { data: exists, error: e1 } = await sb
        .from("rooms")
        .select("room_name")
        .eq("room_name", roomName)
        .maybeSingle();

      if (e1) {
        console.error(e1);
        alert("部屋確認失敗: " + e1.message);
        return;
      }

      if (exists) {
        alert("その部屋はもうあるよ！一覧から選んで入室してね！");
        return;
      }

      const { error } = await sb.from("rooms").insert({ room_name: roomName });

      if (error) {
        console.error(error);
        alert("部屋作成失敗: " + error.message);
        return;
      }

      alert(`部屋「${roomName}」を作った！`);
      await loadRooms();

      // ✅ 作成した部屋に自動で入室したいなら、以下をONにしてもOK
      // document.getElementById("room").value = roomName;
      // await join();
    }

    // ------------------------------
    // メッセージ読み込み
    // ------------------------------
    async function loadMessages() {
      if (!room) return;

      let res = await sb
        .from("messages")
        .select("*")
        .eq("room_id", room)
        .order("created_at", { ascending: true })
        .limit(200);

      if (res.error && String(res.error.message || "").includes("created_at")) {
        res = await sb.from("messages").select("*").eq("room_id", room).limit(200);
      }

      const { data, error } = res;

      if (error) {
        console.error(error);
        setStatus("メッセージ取得失敗: " + error.message, false);
        return;
      }

      const chat = document.getElementById("chat");
      chat.innerHTML = "";

      (data || []).forEach(m => {
        const n = escapeHtml(m.name ?? "");
        const msg = escapeHtml(m.message ?? "");

        if (m.name === SYSTEM_NAME) {
          chat.innerHTML += `<div class="sys">✅ ${msg}</div>`;
        } else {
          chat.innerHTML += `<div><b>${n}:</b> ${msg}</div>`;
        }
      });

      chat.scrollTop = chat.scrollHeight;
      setStatus(`入室中: ${room}（${(data || []).length}件表示）`);
    }

    // ------------------------------
    // 入室（みんなに見えるログを保存）
    // ------------------------------
    async function join() {
      const inputRoom = document.getElementById("room").value.trim();
      const inputName = document.getElementById("name").value.trim();

      if (!inputRoom || !inputName) {
        alert("名前と部屋名を入れてね！");
        return;
      }

      const { data: exists, error } = await sb
        .from("rooms")
        .select("room_name")
        .eq("room_name", inputRoom)
        .maybeSingle();

      if (error) {
        console.error(error);
        alert("部屋確認失敗: " + error.message);
        return;
      }
      if (!exists) {
        alert("その部屋はまだ作られてない！先に『部屋作成』してね！");
        return;
      }

      // ✅ ここで入室を確定
      room = inputRoom;
      name = inputName;

      await loadMessages();

      // ✅ 入室ログを「messages」に保存（＝みんなに表示）
      await sendSystem(`${name} が「${room}」に入室しました`);
    }

    // ------------------------------
    // 退室（みんなに見えるログを保存）
    // ------------------------------
    async function leave() {
      if (!room || !name) {
        alert("まだ入室してないよ！");
        return;
      }

      // ✅ 先に退室ログを保存（保存後にroom消す）
      const leavingRoom = room;
      const leavingName = name;

      await sendSystem(`${leavingName} が「${leavingRoom}」から退室しました`);

      room = "";
      name = leavingName; // 名前は残してもいい（残したくなければ "" にしてOK）

      document.getElementById("chat").innerHTML = "";
      setStatus("退室しました");
    }

    // ------------------------------
    // 送信
    // ------------------------------
    async function send() {
      const text = document.getElementById("msg").value.trim();
      document.getElementById("msg").value = "";

      if (!room || !name) {
        alert("先に入室してね！");
        return;
      }
      if (!text) return;

      const { error } = await sb.from("messages").insert({
        room_id: room,
        name: name,
        message: text
      });

      if (error) {
        console.error(error);
        alert("送信失敗: " + error.message);
        return;
      }

      await loadMessages();
    }

    // ------------------------------
    // 部屋削除（その部屋のmessagesも削除）
    // ------------------------------
    async function deleteRoom(roomName) {
      // 入室中なら先に抜ける（ログは残す/残さない選べる）
      if (room === roomName) {
        await sendSystem(`${name} が「${roomName}」を削除します`);
        room = "";
        document.getElementById("chat").innerHTML = "";
        setStatus("部屋から退出しました（削除処理中…）");
      }

      // ① messagesを削除
      const r1 = await sb.from("messages").delete().eq("room_id", roomName);
      if (r1.error) {
        console.error(r1.error);
        alert("メッセージ削除失敗: " + r1.error.message);
        return;
      }

      // ② roomsを削除
      const r2 = await sb.from("rooms").delete().eq("room_name", roomName);
      if (r2.error) {
        console.error(r2.error);
        alert("部屋削除失敗: " + r2.error.message);
        return;
      }

      alert(`部屋「${roomName}」を削除したよ！`);
      await loadRooms();
    }

    // Enterで送信
    document.getElementById("msg").addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    // 起動時
    (async () => {
      await loadRooms();
      await startRealtime();
    })();
    </script>
</body>
</html>
