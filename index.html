<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: sans-serif; padding: 12px; }
    input { width: 260px; padding: 6px; margin: 4px 0; }
    button { padding: 6px 10px; margin: 4px 2px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .card { border: 1px solid #ccc; background: #fafafa; padding: 10px; border-radius: 10px; margin: 10px 0; }
    .row { display:flex; gap:8px; flex-wrap: wrap; align-items: center; }

    #roomsBox {
      border: 1px solid #ccc; width: 260px; height: 180px;
      overflow: auto; padding: 6px; margin: 10px 0; background: #fafafa;
    }
    .roomRow { display: flex; gap: 6px; margin: 3px 0; align-items: center; }
    .roomBtn {
      flex: 1; width: auto; text-align: left; padding: 6px;
      cursor: pointer; border: 1px solid #ddd; background: #fff;
    }
    .roomBtn:hover { background: #f0f0f0; }

    .delBtn { width: 44px; padding: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .delBtn:hover { background: #ffecec; }
    .delBtn:disabled { opacity: .35; cursor: not-allowed; background: #fff; }

    #status { font-size: 12px; color: #666; margin-top: 6px; }
    .ok { color: #0a7; }
    .ng { color: #c33; }
    .sys { color: #666; font-size: 12px; margin: 4px 0; }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    #callBox{
      border: 1px solid #ccc;
      padding: 10px;
      background: #fafafa;
    }
    #callState { font-size: 12px; color:#444; margin-top: 6px; }

    #peopleBox {
      border: 1px solid #ccc;
      padding: 10px;
      background: #fff;
      margin-top: 10px;
    }
    #peopleList { margin-top: 8px; }
    .personRow{
      display:flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px;
      border: 1px solid #eee;
      margin: 6px 0;
      border-radius: 6px;
      background:#fafafa;
      font-size: 14px;
    }
    .pill {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color:#333;
      white-space: nowrap;
    }

    #chat {
      border: 1px solid #ccc;
      height: 360px;
      overflow: auto;
      padding: 8px;
      background: #fff;
      width: min(900px, 95vw);
    }

    .hint {
      font-size: 12px;
      color:#666;
      margin-top: 6px;
      line-height: 1.4;
    }

    details { margin-top: 10px; }
    #log {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      max-height: 180px;
      overflow: auto;
    }

    .roomBtn.calling {
      border-color: #8be3c8;
      background: #f1fffb;
    }
    .callMark {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #0a7;
      font-weight: 700;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <h2>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</h2>

  <!-- â˜…ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <b>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</b>
    <div class="hint">â€»ãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ã¨ä½¿ãˆã¾ã›ã‚“ï¼ˆRLSã§ä¿è­·ï¼‰</div>

    <div class="row" style="margin-top:8px;">
      <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:260px;" />
      <input id="pass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:260px;" />
    </div>
    <div class="row">
      <button onclick="signUp()">æ–°è¦ç™»éŒ²</button>
      <button onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button onclick="signOut()" id="signOutBtn" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="row" style="margin-top:8px;">
      <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆãƒãƒ£ãƒƒãƒˆåï¼‰" style="width:260px;" />
      <button onclick="saveDisplayName()" id="saveNameBtn" disabled>è¡¨ç¤ºåä¿å­˜</button>
    </div>

    <div class="hint" id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
  </div>

  <div>
    <input id="name" placeholder="åå‰ï¼ˆè‡ªå‹•ï¼‰" disabled /><br />
    <input id="room" placeholder="éƒ¨å±‹åï¼ˆä¾‹: testï¼‰" /><br />

    <button onclick="createRoom()" id="createRoomBtn" disabled>éƒ¨å±‹ä½œæˆ</button>
    <button onclick="join()" id="joinBtn" disabled>å…¥å®¤</button>
    <button onclick="leave()" id="leaveBtn" disabled>é€€å®¤</button>
    <button onclick="loadRooms()" id="reloadRoomsBtn" disabled>éƒ¨å±‹ä¸€è¦§æ›´æ–°</button>

    <div style="margin-top:10px;">
      <b>éƒ¨å±‹ä¸€è¦§ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰</b>
      <div id="roomsBox"></div>
      <div class="hint" id="roomHint">
        ãƒ»éƒ¨å±‹åã‚¯ãƒªãƒƒã‚¯ï¼šå…¥åŠ›æ¬„ã¸ / ãƒ»éƒ¨å±‹åãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šãã®éƒ¨å±‹ã«å…¥å®¤<br />
        ãƒ»ğŸ—‘ï¼šéƒ¨å±‹å‰Šé™¤ï¼ˆâ€»ãã®éƒ¨å±‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å‰Šé™¤ï¼‰<br />
        ãƒ»é€šè©±ã¯ã€Œå…¥å®¤ã€ã—ã¦ã‹ã‚‰ã€Œé€šè©±ã«å‚åŠ ï¼ˆé–‹å§‹ï¼‰ã€ã‚’æŠ¼ã—ã¦ã­
      </div>

      <details>
        <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆå›°ã£ãŸã‚‰ã“ã“ã‚’ã‚³ãƒ”ãƒšã—ã¦é€ã£ã¦ï¼‰</summary>
        <div id="log"></div>
      </details>
    </div>
  </div>

  <hr />

  <div id="status"></div>

  <div class="layout">
    <div>
      <div id="callBox">
        <b>ğŸ¤ éŸ³å£°é€šè©±ï¼ˆè¤‡æ•°äººï¼‰</b>
        <div style="margin-top:8px;">
          <button onclick="startVoice()" id="startVoiceBtn" disabled>é€šè©±ã«å‚åŠ ï¼ˆé–‹å§‹ï¼‰</button>
          <button onclick="toggleMute()" id="muteBtn" disabled>ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF</button>
          <button onclick="hangupAll()" id="hangupBtn" disabled>é€šè©±é€€å‡º</button>
        </div>
        <div id="callState">æœªæ¥ç¶šï¼ˆå…¥å®¤ã—ã¦ã‹ã‚‰ä½¿ã£ã¦ã­ï¼‰</div>
        <div id="audios" style="margin-top:8px;"></div>
      </div>

      <div id="peopleBox">
        <b>ğŸ‘¥ å‚åŠ è€…ï¼ˆé€šè©±ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰</b>
        <div class="hint">â€»ã€Œé€šè©±ã«å‚åŠ ã€ã‚’æŠ¼ã—ãŸäººãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆ</div>
        <div id="peopleList"></div>
      </div>
    </div>

    <div>
      <div id="chat"></div>
      <div style="margin-top:8px;">
        <input id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" disabled />
        <button onclick="send()" id="sendBtn" disabled>é€ä¿¡</button>
      </div>
    </div>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "")
);

/* =================== çŠ¶æ…‹ =================== */
let room = "";
let name = "";
let authUser = null;

let roomsChannel = null;
let messagesChannel = null;
const SYSTEM_NAME = "__system__";

let inCall = false;

/* â˜…é€šè©±ä¸­ã®éƒ¨å±‹æ¤œå‡ºï¼ˆcall_participants.updated_at ãŒæ–°ã—ã„éƒ¨å±‹ã ã‘ğŸ“ï¼‰ */
let activeCallRooms = new Set();
/* â˜…RLSå´ã® interval '30 seconds' ã¨åˆã‚ã›ã‚‹ */
const CALL_ALIVE_SEC = 30;

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[yururu]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

/* =================== è¡¨ç¤ºç³» =================== */
function setStatus(text, ok = true) {
  const el = document.getElementById("status");
  el.innerHTML = `<span class="${ok ? "ok" : "ng"}">${text}</span>`;
}
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/* =================== Auth =================== */
function setAuthUI() {
  const loggedIn = !!authUser;
  document.getElementById("signOutBtn").disabled = !loggedIn;
  document.getElementById("saveNameBtn").disabled = !loggedIn;

  document.getElementById("createRoomBtn").disabled = !loggedIn;
  document.getElementById("joinBtn").disabled = !loggedIn;
  document.getElementById("reloadRoomsBtn").disabled = !loggedIn;

  document.getElementById("leaveBtn").disabled = !loggedIn;
  document.getElementById("sendBtn").disabled = !loggedIn;
  document.getElementById("msg").disabled = !loggedIn;

  document.getElementById("name").disabled = true; // è‡ªå‹•
}

function setAuthStateText() {
  const el = document.getElementById("authState");
  if (!authUser) {
    el.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return;
  }
  const dn = (authUser.user_metadata && authUser.user_metadata.display_name) || "";
  el.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${authUser.email}${dn ? " / è¡¨ç¤ºå: " + dn : ""}`;
}

async function reloadSession() {
  const { data, error } = await sb.auth.getSession();
  if (error) log("getSession error", error);

  authUser = data?.session?.user || null;
  name = (authUser?.user_metadata?.display_name || "").trim();

  if (authUser && !name) {
    // è¡¨ç¤ºåãŒç„¡ã„ãªã‚‰ email ã®å‰åŠã‚’ä»®åã«
    name = (authUser.email || "user").split("@")[0];
  }
  document.getElementById("name").value = name || "";
  document.getElementById("displayName").value = (authUser?.user_metadata?.display_name || "");

  setAuthUI();
  setAuthStateText();
}

async function signUp() {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value.trim();
  if (!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦ã­ï¼");

  const { error } = await sb.auth.signUp({ email, password: pass });
  if (error) {
    log("signUp error", error);
    alert("æ–°è¦ç™»éŒ²å¤±æ•—: " + error.message);
    return;
  }
  alert("æ–°è¦ç™»éŒ²OKï¼ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªè¨­å®šã®å ´åˆã¯ãƒ¡ãƒ¼ãƒ«ã‚‚è¦‹ã¦ã­ï¼");
  await reloadSession();
  await loadRooms();
}

async function signIn() {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value.trim();
  if (!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦ã­ï¼");

  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) {
    log("signIn error", error);
    alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
    return;
  }
  alert("ãƒ­ã‚°ã‚¤ãƒ³OKï¼");
  await reloadSession();
  await loadRooms();
  await startRealtime();
}

async function signOut() {
  await hangupAll();
  room = "";
  document.getElementById("chat").innerHTML = "";
  renderPeople([]);

  const { error } = await sb.auth.signOut();
  if (error) log("signOut error", error);

  authUser = null;
  name = "";
  document.getElementById("name").value = "";

  setAuthUI();
  setAuthStateText();
  setStatus("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
}

async function saveDisplayName() {
  if (!authUser) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return alert("è¡¨ç¤ºåã‚’å…¥ã‚Œã¦ã­ï¼");

  const { error } = await sb.auth.updateUser({
    data: { display_name: dn }
  });
  if (error) {
    log("updateUser error", error);
    alert("è¡¨ç¤ºåä¿å­˜å¤±æ•—: " + error.message);
    return;
  }
  alert("è¡¨ç¤ºåä¿å­˜OKï¼");
  await reloadSession();
}

/* =================== ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚» =================== */
async function sendSystem(text) {
  if (!room) return;
  if (!authUser) return;

  const { error } = await sb.from("messages").insert({
    room_id: room,
    user_id: authUser.id,
    name: SYSTEM_NAME,
    message: text
  });
  if (error) log("sendSystem error", error);
}

/* =================== é€šè©±ä¸­éƒ¨å±‹ä¸€è¦§ã®æ›´æ–° =================== */
async function refreshActiveCallRooms() {
  if (!authUser) return;

  const since = new Date(Date.now() - CALL_ALIVE_SEC * 1000).toISOString();
  const { data, error } = await sb
    .from("call_participants")
    .select("room_id, updated_at")
    .gte("updated_at", since);

  if (error) {
    log("refreshActiveCallRooms error", error);
    activeCallRooms = null;
    setStatus("é€šè©±çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ï¼ˆå®‰å…¨ã®ãŸã‚å‰Šé™¤ãƒ­ãƒƒã‚¯ï¼‰: " + error.message, false);
    updateRoomDeleteButtons();
    return;
  }

  const s = new Set();
  (data || []).forEach(r => s.add(r.room_id));
  activeCallRooms = s;
  updateRoomDeleteButtons();
}

/* =================== UIçŠ¶æ…‹æ›´æ–° =================== */
function setButtonsState() {
  const joined = !!(room && name && authUser);

  document.getElementById("startVoiceBtn").disabled = !joined;
  document.getElementById("hangupBtn").disabled = !joined;
  document.getElementById("muteBtn").disabled = !(joined && localStream);

  document.getElementById("leaveBtn").disabled = !authUser;
  document.getElementById("sendBtn").disabled = !authUser;
  document.getElementById("msg").disabled = !authUser;

  updateRoomDeleteButtons();
  updateRoomHint();
}

function updateRoomHint(){
  const el = document.getElementById("roomHint");
  if (!el) return;

  if (!authUser) {
    el.innerHTML = "ğŸ” ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­";
    return;
  }

  if (activeCallRooms === null) {
    el.innerHTML =
      "âš ï¸ é€šè©±çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ä¸­ï¼šå®‰å…¨ã®ãŸã‚éƒ¨å±‹å‰Šé™¤ã¯ãƒ­ãƒƒã‚¯ä¸­<br />" +
      "ãƒ»RLSãƒãƒªã‚·ãƒ¼ / ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã‚’ç¢ºèªã—ã¦ã­";
    return;
  }

  if (inCall) {
    el.innerHTML =
      "âœ… ã‚ãªãŸã¯é€šè©±ä¸­ï¼šéƒ¨å±‹å‰Šé™¤ã¯ãƒ­ãƒƒã‚¯ä¸­ï¼ˆå…ˆã«ã€Œé€šè©±é€€å‡ºã€ã—ã¦ã­ï¼‰<br />" +
      "ãƒ»éƒ¨å±‹åã‚¯ãƒªãƒƒã‚¯ï¼šå…¥åŠ›æ¬„ã¸ / ãƒ»éƒ¨å±‹åãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šãã®éƒ¨å±‹ã«å…¥å®¤<br />" +
      "ãƒ»ğŸ—‘ï¼šé€šè©±ä¸­ã®éƒ¨å±‹ã¯å‰Šé™¤ã§ããªã„ï¼ˆèª°ã‹ãŒé€šè©±ã—ã¦ãŸã‚‰NGï¼‰";
  } else {
    el.innerHTML =
      "ãƒ»éƒ¨å±‹åã‚¯ãƒªãƒƒã‚¯ï¼šå…¥åŠ›æ¬„ã¸ / ãƒ»éƒ¨å±‹åãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šãã®éƒ¨å±‹ã«å…¥å®¤<br />" +
      "ãƒ»ğŸ—‘ï¼šé€šè©±ä¸­ã®éƒ¨å±‹ã¯å‰Šé™¤ã§ããªã„ï¼ˆèª°ã‹ãŒé€šè©±ã—ã¦ãŸã‚‰NGï¼‰<br />" +
      "ãƒ»é€šè©±ã¯ã€Œå…¥å®¤ã€ã—ã¦ã‹ã‚‰ã€Œé€šè©±ã«å‚åŠ ï¼ˆé–‹å§‹ï¼‰ã€ã‚’æŠ¼ã—ã¦ã­";
  }
}

function isRoomLocked(rn){
  if (activeCallRooms === null) return true;
  return inCall || activeCallRooms.has(rn);
}

function updateRoomDeleteButtons(){
  const box = document.getElementById("roomsBox");
  if (!box) return;

  const rows = box.querySelectorAll(".roomRow");
  rows.forEach(row => {
    const btn = row.querySelector("button.roomBtn");
    const del = row.querySelector("button.delBtn");
    if (!btn || !del) return;

    const rn = btn.dataset.room || btn.textContent;
    const locked = !authUser ? true : isRoomLocked(rn);

    del.disabled = locked;
    del.title = locked
      ? (!authUser ? "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­"
         : activeCallRooms === null ? "é€šè©±çŠ¶æ…‹ã®å–å¾—å¤±æ•—ä¸­ï¼ˆå®‰å…¨ãƒ­ãƒƒã‚¯ï¼‰"
         : inCall ? "ã‚ãªãŸãŒé€šè©±ä¸­ãªã®ã§å‰Šé™¤ã§ãã¾ã›ã‚“ï¼ˆé€šè©±é€€å‡ºã—ã¦ã­ï¼‰"
         : "ã“ã®éƒ¨å±‹ã¯èª°ã‹ãŒé€šè©±ä¸­ãªã®ã§å‰Šé™¤ã§ãã¾ã›ã‚“")
      : "éƒ¨å±‹å‰Šé™¤";

    const calling = (activeCallRooms instanceof Set) && activeCallRooms.has(rn);
    btn.classList.toggle("calling", calling);
  });
}

/* =================== Realtimeï¼ˆéƒ¨å±‹/ãƒ¡ãƒƒã‚»ï¼‰ =================== */
async function startRealtime() {
  if (!authUser) return;
  if (roomsChannel || messagesChannel) return;

  roomsChannel = sb
    .channel("rooms-ch")
    .on("postgres_changes", { event: "*", schema: "public", table: "rooms" }, async () => {
      await loadRooms();
    })
    .subscribe();

  messagesChannel = sb
    .channel("messages-ch")
    .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, async (payload) => {
      if (!room) return;
      const newRow = payload.new || {};
      const oldRow = payload.old || {};
      const rid = newRow.room_id || oldRow.room_id;
      if (rid === room) await loadMessages();
    })
    .subscribe();

  setStatus("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šOK");
}

/* =================== éƒ¨å±‹ä¸€è¦§ =================== */
async function loadRooms() {
  if (!authUser) {
    document.getElementById("roomsBox").innerHTML = "<div>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­</div>";
    return;
  }

  await refreshActiveCallRooms();

  let res = await sb.from("rooms")
    .select("room_name, created_at")
    .order("created_at", { ascending: true });

  if (res.e
