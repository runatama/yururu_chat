<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - ãƒ­ã‚°ã‚¤ãƒ³</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: sans-serif; padding: 16px; max-width: 760px; margin: 0 auto; }
    h2 { margin: 6px 0 14px; }
    input { width: 340px; padding: 10px; margin: 6px 0; box-sizing: border-box; }
    button { padding: 10px 12px; margin: 6px 6px 6px 0; cursor: pointer; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .card { border: 1px solid #ccc; background: #fafafa; padding: 14px; border-radius: 12px; margin: 12px 0; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }

    .hint { font-size: 12px; color:#666; line-height: 1.5; }
    .ok { color:#0a7; }
    .ng { color:#c33; }

    .modeBtns { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .modeBtn{
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      min-width: 160px;
      text-align:left;
      cursor:pointer;
    }
    .modeBtn:hover{ background:#f3f3f3; }
    .modeBtn.active{
      border-color:#8be3c8;
      background:#f1fffb;
    }
    .modeTitle{ font-weight: 800; display:block; margin-bottom: 4px; }
    .modeDesc{ font-size: 12px; color:#666; }

    .topActions { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .pill {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color:#333;
      white-space: nowrap;
    }

    details { margin-top: 10px; }
    #log {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      max-height: 220px;
      overflow: auto;
    }

    .danger {
      border-color: #ffb3b3 !important;
      background: #fff3f3 !important;
    }
  </style>
</head>

<body>
  <div class="topActions">
    <h2 style="margin:0;">ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</h2>
    <span class="pill" id="authPill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
  </div>

  <!-- æœ€åˆã®é¸æŠç”»é¢ -->
  <div class="card">
    <b>ã¯ã˜ã‚ã«é¸ã‚“ã§ã­</b>
    <div class="hint">ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‹ã€Œæ–°è¦ç™»éŒ²ã€ã©ã£ã¡ã‚’ã™ã‚‹ï¼Ÿ</div>

    <div class="modeBtns">
      <div class="modeBtn" id="btnModeSignIn" onclick="setMode('signin')">
        <span class="modeTitle">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</span>
        <span class="modeDesc">ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹äºº</span>
      </div>

      <div class="modeBtn" id="btnModeSignUp" onclick="setMode('signup')">
        <span class="modeTitle">ğŸ†• æ–°è¦ç™»éŒ²</span>
        <span class="modeDesc">ã¯ã˜ã‚ã¦ä½¿ã†äººï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã“ã¨ã‚ã‚Šï¼‰</span>
      </div>
    </div>

    <hr style="margin:12px 0;" />

    <!-- â˜… Googleãƒ­ã‚°ã‚¤ãƒ³è¿½åŠ  -->
    <button onclick="signInWithGoogle()">
      ğŸ”µ Googleã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>

    <div class="hint">
      Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãã®ã¾ã¾å…¥ã‚Œã¾ã™
    </div>

    <div class="hint" style="margin-top:8px;">
      â€»ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„æ™‚ã¯ã€ç”»é¢ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’é€ã£ã¦ã­
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" id="formCard" style="display:none;">
    <b id="formTitle">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</b>
    <div class="hint" id="formHint">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã™ã‚‹ã‚ˆ</div>

    <div class="row" style="margin-top:10px;">
      <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="email" />
      <input id="pass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" />
    </div>

    <div class="row">
      <button onclick="doPrimary()" id="primaryBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button onclick="resetMode()">æˆ»ã‚‹</button>
      <button onclick="signOut()" id="signOutBtn" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="hint" id="status">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

    <details>
      <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
      <div id="log"></div>
    </details>
  </div>

  <!-- è¡¨ç¤ºå -->
  <div class="card" id="nameCard" style="display:none;">
    <b>ğŸªª è¡¨ç¤ºå</b>
    <div class="row">
      <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" />
      <button onclick="saveDisplayName()">ä¿å­˜</button>
      <button onclick="gotoMain()">ãƒ¡ã‚¤ãƒ³ã¸</button>
    </div>

    <div class="hint" id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =================== çŠ¶æ…‹ =================== */
let authUser = null;
let mode = null;

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const el = document.getElementById("log");
  const s = args.join(" ");
  console.log("[login]", s);
  if(el){ el.textContent += s + "\n"; }
}

/* =================== Googleãƒ­ã‚°ã‚¤ãƒ³ =================== */
async function signInWithGoogle(){
  const { error } = await sb.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: location.origin + "/login.html"
    }
  });
  if(error){
    alert("Googleãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
    log(error);
  }
}

/* =================== UI =================== */
function setMode(next){
  mode = next;
  document.getElementById("formCard").style.display = "block";
}
function resetMode(){
  mode = null;
  document.getElementById("formCard").style.display = "none";
}

/* =================== Auth =================== */
async function doPrimary(){
  if(mode === "signin") return signIn();
  if(mode === "signup") return signUp();
}

async function signUp(){
  const email = emailEl();
  const pass = passEl();
  const { error } = await sb.auth.signUp({ email, password: pass });
  if(error) alert(error.message);
}

async function signIn(){
  const email = emailEl();
  const pass = passEl();
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if(error) return alert(error.message);
  gotoMain();
}

async function signOut(){
  await sb.auth.signOut();
  location.reload();
}

async function saveDisplayName(){
  const dn = document.getElementById("displayName").value.trim();
  if(!dn) return;
  await sb.auth.updateUser({ data:{ display_name: dn } });
  gotoMain();
}

/* =================== ã‚»ãƒƒã‚·ãƒ§ãƒ³ =================== */
async function reloadSession(){
  const { data } = await sb.auth.getSession();
  authUser = data?.session?.user || null;
}

/* =================== ç§»å‹• =================== */
function gotoMain(){
  location.replace("./lobby.html");
}

/* =================== util =================== */
const emailEl = ()=>document.getElementById("email").value.trim();
const passEl  = ()=>document.getElementById("pass").value;

/* =================== èµ·å‹• =================== */
reloadSession();
</script>
</body>
</html>

