<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - ãƒ­ã‚°ã‚¤ãƒ³</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: sans-serif; padding: 16px; max-width: 760px; margin: 0 auto; }
    h2 { margin: 6px 0 14px; }
    input { width: 340px; padding: 10px; margin: 6px 0; box-sizing: border-box; }
    button { padding: 10px 12px; margin: 6px 6px 6px 0; cursor: pointer; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .card { border: 1px solid #ccc; background: #fafafa; padding: 14px; border-radius: 12px; margin: 12px 0; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }

    .hint { font-size: 12px; color:#666; line-height: 1.5; }
    .ok { color:#0a7; }
    .ng { color:#c33; }

    .modeBtns { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .modeBtn{
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      min-width: 160px;
      text-align:left;
      cursor:pointer;
    }
    .modeBtn:hover{ background:#f3f3f3; }
    .modeBtn.active{
      border-color:#8be3c8;
      background:#f1fffb;
    }
    .modeTitle{ font-weight: 800; display:block; margin-bottom: 4px; }
    .modeDesc{ font-size: 12px; color:#666; }

    .topActions { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .pill {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color:#333;
      white-space: nowrap;
    }

    details { margin-top: 10px; }
    #log {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      max-height: 220px;
      overflow: auto;
    }

    .danger {
      border-color: #ffb3b3 !important;
      background: #fff3f3 !important;
    }
  </style>
</head>
<body>
  <div class="topActions">
    <h2 style="margin:0;">ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</h2>
    <span class="pill" id="authPill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
  </div>

  <!-- æœ€åˆã®é¸æŠç”»é¢ -->
  <div class="card">
    <b>ã¯ã˜ã‚ã«é¸ã‚“ã§ã­</b>
    <div class="hint">ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‹ã€Œæ–°è¦ç™»éŒ²ã€ã©ã£ã¡ã‚’ã™ã‚‹ï¼Ÿ</div>

    <div class="modeBtns">
      <div class="modeBtn" id="btnModeSignIn" onclick="setMode('signin')">
        <span class="modeTitle">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</span>
        <span class="modeDesc">ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹äºº</span>
      </div>

      <div class="modeBtn" id="btnModeSignUp" onclick="setMode('signup')">
        <span class="modeTitle">ğŸ†• æ–°è¦ç™»éŒ²</span>
        <span class="modeDesc">ã¯ã˜ã‚ã¦ä½¿ã†äººï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã“ã¨ã‚ã‚Šï¼‰</span>
      </div>
    </div>

    <div class="hint" style="margin-top:8px;">
      â€»ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„æ™‚ã¯ã€ç”»é¢ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’é€ã£ã¦ã­
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆé¸ã‚“ã ã¨ãã ã‘è¡¨ç¤ºï¼‰ -->
  <div class="card" id="formCard" style="display:none;">
    <b id="formTitle">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</b>
    <div class="hint" id="formHint">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã™ã‚‹ã‚ˆ</div>

    <div class="row" style="margin-top:10px;">
      <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="email" />
      <input id="pass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" />
    </div>

    <div class="row">
      <button onclick="doPrimary()" id="primaryBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button onclick="resetMode()">æˆ»ã‚‹</button>
      <button onclick="signOut()" id="signOutBtn" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="hint" id="status">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

    <details>
      <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆå›°ã£ãŸã‚‰ã“ã“ã‚’ã‚³ãƒ”ãƒšã—ã¦é€ã£ã¦ï¼‰</summary>
      <div id="log"></div>
    </details>
  </div>

  <!-- è¡¨ç¤ºåï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã ã‘ä½¿ãˆã‚‹ï¼‰ -->
  <div class="card" id="nameCard" style="display:none;">
    <b>ğŸªª è¡¨ç¤ºåï¼ˆãƒãƒ£ãƒƒãƒˆåï¼‰</b>
    <div class="hint">ã“ã“ã§è¨­å®šã—ãŸè¡¨ç¤ºåãŒã€ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å³ä¸Šã«å‡ºã‚‹ã‚ˆ</div>

    <div class="row" style="margin-top:8px;">
      <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" autocomplete="nickname" />
      <button onclick="saveDisplayName()" id="saveNameBtn">è¡¨ç¤ºåä¿å­˜</button>
      <button onclick="gotoMain()">ãƒ¡ã‚¤ãƒ³ã¸</button>
    </div>

    <div class="hint" id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

    <hr style="margin:14px 0;" />

    <!-- âœ… è¿½åŠ ï¼šã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ -->
    <b>âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</b>
    <div class="hint">
      ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚<br>
      ã€Œè‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€è‡ªä½“ã‚’Supabase Authã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚<br>
      â€»å‰Šé™¤ã«ã¯ã‚µãƒ¼ãƒå´ï¼ˆEdge Functionï¼‰ãŒå¿…è¦ã§ã™ï¼ˆä¸‹ã«å®Ÿè£…ã‚ã‚Šï¼‰
    </div>

    <div class="row" style="margin-top:8px;">
      <button onclick="deleteAccount()" id="deleteAccountBtn" class="danger">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "")
);

/* =================== çŠ¶æ…‹ =================== */
let authUser = null;
let mode = null; // 'signin' | 'signup' | null

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[login]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok = true) {
  const el = document.getElementById("status");
  el.className = "hint " + (ok ? "ok" : "ng");
  el.textContent = text;
}

function showAuthError(prefix, error) {
  if (!error) return;
  log(prefix, error);
  const full =
    (error.message || "") +
    (error.status ? ` (status:${error.status})` : "") +
    (error.code ? ` (code:${error.code})` : "");
  alert(prefix + ": " + full);
  setStatus(prefix + ": " + full, false);
}

/* =================== UIï¼šãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ =================== */
function setMode(next){
  mode = next;

  document.getElementById("btnModeSignIn").classList.toggle("active", mode === "signin");
  document.getElementById("btnModeSignUp").classList.toggle("active", mode === "signup");

  const formCard = document.getElementById("formCard");
  formCard.style.display = "block";

  const title = document.getElementById("formTitle");
  const hint = document.getElementById("formHint");
  const primaryBtn = document.getElementById("primaryBtn");

  if (mode === "signin") {
    title.textContent = "ğŸ” ãƒ­ã‚°ã‚¤ãƒ³";
    hint.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã™ã‚‹ã‚ˆ";
    primaryBtn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
    document.getElementById("pass").placeholder = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰";
    document.getElementById("pass").autocomplete = "current-password";
  } else {
    title.textContent = "ğŸ†• æ–°è¦ç™»éŒ²";
    hint.textContent = "æ–°è¦ç™»éŒ² â†’ï¼ˆå¿…è¦ãªã‚‰ï¼‰ãƒ¡ãƒ¼ãƒ«ç¢ºèª â†’ ãƒ­ã‚°ã‚¤ãƒ³ã€ã®æµã‚Œã ã‚ˆ";
    primaryBtn.textContent = "æ–°è¦ç™»éŒ²";
    document.getElementById("pass").placeholder = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Š / æ¨å¥¨8ä»¥ä¸Šï¼‰";
    document.getElementById("pass").autocomplete = "new-password";
  }

  document.getElementById("email").focus();
}

function resetMode(){
  mode = null;
  document.getElementById("btnModeSignIn").classList.remove("active");
  document.getElementById("btnModeSignUp").classList.remove("active");
  document.getElementById("formCard").style.display = "none";
}

/* =================== ãƒ¡ã‚¤ãƒ³ã¸ =================== */
function gotoMain(){
  const u = new URL("./lobby.html", location.href);
  u.searchParams.set("_r", String(Date.now()));

  // âœ… ã‚¹ãƒãƒ›å¯¾ç­–ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚’å¾…ã¤
  setTimeout(() => {
    location.replace(u.toString());
  }, 500); // 300ã€œ500ms æ¨å¥¨
}



/* =================== ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º =================== */
function setAuthPill(){
  const pill = document.getElementById("authPill");
  if (!authUser) {
    pill.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return;
  }
  const dn = (authUser.user_metadata?.display_name || "").trim();
  pill.textContent = dn ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${dn}` : `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${authUser.email}`;
}

function setAuthStateText() {
  const el = document.getElementById("authState");
  if (!authUser) { el.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³"; return; }
  const dn = (authUser.user_metadata && authUser.user_metadata.display_name) || "";
  el.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${authUser.email}${dn ? " / è¡¨ç¤ºå: " + dn : ""}`;
}

function setLoggedInUI(){
  const loggedIn = !!authUser;
  document.getElementById("signOutBtn").disabled = !loggedIn;

  document.getElementById("nameCard").style.display = loggedIn ? "block" : "none";
  if (loggedIn) {
    document.getElementById("displayName").value = (authUser?.user_metadata?.display_name || "");
  }
  setAuthPill();
  setAuthStateText();
}

/* =================== èµ·å‹•/ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾— =================== */
async function reloadSession() {
  const { data, error } = await sb.auth.getSession();
  if (error) log("getSession error", error);

  authUser = data?.session?.user || null;
  setLoggedInUI();

  if (authUser) {
    setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šãƒ¡ã‚¤ãƒ³ã¸è¡Œã‘ã¾ã™", true);
  } else {
    setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šã¾ãšãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­", true);
  }
}

/* =================== ãƒœã‚¿ãƒ³ï¼šãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ï¼ˆå…±é€šï¼‰ =================== */
async function doPrimary(){
  if (mode === "signin") return await signIn();
  if (mode === "signup") return await signUp();
  alert("ã¾ãšã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‹ã€Œæ–°è¦ç™»éŒ²ã€ã‚’é¸ã‚“ã§ã­ï¼");
}

/* =================== Authæ“ä½œ =================== */
async function signUp() {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value;

  if (!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦ã­ï¼");
  if (pass.length < 6) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŸ­ã™ãï¼6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ã­ï¼ˆæ¨å¥¨8æ–‡å­—ä»¥ä¸Šï¼‰");

  const { data, error } = await sb.auth.signUp({
    email,
    password: pass,
    options: {
      emailRedirectTo: location.origin + "/login.html"
    }
  });

  if (error) { showAuthError("æ–°è¦ç™»éŒ²å¤±æ•—", error); return; }

  log("signUp data", data);
  alert("æ–°è¦ç™»éŒ²OKï¼ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  await reloadSession();

  if (!authUser) {
    setMode("signin");
    setStatus("ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰å…ˆã«ç¢ºèª â†’ ãã®å¾Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­", true);
  }
}


  if (error) { showAuthError("æ–°è¦ç™»éŒ²å¤±æ•—", error); return; }

  log("signUp data", data);
  alert("æ–°è¦ç™»éŒ²OKï¼ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  await reloadSession();

  if (!authUser) {
    setMode("signin");
    setStatus("ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰å…ˆã«ç¢ºèª â†’ ãã®å¾Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­", true);
  }
}


  if (error) { showAuthError("æ–°è¦ç™»éŒ²å¤±æ•—", error); return; }

  log("signUp data", data);
  alert("æ–°è¦ç™»éŒ²OKï¼ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  await reloadSession();

  if (!authUser) {
    setMode("signin");
    setStatus("ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰å…ˆã«ç¢ºèª â†’ ãã®å¾Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­", true);
  }
}

async function signIn() {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value;

  if (!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦ã­ï¼");

  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { showAuthError("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—", error); return; }

  log("signIn data", data);
  alert("ãƒ­ã‚°ã‚¤ãƒ³OKï¼ãƒ¡ã‚¤ãƒ³ã¸ç§»å‹•ã™ã‚‹ã‚ˆï¼");
  await reloadSession();
  gotoMain();
}

async function signOut() {
  const { error } = await sb.auth.signOut({ scope: "local" });
  if (error) log("signOut error", error);
  authUser = null;
  setLoggedInUI();
  setStatus("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ", true);
}

/* =================== è¡¨ç¤ºåä¿å­˜ =================== */
async function saveDisplayName() {
  if (!authUser) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return alert("è¡¨ç¤ºåã‚’å…¥ã‚Œã¦ã­ï¼");

  const btn = document.getElementById("saveNameBtn");
  if (btn) btn.disabled = true;

  try {
    const { error } = await sb.auth.updateUser({ data: { display_name: dn } });
    if (error) { showAuthError("è¡¨ç¤ºåä¿å­˜å¤±æ•—", error); return; }

    alert("è¡¨ç¤ºåä¿å­˜OKï¼");
    await reloadSession();
  } finally {
    if (btn) btn.disabled = false;
  }
}

/* =========================================================
   âœ… è¿½åŠ ï¼šã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆEdge FunctionçµŒç”±ï¼‰
   =========================================================
   - ãƒ•ãƒ­ãƒ³ãƒˆã ã‘ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¯ä¸å¯ï¼ˆService RoleãŒå¿…è¦ï¼‰
   - Edge Function /functions/v1/delete-me ã‚’ä½œã£ã¦å‘¼ã³å‡ºã™
   ========================================================= */
async function deleteAccount(){
  if (!authUser) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");

  // â‘  æœ€çµ‚ç¢ºèªï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
  const ok1 = confirm("æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚");
  if (!ok1) return;

  // â‘¡ æ–‡å­—å…¥åŠ›ç¢ºèªï¼ˆã•ã‚‰ã«èª¤çˆ†é˜²æ­¢ï¼‰
  const code = prompt("ç¢ºèªã®ãŸã‚ã€ŒDELETEã€ã¨å…¥åŠ›ã—ã¦ã­ï¼ˆå¤§æ–‡å­—ï¼‰");
  if (code !== "DELETE") {
    alert("ä¸­æ­¢ã—ã¾ã—ãŸï¼ˆDELETEã¨ä¸€è‡´ã—ã¾ã›ã‚“ï¼‰");
    return;
  }

  const btn = document.getElementById("deleteAccountBtn");
  if (btn) btn.disabled = true;

  try {
    // JWTå–å¾—ï¼ˆEdge Functionã§æœ¬äººç¢ºèªã«ä½¿ã†ï¼‰
    const { data: sessData, error: sessErr } = await sb.auth.getSession();
    if (sessErr) log("getSession error(deleteAccount)", sessErr);

    const accessToken = sessData?.session?.access_token;
    if (!accessToken) {
      alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã„ã£ãŸã‚“ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã­ã€‚");
      return;
    }

    setStatus("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­â€¦", true);

    // Edge Function å‘¼ã³å‡ºã—
    const res = await fetch(`${SUPABASE_URL}/functions/v1/delete-me`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${accessToken}`
      },
      body: JSON.stringify({ confirm: true })
    });

    const text = await res.text();
    log("delete-me response", res.status, text);

    if (!res.ok) {
      alert("å‰Šé™¤å¤±æ•—: " + res.status + "\n" + text);
      setStatus("å‰Šé™¤å¤±æ•—: " + res.status, false);
      return;
    }

    alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚");

    // å¿µã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    try { await sb.auth.signOut({ scope: "local" }); } catch {}
    authUser = null;
    setLoggedInUI();

    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæ®‹éª¸é˜²æ­¢ï¼‰
    location.replace("./login.html?_r=" + Date.now());
  } catch (e) {
    log("deleteAccount exception", e);
    alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
    setStatus("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼", false);
  } finally {
    if (btn) btn.disabled = false;
  }
}

/* èµ·å‹•æ™‚ */
(async () => {
  await reloadSession();

  // âœ… è¿½åŠ ï¼šãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒªãƒ³ã‚¯ã§æˆ»ã£ã¦ããŸã£ã½ã„æ™‚ã¯è‡ªå‹•ã§ãƒ­ãƒ“ãƒ¼ã¸
  // ï¼ˆURLã« code / access_token / type ãªã©ãŒä»˜ãã‚±ãƒ¼ã‚¹ãŒå¤šã„ï¼‰
  const url = new URL(location.href);
  const hasAuthParams =
    url.searchParams.has("code") ||
    url.searchParams.has("type") ||
    url.searchParams.has("access_token") ||
    url.searchParams.has("refresh_token") ||
    url.searchParams.has("token");

  if (authUser && hasAuthParams) {
    gotoMain(); // lobby.html ã¸
    return;
  }

  // âœ… è¿½åŠ ï¼šãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒç¢ºå®šã—ãŸç¬é–“ã«ï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªç›´å¾Œå«ã‚€ï¼‰è‡ªå‹•ã§ãƒ­ãƒ“ãƒ¼ã¸
  sb.auth.onAuthStateChange(async () => {
    await reloadSession();
    const u2 = new URL(location.href);
    const hasAuthParams2 =
      u2.searchParams.has("code") ||
      u2.searchParams.has("type") ||
      u2.searchParams.has("access_token") ||
      u2.searchParams.has("refresh_token") ||
      u2.searchParams.has("token");

    if (authUser && hasAuthParams2) {
      gotoMain();
    }
  });

  log("ready. authUser=", authUser?.id || null);
})();

</script>
</body>
</html>





