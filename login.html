<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ - ãƒ­ã‚°ã‚¤ãƒ³</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: sans-serif; padding: 16px; max-width: 720px; margin: 0 auto; }
    h2 { margin: 8px 0 16px; }
    input { width: 320px; padding: 10px; margin: 6px 0; box-sizing: border-box; }
    button { padding: 10px 12px; margin: 6px 4px 6px 0; cursor: pointer; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .card { border: 1px solid #ccc; background: #fafafa; padding: 14px; border-radius: 12px; margin: 12px 0; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .hint { font-size: 12px; color:#666; line-height: 1.5; }
    .ok { color:#0a7; }
    .ng { color:#c33; }
    details { margin-top: 10px; }
    #log {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      max-height: 200px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h2>ã‚†ã‚‹ã‚‹ãƒãƒ£ãƒƒãƒˆ</h2>

  <div class="card">
    <b>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</b>
    <div class="hint">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹ã‚ˆï¼ˆRLSä¿è­·ï¼‰</div>

    <div class="row" style="margin-top:10px;">
      <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="email" />
      <input id="pass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" />
    </div>

    <div class="row">
      <button onclick="signUp()">æ–°è¦ç™»éŒ²</button>
      <button onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button onclick="signOut()" id="signOutBtn" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="card" style="margin-top:10px;">
      <b>ğŸªª è¡¨ç¤ºåï¼ˆãƒãƒ£ãƒƒãƒˆåï¼‰</b>
      <div class="hint">ã“ã“ã§è¨­å®šã—ãŸè¡¨ç¤ºåãŒã€ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å³ä¸Šã«å‡ºã‚‹ã‚ˆ</div>
      <div class="row" style="margin-top:8px;">
        <input id="displayName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: ã‚†ã‚‹ãŸã¾ï¼‰" autocomplete="nickname" />
        <button onclick="saveDisplayName()" id="saveNameBtn" disabled>è¡¨ç¤ºåä¿å­˜</button>
      </div>
      <div class="hint" id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
    </div>

    <div class="hint" id="status">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

    <details>
      <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆå›°ã£ãŸã‚‰ã“ã“ã‚’ã‚³ãƒ”ãƒšã—ã¦é€ã£ã¦ï¼‰</summary>
      <div id="log"></div>
    </details>
  </div>

<script>
/* =================== Supabase è¨­å®š =================== */
const SUPABASE_URL = "https://gqqkjytefyllfomtqcqd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcWtqeXRlZnlsbGZvbXRxY3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDM2NDAsImV4cCI6MjA4MjQxOTY0MH0.ve2TXRWgqGK_KT1i_ZjvCBf6wOxNjp127xeQgC3tjWM";

const sb = supabase.createClient(
  SUPABASE_URL.trim(),
  (SUPABASE_KEY || "").replace(/\s+/g, "")
);

/* =================== ãƒ­ã‚° =================== */
function log(...args){
  const s = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
  console.log("[login]", ...args);
  const el = document.getElementById("log");
  if (!el) return;
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}
window.addEventListener("error", (e)=>log("JS ERROR:", e.message));
window.addEventListener("unhandledrejection", (e)=>log("PROMISE ERROR:", e.reason));

function setStatus(text, ok = true) {
  const el = document.getElementById("status");
  el.className = "hint " + (ok ? "ok" : "ng");
  el.textContent = text;
}

function showAuthError(prefix, error) {
  if (!error) return;
  log(prefix, error);
  const full =
    (error.message || "") +
    (error.status ? ` (status:${error.status})` : "") +
    (error.code ? ` (code:${error.code})` : "");
  alert(prefix + ": " + full);
  setStatus(prefix + ": " + full, false);
}

let authUser = null;

function setAuthUI() {
  const loggedIn = !!authUser;
  document.getElementById("signOutBtn").disabled = !loggedIn;
  document.getElementById("saveNameBtn").disabled = !loggedIn;
}

function setAuthStateText() {
  const el = document.getElementById("authState");
  if (!authUser) { el.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³"; return; }
  const dn = (authUser.user_metadata && authUser.user_metadata.display_name) || "";
  el.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${authUser.email}${dn ? " / è¡¨ç¤ºå: " + dn : ""}`;
}

async function reloadSession() {
  const { data, error } = await sb.auth.getSession();
  if (error) log("getSession error", error);

  authUser = data?.session?.user || null;
  document.getElementById("displayName").value = (authUser?.user_metadata?.display_name || "");

  setAuthUI();
  setAuthStateText();

  if (authUser) setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šãƒ¡ã‚¤ãƒ³ã¸è¡Œã‘ã¾ã™", true);
  else setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³", true);
}

function gotoMain() {
  location.href = "./index.html";
}

/* =================== Authæ“ä½œ =================== */
async function signUp() {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value;
  if (!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦ã­ï¼");
  if (pass.length < 6) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŸ­ã™ãï¼6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ã­ï¼ˆæ¨å¥¨8æ–‡å­—ä»¥ä¸Šï¼‰");

  const { data, error } = await sb.auth.signUp({
    email,
    password: pass,
    options: {
      emailRedirectTo: "https://yururu-chat.pages.dev"
    }
  });

  if (error) { showAuthError("æ–°è¦ç™»éŒ²å¤±æ•—", error); return; }

  log("signUp data", data);
  alert("æ–°è¦ç™»éŒ²OKï¼ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  await reloadSession();
}

async function signIn() {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value;
  if (!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦ã­ï¼");

  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { showAuthError("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—", error); return; }

  log("signIn data", data);
  alert("ãƒ­ã‚°ã‚¤ãƒ³OKï¼ãƒ¡ã‚¤ãƒ³ã¸ç§»å‹•ã™ã‚‹ã‚ˆï¼");
  await reloadSession();
  gotoMain();
}

async function signOut() {
  const { error } = await sb.auth.signOut();
  if (error) log("signOut error", error);
  authUser = null;
  setAuthUI();
  setAuthStateText();
  setStatus("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ", true);
}

async function saveDisplayName() {
  if (!authUser) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼");
  const dn = document.getElementById("displayName").value.trim();
  if (!dn) return alert("è¡¨ç¤ºåã‚’å…¥ã‚Œã¦ã­ï¼");

  const { error } = await sb.auth.updateUser({ data: { display_name: dn } });
  if (error) { showAuthError("è¡¨ç¤ºåä¿å­˜å¤±æ•—", error); return; }

  alert("è¡¨ç¤ºåä¿å­˜OKï¼");
  await reloadSession();
}

/* èµ·å‹•æ™‚ */
(async () => {
  await reloadSession();

  // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ãªã‚‰å³ãƒ¡ã‚¤ãƒ³ã¸ï¼ˆå¥½ã¿ã§æ¶ˆã—ã¦OKï¼‰
  // if (authUser) gotoMain();

  sb.auth.onAuthStateChange(async () => {
    await reloadSession();
  });

  log("ready. authUser=", authUser?.id || null);
})();
</script>
</body>
</html>
